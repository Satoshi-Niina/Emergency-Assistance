# 1つの質問のみ表示 - 厳格な修正版

## 🔧 **修正内容**

### ❌ **問題**
```
AI: "エンジンの回転が上昇しない原因はいくつか考えられますね。以下に一般的な原因とその対策を挙げますので、確認してみてください。1. 燃料供給の問題: - 燃料フィルターが詰まっていると..."
```
**問題**: まだまとめて表示されている

### ✅ **厳格な修正**

#### 1. **サーバー側プロンプトの厳格化**
```
**厳格なルール:**
1. **1つの質問のみ**: 絶対に複数の質問や説明を同時に表示しない
2. **簡潔**: 端的で分かりやすい質問のみ
3. **段階的**: 問題を段階的に絞り込み、応急処置に誘導
4. **時間管理**: 20分以内での解決を目指す

**重要**: 質問以外の説明文、複数の選択肢、長い文章は一切含めないでください。質問のみを返してください。
```

#### 2. **サーバー側後処理の追加**
```javascript
// AI支援モードでシンプルモードの場合は1つの質問のみに絞り込む
if (aiSupportMode && simpleMode) {
  response = extractSingleQuestion(response);
}
```

#### 3. **フロントエンド側後処理の強化**
```javascript
// 複数の質問や説明文を1つの質問に絞り込む
let cleanResponse = response.trim();

// 複数の質問がある場合は最初の質問のみを抽出
const questionMarks = cleanResponse.split('？');
if (questionMarks.length > 1) {
  cleanResponse = questionMarks[0] + '？';
}

// 長い説明文がある場合は質問部分のみを抽出
const lines = cleanResponse.split('\n');
const questionLine = lines.find(line => 
  line.includes('？') || 
  line.includes('ですか') || 
  line.includes('ますか') ||
  line.includes('ありますか')
);
```

## 🎯 **期待される動作**

### 正しい動作例
```
ユーザー: "エンジン回転が上昇しない"
AI: "応急処置する時間がありますか？"

ユーザー: "約30分"
AI: "エンジンルームにあるアクセルワイヤーが外れていませんか？"

ユーザー: "つながっている"
AI: "アクセルレバーを指で押して動きますか？"

ユーザー: "動く"
AI: "アクセルレバーを押した時、エンジン回転が上昇しますか？"

ユーザー: "変わらない"
AI: "応急処置は困難です。アイドリング状態で退避してください。"
```

### 間違った動作（修正前）
```
AI: "エンジンの回転が上昇しない原因はいくつか考えられますね。以下に一般的な原因とその対策を挙げますので、確認してみてください。1. 燃料供給の問題: - 燃料フィルターが詰まっていると、燃料が適切に供給されないため、エンジンがパワーを失うことがありますね。フィルターを点検し、必要であれば交換してみてください。 - 燃料ポンプの故障も考えられますね。燃料ポンプの動作を確認し、異常があれば修理または交換を検討してみてください。2. エアフィルターの詰まり: - エアフィルターが汚れていると、エンジンに必要な空気が十分に供給されません。エアフィルターを確認し、汚れている場合は清掃または交換してみてください。3. 点火系統の問題: - スパークプラグが劣化していると、適切に点火できなくなりますね。スパークプラグを点検し、必要に応じて交換してみてください。 - イグニッションコイルやディストリビューターキャップの故障も考えられますね。これらの部品を点検し、異常があれば交換してみてください。4. 吸気・排気系の問題: - 吸気系または排気系の詰まりがあると、エンジンの効率が低下しますね。特に、排気系の触媒コンバーターが詰まっていないか確認してみてください。5. センサーの故障: - マスフローセンサー（MAF）や酸素センサー（O2センサー）が故障すると、エンジンのコンピュータが正確な情報を得られず、出力が低下しますね。診断ツールを使ってセンサーの異常を確認し、必要に応じて交換してみてください。6. トランスミッションの問題: - トランスミッションが正しくシフトしていない場合、エンジンの回転が上がらないことがありますね。トランスミッションの状態を確認し、必要なら専門家に相談してみてください。これらの点を確認しても問題が解決しない場合は、専門のメカニックに診断を依頼することをお勧めしますね。"
```

## 🔍 **修正のポイント**

### 1. **プロンプトの厳格化**
- "絶対に1つの質問のみ"を強調
- 説明文や複数選択肢の禁止を明記

### 2. **後処理の強化**
- サーバー側とフロントエンド側の両方で後処理
- 複数質問の検出と最初の質問のみの抽出
- 長い説明文からの質問部分の抽出

### 3. **質問パターンの検出**
- "？"、"ですか"、"ますか"、"ありますか"、"でしょうか"の検出
- 質問以外の説明文の除去

## 📋 **テスト手順**

### 1. 基本テスト
1. AI支援を開始
2. "エンジン回転が上昇しない"と入力
3. 1つの質問のみが表示されることを確認

### 2. 複数質問テスト
1. AIが複数の質問を返した場合
2. 最初の質問のみが表示されることを確認

### 3. 長文テスト
1. AIが長い説明文を返した場合
2. 質問部分のみが抽出されることを確認

この修正により、確実に1つの質問のみが表示され、段階的な応急処置フローが実現されます。
