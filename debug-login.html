<!DOCTYPE html>
<html>
<head>
    <title>緊急支援システム - ログインデバッグ</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .debug-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        input, button { padding: 10px; margin: 5px; width: 200px; }
        .status-panel { background: #e3f2fd; padding: 10px; border-left: 4px solid #2196f3; }
    </style>
</head>
<body>
    <h1>🚨 緊急支援システム - ログインデバッグ</h1>
    
    <div class="status-panel">
        <h3>📋 システム情報</h3>
        <p><strong>フロントエンド URL:</strong> Azure Static Web Apps</p>
        <p><strong>バックエンド API:</strong> https://emergency-backend-webapp.azurewebsites.net</p>
        <p><strong>現在の接続状態:</strong> <span id="connection-status">確認中...</span></p>
    </div>

    <div class="debug-section">
        <h3>🔐 ログイン情報</h3>
        <p><strong>管理者:</strong></p>
        <ul>
            <li>ユーザー名: <code>admin</code></li>
            <li>パスワード: <code>password</code></li>
        </ul>
        <p><strong>従業員:</strong></p>
        <ul>
            <li>ユーザー名: <code>employee1</code></li>
            <li>パスワード: <code>password</code></li>
        </ul>
    </div>

    <div class="debug-section">
        <h3>🧪 ログインテスト</h3>
        <form id="loginForm">
            <div>
                <input type="text" id="username" placeholder="ユーザー名" value="admin">
            </div>
            <div>
                <input type="password" id="password" placeholder="パスワード" value="password">
            </div>
            <div>
                <button type="submit">ログインテスト</button>
            </div>
        </form>
        <div id="login-result"></div>
    </div>

    <div class="debug-section">
        <h3>🔧 診断結果</h3>
        <div id="diagnostics">
            <p>1. <span id="api-health">API接続確認中...</span></p>
            <p>2. <span id="db-connection">データベース接続確認中...</span></p>
            <p>3. <span id="gpt-connection">GPT接続確認中...</span></p>
        </div>
    </div>

    <script>
        const API_BASE = 'https://emergency-backend-webapp.azurewebsites.net';

        // 1. API Health Check
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                document.getElementById('api-health').innerHTML = 
                    `<span class="success">✅ API接続OK (${data.status})</span>`;
                document.getElementById('connection-status').innerHTML = 
                    '<span class="success">接続OK</span>';
                return true;
            } catch (error) {
                document.getElementById('api-health').innerHTML = 
                    `<span class="error">❌ API接続エラー: ${error.message}</span>`;
                document.getElementById('connection-status').innerHTML = 
                    '<span class="error">接続エラー</span>';
                return false;
            }
        }

        // 2. Database Connection Check
        async function checkDBConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/health/db`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('db-connection').innerHTML = 
                        `<span class="success">✅ データベース接続OK</span>`;
                } else {
                    document.getElementById('db-connection').innerHTML = 
                        `<span class="error">❌ データベース接続エラー (${response.status})</span>`;
                }
            } catch (error) {
                document.getElementById('db-connection').innerHTML = 
                    `<span class="error">❌ データベース接続エラー: ${error.message}</span>`;
            }
        }

        // 3. GPT Connection Check
        async function checkGPTConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/health/gpt`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('gpt-connection').innerHTML = 
                        `<span class="success">✅ GPT接続OK</span>`;
                } else {
                    document.getElementById('gpt-connection').innerHTML = 
                        `<span class="error">❌ GPT接続エラー (${response.status})</span>`;
                }
            } catch (error) {
                document.getElementById('gpt-connection').innerHTML = 
                    `<span class="error">❌ GPT接続エラー: ${error.message}</span>`;
            }
        }

        // Login Test
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');
            
            resultDiv.innerHTML = '<p>ログイン中...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>✅ ログイン成功!</h4>
                            <p>ユーザー: ${data.user.display_name}</p>
                            <p>権限: ${data.user.role}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>❌ ログイン失敗</h4>
                            <p>${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>❌ 接続エラー</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // Run diagnostics on page load
        window.addEventListener('load', () => {
            checkAPIHealth();
            setTimeout(checkDBConnection, 1000);
            setTimeout(checkGPTConnection, 2000);
        });
    </script>
</body>
</html>
