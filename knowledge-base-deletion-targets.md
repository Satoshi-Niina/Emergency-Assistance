# ナレッジデータ削除機能の削除対象

## 🗑️ 削除されるフォルダ・ファイル

### 削除対象フォルダ

ナレッジデータ削除機能（`/api/knowledge-base/cleanup/manual` および `/cleanup/auto`）は、以下のフォルダを削除対象とします：

#### 1. **`documents/` フォルダ全体**
```
knowledge-base/documents/
├── doc_1745235432958_161/          ← 削除される
│   ├── chunks.json                  ← 削除される
│   ├── metadata.json                ← 削除される
│   └── qa/                          ← 削除される
│       ├── qa_1.json
│       └── qa_pairs.json
├── doc_1746327645944_199/          ← 削除される
│   ├── chunks.json                  ← 削除される
│   ├── metadata.json                ← 削除される
│   └── qa/                          ← 削除される
├── doc_*.json（直下のJSONファイル）  ← 削除される
└── すべてのサブディレクトリ          ← 削除される
```

#### 2. **`text/` フォルダ全体**
```
knowledge-base/text/
├── _________1754135672622_1754135673999.txt  ← 削除される
├── _________1754203761794_1754203762616.txt  ← 削除される
└── すべての.txtファイル                      ← 削除される
```

#### 3. **`qa/` フォルダ全体**
```
knowledge-base/qa/
├── MC応急処置（画像検索用サンプル）_1745233986839_qa_1745234006292.json  ← 削除される
├── railway_maintenance_knowledge_1745234685192_qa_1745234707086.json     ← 削除される
├── railway_maintenance_knowledge_1745235432716_qa_1745235451840.json     ← 削除される
├── 保守用車ナレッジ_1746327645934_qa_1746327668942.json                   ← 削除される
└── すべての.jsonファイル                                                  ← 削除される
```

#### 4. **`troubleshooting/` フォルダ全体**
```
knowledge-base/troubleshooting/
├── flow_1754393718848.json  ← 削除される
├── flow_1754961802332.json  ← 削除される
├── flow_1759046637188.json  ← 削除される
├── flow_1761981323239.json  ← 削除される
└── すべての.jsonファイル    ← 削除される
```

#### 5. **ルート直下の`doc_*`フォルダ**（存在する場合）
```
knowledge-base/
└── doc_1746327645944_199/  ← 削除される（ルート直下の場合）
    └── すべてのファイル
```

### 削除モード

#### モード1: **全削除** (`deleteAll = true`)

- **動作**: 上記のすべてのフォルダ内の**すべてのファイルとサブディレクトリ**を削除
- **条件**: `deleteAll = true`を指定
- **結果**: 
  - `documents/`フォルダ内のすべての`doc_*`フォルダが削除
  - `text/`フォルダ内のすべての`.txt`ファイルが削除
  - `qa/`フォルダ内のすべての`.json`ファイルが削除
  - `troubleshooting/`フォルダ内のすべての`.json`ファイルが削除

#### モード2: **日付ベース削除** (`olderThanDays` 指定)

- **動作**: 最終更新日時（`mtimeMs`）が指定日数より古いファイルのみ削除
- **条件**: `olderThanDays`に日数を指定（例：`olderThanDays: 180` = 6ヶ月以上）
- **結果**:
  - 指定日数より古いファイルのみ削除
  - 新しいファイルは残る
  - 空になったディレクトリも削除

#### モード3: **自動削除** (`/cleanup/auto`)

- **動作**: 1年以上経過したデータを自動削除
- **条件**: 自動実行
- **結果**: `olderThanDays: 365`と同じ動作

---

## ✅ 削除されないフォルダ・ファイル

### 削除対象外のフォルダ

以下のフォルダは**削除されません**：

#### 1. **`data/`` フォルダ
```
knowledge-base/data/
├── image_search_data.json  ← 削除されない（画像検索データ）
└── （その他のファイル）     ← 削除されない
```

#### 2. **`images/` フォルダ**
```
knowledge-base/images/
├── chat-exports/           ← 削除されない
│   ├── chat_image_*.png
│   └── README.md
├── emergency-flows/        ← 削除されない
│   └── emergency-flow-step*.JPG
└── すべての画像ファイル     ← 削除されない
```

#### 3. **`exports/` フォルダ**
```
knowledge-base/exports/
├── *.json（エクスポートファイル）  ← 削除されない
└── すべてのファイル               ← 削除されない
```

#### 4. **`index.json` ファイル**
```
knowledge-base/index.json  ← 削除されない（全削除の場合は空になるが、ファイル自体は残る）
```

---

## 📋 削除処理の詳細

### インデックスファイルの更新

削除処理後、`index.json`も更新されます：

1. **全削除の場合**:
   - `index.json`を空の状態にリセット
   ```json
   {
     "knowledge": [],
     "lastUpdated": "2025-01-XX..."
   }
   ```

2. **日付ベース削除の場合**:
   - 削除されたファイルのパスを`index.json`から除外
   - 残っているファイルのパスのみ残す

### 削除カウント

削除処理の結果として、以下の情報が返されます：
```json
{
  "success": true,
  "deletedCount": 150,  // 削除されたファイル+ディレクトリの合計数
  "message": "150件のファイル/ディレクトリを削除しました"
}
```

---

## ⚠️ 重要な注意事項

1. **`documents/`フォルダの完全削除**
   - `documents/`フォルダ内のすべての`doc_*`フォルダが削除されます
   - `chunks.json`、`metadata.json`、`qa/`サブフォルダもすべて削除されます

2. **GPT検索への影響**
   - 削除されたファイルは、以降のGPT検索（`searchKnowledgeBase`）で使用できなくなります
   - 削除後は、新しいドキュメントを追加しない限り検索結果が減ります

3. **バックアップの推奨**
   - 削除前に重要なデータのバックアップを推奨します
   - `/api/knowledge-base/export`エンドポイントでエクスポートできます

4. **復元不可**
   - 削除されたファイルは復元できません（ごみ箱にも入りません）
   - データベースに保存されていない限り、復元不可能です

