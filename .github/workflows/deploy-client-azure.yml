name: Deploy Client to Azure Static Web Apps

on:
  push:
    branches:
      - main
    paths:
      - 'client/**'
      - '.github/workflows/deploy-client-azure.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Static Web App
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean previous build
        working-directory: ./client
        run: |
          echo "üßπ Cleaning previous build artifacts..."
          rm -rf dist
          rm -rf node_modules/.vite
          rm -rf .vite
          rm -rf node_modules/.cache
          echo "‚úÖ Cleaned previous build artifacts"

      - name: Install dependencies
        working-directory: ./client
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci --prefer-offline --no-audit
          echo "‚úÖ Dependencies installed"

      - name: Build client
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '/api' }}
        run: |
          echo "üî® Building client..."
          echo "NODE_ENV: $NODE_ENV"
          echo "VITE_API_BASE_URL: $VITE_API_BASE_URL"
          
          # Clean build with no cache
          npm run build -- --force
          
          echo "‚úÖ Build completed"
          
          # Verify build output
          echo "üìÅ Checking build output..."
          if [ ! -d "dist" ]; then
            echo "‚ùå ERROR: dist directory not found after build"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå ERROR: dist/index.html not found after build"
            exit 1
          fi
          
          echo "üìÑ Build output directory contents:"
          ls -la dist/
          
          echo ""
          echo "üìÑ dist/index.html content:"
          cat dist/index.html
          
          echo ""
          echo "üîç Checking for /src/main.tsx reference:"
          if grep -q "/src/main.tsx" dist/index.html; then
            echo "‚ùå ERROR: /src/main.tsx still found in dist/index.html!"
            echo "Vite build failed to replace module script reference"
            echo "This will cause 404 errors and 'Unexpected token <' error"
            echo ""
            echo "Current index.html script tags:"
            grep -i "script" dist/index.html
            exit 1
          fi
          
          echo "‚úÖ No /src/main.tsx found - build is correct"
          
          # Check for actual asset references
          echo ""
          echo "üîç Checking for asset references:"
          if grep -q "/assets/" dist/index.html; then
            echo "‚úÖ Found /assets/ references (correct)"
            grep -o '/assets/[^"]*' dist/index.html | head -5
          else
            echo "‚ö†Ô∏è No /assets/ references found in index.html"
          fi
          
          echo "‚úÖ Build verification passed"

      - name: Verify build output
        working-directory: ./client
        run: |
          echo "üìÅ Build output directory contents:"
          ls -la dist/ || echo "‚ùå dist directory not found"
          echo ""
          echo "üìÅ Checking for runtime-config.js:"
          if [ -f "dist/runtime-config.js" ]; then
            echo "‚úÖ runtime-config.js found in dist"
            ls -la dist/runtime-config.js
            echo "üìÑ First 10 lines:"
            head -10 dist/runtime-config.js
          else
            echo "‚ö†Ô∏è runtime-config.js NOT found in dist"
            echo "üìÅ Checking public directory:"
            ls -la public/ || echo "‚ùå public directory not found"
            if [ -f "public/runtime-config.js" ]; then
              echo "‚úÖ Found in public, copying to dist..."
              cp public/runtime-config.js dist/
              ls -la dist/runtime-config.js
            else
              echo "‚ùå ERROR: runtime-config.js not found in public/"
              exit 1
            fi
          fi

      - name: Copy staticwebapp.config.json to dist
        working-directory: ./client
        run: |
          if [ -f "staticwebapp.config.json" ]; then
            cp staticwebapp.config.json dist/
            echo "‚úÖ Copied staticwebapp.config.json to dist"
            ls -la dist/staticwebapp.config.json
            echo "üìÑ Verifying staticwebapp.config.json content:"
            cat dist/staticwebapp.config.json | head -20
          else
            echo "‚ùå ERROR: staticwebapp.config.json not found"
            exit 1
          fi
          # Ensure staticwebapp.config.json is valid JSON
          python3 -m json.tool dist/staticwebapp.config.json > /dev/null && echo "‚úÖ JSON is valid" || echo "‚ùå ERROR: Invalid JSON"

      - name: Final verification before deploy
        working-directory: ./client
        run: |
          echo "üì¶ Final dist directory contents:"
          ls -la dist/
          echo ""
          echo "üîç Checking critical files:"
          [ -f "dist/index.html" ] && echo "‚úÖ index.html" || echo "‚ùå index.html missing"
          [ -f "dist/runtime-config.js" ] && echo "‚úÖ runtime-config.js" || echo "‚ùå runtime-config.js missing"
          [ -f "dist/staticwebapp.config.json" ] && echo "‚úÖ staticwebapp.config.json" || echo "‚ùå staticwebapp.config.json missing"
          [ -d "dist/assets" ] && echo "‚úÖ assets directory" || echo "‚ö†Ô∏è assets directory missing"
          echo ""
          echo "üìÑ Checking index.html content:"
          if [ -f "dist/index.html" ]; then
            echo "--- index.html content (last 20 lines) ---"
            tail -20 dist/index.html
            echo ""
            echo "üîç Checking for script tags:"
            grep -i "script" dist/index.html || echo "‚ö†Ô∏è No script tags found"
            echo ""
            echo "üîç Checking for /src/main.tsx reference:"
            if grep -q "/src/main.tsx" dist/index.html; then
              echo "‚ùå ERROR: /src/main.tsx still referenced in built index.html!"
              echo "This should have been replaced by Vite with /assets/main-*.js"
              echo "Vite build may have failed or index.html was not processed correctly"
              echo "‚ö†Ô∏è This will cause 404 errors - /src/main.tsx will be rewritten to index.html"
              echo ""
              echo "Full script section:"
              grep -A 2 -B 2 "script" dist/index.html | head -20
            else
              echo "‚úÖ No /src/main.tsx reference found (correctly replaced)"
            fi
            echo ""
            echo "üîç Checking actual script references in index.html:"
            grep -o 'src="[^"]*"' dist/index.html || echo "No script src found"
          fi
          echo ""
          echo "üìÅ Assets directory contents:"
          ls -la dist/assets/ 2>/dev/null | head -10 || echo "‚ö†Ô∏è assets directory not found or empty"

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/client"
          output_location: "dist"
          skip_app_build: true

      - name: Deploy summary
        run: |
          echo "‚úÖ Client deployed to Azure Static Web Apps"
          echo "üåê Frontend URL: https://witty-river-012f39e00.1.azurestaticapps.net"

