name: Deploy Client to Azure Static Web Apps

on:
  push:
    branches:
      - main
    paths:
      - 'client/**'
      - '.github/workflows/deploy-client-azure.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Static Web App
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean previous build
        working-directory: ./client
        run: |
          echo "ğŸ§¹ Cleaning previous build artifacts..."
          rm -rf dist
          rm -rf node_modules/.vite
          rm -rf .vite
          rm -rf node_modules/.cache
          echo "âœ… Cleaned previous build artifacts"

      - name: Install dependencies
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"

      - name: Build client
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '/api' }}
        run: |
          echo "ğŸ”¨ Building client..."
          echo "NODE_ENV: $NODE_ENV"
          echo "VITE_API_BASE_URL: $VITE_API_BASE_URL"
          
          # Clean build - Vite doesn't support --force flag, use emptyOutDir instead
          npm run build 2>&1 || {
            echo "âŒ Build failed. Checking for errors..."
            exit 1
          }
          
          echo "âœ… Build completed"
          
          # Verify build output
          echo "ğŸ“ Checking build output..."
          if [ ! -d "dist" ]; then
            echo "âŒ ERROR: dist directory not found after build"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ ERROR: dist/index.html not found after build"
            exit 1
          fi
          
          echo "ğŸ“„ Build output directory contents:"
          ls -la dist/
          
          echo ""
          echo "ğŸ“„ dist/index.html content:"
          cat dist/index.html
          
          echo ""
          echo "ğŸ” Checking for /src/main.tsx reference:"
          if grep -q "/src/main.tsx" dist/index.html; then
            echo "âŒ ERROR: /src/main.tsx still found in dist/index.html!"
            echo "Vite build failed to replace module script reference"
            echo "This will cause 404 errors and 'Unexpected token <' error"
            echo ""
            echo "Current index.html script tags:"
            grep -i "script" dist/index.html
            exit 1
          fi
          
          echo "âœ… No /src/main.tsx found - build is correct"
          
          # Check for actual asset references
          echo ""
          echo "ğŸ” Checking for asset references:"
          if grep -q "/assets/" dist/index.html; then
            echo "âœ… Found /assets/ references (correct)"
            grep -o '/assets/[^"]*' dist/index.html | head -5
          else
            echo "âš ï¸ No /assets/ references found in index.html"
          fi
          
          echo "âœ… Build verification passed"

      - name: Verify build output
        working-directory: ./client
        run: |
          echo "ğŸ“ Build output directory contents:"
          ls -la dist/ || echo "âŒ dist directory not found"
          echo ""
          echo "ğŸ“ Checking for runtime-config.js:"
          if [ -f "dist/runtime-config.js" ]; then
            echo "âœ… runtime-config.js found in dist"
            ls -la dist/runtime-config.js
            echo "ğŸ“„ First 10 lines:"
            head -10 dist/runtime-config.js
          else
            echo "âš ï¸ runtime-config.js NOT found in dist"
            echo "ğŸ“ Checking public directory:"
            ls -la public/ || echo "âŒ public directory not found"
            if [ -f "public/runtime-config.js" ]; then
              echo "âœ… Found in public, copying to dist..."
              cp public/runtime-config.js dist/
              ls -la dist/runtime-config.js
            else
              echo "âŒ ERROR: runtime-config.js not found in public/"
              exit 1
            fi
          fi

      - name: Copy staticwebapp.config.json to dist
        working-directory: ./client
        run: |
          if [ -f "staticwebapp.config.json" ]; then
            cp staticwebapp.config.json dist/
            echo "âœ… Copied staticwebapp.config.json to dist"
            ls -la dist/staticwebapp.config.json
            echo "ğŸ“„ Verifying staticwebapp.config.json content:"
            cat dist/staticwebapp.config.json | head -20
          else
            echo "âŒ ERROR: staticwebapp.config.json not found"
            exit 1
          fi
          # Ensure staticwebapp.config.json is valid JSON
          python3 -m json.tool dist/staticwebapp.config.json > /dev/null && echo "âœ… JSON is valid" || echo "âŒ ERROR: Invalid JSON"

      - name: Final verification before deploy
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Final dist directory contents:"
          ls -la dist/
          echo ""
          echo "ğŸ” Checking critical files:"
          [ -f "dist/index.html" ] && echo "âœ… index.html" || echo "âŒ index.html missing"
          [ -f "dist/runtime-config.js" ] && echo "âœ… runtime-config.js" || echo "âŒ runtime-config.js missing"
          [ -f "dist/staticwebapp.config.json" ] && echo "âœ… staticwebapp.config.json" || echo "âŒ staticwebapp.config.json missing"
          [ -d "dist/assets" ] && echo "âœ… assets directory" || echo "âš ï¸ assets directory missing"
          echo ""
          echo "ğŸ“„ Checking index.html content:"
          if [ -f "dist/index.html" ]; then
            echo "--- index.html content (last 20 lines) ---"
            tail -20 dist/index.html
            echo ""
            echo "ğŸ” Checking for script tags:"
            grep -i "script" dist/index.html || echo "âš ï¸ No script tags found"
            echo ""
            echo "ğŸ” Checking for /src/main.tsx reference:"
            if grep -q "/src/main.tsx" dist/index.html; then
              echo "âŒ ERROR: /src/main.tsx still referenced in built index.html!"
              echo "This should have been replaced by Vite with /assets/main-*.js"
              echo "Vite build may have failed or index.html was not processed correctly"
              echo "âš ï¸ This will cause 404 errors - /src/main.tsx will be rewritten to index.html"
              echo ""
              echo "Full script section:"
              grep -A 2 -B 2 "script" dist/index.html | head -20
            else
              echo "âœ… No /src/main.tsx reference found (correctly replaced)"
            fi
            echo ""
            echo "ğŸ” Checking actual script references in index.html:"
            grep -o 'src="[^"]*"' dist/index.html || echo "No script src found"
          fi
          echo ""
          echo "ğŸ“ Assets directory contents:"
          ls -la dist/assets/ 2>/dev/null | head -10 || echo "âš ï¸ assets directory not found or empty"

      - name: Verify dist/index.html before deploy
        working-directory: ./client
        run: |
          echo "ğŸ” Final verification of dist/index.html:"
          if [ -f "dist/index.html" ]; then
            echo "ğŸ“„ Full content of dist/index.html:"
            cat dist/index.html
            echo ""
            echo "ğŸ” Script tags found:"
            grep -i "script" dist/index.html || echo "No script tags found"
            echo ""
            echo "ğŸ” Checking for /src/main.tsx:"
            if grep -q "/src/main.tsx" dist/index.html; then
              echo "âŒ CRITICAL ERROR: /src/main.tsx still in dist/index.html!"
              echo "Build verification failed - deployment will fail"
              exit 1
            fi
            echo "âœ… Verification passed - /src/main.tsx not found"
          else
            echo "âŒ ERROR: dist/index.html not found"
            exit 1
          fi

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/client"
          output_location: "dist"
          skip_app_build: true

      - name: Deploy summary
        run: |
          echo "âœ… Client deployed to Azure Static Web Apps"
          echo "ğŸŒ Frontend URL: https://witty-river-012f39e00.1.azurestaticapps.net"

