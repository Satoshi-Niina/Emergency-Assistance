name: Force Deploy Server Now

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for force deployment'
        required: false
        default: 'Environment variables updated - force redeploy'

permissions:
  contents: read

jobs:
  force-deploy:
    runs-on: ubuntu-latest
    name: Force Deploy with Environment Variables
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Debug deployment trigger
        run: |
          echo "ğŸ”„ Force deployment triggered"
          echo "ğŸ” Reason: ${{ github.event.inputs.reason || 'Environment variables updated' }}"
          echo "ğŸ” Branch: ${{ github.ref }}"
          echo "ğŸ” Commit: ${{ github.sha }}"
          echo "ğŸ“ Server files:"
          ls -la server/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package.json

      - name: Install dependencies
        run: |
          cd server
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --no-audit --no-fund
          echo "ğŸ“¦ Dependencies installed"
          echo "ğŸ“¦ Checking critical files:"
          ls -la index.js azure-server.js azure-server-debug.js || true

      - name: Prepare deployment package
        run: |
          mkdir -p deploy
          cp -r server/* deploy/
          cp -r shared deploy/ || echo "No shared directory"
          cp -r knowledge-base deploy/ || echo "No knowledge-base directory"
          
          # Create required directories
          mkdir -p deploy/app-logs/exports
          mkdir -p deploy/app-logs/history
          mkdir -p deploy/uploads
          
          echo "ğŸ“¦ Deployment package contents:"
          ls -la deploy/
          echo "ğŸ“¦ Package size: $(du -sh deploy/)"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: Emergency-Assistance
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy
        
      - name: Post-deployment verification
        run: |
          echo "âœ… Deployment completed"
          echo "ğŸŒ App URL: https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net"
          echo "â° Waiting 30 seconds for app to start..."
          sleep 30
          
          echo "ğŸ” Testing health check..."
          curl -f https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net/api/health || echo "Health check failed - app may still be starting"