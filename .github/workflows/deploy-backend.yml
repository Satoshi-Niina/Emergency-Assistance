name: Deploy Backend to Azure Web App

on:
  push:
    branches: [ main, develop ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # バックエンドは server/ 配下（最小限の本番用サーバーのみビルド）
      - name: Install deps
        working-directory: server
        run: |
          echo "Installing server dependencies..."
          npm ci --legacy-peer-deps
      
      - name: Build (Production Server Only)
        working-directory: server
        run: |
          echo "Building only production server..."
          npx tsc production-server.ts --outDir dist --target es2020 --module commonjs --esModuleInterop --skipLibCheck

      # デプロイ用のZIPを作成（ビルド成果物とpackage.jsonのみ）
      - name: Create package (zip)
        run: |
          cd server
          zip -r $RUNNER_TEMP/backend.zip dist/ package.json package-lock.json -x "**/node_modules/**"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: "Emergencyassistance-sv"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ${{ runner.temp }}/backend.zip
          startup-command: "npm run start:production"
          slot-name: "Production"
