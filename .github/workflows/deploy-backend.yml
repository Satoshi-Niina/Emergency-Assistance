name: Deploy Backend (App Service)

name: Deploy Backend (server + shared)

on:
  push:
    branches: [ backup-clean ]
    paths:
      - 'server/**'
      - 'shared/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install shared dependencies
        working-directory: shared
        run: npm ci

      - name: Build shared (tsc)
        run: |
          if [ -f shared/package.json ]; then npm --prefix shared run build || npx -y tsc -p shared/tsconfig.json; else npx -y tsc -p shared/tsconfig.json; fi

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Build server (tsc)
        run: |
          if [ -f server/package.json ]; then npm --prefix server run build || npx -y tsc -p server/tsconfig.json; else npx -y tsc -p server/tsconfig.json; fi

      - name: Check publish profile secret exists
        run: |
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "Missing AZURE_WEBAPP_PUBLISH_PROFILE"; exit 1;
          fi

      - name: Validate publish profile matches app
        shell: bash
        run: |
          APP="Emergencyassistance-sv"
          echo "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" | grep -qi "${APP}\.scm\.azurewebsites\.net" || { echo "NG: profile host not for ${APP}"; exit 1; }

      - name: Deploy to Azure WebApp
        uses: azure/webapps-deploy@v3
        with:
          app-name: Emergencyassistance-sv
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: server

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install shared dependencies
        working-directory: shared
        run: npm ci

      - name: Build shared (tsc)
        run: |
          if [ -f shared/package.json ]; then npm --prefix shared run build || npx -y tsc -p shared/tsconfig.json; else npx -y tsc -p shared/tsconfig.json; fi

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Build server (tsc)
        run: |
          if [ -f server/package.json ]; then npm --prefix server run build || npx -y tsc -p server/tsconfig.json; else npx -y tsc -p server/tsconfig.json; fi

      - name: Check publish profile secret exists
        run: |
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "Missing AZURE_WEBAPP_PUBLISH_PROFILE"; exit 1;
          fi

      - name: Validate publish profile matches app
        shell: bash
        run: |
          APP="Emergencyassistance-sv"
          echo "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" | grep -qi "${APP}\.scm\.azurewebsites\.net" || { echo "NG: profile host not for ${APP}"; exit 1; }

      - name: Deploy to Azure WebApp
        uses: azure/webapps-deploy@v3
        with:
          app-name: Emergencyassistance-sv
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: server
