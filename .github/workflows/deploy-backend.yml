name: Deploy Backend to Azure Web App

on:
  push:
    branches: [ main, develop ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # バックエンドは server/ 配下（tsc で dist を生成）
      - name: Install deps
        working-directory: server
        run: npm ci

      - name: Build (tsc)
        working-directory: server
        run: npm run build

      # デプロイ用のZIPを作成（node_modulesは除外、Azure側でOryxが復元）
      - name: Create package (zip)
        run: |
          cd server
          zip -r $RUNNER_TEMP/backend.zip . -x "**/node_modules/**" "**/.git/**" "**/.github/**"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: "Emergencyassistance-sv"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ${{ runner.temp }}/backend.zip
          startup-command: "npm run start:production"
