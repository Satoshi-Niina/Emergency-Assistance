name: Deploy Backend to Azure Web App

on:
  push:
    branches: [ main, develop ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install deps
        working-directory: server
        run: |
          echo "Installing server dependencies..."
          npm ci --legacy-peer-deps --ignore-scripts
      
      - name: Build
        working-directory: server
        run: |
          echo "Building server with TypeScript..."
          npm run build

      - name: Create package (zip)
        run: |
          cd server
          echo "Creating deployment package..."
          echo "Contents of dist/:"
          ls -la dist/ || echo "dist/ directory not found"
          echo "Creating ZIP package..."
          zip -r $RUNNER_TEMP/backend.zip dist/ package.json package-lock.json -x "**/node_modules/**"
          echo "ZIP package created:"
          ls -la $RUNNER_TEMP/backend.zip

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: "Emergencyassistance-sv"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ${{ runner.temp }}/backend.zip
          startup-command: "npm run start:production"
          app-settings: |
            -NODE_ENV=production
            -PORT=8080
