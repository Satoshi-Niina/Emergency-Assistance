name: Deploy Backend

on:
  push:
    branches: [ main, develop, backup-clean ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"
  pull_request:
    branches: [ main, develop, backup-clean ]
    paths:
      - "server/**"
      - ".github/workflows/deploy-backend.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Debug Environment
        run: |
          echo "Current directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Directory contents:"
          ls -la

      - name: Install & Build
        run: |
          echo "Installing dependencies..."
          npm ci --verbose
          echo "Building project..."
          npm run build || echo "Build step not found or failed"
          echo "Build completed. Checking dist directory:"
          ls -la dist/ || echo "dist directory not found"

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Debug Azure CLI
        run: |
          echo "Azure CLI version:"
          az --version
          echo "Current Azure account:"
          az account show --query "{name:name, id:id, tenantId:tenantId}" --output table

      - name: Deploy using Azure CLI
        run: |
          echo "Creating deployment package..."
          zip -r deployment.zip dist/ package.json package-lock.json
          echo "Deployment package created:"
          ls -la deployment.zip
          
          echo "Deploying to Azure Web App..."
          az webapp deployment source config-zip \
            --resource-group "rg-Emergencyassistant-app" \
            --name "Emergencyassistance-sv" \
            --src "deployment.zip" \
            --timeout 1800
          
          echo "Deployment completed successfully!"
