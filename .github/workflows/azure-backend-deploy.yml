name: Deploy Emergency Backend to Azure

on:
  push:
    branches:
      - main
    paths:
      - "server/**"
      - ".github/workflows/azure-backend-deploy.yml"
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: emergency-backend-app
  AZURE_WEBAPP_PACKAGE_PATH: "server"
  NODE_VERSION: "18"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Backend

    steps:
      - name: 🔄 Checkout repository
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/package.json

      - name: 📋 Display environment info
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Files in workspace:"
          ls -la
          echo "Files in server directory:"
          ls -la ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: 📦 Install dependencies
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          echo "Installing dependencies..."
          npm ci --only=production
          echo "✅ Dependencies installed"

      - name: 🔨 Build application (if needed)
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          # シンプルアプリの場合、ビルドは不要
          echo "Using simple Express app - no build required"

      - name: 🧪 Test application startup
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          echo "Testing application startup..."
          # シンプルアプリが存在するかチェック
          if [ -f "simple-app.js" ]; then
            echo "✅ Simple application found: simple-app.js"
            # package.jsonのstartスクリプトを確認
            echo "Package.json start script:"
            node -e "console.log(require('./package.json').scripts.start || 'No start script')"
          else
            echo "❌ Simple app file not found"
            exit 1
          fi

      - name: 📂 Prepare deployment package
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          echo "Preparing deployment package..."
          # node_modulesを除外してファイルを確認
          echo "Files to be deployed:"
          find . -name "node_modules" -prune -o -type f -print | head -20
          echo "Package.json contents:"
          cat package.json

      - name: 🚀 Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_EMERGENCY_BACKEND }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: 🔍 Post-deployment verification
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30
          echo "Testing deployed application..."
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health || echo "Health check failed"
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/ || echo "Root endpoint failed"

      - name: 📊 Deployment summary
        if: always()
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "App Name: ${{ env.AZURE_WEBAPP_NAME }}"
          echo "Package Path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}"
          echo "Node Version: ${{ env.NODE_VERSION }}"
          echo "Deployment URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "=========================="
