name: Deploy Emergency Backend to Azure

on:
  push:
    branches:
      - main
    paths:
      - "server/**"
      - ".github/workflows/azure-backend-deploy.yml"
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: emergency-backend-app
  AZURE_WEBAPP_PACKAGE_PATH: "server"
  NODE_VERSION: "18"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Backend

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/package.json

      - name: ğŸ“‹ Display environment info
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Files in workspace:"
          ls -la
          echo "Files in server directory:"
          ls -la ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: ğŸ“¦ Install dependencies
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          echo "Installing dependencies..."
          npm ci --only=production
          echo "âœ… Dependencies installed"

      - name: ğŸ”¨ Build application (if needed)
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          # ã‚·ãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®å ´åˆã€ãƒ“ãƒ«ãƒ‰ã¯ä¸è¦
          echo "Using simple Express app - no build required"

      - name: ğŸ§ª Test application startup
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          echo "Testing application startup..."
          # ã‚·ãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -f "simple-app.js" ]; then
            echo "âœ… Simple application found: simple-app.js"
            # package.jsonã®startã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèª
            echo "Package.json start script:"
            node -e "console.log(require('./package.json').scripts.start || 'No start script')"
          else
            echo "âŒ Simple app file not found"
            exit 1
          fi

      - name: ğŸ“‚ Prepare deployment package
        run: |
          cd ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          echo "Preparing deployment package..."
          # node_modulesã‚’é™¤å¤–ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          echo "Files to be deployed:"
          find . -name "node_modules" -prune -o -type f -print | head -20
          echo "Package.json contents:"
          cat package.json

      - name: ğŸš€ Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_EMERGENCY_BACKEND }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: ğŸ” Post-deployment verification
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30
          echo "Testing deployed application..."
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health || echo "Health check failed"
          curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/ || echo "Root endpoint failed"

      - name: ğŸ“Š Deployment summary
        if: always()
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "App Name: ${{ env.AZURE_WEBAPP_NAME }}"
          echo "Package Path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}"
          echo "Node Version: ${{ env.NODE_VERSION }}"
          echo "Deployment URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "=========================="
