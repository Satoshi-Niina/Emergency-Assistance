name: Deploy to Azure App Service

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: 'azure-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  APP_URL: 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net'
  AZURE_APP_NAME: 'Emergency-Assistance'

# IMPORTANT: Ensure the following settings are configured in Azure App Service:
# - SCM_DO_BUILD_DURING_DEPLOYMENT: true (enables Oryx build)
# - WEBSITE_NODE_DEFAULT_VERSION: 20-lts
# - NPM_CONFIG_PRODUCTION: false (installs devDependencies for build)

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "üîç Validating required secrets..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "‚ùå AZURE_WEBAPP_PUBLISH_PROFILE secret is missing"
            echo "üìã Setup: GitHub > Settings > Secrets > Actions"
            exit 1
          fi
          echo "‚úÖ Required secrets validated"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install and Build Server
        working-directory: ./server
        run: |
          echo "üì¶ Installing server dependencies..."
          npm ci --production=false --no-audit --no-fund

          echo "üî® Running server build check..."
          npm run build || echo "No build script, continuing..."
          echo "‚úÖ Server preparation completed"

      - name: Install and Build Client
        working-directory: ./client
        run: |
          echo "üèóÔ∏è Installing client dependencies..."
          npm ci --no-audit --no-fund

          echo "üî® Building client..."
          npm run build

          # Verify critical build outputs
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          echo "üìä Client build completed:"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "   Files: $(find dist -type f | wc -l) files"
          echo "‚úÖ Client built successfully"

      - name: Prepare Source Package for Oryx Build
        shell: bash
        run: |
          echo "üì¶ Creating source package for Azure Oryx build..."

          # Create clean deployment directory
          rm -rf deploy-package
          mkdir -p deploy-package

          echo "üìÅ Step 1: Copy server source files..."
          # Copy all server source files (Oryx will install dependencies)
          cp -r server/* deploy-package/

          # Remove node_modules if exists (Oryx will install fresh)
          rm -rf deploy-package/node_modules

          echo "üìÅ Step 2: Copy client build..."
          mkdir -p deploy-package/client
          cp -r client/dist deploy-package/client/

          echo "ÔøΩ Step 3: Source package validation..."

          # Critical source files validation
          CRITICAL_FILES=(
            "package.json:Server package configuration"
            "azure-server.js:Main application file"
            "client/dist/index.html:Frontend entry point"
          )

          validation_failed=false
          for file_info in "${CRITICAL_FILES[@]}"; do
            IFS=':' read -r file desc <<< "$file_info"
            full_path="deploy-package/$file"

            if [ -f "$full_path" ]; then
              echo "  ‚úÖ $desc"
            else
              echo "  ‚ùå $desc - NOT FOUND: $full_path"
              validation_failed=true
            fi
          done

          if [ "$validation_failed" = "true" ]; then
            echo "‚ùå Source package validation failed"
            echo "üìã Package contents:"
            find deploy-package -maxdepth 2 -type f | head -20
            exit 1
          fi

          # Package statistics
          package_size=$(du -sh deploy-package/ | cut -f1)
          file_count=$(find deploy-package -type f | wc -l)

          echo "üìä Source Package Statistics:"
          echo "   üì¶ Total Size: $package_size"
          echo "   üìÑ File Count: $file_count"
          echo "   üóÇÔ∏è Structure:"
          ls -la deploy-package/

          echo "üìã Package.json contents:"
          cat deploy-package/package.json | head -20

          echo "‚úÖ Source package ready for Oryx build"

      - name: Deploy to Azure App Service (Oryx Build)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package
          clean: true
          restart: true

      - name: Post-Deploy Wait (Oryx Build Time)
        run: |
          echo "‚è≥ Waiting for Oryx build and deployment..."
          echo "üîß Azure is building and installing dependencies..."
          echo "ÔøΩ This includes: npm install, build processes, and app startup"
          echo "‚è∞ Allowing extra time for build completion..."
          sleep 120

      - name: Comprehensive Health Check
        env:
          MAX_RETRIES: 6
          RETRY_INTERVAL: 20
        run: |
          echo "üè• Starting comprehensive health check..."

          perform_health_check() {
            local url="$1"
            local name="$2"
            local timeout="${3:-10}"

            echo "üîç Testing: $name ($url)"

            # Use verbose curl for better debugging
            response=$(curl -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" \
              --max-time "$timeout" \
              --silent \
              --show-error \
              "$url" 2>/dev/null || echo "HTTPSTATUS:000;TIME:timeout")

            http_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
            time_total=$(echo "$response" | grep -o "TIME:[0-9.]*" | cut -d: -f2)
            body=$(echo "$response" | sed 's/HTTPSTATUS:[0-9]*;TIME:[0-9.]*$//')

            if [[ "$http_code" =~ ^2[0-9][0-9]$ ]]; then
              echo "  ‚úÖ $name - HTTP $http_code (${time_total}s)"
              return 0
            else
              echo "  ‚ùå $name - HTTP $http_code (${time_total}s)"
              if [ ${#body} -gt 0 ] && [ ${#body} -lt 100 ]; then
                echo "     Response: $body"
              fi
              return 1
            fi
          }

          # Define endpoints to check
          declare -a ENDPOINTS=(
            "${{ env.APP_URL }}/health|Health Check|15"
            "${{ env.APP_URL }}/ping|Ping Endpoint|10"
            "${{ env.APP_URL }}/|Main Application|20"
          )

          overall_success=true

          for endpoint_def in "${ENDPOINTS[@]}"; do
            IFS='|' read -r url name timeout <<< "$endpoint_def"

            echo ""
            echo "üéØ Testing endpoint: $name"

            success=false
            for attempt in $(seq 1 ${{ env.MAX_RETRIES }}); do
              echo "   Attempt $attempt/${{ env.MAX_RETRIES }}..."

              if perform_health_check "$url" "$name" "$timeout"; then
                success=true
                break
              fi

              if [ $attempt -lt ${{ env.MAX_RETRIES }} ]; then
                echo "   ‚è∞ Waiting ${{ env.RETRY_INTERVAL }}s before retry..."
                sleep ${{ env.RETRY_INTERVAL }}
              fi
            done

            if [ "$success" = "false" ]; then
              overall_success=false
              echo "   üí• Final result: FAILED after ${{ env.MAX_RETRIES }} attempts"
            else
              echo "   üéâ Final result: SUCCESS"
            fi
          done

          echo ""
          echo "===================="
          if [ "$overall_success" = "true" ]; then
            echo "üéä DEPLOYMENT FULLY SUCCESSFUL!"
            echo "üåê Application is healthy and responsive"
            echo "üîó Access your app: ${{ env.APP_URL }}"
          else
            echo "‚ö†Ô∏è  DEPLOYMENT COMPLETED WITH HEALTH CHECK WARNINGS"
            echo "üîß Manual verification recommended"
            echo "üîó Check app manually: ${{ env.APP_URL }}"
            echo "üìä Debug info: ${{ env.APP_URL }}.scm.azurewebsites.net"
            # Don't fail - allow manual verification
          fi
          echo "===================="

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìã FINAL DEPLOYMENT SUMMARY"
          echo "=========================="
          echo "üïê Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üîó Application: ${{ env.APP_URL }}"
          echo "‚öôÔ∏è Runtime: Node.js 20 + Express + React"
          echo "üì¶ Deploy Method: Source Code + Oryx Build System"
          echo "üèóÔ∏è Build: Azure Oryx (npm install + build automation)"
          echo "üéØ Job Status: ${{ job.status }}"
          echo ""

          case "${{ job.status }}" in
            "success")
              echo "‚úÖ Status: DEPLOYMENT SUCCESSFUL"
              echo "üöÄ Your application is ready!"
              echo "üß™ Test login functionality at: ${{ env.APP_URL }}"
              ;;
            "failure")
              echo "‚ùå Status: DEPLOYMENT FAILED"
              echo "üîß Troubleshooting steps:"
              echo "   1. Check Azure App Service logs"
              echo "   2. Verify secrets configuration"
              echo "   3. Check Kudu console: ${{ env.APP_URL }}.scm.azurewebsites.net"
              ;;
            *)
              echo "‚ö†Ô∏è Status: DEPLOYMENT COMPLETED WITH WARNINGS"
              echo "üëÄ Manual verification recommended"
              ;;
          esac
          echo "=========================="
