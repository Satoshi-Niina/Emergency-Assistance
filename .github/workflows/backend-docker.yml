name: Deploy Backend with Docker (Stable)

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/backend-docker.yml'
      - 'migrations/**'
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: 'rg-Emergencyassistant-app'
  AZURE_WEBAPP_NAME: 'Emergencyassistance-sv'
  REGISTRY_NAME: 'emergencyassistance'
  IMAGE_NAME: 'backend'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Azure Container Registry
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Create Azure Container Registry
      run: |
        # Create ACR if it doesn't exist
        az acr create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.REGISTRY_NAME }} \
          --sku Basic \
          --admin-enabled true \
          || echo "ACR already exists"
          
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.REGISTRY_NAME }}
        
    - name: Build and push Docker image
      run: |
        # Build Docker image from server directory
        docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest ./server
        
        # Push to ACR
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        
    - name: Deploy to Azure App Service
      run: |
        # Get ACR credentials
        ACR_USERNAME=$(az acr credential show --name ${{ env.REGISTRY_NAME }} --query username --output tsv)
        ACR_PASSWORD=$(az acr credential show --name ${{ env.REGISTRY_NAME }} --query passwords[0].value --output tsv)
        
        # Configure App Service to use Docker
        az webapp config container set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --docker-custom-image-name ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          --docker-registry-server-url https://${{ env.REGISTRY_NAME }}.azurecr.io \
          --docker-registry-server-user $ACR_USERNAME \
          --docker-registry-server-password $ACR_PASSWORD
        
        # Restart App Service
        az webapp restart \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }}
        
    - name: Health check after deployment
      run: |
        echo "‚è≥ Waiting for Docker deployment to complete..."
        sleep 120
        
        echo "üîç Performing health checks..."
        
        # Health check with retry logic
        for i in {1..8}; do
          echo "Health check attempt $i/8..."
          if curl -f --max-time 30 https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net/api/health; then
            echo "‚úÖ Health check successful on attempt $i"
            break
          else
            echo "‚ùå Attempt $i failed, waiting 30 seconds..."
            sleep 30
            if [ $i -eq 8 ]; then
              echo "‚ùå All health check attempts failed"
              echo "üîç Checking App Service logs..."
              az webapp log tail --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEBAPP_NAME }} --output table
              exit 1
            fi
          fi
        done
        
        echo "‚úÖ Docker deployment successful!"
        
    - name: Test login endpoint
      run: |
        echo "üîê Testing login endpoint..."
        
        # Test login with admin user
        LOGIN_RESPONSE=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d '{"username":"admin","password":"admin123"}' \
          https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net/api/auth/login)
        
        echo "Login response: $LOGIN_RESPONSE"
        
        if echo "$LOGIN_RESPONSE" | grep -q "success.*true"; then
          echo "‚úÖ Login test successful"
        else
          echo "‚ùå Login test failed"
          echo "Response: $LOGIN_RESPONSE"
        fi
        
    - name: Deployment summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ DOCKER DEPLOYMENT SUCCESSFUL!"
          echo "üöÄ Backend API: https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net"
          echo "üîç Health check: https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net/api/health"
          echo "üîê Login test: Use admin/admin123"
          echo "üê≥ Docker image: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"
        else
          echo "‚ùå DOCKER DEPLOYMENT FAILED"
          echo "üîç Check the logs above for detailed error information"
        fi