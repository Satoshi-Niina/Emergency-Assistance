name: Deploy Backend to Azure App Service (Auto)

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/backend-docker.yml'
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: 'rg-Emergencyassistant-app'
  AZURE_WEBAPP_NAME: 'Emergencyassistance-sv'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
     - name: Setup Node.js
       uses: actions/setup-node@v4
       with:
         node-version: '20'
         cache: 'npm'
         cache-dependency-path: 'server/package.json'
        
     - name: Install dependencies
       run: |
         cd server
         npm install --only=production
        
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: './server'
        startup-command: 'node azure-server.js'
        
    - name: Configure App Service Settings
      run: |
        echo "üîß Configuring App Service settings..."
        
        # Set startup command
        az webapp config set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --startup-file "node azure-server.js"
        
        # Set Node.js version
        az webapp config set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --node-version "20-lts"
        
        # Restart App Service
        az webapp restart \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }}
        
        echo "‚úÖ App Service configuration completed"
        
    - name: Health check with retry
      run: |
        echo "‚è≥ Waiting for deployment to complete..."
        sleep 90
        
        echo "üîç Performing health checks..."
        
        # Health check with retry logic
        for i in {1..6}; do
          echo "Health check attempt $i/6..."
          if curl -f --max-time 30 https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net/api/health; then
            echo "‚úÖ Health check successful on attempt $i"
            break
          else
            echo "‚ùå Attempt $i failed, waiting 30 seconds..."
            sleep 30
            if [ $i -eq 6 ]; then
              echo "‚ùå All health check attempts failed"
              echo "üîç Checking App Service logs..."
              az webapp log tail --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEBAPP_NAME }} --output table
              exit 1
            fi
          fi
        done
        
        echo "‚úÖ Deployment successful!"
        
    - name: Test login endpoint
      run: |
        echo "üîê Testing login endpoint..."
        
        # Test login with admin user
        LOGIN_RESPONSE=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d '{"username":"admin","password":"admin123"}' \
          https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net/api/auth/login)
        
        echo "Login response: $LOGIN_RESPONSE"
        
        if echo "$LOGIN_RESPONSE" | grep -q "success.*true"; then
          echo "‚úÖ Login test successful"
        else
          echo "‚ùå Login test failed"
          echo "Response: $LOGIN_RESPONSE"
        fi
        
    - name: Deployment summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ DEPLOYMENT SUCCESSFUL!"
          echo "üöÄ Backend API: https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net"
          echo "üîç Health check: https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net/api/health"
          echo "üîê Login test: Use admin/admin123"
        else
          echo "‚ùå DEPLOYMENT FAILED"
          echo "üîç Check the logs above for detailed error information"
        fi