name: Deploy Server (Azure App Service)

on:
  push:
    branches: [main, develop]
    paths:
      - 'server/**'
      - 'package.json'
      - '.github/workflows/server-azure.yml'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'server-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  deploy-production:
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production
    env:
      APP_URL: 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net'
      AZURE_APP_NAME: 'Emergency-Assistance'
      ENVIRONMENT: 'production'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "üîç Validating deployment secrets for production..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "‚ùå AZURE_WEBAPP_PUBLISH_PROFILE secret is missing"
            exit 1
          fi
          echo "‚úÖ Required secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install Server Dependencies
        working-directory: ./server
        run: |
          echo "üì¶ Installing server dependencies with optimizations..."
          npm ci --prefer-offline --no-audit --no-fund --progress=false
          echo "‚úÖ Server dependencies installed"

      - name: Install Client Dependencies
        working-directory: ./client
        run: |
          echo "üèóÔ∏è Installing client dependencies with optimizations..."
          npm ci --prefer-offline --no-audit --no-fund --progress=false
          echo "‚úÖ Client dependencies installed"

      - name: Build Client Application
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '/api' }}
          VITE_BACKEND_SERVICE_URL: ${{ env.APP_URL }}
          VITE_ENVIRONMENT: 'production'
        run: |
          echo "üî® Building client for production environment..."
          echo "   Backend URL: ${{ env.APP_URL }}"

          npm run build

          # „Éì„É´„ÉâÁµêÊûúÊ§úË®º
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          echo "üìä Build Statistics:"
          echo "   Files: $(find dist -type f | wc -l)"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "‚úÖ Client build completed successfully"

      - name: Run Server Tests (if available)
        working-directory: ./server
        run: |
          echo "üß™ Running server tests..."
          if npm run test 2>/dev/null; then
            echo "‚úÖ Server tests passed"
          else
            echo "‚ÑπÔ∏è No tests configured or tests failed (continuing deployment)"
          fi

      - name: Create Optimized Deployment Package
        shell: bash
        run: |
          echo "üì¶ Creating optimized deployment package for production..."

          # „ÇØ„É™„Éº„É≥„Å™‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™
          rm -rf deploy-package
          mkdir -p deploy-package

          echo "üìÅ Copying essential server files..."
          # ÂøÖË¶ÅÊúÄÂ∞èÈôê„ÅÆ„Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº
          cp server/package.json deploy-package/
          cp server/app.js deploy-package/ 2>/dev/null || echo "app.js not found"
          cp server/azure-server.mjs deploy-package/ 2>/dev/null || echo "azure-server.mjs not found"
          cp server/unified-hot-reload-server.js deploy-package/ 2>/dev/null || echo "unified-hot-reload-server.js not found"
          cp server/web.config deploy-package/ 2>/dev/null || echo "web.config not found"
          
          # ÈáçË¶Å„Å™„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Ç≥„Éî„ÉºÔºàÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
          [ -d "server/routes" ] && cp -r server/routes deploy-package/ || echo "routes directory not found"
          [ -d "server/middleware" ] && cp -r server/middleware deploy-package/ || echo "middleware directory not found"
          [ -d "server/models" ] && cp -r server/models deploy-package/ || echo "models directory not found"
          [ -d "server/utils" ] && cp -r server/utils deploy-package/ || echo "utils directory not found"
          
          # .js, .mjs, .json „Éï„Ç°„Ç§„É´„ÅÆ„Åø„Çí„Ç≥„Éî„Éº
          find server/ -maxdepth 1 -name "*.js" -o -name "*.mjs" -o -name "*.json" | while read file; do
            cp "$file" deploy-package/ 2>/dev/null || true
          done

          echo "üìÅ Copying optimized client build..."
          mkdir -p deploy-package/client/dist
          
          # „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É´„Éâ„ÅÆÈáçË¶Å„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Ç≥„Éî„Éº
          cp client/dist/index.html deploy-package/client/dist/ 2>/dev/null || echo "client index.html not found"
          
          # „Ç¢„Çª„ÉÉ„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„Ç≥„Éî„Éº
          [ -d "client/dist/assets" ] && cp -r client/dist/assets deploy-package/client/dist/ || echo "client assets not found"
          
          # „Åù„ÅÆ‰ªñ„ÅÆÈáçË¶Å„Éï„Ç°„Ç§„É´
          [ -f "client/dist/favicon.ico" ] && cp client/dist/favicon.ico deploy-package/client/dist/ || true
          [ -f "client/dist/manifest.json" ] && cp client/dist/manifest.json deploy-package/client/dist/ || true

          echo "‚ö° Optimizing package.json for production..."

          cd deploy-package

          # ÊúÄÂ∞èÈôê„ÅÆpackage.json„Çí‰ΩúÊàê
          echo '{
            "name": "emergency-assistance-server",
            "version": "1.0.3",
            "main": "app.js",
            "engines": {
              "node": ">=20.0.0",
              "npm": ">=10.0.0"
            },
            "scripts": {
              "start": "node app.js"
            },
            "dependencies": {
              "express": "^4.21.2",
              "cors": "^2.8.5",
              "helmet": "^8.1.0",
              "compression": "^1.7.4",
              "dotenv": "^16.6.1",
              "cookie-parser": "^1.4.7",
              "express-session": "^1.18.2",
              "express-rate-limit": "^8.1.0",
              "morgan": "^1.10.1"
            }
          }' > package.json

          # „Éë„ÉÉ„Ç±„Éº„Ç∏„Çµ„Ç§„Ç∫Á¢∫Ë™ç
          package_size=$(du -sh . | cut -f1)
          file_count=$(find . -type f | wc -l)
          echo "üìä Optimized Package Statistics:"
          echo "   Size: $package_size"
          echo "   Files: $file_count"
          echo "   Main files:"
          ls -la *.js *.mjs *.json 2>/dev/null || echo "   No main files found"
          
          if [ -d "client/dist" ]; then
            echo "   Client files:"
            ls -la client/dist/ | head -5
          fi

          echo "‚úÖ Ultra-optimized package ready for production"

      - name: Deploy to Azure App Service (Production)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package
          clean: true
          restart: true
        env:
          # Azure Oryx „Éì„É´„ÉâÊúÄÈÅ©Âåñ
          SCM_DO_BUILD_DURING_DEPLOYMENT: 'true'
          ENABLE_ORYX_BUILD: 'true'
          ORYX_APPTYPE: 'node'
          # npm „Ç§„É≥„Çπ„Éà„Éº„É´ÊúÄÈÅ©Âåñ
          NPM_CONFIG_PRODUCTION: 'false'
          NPM_CONFIG_CACHE: '.npm'
          NPM_CONFIG_PREFER_OFFLINE: 'true'
          NPM_CONFIG_PROGRESS: 'false'
          NPM_CONFIG_AUDIT: 'false'
          NPM_CONFIG_FUND: 'false'
          # Azure App Service ÊúÄÈÅ©Âåñ
          WEBSITE_NODE_DEFAULT_VERSION: '20-lts'
          WEBSITE_SCM_COMMAND_IDLE_TIMEOUT: '3600'

      - name: Post-Deploy Wait
        run: |
          echo "‚è≥ Waiting for production deployment to stabilize..."
          echo "üîß Azure is completing build and app startup..."
          sleep 90

      - name: Production Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 30
        run: |
          echo "üè• Running health check for production environment..."

          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
          health_check() {
            local url="$1"
            local name="$2"
            response=$(curl -s --max-time 15 -o /dev/null -w "%{http_code}" "$url")
            if [[ "$response" =~ ^2[0-9][0-9]$ ]]; then
              echo "‚úÖ $name - HTTP $response"
              return 0
            else
              echo "‚ö†Ô∏è $name - HTTP $response"
              return 1
            fi
          }

          # „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅÆ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          success=false
          for attempt in $(seq 1 ${{ env.MAX_RETRIES }}); do
            echo "üîç Attempt $attempt/${{ env.MAX_RETRIES }}..."

            if health_check "${{ env.APP_URL }}/health" "Health Endpoint" || health_check "${{ env.APP_URL }}/" "Main Application"; then
              success=true
              echo "üéä Health check passed!"
              break
            fi

            if [ $attempt -lt ${{ env.MAX_RETRIES }} ]; then
              echo "‚è∞ Waiting ${{ env.RETRY_INTERVAL }}s..."
              sleep ${{ env.RETRY_INTERVAL }}
            fi
          done

          if [ "$success" = "false" ]; then
            echo "‚ö†Ô∏è Health check failed after all retries (continuing for manual verification)"
          fi

      - name: Production Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìã PRODUCTION SERVER DEPLOYMENT SUMMARY"
          echo "======================================="
          echo "üïê Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üåç Environment: Production"
          echo "üîó Application: ${{ env.APP_URL }}"
          echo "üì± Azure App: ${{ env.AZURE_APP_NAME }}"
          echo "‚öôÔ∏è Runtime: Node.js ${{ env.NODE_VERSION }} + Express + React"
          echo "üì¶ Deploy Method: Source Code + Oryx Build System"
          echo "üéØ Status: ${{ job.status }}"
          echo ""

          echo "‚ö° Applied Optimizations:"
          echo "   ‚úÖ Extended timeout (45min)"
          echo "   ‚úÖ Parallel dependency installation"
          echo "   ‚úÖ Production package optimization"
          echo "   ‚úÖ Enhanced Azure build settings"
          echo "   ‚úÖ Production health checks"
          echo ""

          case "${{ job.status }}" in
            "success")
              echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL!"
              echo "üöÄ Your production server is ready!"
              echo "üß™ Test functionality at: ${{ env.APP_URL }}"
              ;;
            "failure")
              echo "‚ùå PRODUCTION DEPLOYMENT FAILED!"
              echo "üîß Troubleshooting steps:"
              echo "   1. Check Azure App Service logs"
              echo "   2. Verify secrets configuration"
              echo "   3. Check Kudu console: ${{ env.APP_URL }}.scm.azurewebsites.net"
              ;;
            *)
              echo "‚ö†Ô∏è PRODUCTION DEPLOYMENT COMPLETED WITH WARNINGS"
              echo "üëÄ Manual verification recommended"
              ;;
          esac
          echo "======================================="

  deploy-staging:
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      APP_URL: 'https://emergency-assistance-staging.azurewebsites.net'
      AZURE_APP_NAME: 'Emergency-Assistance-Staging'
      ENVIRONMENT: 'staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "üîç Validating deployment secrets for staging..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_STAGING }}" ]; then
            echo "‚ùå AZURE_WEBAPP_PUBLISH_PROFILE_STAGING secret is missing"
            exit 1
          fi
          echo "‚úÖ Required secrets validated"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install Dependencies (Staging)
        run: |
          echo "üì¶ Installing dependencies for staging..."

          # Server dependencies
          cd server
          npm ci --prefer-offline --no-audit --no-fund
          cd ..

          # Client dependencies
          cd client
          npm ci --prefer-offline --no-audit --no-fund
          cd ..

          echo "‚úÖ Dependencies installed"

      - name: Build Client (Staging)
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: '/api'
          VITE_BACKEND_SERVICE_URL: ${{ env.APP_URL }}
          VITE_ENVIRONMENT: 'staging'
        run: |
          echo "üî® Building client for staging environment..."
          npm run build

          # „Éì„É´„ÉâÊ§úË®º
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed"
            exit 1
          fi
          echo "‚úÖ Client build completed"

      - name: Create Staging Package
        run: |
          echo "üì¶ Creating staging deployment package..."
          rm -rf deploy-package
          mkdir -p deploy-package

          # Copy essential server files only
          cp server/package.json deploy-package/
          cp server/app.js deploy-package/ 2>/dev/null || echo "app.js not found"
          cp server/azure-server.mjs deploy-package/ 2>/dev/null || echo "azure-server.mjs not found"
          cp server/unified-hot-reload-server.js deploy-package/ 2>/dev/null || echo "unified-hot-reload-server.js not found"
          
          # Copy essential directories only if they exist
          [ -d "server/routes" ] && cp -r server/routes deploy-package/ || echo "routes not found"
          [ -d "server/middleware" ] && cp -r server/middleware deploy-package/ || echo "middleware not found"
          
          # Copy optimized client build
          mkdir -p deploy-package/client/dist
          [ -f "client/dist/index.html" ] && cp client/dist/index.html deploy-package/client/dist/
          [ -d "client/dist/assets" ] && cp -r client/dist/assets deploy-package/client/dist/

          # Minimal package.json for staging
          cd deploy-package
          echo '{
            "name": "emergency-assistance-server",
            "version": "1.0.3",
            "main": "app.js",
            "scripts": {
              "start": "node app.js"
            },
            "dependencies": {
              "express": "^4.21.2",
              "cors": "^2.8.5",
              "dotenv": "^16.6.1"
            }
          }' > package.json

          echo "‚úÖ Optimized staging package ready"

      - name: Deploy to Azure App Service (Staging)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_STAGING }}
          package: ./deploy-package
          clean: true
          restart: true

      - name: Staging Health Check
        env:
          MAX_RETRIES: 3
          RETRY_INTERVAL: 20
        run: |
          echo "üè• Running staging health check..."

          for attempt in $(seq 1 ${{ env.MAX_RETRIES }}); do
            echo "üîç Attempt $attempt/${{ env.MAX_RETRIES }}..."

            if curl -s --max-time 10 "${{ env.APP_URL }}/health" | grep -q "OK\|healthy\|success" || \
               curl -s --max-time 10 -o /dev/null -w "%{http_code}" "${{ env.APP_URL }}/" | grep -q "^2[0-9][0-9]$"; then
              echo "‚úÖ Staging health check passed!"
              break
            fi

            if [ $attempt -lt ${{ env.MAX_RETRIES }} ]; then
              echo "‚è∞ Waiting ${{ env.RETRY_INTERVAL }}s..."
              sleep ${{ env.RETRY_INTERVAL }}
            fi
          done

      - name: Integration Tests (Staging)
        run: |
          echo "üß™ Running integration tests on staging..."

          # Âü∫Êú¨„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÉÜ„Çπ„Éà
          test_endpoint() {
            local endpoint="$1"
            local expected_status="${2:-200}"

            response=$(curl -s -w "HTTPSTATUS:%{http_code}" "${{ env.APP_URL }}$endpoint")
            status=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)

            if [ "$status" = "$expected_status" ]; then
              echo "‚úÖ $endpoint - Status $status"
              return 0
            else
              echo "‚ùå $endpoint - Status $status (expected $expected_status)"
              return 1
            fi
          }

          # ‰∏ªË¶Å„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅÆ„ÉÜ„Çπ„Éà
          test_endpoint "/health"
          test_endpoint "/api/ping" || echo "‚ö†Ô∏è API ping endpoint may not be available"
          test_endpoint "/"

          echo "‚úÖ Integration tests completed"

      - name: Staging Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìã STAGING SERVER DEPLOYMENT SUMMARY"
          echo "===================================="
          echo "üïê Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üåç Environment: Staging"
          echo "üîó Application: ${{ env.APP_URL }}"
          echo "üì± Azure App: ${{ env.AZURE_APP_NAME }}"
          echo "üéØ Status: ${{ job.status }}"
          echo ""

          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ STAGING DEPLOYMENT SUCCESSFUL!"
            echo "üß™ Ready for testing at: ${{ env.APP_URL }}"
          else
            echo "‚ùå STAGING DEPLOYMENT FAILED!"
          fi
          echo "===================================="
