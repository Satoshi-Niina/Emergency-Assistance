name: Deploy Server (Azure App Service)

on:
  push:
    branches: [main, develop]
    paths:
      - 'server/**'
      - 'package.json'
      - '.github/workflows/server-azure.yml'
      - 'docs/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'server-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  deploy-production:
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production
    env:
      APP_URL: 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net'
      AZURE_APP_NAME: 'Emergency-Assistance'
      ENVIRONMENT: 'production'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "üîç Validating deployment secrets for production..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "‚ùå AZURE_WEBAPP_PUBLISH_PROFILE secret is missing"
            exit 1
          fi
          echo "‚úÖ Required secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install Server Dependencies
        working-directory: ./server
        run: |
          echo "üì¶ Installing server dependencies with optimizations..."
          npm ci --prefer-offline --no-audit --no-fund --progress=false
          echo "‚úÖ Server dependencies installed"

      - name: Install Client Dependencies
        working-directory: ./client
        run: |
          echo "üèóÔ∏è Installing client dependencies with optimizations..."
          npm ci --prefer-offline --no-audit --no-fund --progress=false
          echo "‚úÖ Client dependencies installed"

      - name: Build Client Application
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_BACKEND_SERVICE_URL: ${{ env.APP_URL }}
          VITE_ENVIRONMENT: 'production'
        run: |
          echo "üî® Building client for production environment..."
          echo "   Backend URL: ${{ env.APP_URL }}"

          # Set VITE_API_BASE_URL with fallback
          if [ -n "${{ secrets.VITE_API_BASE_URL }}" ]; then
            export VITE_API_BASE_URL="${{ secrets.VITE_API_BASE_URL }}"
          else
            export VITE_API_BASE_URL="/api"
          fi
          echo "   API Base URL: $VITE_API_BASE_URL"

          npm run build

          # „Éì„É´„ÉâÁµêÊûúÊ§úË®º
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          echo "üìä Build Statistics:"
          echo "   Files: $(find dist -type f | wc -l)"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "‚úÖ Client build completed successfully"

      - name: Run Server Tests (if available)
        working-directory: ./server
        run: |
          echo "üß™ Running server tests..."
          if npm run test 2>/dev/null; then
            echo "‚úÖ Server tests passed"
          else
            echo "‚ÑπÔ∏è No tests configured or tests failed (continuing deployment)"
          fi

      - name: Create Optimized Deployment Package
        shell: bash
        run: |
          echo "üì¶ Creating optimized deployment package for production..."

          # „ÇØ„É™„Éº„É≥„Å™‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™
          rm -rf deploy-package
          mkdir -p deploy-package

          echo "üìÅ Copying essential server files only..."

          # ÂøÖÈ†à„Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº
          cp server/package.json deploy-package/
          cp server/package-lock.json deploy-package/ 2>/dev/null || echo "‚ö†Ô∏è package-lock.json not found"
          cp server/web.config deploy-package/ 2>/dev/null || echo "‚ö†Ô∏è web.config not found"

          # „É°„Ç§„É≥„Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´
          [ -f "server/app.js" ] && cp server/app.js deploy-package/
          [ -f "server/azure-server.mjs" ] && cp server/azure-server.mjs deploy-package/
          [ -f "server/index.js" ] && cp server/index.js deploy-package/
          [ -f "server/server.js" ] && cp server/server.js deploy-package/

          # ÂøÖÈ†à„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Ç≥„Éî„ÉºÔºànode_modules„ÄÅ„É≠„Ç∞„ÄÅ‰∏ÄÊôÇ„Éï„Ç°„Ç§„É´„ÇíÈô§Â§ñÔºâ
          echo "üìÅ Copying server directories (excluding dev files)..."
          for dir in routes middleware lib services utils config db types; do
            if [ -d "server/$dir" ]; then
              mkdir -p "deploy-package/$dir"
              # ÈñãÁô∫Áî®„Éï„Ç°„Ç§„É´„ÇíÈô§Â§ñ„Åó„Å¶„Ç≥„Éî„Éº
              find "server/$dir" -type f \( -name "*.js" -o -name "*.ts" -o -name "*.json" -o -name "*.sql" \) \
                ! -name "*.test.*" ! -name "*.spec.*" ! -name "*.dev.*" ! -name "*.backup" | while read file; do
                rel_path="${file#server/}"
                target_path="deploy-package/$rel_path"
                mkdir -p "$(dirname "$target_path")"
                cp "$file" "$target_path"
              done
              echo "   ‚úÖ Copied $dir/"
            fi
          done

          # compat„Éá„Ç£„É¨„ÇØ„Éà„É™
          [ -d "server/compat" ] && cp -r server/compat deploy-package/ 2>/dev/null || true

          # migrations„Éá„Ç£„É¨„ÇØ„Éà„É™ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
          [ -d "server/migrations" ] && cp -r server/migrations deploy-package/ 2>/dev/null || true

          # shared„É©„Ç§„Éñ„É©„É™ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
          if [ -d "shared" ]; then
            mkdir -p deploy-package/shared
            cp shared/package.json deploy-package/shared/ 2>/dev/null || true
            [ -d "shared/src" ] && cp -r shared/src deploy-package/shared/ 2>/dev/null || true
            [ -d "shared/dist" ] && cp -r shared/dist deploy-package/shared/ 2>/dev/null || true
          fi

          echo "üìÅ Copying client build..."
          # „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É´„Éâ„Çí„Ç≥„Éî„Éº
          if [ -d "client/dist" ]; then
            mkdir -p deploy-package/public
            cp -r client/dist/* deploy-package/public/
            echo "‚úÖ Client build copied to public directory"
          else
            echo "‚ö†Ô∏è Client dist directory not found, creating empty public directory"
            mkdir -p deploy-package/public
            echo "<h1>Server is running</h1>" > deploy-package/public/index.html
          fi

          # ‰∏çË¶Å„Å™„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§
          echo "üßπ Cleaning up unnecessary files..."
          find deploy-package -type f \( -name "*.log" -o -name "*.tmp" -o -name "*.bak" -o -name "*.backup" -o -name "*.test.*" -o -name "*.spec.*" \) -delete
          find deploy-package -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
          find deploy-package -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true
          find deploy-package -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true
          find deploy-package -type d -name "test" -exec rm -rf {} + 2>/dev/null || true

          cd deploy-package

          echo "üìä Optimized Package Statistics:"
          echo "   Files: $(find . -type f | wc -l)"
          echo "   Size: $(du -sh . | cut -f1)"
          echo "   Directories: $(find . -type d | wc -l)"
          echo "‚úÖ Optimized deployment package ready"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure App Service Environment Variables
        run: |
          echo "üîß Setting environment variables in Azure App Service..."

          # Áí∞Â¢ÉÂ§âÊï∞„ÇíË®≠ÂÆöÔºàÊó¢Â≠ò„ÅÆÂÄ§„Çí‰∏äÊõ∏„Åç„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÔºâ
          az webapp config appsettings set \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_APP_NAME }} \
            --settings \
              NODE_ENV=production \
              PORT=80 \
              API_BASE_URL=${{ env.APP_URL }}/api \
              API_PREFIX=/api \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
              BCRYPT_SALT_ROUNDS=12 \
              BYPASS_DB_FOR_LOGIN=false \
              OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              OPENAI_MODEL=gpt-4o \
              OPENAI_EMERGENCY_MODEL=gpt-4o \
              OPENAI_KNOWLEDGE_MODEL=gpt-3.5-turbo \
              OPENAI_MAX_TOKENS=2000 \
              OPENAI_TEMPERATURE=0.7 \
              CORS_ALLOW_ORIGINS="https://witty-river-012f39e00.1.azurestaticapps.net,${{ env.APP_URL }}" \
              STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net \
              FRONTEND_URL=https://witty-river-012f39e00.1.azurestaticapps.net \
              LOCAL_DEV=false \
              KNOWLEDGE_BASE_PATH=/home/site/wwwroot/knowledge-base \
              IMAGES_BASE_PATH=/home/site/wwwroot/knowledge-base/images \
              KNOWLEDGE_BASE_ENABLED=true \
              FAULT_HISTORY_STORAGE_MODE=database \
              CHAT_EXPORTS_PATH=/tmp/chat-exports \
              CHAT_IMAGES_PATH=/tmp/chat-images \
              FAULT_HISTORY_IMAGES_DIR=/tmp/fault-history-images \
              SESSION_DRIVER=database \
              SESSION_LIFETIME=60 \
              DEBUG_MODE=false \
              HOT_RELOAD=false \
              VERBOSE_LOGGING=false \
            --output none

          echo "‚úÖ Environment variables configured successfully"

      - name: Deploy to Azure App Service (Production)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package
          clean: true
          restart: true
        env:
          # Azure Oryx „Éì„É´„ÉâÊúÄÈÅ©Âåñ
          SCM_DO_BUILD_DURING_DEPLOYMENT: 'true'
          ENABLE_ORYX_BUILD: 'true'
          ORYX_APPTYPE: 'node'
          # npm „Ç§„É≥„Çπ„Éà„Éº„É´ÊúÄÈÅ©Âåñ
          NPM_CONFIG_PRODUCTION: 'false'
          NPM_CONFIG_CACHE: '.npm'
          NPM_CONFIG_PREFER_OFFLINE: 'true'
          NPM_CONFIG_PROGRESS: 'false'
          NPM_CONFIG_AUDIT: 'false'
          NPM_CONFIG_FUND: 'false'
          # Azure App Service ÊúÄÈÅ©Âåñ
          WEBSITE_NODE_DEFAULT_VERSION: '20-lts'
          WEBSITE_SCM_COMMAND_IDLE_TIMEOUT: '3600'

      - name: Post-Deploy Wait
        run: |
          echo "‚è≥ Waiting for production deployment to stabilize..."
          echo "üîß Azure is completing build and app startup..."
          sleep 90

      - name: Production Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 30
        run: |
          echo "üè• Running health check for production environment..."

          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
          health_check() {
            local url="$1"
            local name="$2"
            response=$(curl -s --max-time 15 -o /dev/null -w "%{http_code}" "$url")
            if [[ "$response" =~ ^2[0-9][0-9]$ ]]; then
              echo "‚úÖ $name - HTTP $response"
              return 0
            else
              echo "‚ö†Ô∏è $name - HTTP $response"
              return 1
            fi
          }

          # „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅÆ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          success=false
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "üîç Attempt $attempt/$MAX_RETRIES..."

            if health_check "${{ env.APP_URL }}/health" "Health Endpoint" || health_check "${{ env.APP_URL }}/" "Main Application"; then
              success=true
              echo "üéä Health check passed!"
              break
            fi

            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "‚è∞ Waiting ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

          if [ "$success" = "false" ]; then
            echo "‚ö†Ô∏è Health check failed after all retries (continuing for manual verification)"
          fi

      - name: Production Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìã PRODUCTION SERVER DEPLOYMENT SUMMARY"
          echo "======================================="
          echo "üïê Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üåç Environment: Production"
          echo "üîó Application: ${{ env.APP_URL }}"
          echo "üì± Azure App: ${{ env.AZURE_APP_NAME }}"
          echo "‚öôÔ∏è Runtime: Node.js ${{ env.NODE_VERSION }} + Express + React"
          echo "üì¶ Deploy Method: Source Code + Oryx Build System"
          echo "üéØ Status: ${{ job.status }}"
          echo ""

          echo "‚ö° Applied Optimizations:"
          echo "   ‚úÖ Extended timeout (45min)"
          echo "   ‚úÖ Parallel dependency installation"
          echo "   ‚úÖ Production package optimization"
          echo "   ‚úÖ Enhanced Azure build settings"
          echo "   ‚úÖ Production health checks"
          echo ""

          case "${{ job.status }}" in
            "success")
              echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL!"
              echo "üöÄ Your production server is ready!"
              echo "üß™ Test functionality at: ${{ env.APP_URL }}"
              ;;
            "failure")
              echo "‚ùå PRODUCTION DEPLOYMENT FAILED!"
              echo "üîß Troubleshooting steps:"
              echo "   1. Check Azure App Service logs"
              echo "   2. Verify secrets configuration"
              echo "   3. Check Kudu console: ${{ env.APP_URL }}.scm.azurewebsites.net"
              ;;
            *)
              echo "‚ö†Ô∏è PRODUCTION DEPLOYMENT COMPLETED WITH WARNINGS"
              echo "üëÄ Manual verification recommended"
              ;;
          esac
          echo "======================================="

  deploy-staging:
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      APP_URL: 'https://emergency-assistance-staging.azurewebsites.net'
      AZURE_APP_NAME: 'Emergency-Assistance-Staging'
      ENVIRONMENT: 'staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "üîç Validating deployment secrets for staging..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_STAGING }}" ]; then
            echo "‚ùå AZURE_WEBAPP_PUBLISH_PROFILE_STAGING secret is missing"
            exit 1
          fi
          echo "‚úÖ Required secrets validated"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install Dependencies (Staging)
        run: |
          echo "üì¶ Installing dependencies for staging..."

          # Server dependencies
          cd server
          npm ci --prefer-offline --no-audit --no-fund
          cd ..

          # Client dependencies
          cd client
          npm ci --prefer-offline --no-audit --no-fund
          cd ..

          echo "‚úÖ Dependencies installed"

      - name: Build Client (Staging)
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: '/api'
          VITE_BACKEND_SERVICE_URL: ${{ env.APP_URL }}
          VITE_ENVIRONMENT: 'staging'
        run: |
          echo "üî® Building client for staging environment..."
          npm run build

          # „Éì„É´„ÉâÊ§úË®º
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed"
            exit 1
          fi
          echo "‚úÖ Client build completed"

      - name: Create Optimized Staging Package
        run: |
          echo "üì¶ Creating optimized staging deployment package..."
          rm -rf deploy-package
          mkdir -p deploy-package

          echo "üìÅ Copying essential server files only..."

          # ÂøÖÈ†à„Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº
          cp server/package.json deploy-package/
          cp server/package-lock.json deploy-package/ 2>/dev/null || echo "‚ö†Ô∏è package-lock.json not found"
          cp server/web.config deploy-package/ 2>/dev/null || echo "‚ö†Ô∏è web.config not found"

          # „É°„Ç§„É≥„Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´
          [ -f "server/app.js" ] && cp server/app.js deploy-package/
          [ -f "server/azure-server.mjs" ] && cp server/azure-server.mjs deploy-package/
          [ -f "server/index.js" ] && cp server/index.js deploy-package/
          [ -f "server/server.js" ] && cp server/server.js deploy-package/

          # ÂøÖÈ†à„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Ç≥„Éî„ÉºÔºàÈñãÁô∫Áî®„Éï„Ç°„Ç§„É´„ÇíÈô§Â§ñÔºâ
          echo "üìÅ Copying server directories (excluding dev files)..."
          for dir in routes middleware lib services utils config db types; do
            if [ -d "server/$dir" ]; then
              mkdir -p "deploy-package/$dir"
              find "server/$dir" -type f \( -name "*.js" -o -name "*.ts" -o -name "*.json" -o -name "*.sql" \) \
                ! -name "*.test.*" ! -name "*.spec.*" ! -name "*.dev.*" ! -name "*.backup" | while read file; do
                rel_path="${file#server/}"
                target_path="deploy-package/$rel_path"
                mkdir -p "$(dirname "$target_path")"
                cp "$file" "$target_path"
              done
              echo "   ‚úÖ Copied $dir/"
            fi
          done

          # compat„Éá„Ç£„É¨„ÇØ„Éà„É™
          [ -d "server/compat" ] && cp -r server/compat deploy-package/ 2>/dev/null || true

          # shared„É©„Ç§„Éñ„É©„É™
          if [ -d "shared" ]; then
            mkdir -p deploy-package/shared
            cp shared/package.json deploy-package/shared/ 2>/dev/null || true
            [ -d "shared/src" ] && cp -r shared/src deploy-package/shared/ 2>/dev/null || true
            [ -d "shared/dist" ] && cp -r shared/dist deploy-package/shared/ 2>/dev/null || true
          fi

          # Copy optimized client build
          echo "üìÅ Copying client build..."
          if [ -d "client/dist" ]; then
            mkdir -p deploy-package/public
            cp -r client/dist/* deploy-package/public/
            echo "‚úÖ Client build copied"
          else
            mkdir -p deploy-package/public
            echo "<h1>Server is running</h1>" > deploy-package/public/index.html
          fi

          # ‰∏çË¶Å„Å™„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§
          echo "üßπ Cleaning up unnecessary files..."
          find deploy-package -type f \( -name "*.log" -o -name "*.tmp" -o -name "*.bak" -o -name "*.backup" -o -name "*.test.*" -o -name "*.spec.*" \) -delete
          find deploy-package -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
          find deploy-package -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true

          cd deploy-package

          echo "üìä Optimized Staging Package Statistics:"
          echo "   Files: $(find . -type f | wc -l)"
          echo "   Size: $(du -sh . | cut -f1)"
          echo "‚úÖ Optimized staging package ready"

      - name: Azure Login (Staging)
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure App Service Environment Variables (Staging)
        run: |
          echo "üîß Setting environment variables in Azure App Service (Staging)..."

          az webapp config appsettings set \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_APP_NAME }} \
            --settings \
              NODE_ENV=production \
              PORT=80 \
              API_BASE_URL=${{ env.APP_URL }}/api \
              API_PREFIX=/api \
              DATABASE_URL="${{ secrets.DATABASE_URL_STAGING || secrets.DATABASE_URL }}" \
              JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
              BCRYPT_SALT_ROUNDS=12 \
              BYPASS_DB_FOR_LOGIN=false \
              OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              OPENAI_MODEL=gpt-4o \
              OPENAI_EMERGENCY_MODEL=gpt-4o \
              OPENAI_KNOWLEDGE_MODEL=gpt-3.5-turbo \
              LOCAL_DEV=false \
              KNOWLEDGE_BASE_ENABLED=true \
              FAULT_HISTORY_STORAGE_MODE=database \
              SESSION_DRIVER=database \
              DEBUG_MODE=false \
            --output none

          echo "‚úÖ Staging environment variables configured"

      - name: Deploy to Azure App Service (Staging)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_STAGING }}
          package: ./deploy-package
          clean: true
          restart: true

      - name: Staging Health Check
        env:
          MAX_RETRIES: 3
          RETRY_INTERVAL: 20
        run: |
          echo "üè• Running staging health check..."

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "üîç Attempt $attempt/$MAX_RETRIES..."

            if curl -s --max-time 10 "${{ env.APP_URL }}/health" | grep -q "OK\|healthy\|success" || \
               curl -s --max-time 10 -o /dev/null -w "%{http_code}" "${{ env.APP_URL }}/" | grep -q "^2[0-9][0-9]$"; then
              echo "‚úÖ Staging health check passed!"
              break
            fi

            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "‚è∞ Waiting ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            fi
          done

      - name: Integration Tests (Staging)
        run: |
          echo "üß™ Running integration tests on staging..."

          # Âü∫Êú¨„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÉÜ„Çπ„Éà
          test_endpoint() {
            local endpoint="$1"
            local expected_status="${2:-200}"

            response=$(curl -s -w "HTTPSTATUS:%{http_code}" "${{ env.APP_URL }}$endpoint")
            status=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)

            if [ "$status" = "$expected_status" ]; then
              echo "‚úÖ $endpoint - Status $status"
              return 0
            else
              echo "‚ùå $endpoint - Status $status (expected $expected_status)"
              return 1
            fi
          }

          # ‰∏ªË¶Å„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅÆ„ÉÜ„Çπ„Éà
          test_endpoint "/health"
          test_endpoint "/api/ping" || echo "‚ö†Ô∏è API ping endpoint may not be available"
          test_endpoint "/"

          echo "‚úÖ Integration tests completed"

      - name: Staging Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìã STAGING SERVER DEPLOYMENT SUMMARY"
          echo "===================================="
          echo "üïê Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üåç Environment: Staging"
          echo "üîó Application: ${{ env.APP_URL }}"
          echo "üì± Azure App: ${{ env.AZURE_APP_NAME }}"
          echo "üéØ Status: ${{ job.status }}"
          echo ""

          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ STAGING DEPLOYMENT SUCCESSFUL!"
            echo "üß™ Ready for testing at: ${{ env.APP_URL }}"
          else
            echo "‚ùå STAGING DEPLOYMENT FAILED!"
          fi
          echo "===================================="
