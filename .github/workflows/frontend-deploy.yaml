name: Deploy Frontend to Azure Static Web Apps
on:
  push:
    branches:
      - main
    paths:
      - 'client/**'
      - 'api/**'
      - 'server/**'
      - '.github/workflows/frontend-deploy.yaml'
      - 'trigger.txt'
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Create .env.production for Vite
        working-directory: client
        run: |
          cat > .env.production << 'EOF'
          VITE_API_BASE_URL=https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net
          FRONTEND_URL=https://witty-river-012f39e00.1.azurestaticapps.net
          EOF
      - name: Install frontend dependencies
        working-directory: client
        run: |
          echo "=== Installing frontend dependencies ==="
          npm install --no-audit --prefer-offline
      - name: Build frontend
        working-directory: client
        run: npm run build
        env:
          VITE_API_BASE: ${{ secrets.VITE_API_BASE }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          NODE_ENV: production

      - name: Backend Health Check
        run: |
          echo "ðŸ” Checking existing backend health..."
          backend_url="https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net/api/health"
          echo "Checking backend: ${backend_url}"
          for i in {1..3}; do
            backend_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${backend_url}")
            echo "Backend check $i: $backend_status"
            if [ "$backend_status" = "200" ]; then
              echo "âœ… Backend is healthy!"
              echo "Backend URL: ${backend_url}"
              break
            fi
            if [ $i -lt 3 ]; then
              echo "â³ Retrying in 10 seconds..."
              sleep 10
            fi
          done
          if [ "$backend_status" != "200" ]; then
            echo "âš ï¸ Backend health check failed, but continuing with frontend deployment"
          fi

      - name: Prepare frontend deployment
        run: |
          echo "=== Preparing frontend deployment ==="
          mkdir -p ./deploy-frontend
          cp -r ./client/dist/* ./deploy-frontend/
          
          # Include Azure Static Web Apps configuration
          if [ -f ./staticwebapp.config.json ]; then
            cp ./staticwebapp.config.json ./deploy-frontend/staticwebapp.config.json
          fi
          
          echo "=== Frontend deployment package ready ==="
          echo "Frontend package size:"
          du -sh ./deploy-frontend
          echo "Files in deployment package:"
          ls -la ./deploy-frontend/

      - name: Deploy Frontend to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "upload"
          app_location: "client"
          api_location: ""
          output_location: "dist"
          skip_app_build: false

      - name: Frontend Health Check
        run: |
          echo "ðŸ” Starting frontend health check..."
          
          # Wait for deployment
          echo "â³ Waiting for frontend deployment (30 seconds)..."
          sleep 30
          
          # Check frontend
          frontend_url="https://witty-river-012f39e00.1.azurestaticapps.net"
          echo "Checking frontend: ${frontend_url}"
          
          for i in {1..3}; do
            frontend_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${frontend_url}")
            echo "Frontend check $i: $frontend_status"
            
            if [ "$frontend_status" = "200" ]; then
              echo "âœ… Frontend deployment successful!"
              echo "Frontend URL: ${frontend_url}"
              break
            fi
            
            if [ $i -lt 3 ]; then
              echo "â³ Retrying in 15 seconds..."
              sleep 15
            fi
          done
          
          if [ "$frontend_status" != "200" ]; then
            echo "âŒ Frontend health check failed!"
            exit 1
          fi

      - name: Frontend Smoke Test
        run: |
          echo "ðŸ” Starting frontend smoke test..."
          
          frontend_url="https://witty-river-012f39e00.1.azurestaticapps.net"
          backend_url="https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net"
          
          # Test frontend-backend connectivity
          echo "Testing frontend-backend connectivity..."
          api_response=$(curl -s -w "%{http_code}" -o /dev/null "${backend_url}/api/health")
          echo "Backend API health check: $api_response"
          
          if [ "$api_response" = "200" ]; then
            echo "âœ… Frontend can reach backend API"
          else
            echo "âŒ Frontend cannot reach backend API"
            exit 1
          fi
          
          # Test authentication flow
          echo "Testing authentication flow..."
          auth_response=$(curl -s -w "%{http_code}" -o /dev/null "${backend_url}/api/auth/me")
          echo "Authentication endpoint check: $auth_response"
          
          if [ "$auth_response" = "401" ]; then
            echo "âœ… Authentication endpoint working correctly"
          else
            echo "âŒ Authentication endpoint not working correctly"
            exit 1
          fi
          
          echo "âœ… Frontend smoke test passed!"
