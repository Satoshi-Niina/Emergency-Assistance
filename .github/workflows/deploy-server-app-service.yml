name: deploy-server-app-service

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: 'azure-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  APP_URL: 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net'
  AZURE_APP_NAME: 'Emergency-Assistance'

# IMPORTANT: Ensure the following settings are configured in Azure App Service:
# - SCM_DO_BUILD_DURING_DEPLOYMENT: true (enables Oryx build)
# - WEBSITE_NODE_DEFAULT_VERSION: 20-lts
# - NPM_CONFIG_PRODUCTION: false (installs devDependencies for build)

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "ğŸ” Validating required secrets..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "âŒ AZURE_WEBAPP_PUBLISH_PROFILE secret is missing"
            echo "ğŸ“‹ Setup: GitHub > Settings > Secrets > Actions"
            exit 1
          fi
          echo "âœ… Required secrets validated"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install and Build Server
        working-directory: ./server
        run: |
          echo "ğŸ“¦ Installing server dependencies..."
          npm ci --production=false --no-audit --no-fund

          echo "ğŸ”¨ Running server build check..."
          npm run build || echo "No build script, continuing..."
          echo "âœ… Server preparation completed"

      - name: Install and Build Client
        working-directory: ./client
        run: |
          echo "ğŸ—ï¸ Installing client dependencies..."
          npm ci --no-audit --no-fund

          echo "ğŸ”¨ Building client..."
          npm run build

          # Verify critical build outputs
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          echo "ğŸ“Š Client build completed:"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "   Files: $(find dist -type f | wc -l) files"
          echo "âœ… Client built successfully"

      - name: Prepare Source Package for Oryx Build
        shell: bash
        run: |
          echo "ğŸ“¦ Creating source package for Azure Oryx build..."

          # Create clean deployment directory
          rm -rf deploy-package
          mkdir -p deploy-package

          echo "ğŸ“ Step 1: Copy server source files..."
          # Copy all server source files (Oryx will install dependencies)
          cp -r server/* deploy-package/

          # Remove node_modules if exists (Oryx will install fresh)
          rm -rf deploy-package/node_modules

          echo "ğŸ“ Step 2: Copy client build..."

          # Verify client build exists before copying
          if [ ! -d "client/dist" ]; then
            echo "âŒ Error: client/dist directory not found"
            echo "ğŸ“‹ Client directory contents:"
            ls -la client/ || echo "Client directory does not exist"
            exit 1
          fi

          echo "ğŸ“‹ Client/dist contents before copy:"
          ls -la client/dist/

          mkdir -p deploy-package/client/dist
          cp -r client/dist/* deploy-package/client/dist/

          echo "ğŸ“‹ Deploy package client/dist contents after copy:"
          ls -la deploy-package/client/dist/

          echo "ï¿½ Step 3: Source package validation..."

          # Critical source files validation
          CRITICAL_FILES=(
            "package.json:Server package configuration"
            "azure-server.js:Main application file"
            "client/dist/index.html:Frontend entry point"
          )

          validation_failed=false
          for file_info in "${CRITICAL_FILES[@]}"; do
            IFS=':' read -r file desc <<< "$file_info"
            full_path="deploy-package/$file"

            if [ -f "$full_path" ]; then
              echo "  âœ… $desc"
            else
              echo "  âŒ $desc - NOT FOUND: $full_path"
              validation_failed=true
            fi
          done

          if [ "$validation_failed" = "true" ]; then
            echo "âŒ Source package validation failed"
            echo "ğŸ“‹ Package contents:"
            find deploy-package -maxdepth 2 -type f | head -20
            exit 1
          fi

          # Package statistics
          package_size=$(du -sh deploy-package/ | cut -f1)
          file_count=$(find deploy-package -type f | wc -l)

          echo "ğŸ“Š Source Package Statistics:"
          echo "   ğŸ“¦ Total Size: $package_size"
          echo "   ğŸ“„ File Count: $file_count"
          echo "   ğŸ—‚ï¸ Root Structure:"
          ls -la deploy-package/

          echo "   ğŸ—‚ï¸ Client Structure:"
          find deploy-package/client -type f | head -10

          echo "   ğŸ“‹ Package.json (main fields):"
          cat deploy-package/package.json | grep -E '"(name|main|scripts|dependencies)"' -A 3

          echo "âœ… Source package ready for Oryx build"

      - name: Deploy to Azure App Service (Oryx Build)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package
          clean: true
          restart: true

      - name: Post-Deploy Wait (Oryx Build Time)
        run: |
          echo "â³ Waiting for Oryx build and deployment..."
          echo "ğŸ”§ Azure is building and installing dependencies..."
          echo "ğŸ’¡ This includes: npm install, build processes, and app startup"
          echo "â° Allowing extra time for build completion..."
          sleep 120

      - name: Check Azure Deployment Structure
        run: |
          echo "ğŸ” Checking deployed structure on Azure App Service..."

          app_name="${{ env.AZURE_APP_NAME }}"
          kudu_url="https://${app_name}.scm.azurewebsites.net"

          echo "ğŸŒ Kudu URL: $kudu_url"
          echo "ğŸ“‹ App Service Name: $app_name"
          echo ""

          echo "ï¿½ Expected structure after Oryx build:"
          echo "   /home/site/wwwroot/azure-server.js"
          echo "   /home/site/wwwroot/client/dist/index.html"
          echo "   /home/site/wwwroot/package.json"
          echo "   /home/site/wwwroot/node_modules/"
          echo ""

          echo "ğŸ’¡ Manual verification steps:"
          echo "   1. Visit: $kudu_url"
          echo "   2. Go to Debug Console > CMD or PowerShell"
          echo "   3. Run: cd D:\\home\\site\\wwwroot"
          echo "   4. Run: dir /s client"
          echo "   5. Check: type client\\dist\\index.html"
          echo ""

          echo "ï¿½ Enhanced server now includes path resolution:"
          echo "   - Tries multiple client/dist locations"
          echo "   - Shows detailed debug info on startup"
          echo "   - Exits gracefully if client files not found"      - name: Comprehensive Health Check
        env:
          MAX_RETRIES: 6
          RETRY_INTERVAL: 20
        run: |
          echo "ğŸ¥ Starting comprehensive health check..."

          perform_health_check() {
            local url="$1"
            local name="$2"
            local timeout="${3:-10}"

            echo "ğŸ” Testing: $name ($url)"

            # Use verbose curl for better debugging
            response=$(curl -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" \
              --max-time "$timeout" \
              --silent \
              --show-error \
              "$url" 2>/dev/null || echo "HTTPSTATUS:000;TIME:timeout")

            http_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
            time_total=$(echo "$response" | grep -o "TIME:[0-9.]*" | cut -d: -f2)
            body=$(echo "$response" | sed 's/HTTPSTATUS:[0-9]*;TIME:[0-9.]*$//')

            if [[ "$http_code" =~ ^2[0-9][0-9]$ ]]; then
              echo "  âœ… $name - HTTP $http_code (${time_total}s)"
              return 0
            else
              echo "  âŒ $name - HTTP $http_code (${time_total}s)"
              if [ ${#body} -gt 0 ] && [ ${#body} -lt 100 ]; then
                echo "     Response: $body"
              fi
              return 1
            fi
          }

          # Define endpoints to check
          declare -a ENDPOINTS=(
            "${{ env.APP_URL }}/health|Health Check|15"
            "${{ env.APP_URL }}/ping|Ping Endpoint|10"
            "${{ env.APP_URL }}/|Main Application|20"
          )

          overall_success=true

          for endpoint_def in "${ENDPOINTS[@]}"; do
            IFS='|' read -r url name timeout <<< "$endpoint_def"

            echo ""
            echo "ğŸ¯ Testing endpoint: $name"

            success=false
            for attempt in $(seq 1 ${{ env.MAX_RETRIES }}); do
              echo "   Attempt $attempt/${{ env.MAX_RETRIES }}..."

              if perform_health_check "$url" "$name" "$timeout"; then
                success=true
                break
              fi

              if [ $attempt -lt ${{ env.MAX_RETRIES }} ]; then
                echo "   â° Waiting ${{ env.RETRY_INTERVAL }}s before retry..."
                sleep ${{ env.RETRY_INTERVAL }}
              fi
            done

            if [ "$success" = "false" ]; then
              overall_success=false
              echo "   ğŸ’¥ Final result: FAILED after ${{ env.MAX_RETRIES }} attempts"
            else
              echo "   ğŸ‰ Final result: SUCCESS"
            fi
          done

          echo ""
          echo "===================="
          if [ "$overall_success" = "true" ]; then
            echo "ğŸŠ DEPLOYMENT FULLY SUCCESSFUL!"
            echo "ğŸŒ Application is healthy and responsive"
            echo "ğŸ”— Access your app: ${{ env.APP_URL }}"
          else
            echo "âš ï¸  DEPLOYMENT COMPLETED WITH HEALTH CHECK WARNINGS"
            echo "ğŸ”§ Manual verification recommended"
            echo "ğŸ”— Check app manually: ${{ env.APP_URL }}"
            echo "ğŸ“Š Debug info: ${{ env.APP_URL }}.scm.azurewebsites.net"
            # Don't fail - allow manual verification
          fi
          echo "===================="

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ FINAL DEPLOYMENT SUMMARY"
          echo "=========================="
          echo "ğŸ• Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Application: ${{ env.APP_URL }}"
          echo "âš™ï¸ Runtime: Node.js 20 + Express + React"
          echo "ğŸ“¦ Deploy Method: Source Code + Oryx Build System"
          echo "ğŸ—ï¸ Build: Azure Oryx (npm install + build automation)"
          echo "ğŸ¯ Job Status: ${{ job.status }}"
          echo ""

          case "${{ job.status }}" in
            "success")
              echo "âœ… Status: DEPLOYMENT SUCCESSFUL"
              echo "ğŸš€ Your application is ready!"
              echo "ğŸ§ª Test login functionality at: ${{ env.APP_URL }}"
              ;;
            "failure")
              echo "âŒ Status: DEPLOYMENT FAILED"
              echo "ğŸ”§ Troubleshooting steps:"
              echo "   1. Check Azure App Service logs"
              echo "   2. Verify secrets configuration"
              echo "   3. Check Kudu console: ${{ env.APP_URL }}.scm.azurewebsites.net"
              ;;
            *)
              echo "âš ï¸ Status: DEPLOYMENT COMPLETED WITH WARNINGS"
              echo "ğŸ‘€ Manual verification recommended"
              ;;
          esac
          echo "=========================="
