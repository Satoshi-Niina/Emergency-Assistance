name: Security Check - RSC & Next.js Vulnerabilities

# ã™ã¹ã¦ã®ãƒ—ãƒƒã‚·ãƒ¥ã¨ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œ
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - '**/package.json'
      - '**/package-lock.json'
      - 'scripts/check-rsc-vulnerabilities.mjs'
      - '.github/workflows/security-check.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/package.json'
      - '**/package-lock.json'
      - 'scripts/check-rsc-vulnerabilities.mjs'
  workflow_dispatch:
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯é€±æœˆæ›œæ—¥ 9:00 JST = 0:00 UTCï¼‰
  schedule:
    - cron: '0 0 * * 1'

# æ–°ã—ã„å®Ÿè¡ŒãŒé–‹å§‹ã•ã‚ŒãŸã‚‰å¤ã„å®Ÿè¡Œã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: security-check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vulnerability-check:
    name: Check RSC & Next.js Vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: |
          echo "ğŸ“¦ Installing root dependencies..."
          npm ci --ignore-scripts
        continue-on-error: true

      - name: Install client dependencies
        run: |
          if [ -f "client/package.json" ]; then
            echo "ğŸ“¦ Installing client dependencies..."
            cd client
            npm ci --ignore-scripts
            cd ..
          fi
        continue-on-error: true

      - name: Install server dependencies
        run: |
          if [ -f "server/package.json" ]; then
            echo "ğŸ“¦ Installing server dependencies..."
            cd server
            npm ci --ignore-scripts
            cd ..
          fi
        continue-on-error: true

      - name: Install shared dependencies
        run: |
          if [ -f "shared/package.json" ]; then
            echo "ğŸ“¦ Installing shared dependencies..."
            cd shared
            npm ci --ignore-scripts
            cd ..
          fi
        continue-on-error: true

      - name: Run RSC & Next.js vulnerability check
        id: vulnerability_check
        run: |
          echo "ğŸ” Running vulnerability check..."
          echo "Checking for CVE-2025-55182 (RSC) and CVE-2025-66478 (Next.js)"
          echo ""
          
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆè„†å¼±æ€§ãŒã‚ã‚Œã° exit 1 ã§çµ‚äº†ã™ã‚‹ï¼‰
          node scripts/check-rsc-vulnerabilities.mjs
        continue-on-error: false

      - name: Upload vulnerability report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-${{ github.sha }}
          path: |
            package.json
            client/package.json
            server/package.json
            shared/package.json
          retention-days: 30

      - name: Comment on PR (if vulnerable)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const message = `## âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š: è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
            
            **CVE-2025-55182** (React Server Components) ã¾ãŸã¯ **CVE-2025-66478** (Next.js) ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
            
            ### å¯¾å¿œãŒå¿…è¦ã§ã™
            
            1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            2. æ¤œå‡ºã•ã‚ŒãŸè„†å¼±ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¨å¥¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ãã ã•ã„
            3. \`npm install\` ã‚’å®Ÿè¡Œã—ã¦ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ã—ã¦ãã ã•ã„
            4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„
            
            ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
            \`\`\`bash
            # ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            npm run security:check-rsc
            
            # è„†å¼±ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
            npm install <package>@<recommended-version>
            
            # å†åº¦ãƒã‚§ãƒƒã‚¯
            npm run security:check-rsc
            \`\`\`
            
            è©³ç´°ã¯ [scripts/README-check-rsc-vulnerabilities.md](../scripts/README-check-rsc-vulnerabilities.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: message
            });

      - name: Security check summary
        if: always()
        run: |
          echo "ğŸ“Š Security Check Summary"
          echo "=========================="
          echo "Workflow: ${{ github.workflow }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo ""
          if [ "${{ steps.vulnerability_check.outcome }}" == "success" ]; then
            echo "âœ… Status: PASSED - No vulnerabilities detected"
            exit 0
          else
            echo "âŒ Status: FAILED - Vulnerabilities detected"
            echo ""
            echo "âš ï¸ ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ãŸã¯ã‚³ãƒŸãƒƒãƒˆã«ã¯è„†å¼±æ€§ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
            echo "æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œæ–¹æ³•ã«ã¤ã„ã¦ã¯ä¸Šè¨˜ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          fi
