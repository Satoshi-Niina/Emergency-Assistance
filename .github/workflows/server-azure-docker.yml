name: Deploy Server (Docker Container)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'shared/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - '.github/workflows/server-azure-docker.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'server-docker-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  IMAGE_NAME: emergency-assistance
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set Environment Variables
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "ENVIRONMENT=production" >> $GITHUB_ENV
          echo "WEBAPP_NAME=Emergency-Assistance" >> $GITHUB_ENV
          echo "RESOURCE_GROUP=${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_ENV
          echo "APP_URL=https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
          echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          echo "âœ… Environment: production"
        else
          echo "ENVIRONMENT=staging" >> $GITHUB_ENV
          echo "WEBAPP_NAME=Emergency-Assistance-Staging" >> $GITHUB_ENV
          echo "RESOURCE_GROUP=${{ secrets.AZURE_RESOURCE_GROUP_STAGING }}" >> $GITHUB_ENV
          echo "APP_URL=https://emergency-assistance-staging.azurewebsites.net" >> $GITHUB_ENV
          echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00-staging.azurestaticapps.net" >> $GITHUB_ENV
          echo "âœ… Environment: staging"
        fi
        echo "ðŸ”— Backend: $APP_URL"
        echo "ðŸ”— Frontend: $STATIC_WEB_APP_URL"

    - name: Validate Required Secrets
      run: |
        echo "ðŸ” Validating deployment secrets..."

        # Azure Container Registry
        if [ -z "${{ secrets.ACR_LOGIN_SERVER }}" ] || [ -z "${{ secrets.ACR_USERNAME }}" ] || [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
          echo "âŒ Azure Container Registry secrets are missing"
          exit 1
        fi

        # Azure Resource Group
        if [ -z "${{ env.RESOURCE_GROUP }}" ]; then
          echo "âŒ AZURE_RESOURCE_GROUP secret is missing"
          exit 1
        fi

        # Application secrets
        if [ -z "${{ secrets.DATABASE_URL }}" ]; then
          echo "âŒ DATABASE_URL secret is missing"
          exit 1
        fi

        echo "âœ… All required secrets validated"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build and Push Docker Image to ACR
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        no-cache: false
        cache-from: type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-cache
        cache-to: type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-cache,mode=max
        tags: |
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-latest
        build-args: |
          NODE_ENV=${{ env.ENVIRONMENT }}

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure App Service Environment Variables
      run: |
        echo "ðŸ”§ Configuring App Service environment variables..."

        az webapp config appsettings set \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.WEBAPP_NAME }} \
          --settings \
            NODE_ENV=${{ env.ENVIRONMENT }} \
            PORT=8080 \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            PG_SSL=require \
            SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            FRONTEND_URL="${{ env.STATIC_WEB_APP_URL }}" \
            STATIC_WEB_APP_URL="${{ env.STATIC_WEB_APP_URL }}" \
            CORS_ALLOW_ORIGINS="${{ env.STATIC_WEB_APP_URL }},http://localhost:5173,http://localhost:8080" \
            AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
            STORAGE_MODE=hybrid \
            LOCAL_EXPORT_DIR=/app/knowledge-base/exports \
            FAULT_HISTORY_IMAGES_DIR=/app/knowledge-base/images/chat-exports \
            WEBSITES_PORT=8080 \
            WEBSITES_CONTAINER_START_TIME_LIMIT=600 \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
          --output none

        echo "âœ… Environment variables configured"

    - name: Deploy Docker Container to App Service
      run: |
        echo "ðŸ³ Deploying Docker container to Azure App Service..."

        az webapp config container set \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --docker-custom-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --docker-registry-server-url https://${{ secrets.ACR_LOGIN_SERVER }} \
          --docker-registry-server-user ${{ secrets.ACR_USERNAME }} \
          --docker-registry-server-password ${{ secrets.ACR_PASSWORD }}

        echo "âœ… Docker container configured"

        # Clear appCommandLine to use Dockerfile's CMD
        echo "ðŸ”§ Clearing appCommandLine to use Dockerfile CMD..."
        az webapp config set \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --generic-configurations '{"appCommandLine":""}'

        echo "âœ… appCommandLine cleared - Dockerfile CMD will be used"

    - name: Restart App Service
      run: |
        echo "ðŸ”„ Restarting App Service to pull new Docker image..."

        az webapp restart \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }}

        echo "âœ… App Service restart initiated"

    - name: Wait for Container Startup
      run: |
        echo "â³ Waiting for Docker container to start (60 seconds)..."
        sleep 60

    - name: Health Check
      continue-on-error: true
      run: |
        echo "ðŸ¥ Verifying deployment health..."

        MAX_RETRIES=10
        RETRY_INTERVAL=10

        for attempt in $(seq 1 $MAX_RETRIES); do
          echo "ðŸ” Health check attempt $attempt/$MAX_RETRIES..."

          # ã‚·ãƒ³ãƒ—ãƒ«ãª /health ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${{ env.APP_URL }}/health" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"

            # è©³ç´°ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚‚å®Ÿè¡Œ
            echo "ðŸ“Š Fetching detailed health info..."
            curl -s "${{ env.APP_URL }}/api/health/detailed" | head -n 20

            echo "ðŸŽ‰ Deployment successful and server is responding"
            exit 0
          fi

          echo "â³ Server not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
          [ $attempt -lt $MAX_RETRIES ] && sleep $RETRY_INTERVAL
        done

        echo "âš ï¸ Health check timeout after $MAX_RETRIES attempts"
        echo "ðŸ“‹ Check logs: az webapp log tail --name ${{ env.WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}"
        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸ³ Docker Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Image | \`${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Web App | ${{ env.WEBAPP_NAME }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend URL | ${{ env.APP_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend URL | ${{ env.STATIC_WEB_APP_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Verification Commands:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Health check" >> $GITHUB_STEP_SUMMARY
          echo "curl ${{ env.APP_URL }}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Detailed health" >> $GITHUB_STEP_SUMMARY
          echo "curl ${{ env.APP_URL }}/api/health/detailed | jq" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# CORS test from frontend" >> $GITHUB_STEP_SUMMARY
          echo 'curl -i -X OPTIONS ${{ env.APP_URL }}/api/auth/login \' >> $GITHUB_STEP_SUMMARY
          echo '  -H "Origin: ${{ env.STATIC_WEB_APP_URL }}" \' >> $GITHUB_STEP_SUMMARY
          echo '  -H "Access-Control-Request-Method: POST"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "az webapp log tail --name ${{ env.WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check workflow logs above" >> $GITHUB_STEP_SUMMARY
          echo "2. View container logs: \`az webapp log tail --name ${{ env.WEBAPP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check App Service status: \`az webapp show --name ${{ env.WEBAPP_NAME }} --query state\`" >> $GITHUB_STEP_SUMMARY
        fi
