name: Deploy Server (Docker Container)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'shared/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - '.github/workflows/server-azure-docker.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'server-docker-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  REGISTRY_NAME: emergencyassistanceacr
  IMAGE_NAME: emergency-assistance
  WEBAPP_NAME: Emergency-Assistance
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set Environment Variables
      run: |
        echo "ENVIRONMENT=production" >> $GITHUB_ENV
        echo "APP_URL=https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
        echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
        echo "‚úÖ Environment: production"
        echo "üîó Backend: $APP_URL"

    - name: Validate Secrets
      run: |
        echo "üîç Validating deployment secrets..."
        if [ -z "${{ secrets.ACR_LOGIN_SERVER }}" ] || [ -z "${{ secrets.ACR_USERNAME }}" ] || [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
          echo "‚ùå Azure Container Registry secrets are missing"
          exit 1
        fi
        if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
          echo "‚ùå AZURE_WEBAPP_PUBLISH_PROFILE secret is missing"
          exit 1
        fi
        echo "‚úÖ Required secrets validated"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}
        tags: |
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        no-cache: true
        tags: |
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Stop App Service (Clean Deploy)
      run: |
        echo "üõë Stopping App Service to clear container cache..."
        az webapp stop \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
        
        echo "‚è≥ Waiting for complete shutdown..."
        sleep 30
        echo "‚úÖ App Service stopped"

    - name: Configure Azure App Service for Docker
      run: |
        echo "üîß Configuring Azure App Service for Docker deployment..."

        # App Service„ÅßDocker„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩøÁî®„Åô„Çã„Çà„ÅÜ„Å´Ë®≠ÂÆö
        az webapp config container set \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --docker-custom-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --docker-registry-server-url https://${{ secrets.ACR_LOGIN_SERVER }} \
          --docker-registry-server-user ${{ secrets.ACR_USERNAME }} \
          --docker-registry-server-password ${{ secrets.ACR_PASSWORD }}

        echo "‚úÖ Docker configuration completed"

    - name: Set Azure App Service Environment Variables
      run: |
        echo "üîß Setting environment variables in Azure App Service..."

        az webapp config appsettings set \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.WEBAPP_NAME }} \
          --settings \
            NODE_ENV=production \
            PORT=8080 \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            PG_SSL=require \
            SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            FRONTEND_URL="${{ env.STATIC_WEB_APP_URL }}" \
            STATIC_WEB_APP_URL="${{ env.STATIC_WEB_APP_URL }}" \
            CORS_ALLOW_ORIGINS="${{ env.STATIC_WEB_APP_URL }},${{ env.APP_URL }}" \
            AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
            STORAGE_MODE=hybrid \
            LOCAL_EXPORT_DIR=/app/knowledge-base/exports \
            FAULT_HISTORY_IMAGES_DIR=/app/knowledge-base/images/chat-exports \
            WEBSITES_PORT=8080 \
            WEBSITES_CONTAINER_START_TIME_LIMIT=600 \
          --output none

        echo "‚úÖ Environment variables configured"

    - name: Deploy to Azure Web App (Docker)
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        images: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Force restart App Service (Clear Cache)
      run: |
        echo "üîÑ Force restarting App Service to ensure new image is loaded..."
        az webapp restart \
          --name ${{ env.WEBAPP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
        
        echo "‚úÖ Restart command sent"

    - name: Wait for deployment to stabilize
      run: |
        echo "‚è≥ Waiting for Docker container to start with fresh image..."
        sleep 120

    - name: Verify deployment health
      continue-on-error: true
      env:
        MAX_RETRIES: 15
        RETRY_INTERVAL: 20
      run: |
        echo "üè• Running health check..."
        HEALTH_URL="${{ env.APP_URL }}/health"

        for attempt in $(seq 1 $MAX_RETRIES); do
          echo "üîç Attempt $attempt/$MAX_RETRIES..."

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$HEALTH_URL" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"
            exit 0
          fi

          echo "‚è≥ Waiting... (HTTP $HTTP_CODE)"
          if [ $attempt -lt $MAX_RETRIES ]; then
            sleep $RETRY_INTERVAL
          fi
        done

        echo "‚ö†Ô∏è Health check failed after $MAX_RETRIES attempts"
        echo "‚ö†Ô∏è Deployment completed but health check timed out"
        echo "üìã Please check Azure App Service logs manually:"
        echo "   az webapp log tail --name Emergency-Assistance --resource-group <your-rg>"
        exit 0

    - name: Deployment summary
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üê≥ Docker Server Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Image**: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Web App**: ${{ env.APP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check**: ${{ env.APP_URL }}/health" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: ${{ env.STATIC_WEB_APP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ **Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéØ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Visit: ${{ env.STATIC_WEB_APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Test API: ${{ env.APP_URL }}/api/ping" >> $GITHUB_STEP_SUMMARY
          echo "3. Check logs if needed" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Deployment Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîß Troubleshooting:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Azure App Service logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify Docker image build" >> $GITHUB_STEP_SUMMARY
          echo "3. Check environment variables" >> $GITHUB_STEP_SUMMARY
        fi
