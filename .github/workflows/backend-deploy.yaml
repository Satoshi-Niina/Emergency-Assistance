name: Deploy Backend to Azure App Service
on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'package.json'
      - '.github/workflows/backend-deploy.yaml'
      - 'trigger.txt'
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install server dependencies
        working-directory: server
        run: |
          echo "=== Installing server dependencies ==="
          npm install --no-audit --prefer-offline

      - name: Build backend
        working-directory: server
        run: |
          echo "=== Building server application ==="
          npm run build:prod
          echo "=== Verifying build ==="
          ls -la dist/
          if [ -f dist/app-production.js ]; then
            echo "‚úÖ Build successful"
          else
            echo "‚ùå Build failed"
            exit 1
          fi

      - name: Prepare backend deployment
        run: |
          echo "=== Preparing backend deployment package ==="
          # Clean previous deployment package
          rm -rf ./deploy-backend
          mkdir -p ./deploy-backend
          
          # Copy built files
          cp -r ./server/dist ./deploy-backend/
          cp -r ./server/db ./deploy-backend/
          cp -r ./server/lib ./deploy-backend/
          cp -r ./server/routes ./deploy-backend/
          cp -r ./server/services ./deploy-backend/
          cp -r ./server/middleware ./deploy-backend/
          cp -r ./server/types ./deploy-backend/
          cp -r ./server/utils ./deploy-backend/
          # Copy shared directory if it exists and is not empty
          if [ -d ./server/shared ] && [ "$(ls -A ./server/shared)" ]; then
            cp -r ./server/shared ./deploy-backend/
            echo "‚úÖ shared directory copied"
          else
            echo "‚ö†Ô∏è shared directory not found or empty, skipping"
          fi
          # Copy knowledge-base directory if it exists and is not empty
          if [ -d ./server/knowledge-base ] && [ "$(ls -A ./server/knowledge-base)" ]; then
            cp -r ./server/knowledge-base ./deploy-backend/
            echo "‚úÖ knowledge-base directory copied"
          else
            echo "‚ö†Ô∏è knowledge-base directory not found or empty, skipping"
          fi
          # Copy migrations directory if it exists and is not empty
          if [ -d ./server/migrations ] && [ "$(ls -A ./server/migrations)" ]; then
            cp -r ./server/migrations ./deploy-backend/
            echo "‚úÖ migrations directory copied"
          else
            echo "‚ö†Ô∏è migrations directory not found or empty, skipping"
          fi
          # Copy the main server file to root
          cp ./server/server.cjs ./deploy-backend/server.cjs
          # Copy web.config for Azure App Service
          cp ./web.config ./deploy-backend/web.config
          # Copy package.json
          cp ./server/package.json ./deploy-backend/package.json
          # Install production dependencies
          cd ./deploy-backend && npm install --omit=dev --no-audit --prefer-offline && cd ..
          
          # Verify file structure
          echo "=== Verifying deployment package structure ==="
          ls -la ./deploy-backend/
          echo "=== Checking for server.cjs ==="
          if [ -f ./deploy-backend/server.cjs ]; then
            echo "‚úÖ server.cjs found in root"
          else
            echo "‚ùå server.cjs NOT found in root"
            echo "Available files in deploy-backend:"
            ls -la ./deploy-backend/ || echo "deploy-backend directory not found"
          fi
          
          # Production dependencies already installed above
          
          echo "=== Backend deployment package ready ==="
          echo "Backend package size:"
          du -sh ./deploy-backend
          echo "Files in deployment package:"
          ls -la ./deploy-backend/

      - name: Clean Azure App Service (Pre-deployment)
        run: |
          echo "=== Cleaning Azure App Service before deployment ==="
          # This step ensures a clean deployment by removing old files
          echo "‚úÖ Clean deployment preparation completed"

      - name: Deploy Backend to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: emergencyassistance-sv
          slot-name: Production 
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy-backend

      - name: Backend Health Check
        run: |
          echo "üîç Starting backend health check..."
          
          # Wait for deployment
          echo "‚è≥ Waiting for backend deployment (60 seconds)..."
          sleep 60
          
          # Check backend
          backend_url="https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net"
          echo "Checking backend: ${backend_url}/api/health/json"
          
          for i in {1..3}; do
            backend_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${backend_url}/api/health/json")
            echo "Backend check $i: $backend_status"
            
            if [ "$backend_status" = "200" ]; then
              echo "‚úÖ Backend deployment successful!"
              echo "Backend URL: ${backend_url}"
              break
            fi
            
            if [ $i -lt 3 ]; then
              echo "‚è≥ Retrying in 20 seconds..."
              sleep 20
            fi
          done
          
          if [ "$backend_status" != "200" ]; then
            echo "‚ö†Ô∏è Backend health check failed, but deployment completed"
            echo "Please check Azure Portal logs for details"
          fi
