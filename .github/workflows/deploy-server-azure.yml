name: Deploy Server to Azure App Service (Simplified)

on:
  push:
    branches:
      - main
      - master
      - backup
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Azure App Service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install dependencies (isolated npm)
        run: |
          echo "üì¶ Installing server dependencies..."

          # Navigate to server directory and work in isolation
          cd server

          # Clean start - remove any conflicting files
          rm -rf node_modules package-lock.json yarn.lock .npm .npmrc

          # Create isolated npm environment with environment variables
          echo "üîß Setting up isolated npm environment..."

          # Set npm environment variables (safer than config commands)
          export NPM_CONFIG_AUDIT=false
          export NPM_CONFIG_FUND=false
          export NPM_CONFIG_WORKSPACES=false
          export NPM_CONFIG_WORKSPACE=""
          export npm_config_workspaces=false

          # Install dependencies with isolation flags
          echo "üì¶ Installing dependencies with isolation..."
          INSTALL_SUCCESS=false
          for attempt in 1 2 3; do
            echo "üì¶ Installation attempt $attempt/3..."

            # Use modern npm flags and isolation
            if npm install --ignore-workspace-root-check --no-workspaces --omit=optional --loglevel=error; then
              INSTALL_SUCCESS=true
              echo "‚úÖ npm install completed successfully on attempt $attempt"
              break
            else
              echo "‚ö†Ô∏è Attempt $attempt failed, cleaning up..."
              rm -rf node_modules package-lock.json
              sleep 5
            fi
          done

          if [ "$INSTALL_SUCCESS" = false ]; then
            echo "‚ùå All installation attempts failed"
            exit 1
          fi

          # Verify installation
          echo "üì¶ Installation verification:"
          if [ -d "node_modules" ]; then
            MODULE_COUNT=$(ls node_modules 2>/dev/null | wc -l || echo '0')
            echo "  - Modules installed: $MODULE_COUNT"

            # Check critical dependencies
            for module in express cors dotenv bcryptjs; do
              if [ -d "node_modules/$module" ]; then
                echo "  ‚úÖ $module: Found"
              else
                echo "  ‚ùå $module: Missing"
                exit 1
              fi
            done
          else
            echo "  ‚ùå node_modules directory not created"
            exit 1
          fi

      - name: Prepare deployment package
        run: |
          echo "üì¶ Creating deployment package..."

          # Create deployment directory
          mkdir -p deploy

          # Copy server files (explicitly include node_modules)
          cp -r server/* deploy/

          # Ensure node_modules is copied (critical for deployment)
          if [ -d "server/node_modules" ]; then
            echo "üì¶ Copying node_modules to deployment package..."
            cp -r server/node_modules deploy/
            echo "‚úÖ node_modules copied successfully"
          else
            echo "‚ùå server/node_modules not found - attempting emergency install in deploy directory"

            # Emergency npm install directly in deploy directory
            cd deploy
            echo "üö® Running emergency npm install in deploy directory..."
            npm install --production --no-optional --omit=dev
            cd ..

            if [ -d "deploy/node_modules" ]; then
              echo "‚úÖ Emergency npm install successful"
            else
              echo "‚ùå Emergency npm install failed - deployment will fail"
              exit 1
            fi
          fi

          # Copy additional resources
          cp -r shared deploy/shared 2>/dev/null || echo "No shared directory"
          cp -r knowledge-base deploy/knowledge-base 2>/dev/null || echo "No knowledge-base directory"

          # Create required directories
          mkdir -p deploy/app-logs/{exports,history}
          mkdir -p deploy/uploads

          # Clean up unnecessary files
          rm -f deploy/.env* deploy/tsconfig*.json

          # Ensure web.config exists for IIS/Azure App Service
          if [ ! -f deploy/web.config ]; then
            echo "‚ö†Ô∏è web.config missing, creating default..."
            cat > deploy/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="index.js" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="index.js"/>
                  </rule>
                </rules>
              </rewrite>
              <iisnode node_env="production" />
            </system.webServer>
          </configuration>
          EOF
          fi

          # Comprehensive deployment package verification
          echo "üîç Deployment package verification:"
          echo "  - Entry point: $(test -f deploy/index.js && echo 'OK' || echo 'MISSING')"
          echo "  - Package.json: $(test -f deploy/package.json && echo 'OK' || echo 'MISSING')"
          echo "  - Web.config: $(test -f deploy/web.config && echo 'OK' || echo 'MISSING')"
          echo "  - Node modules: $(test -d deploy/node_modules && echo 'OK' || echo 'MISSING')"
          echo "  - Express: $(test -f deploy/node_modules/express/package.json && echo 'OK' || echo 'MISSING')"

          # Detailed node_modules verification
          if [ -d deploy/node_modules ]; then
            echo "üì¶ Node modules details:"
            echo "  - Modules count: $(ls deploy/node_modules | wc -l)"
            echo "  - Express version: $(cat deploy/node_modules/express/package.json | grep '"version"' || echo 'Not found')"
            echo "  - Core modules present:"
            for module in express cors dotenv bcryptjs jsonwebtoken; do
              if [ -d "deploy/node_modules/$module" ]; then
                echo "    ‚úÖ $module"
              else
                echo "    ‚ùå $module (CRITICAL MISSING)"
              fi
            done
          else
            echo "‚ùå CRITICAL: node_modules directory missing completely"
            echo "üìã Deploy directory contents:"
            ls -la deploy/ || echo "Deploy directory not accessible"
            exit 1
          fi

          # Check file permissions and structure
          echo "üìÇ Deploy directory structure:"
          echo "  - Total files: $(find deploy -type f | wc -l)"
          echo "  - JavaScript files: $(find deploy -name '*.js' | wc -l)"
          echo "  - Index.js size: $(stat -c%s deploy/index.js 2>/dev/null || echo 'N/A') bytes"

          # Display package.json engines
          if [ -f deploy/package.json ]; then
            echo "  - Node version requirement: $(grep -A2 '"engines"' deploy/package.json || echo 'Not specified')"
          fi

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: Emergency-Assistance
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy
          type: 'ZIP'
          clean: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FRONTEND_URL: "https://witty-river-012f39e00.1.azurestaticapps.net"
          NODE_ENV: "production"
          WEBSITE_NODE_DEFAULT_VERSION: "20-lts"
          SCM_DO_BUILD_DURING_DEPLOYMENT: "false"

      - name: Health check
        run: |
          APP_URL="https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net"

          echo "üöÄ Deployment completed"
          echo "‚è∞ Starting health check in 30 seconds..."
          sleep 30

          # Multi-endpoint health check with retries
          HEALTH_ENDPOINTS=(
            "$APP_URL/ping"
            "$APP_URL/health"
            "$APP_URL/api/ping"
            "$APP_URL/api/health"
          )

          SUCCESS=false

          for endpoint in "${HEALTH_ENDPOINTS[@]}"; do
            echo "üîç Testing endpoint: $endpoint"

            for i in {1..3}; do
              echo "  Attempt $i/3..."

              if curl -f "$endpoint" --max-time 15 --silent --show-error; then
                echo "  ‚úÖ SUCCESS - $endpoint is responding"
                SUCCESS=true
                break 2  # Break out of both loops
              else
                echo "  ‚ö†Ô∏è Attempt $i failed for $endpoint"
                if [ $i -lt 3 ]; then
                  sleep 30
                fi
              fi
            done

            # Short delay between endpoints
            sleep 10
          done

          if [ "$SUCCESS" = true ]; then
            echo "‚úÖ Health check PASSED - At least one endpoint is responding"

            # Additional verification with detailed health check
            echo "üîç Running detailed health verification..."
            if curl -f "$APP_URL/api/health" --max-time 30 --silent; then
              echo "‚úÖ Detailed health check also passed"
            else
              echo "‚ö†Ô∏è Detailed health check failed, but basic health is OK"
            fi

            exit 0
          else
            echo "‚ùå Health check failed - No endpoints responding after multiple attempts"
            echo "üìã Please check Azure App Service logs and deployment status"
            exit 1
          fi
