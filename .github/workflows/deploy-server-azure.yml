name: Deploy Server to Azure App Service (ZIP)

on:
  push:
    branches:
      - main
      - master
      - backup
    paths:
      - 'server/**'
      - 'shared/**'
      - 'knowledge-base/**'
      - '.github/workflows/deploy-server-azure.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no server files changed'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Azure App Service (Node.js)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Debug workflow trigger
        run: |
          echo "ğŸ” Workflow triggered by: ${{ github.event_name }}"
          echo "ğŸ” Branch: ${{ github.ref }}"
          echo "ğŸ” Commit SHA: ${{ github.sha }}"
          echo "ğŸ” Changed files:"
          git diff --name-only HEAD~1 HEAD || echo "No previous commit"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package.json

      - name: Install dependencies and prepare package
        run: |
          echo "ğŸ“¦ Installing dependencies in server directory..."
          cd server
          
          # Show current working directory and package.json
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“„ Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"
          echo "ğŸ“„ Package.json content:"
          cat package.json | head -20
          
          # Clean install with all dependencies first
          echo "ğŸ“¦ Starting npm ci..."
          npm ci --no-audit --no-fund --verbose
          echo "ğŸ“¦ Dependencies installed successfully"
          
          # Comprehensive express check
          echo "ğŸ“¦ Checking express installation:"
          echo "  - npm list express:"
          npm list express || echo "    Express not found in npm list"
          echo "  - node_modules directory:"
          ls -la node_modules/ | head -10
          echo "  - express directory check:"
          ls -la node_modules/express/ || echo "    Express directory not found"
          echo "  - node_modules size:"
          du -sh node_modules/

      - name: Prepare deployment package
        run: |
          echo "ğŸ“¦ Preparing deployment package..."
          
          # Create deployment directory
          mkdir -p deploy
          
          # Copy all server files including node_modules
          echo "ğŸ“¦ Copying server files..."
          cp -r server/* deploy/
          
          # Double check node_modules copy with detailed verification
          echo "ğŸ“¦ Verifying node_modules copy:"
          echo "  - Source server directory contents:"
          ls -la server/ | grep -E "(node_modules|package|index)"
          echo "  - Deploy directory contents before copy:"
          ls -la deploy/ || echo "    Deploy directory empty/missing"
          
          if [ -d "deploy/node_modules" ]; then
            echo "âœ… node_modules directory exists in deploy"
            echo "  - Deploy node_modules size: $(du -sh deploy/node_modules/)"
            echo "  - Deploy node_modules file count: $(find deploy/node_modules -type f | wc -l)"
            if [ -d "deploy/node_modules/express" ]; then
              echo "âœ… express module found in deployment package"
              echo "  - Express files: $(find deploy/node_modules/express -name '*.js' | wc -l) JS files"
            else
              echo "âŒ express module NOT found in deployment package"
              echo "  - Available modules in deploy:"
              ls -la deploy/node_modules/ | head -5
            fi
          else
            echo "âŒ node_modules directory NOT copied to deploy"
            echo "  - Attempting manual copy..."
            if [ -d "server/node_modules" ]; then
              cp -r server/node_modules deploy/
              echo "  - Manual copy completed"
            else
              echo "  - ERROR: server/node_modules does not exist!"
              ls -la server/
            fi
          fi
          
          # Copy shared modules
          cp -r shared deploy/
          
          # Copy knowledge base
          cp -r knowledge-base deploy/
          
          # Create necessary directories
          mkdir -p deploy/app-logs/exports
          mkdir -p deploy/app-logs/history
          mkdir -p deploy/uploads
          
          # Only remove specific dev files, keep all production dependencies
          rm -f deploy/tsconfig*.json
          rm -rf deploy/.env*
          
          echo "ğŸ“¦ Final deployment package contents:"
          ls -la deploy/
          echo "ğŸ“¦ Final node_modules check:"
          ls -la deploy/node_modules/express/ || echo "Express still missing!"
          echo "ğŸ“¦ Package size:"
          du -sh deploy/

      - name: Deploy to Azure App Service (publish profile method)
        uses: azure/webapps-deploy@v3
        with:
          app-name: Emergency-Assistance
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy
        continue-on-error: false
        
      - name: Verify deployment
        run: |
          echo "ğŸ“‹ Deployment summary:"
          echo "  - App Name: Emergency-Assistance"
          echo "  - Package: deploy directory"
          echo "  - Startup: node index.js"
          echo ""
          echo "ğŸ’¡ If deployment failed due to credentials:"
          echo "   Please ensure AZURE_WEBAPP_PUBLISH_PROFILE is set in GitHub Secrets"
          echo "   Download from: Azure Portal > App Service > Deployment Center > Publish Profile"

      - name: Configure CORS on Azure App Service
        run: |
          echo "ğŸŒ Configuring CORS for Azure App Service..."
          # Publish Profileã‚’ä½¿ã£ã¦CORSã‚’è¨­å®šï¼ˆREST APIçµŒç”±ï¼‰
          echo "â„¹ï¸ CORS will be configured manually in Azure Portal"
          echo "   Add origin: https://witty-river-012f39e00.1.azurestaticapps.net"
          echo ""
          echo "ğŸ’¡ Current deployment uses publish profile method"
          echo "   Environment variables are managed through the deployment process"



      - name: Deploy summary
        run: |
          echo "âœ… Node.js application deployed to Azure App Service"
          echo "ğŸš€ Server deployed via ZIP deployment using Publish Profile"
          echo "ğŸŒ Backend URL: https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net"
          echo "ğŸŒ Frontend URL: https://witty-river-012f39e00.1.azurestaticapps.net"
          echo "âœ… Environment variables set on Azure App Service"
          echo "ğŸ”§ Startup command: node index.js"
          echo ""
          echo "âš ï¸  Manual step required:"
          echo "   Configure CORS in Azure Portal for Emergency-Assistance App Service"
          echo "   Add allowed origin: https://witty-river-012f39e00.1.azurestaticapps.net"

