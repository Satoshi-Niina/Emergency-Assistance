name: Deploy Server to Azure App Service (Oryx)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

concurrency:
  group: 'azure-appservice-deploy'
  cancel-in-progress: true

env:
  # æœ¬ç•ªã® App Service URLï¼ˆä¾‹: https://xxxx.azurewebsites.netï¼‰
  APP_URL: ${{ secrets.APP_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # å¿…é ˆSecretã®ç¢ºèªï¼ˆPublish Profileæ–¹å¼ï¼‰
      - name: Validate required secrets
        shell: bash
        run: |
          echo "ğŸ” Validating required secrets for Publish Profile deployment..."
          echo ""

          MISSING_SECRETS=()

          # Publish Profileæ–¹å¼ã«å¿…è¦ãªSecretã‚’ãƒã‚§ãƒƒã‚¯
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            MISSING_SECRETS+=("AZURE_WEBAPP_PUBLISH_PROFILE")
          fi

          if [ -z "${{ secrets.APP_URL }}" ]; then
            MISSING_SECRETS+=("APP_URL")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "ğŸ“‹ Quick Setup:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "ğŸ“ Required Secrets:"
            echo "   1. AZURE_WEBAPP_PUBLISH_PROFILE"
            echo "      - Azure Portal > App Service > Overview > Get publish profile"
            echo "      - Download .PublishSettings file and copy entire XML content"
            echo ""
            echo "   2. APP_URL"
            echo "      - Your App Service URL (e.g., https://your-app.azurewebsites.net)"
            echo ""
            exit 1
          fi

          echo "âœ… All required secrets are set"

      # Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆOryxãƒ“ãƒ«ãƒ‰ã¨åˆã‚ã›ã¦ä½¿ç”¨ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # package-lock.jsonåŒæœŸã®å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
          # cache: 'npm'

      # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ“ãƒ«ãƒ‰å‰ãƒã‚§ãƒƒã‚¯ï¼‰
      - name: Install dependencies
        shell: bash
        run: |
          echo "ğŸ”§ Clearing npm cache..."
          npm cache clean --force

          echo "ğŸ”§ Installing root dependencies..."
          if [ -f package.json ]; then
            npm install --no-audit --no-fund
          else
            echo "No root package.json found, skipping root install"
          fi

          echo "ğŸ”§ Installing server dependencies..."
          cd server
          npm cache clean --force
          npm install --no-audit --no-fund

      # åŸºæœ¬çš„ãªãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
      - name: Run build check
        shell: bash
        run: |
          echo "ğŸ” Checking server build..."
          cd server
          npm run build

          echo "âœ… Build check completed"

      # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
      - name: Pre-deploy validation
        shell: bash
        run: |
          echo "ğŸ“‹ Pre-deployment validation:"
          echo "   - Checking server/package.json..."
          test -f server/package.json || { echo "âŒ server/package.json not found"; exit 1; }

          echo "   - Checking server/azure-server.js..."
          test -f server/azure-server.js || { echo "âŒ server/azure-server.js not found"; exit 1; }

          echo "   - Checking server/web.config..."
          test -f server/web.config || { echo "âŒ server/web.config not found"; exit 1; }

          echo "âœ… All required files present"

      # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ“ãƒ«ãƒ‰ï¼ˆã‚µãƒ¼ãƒãƒ¼ãŒå‚ç…§ã™ã‚‹ãŸã‚ï¼‰
      - name: Build client
        shell: bash
        run: |
          echo "ğŸ—ï¸ Building client for server static files..."

          if [ ! -d "client" ]; then
            echo "âŒ Client directory not found"
            exit 1
          fi

          cd client

          if [ ! -f "package.json" ]; then
            echo "âŒ Client package.json not found"
            exit 1
          fi

          echo "ğŸ“¦ Installing client dependencies..."
          npm cache clean --force
          npm install --no-audit --no-fund

          echo "ğŸ”¨ Building client..."
          npm run build

          if [ ! -d "dist" ]; then
            echo "âŒ Client build failed - dist directory not created"
            exit 1
          fi

          echo "ğŸ“‹ Client build output:"
          ls -la dist/

          echo "âœ… Client build completed"

      # ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Prepare deployment package
        shell: bash
        run: |
          echo "ğŸ“¦ Preparing deployment package..."

          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p deploy-package

          # ã‚µãƒ¼ãƒãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆpackage.jsonå«ã‚€ - Oryxãƒ“ãƒ«ãƒ‰ç”¨ï¼‰
          cp -r server/* deploy-package/

          # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®distãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆazure-server.jsãŒå‚ç…§ã™ã‚‹ãŸã‚ï¼‰
          mkdir -p deploy-package/client
          cp -r client/dist deploy-package/client/

          # é–‹ç™ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼ˆOryxãŒä¾å­˜é–¢ä¿‚ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ node_modules ã¯é™¤å¤–ï¼‰
          rm -rf deploy-package/node_modules
          rm -f deploy-package/package-lock.json

          # package.jsonãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆOryxãƒ“ãƒ«ãƒ‰ç”¨ï¼‰
          test -f deploy-package/package.json || { echo "âŒ package.json missing"; exit 1; }

          echo "ğŸ“‹ Deployment package contents:"
          ls -la deploy-package/
          echo "ğŸ“‹ Client files:"
          ls -la deploy-package/client/ || echo "No client directory"

          echo "âœ… Package preparation completed"

      # Oryx Build ã‚’ç”¨ã„ãŸ App Service ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Azure Web App (Oryx)
        uses: azure/webapps-deploy@v3
        with:
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package
          clean: true
          restart: true
          # ğŸ”§ é‡è¦ï¼šä»¥ä¸‹ã®è¨­å®šã‚’Azure Portal > App Service > Configuration > Application settingsã§è¨­å®šã™ã‚‹:
          # - SCM_DO_BUILD_DURING_DEPLOYMENT=true (Oryxãƒ“ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–)
          # - WEBSITE_NODE_DEFAULT_VERSION=20-lts (Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³)
          # - NPM_CONFIG_PRODUCTION=false (devDependenciesã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)

      # æ®µéšçš„Health Check - ã‚ˆã‚Šå®Ÿç”¨çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
      - name: Comprehensive Health Check
        env:
          APP_URL: ${{ env.APP_URL }}
          HEALTH_TOKEN: ${{ secrets.HEALTH_TOKEN }}
        shell: bash
        run: |
          set -eo pipefail

          if [ -z "${APP_URL}" ]; then
            echo "âŒ APP_URL is not set. Define it in GitHub Secrets (APP_URL)."
            exit 1
          fi

          echo "ğŸ¥ Starting comprehensive health check for: ${APP_URL}"

          # Stage 1: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬èµ·å‹•ãƒã‚§ãƒƒã‚¯
          echo "ğŸ“‹ Stage 1: Basic availability check"
          MAX_WAIT=300  # 5åˆ†
          WAIT_INTERVAL=30
          elapsed=0

          while [ $elapsed -lt $MAX_WAIT ]; do
            echo "â° Waiting for application startup... ($elapsed/$MAX_WAIT seconds)"

            # åŸºæœ¬çš„ãªæ¥ç¶šãƒ†ã‚¹ãƒˆ
            if curl -fsSL --max-time 10 "${APP_URL}/" >/dev/null 2>&1; then
              echo "âœ… Stage 1 PASSED: Basic connectivity established"
              break
            fi

            sleep $WAIT_INTERVAL
            elapsed=$((elapsed + WAIT_INTERVAL))
          done

          if [ $elapsed -ge $MAX_WAIT ]; then
            echo "âŒ Stage 1 FAILED: Application did not respond within $MAX_WAIT seconds"
            echo "ğŸ” Debugging info:"
            curl -v "${APP_URL}/" || true
            exit 1
          fi

          # Stage 2: Health endpointã®è©³ç´°ãƒã‚§ãƒƒã‚¯
          echo ""
          echo "ğŸ“‹ Stage 2: Health endpoint verification"

          check_health_endpoint() {
            local endpoint="$1"
            local required="${2:-false}"
            local url="${APP_URL}${endpoint}"

            echo "ğŸ” Testing: ${endpoint}"

            local response
            local status_code

            if [ -n "${HEALTH_TOKEN}" ]; then
              response=$(curl -w "%{http_code}" -s --max-time 15 \
                -H "x-health-token: ${HEALTH_TOKEN}" \
                "${url}" 2>/dev/null || echo "000")
            else
              response=$(curl -w "%{http_code}" -s --max-time 15 \
                "${url}" 2>/dev/null || echo "000")
            fi

            status_code="${response: -3}"
            body="${response%???}"

            if [[ "$status_code" =~ ^2[0-9][0-9]$ ]]; then
              echo "  âœ… ${endpoint} - HTTP ${status_code} (${body:0:50}...)"
              return 0
            else
              echo "  âš ï¸  ${endpoint} - HTTP ${status_code}"
              if [ "$required" = "true" ]; then
                return 1
              fi
              return 0
            fi
          }

          # å¿…é ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯
          CRITICAL_ENDPOINTS=("/ping" "/health")
          OPTIONAL_ENDPOINTS=("/live" "/ready" "/api/ping" "/api/health")

          critical_failed=false

          echo "ğŸš¨ Checking critical endpoints:"
          for endpoint in "${CRITICAL_ENDPOINTS[@]}"; do
            if ! check_health_endpoint "$endpoint" "true"; then
              critical_failed=true
            fi
          done

          echo "ï¿½ Checking optional endpoints:"
          for endpoint in "${OPTIONAL_ENDPOINTS[@]}"; do
            check_health_endpoint "$endpoint" "false"
          done

          # Stage 3: æœ€çµ‚åˆ¤å®š
          echo ""
          echo "ğŸ“‹ Stage 3: Final health assessment"

          if [ "$critical_failed" = "true" ]; then
            echo "âŒ HEALTH CHECK FAILED: Critical endpoints are not responding"
            echo ""
            echo "ï¿½ Troubleshooting steps:"
            echo "  1. Check Azure Portal > App Service > Log stream"
            echo "  2. Verify environment variables: SCM_DO_BUILD_DURING_DEPLOYMENT=true"
            echo "  3. Check Kudu console: ${APP_URL%/}.scm.azurewebsites.net"
            echo "  4. Review application logs for startup errors"
            echo ""
            echo "ğŸ“Š Manual verification URL: ${APP_URL}"
            exit 1
          else
            echo "âœ… HEALTH CHECK PASSED: Application is healthy and ready"
            echo "ğŸš€ Deployment completed successfully!"
            echo "ğŸŒ Application URL: ${APP_URL}"
          fi
