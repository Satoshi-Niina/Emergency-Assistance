name: Deploy Server to Azure App Service (Simplified)

on:
  push:
    branches:
      - main
      - master
      - backup
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Azure App Service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.0'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install dependencies (isolated npm)
        run: |
          echo "üì¶ Installing server dependencies..."

          # Navigate to server directory and work in isolation
          cd server

          # Clean start - remove any conflicting files
          rm -rf node_modules package-lock.json yarn.lock .npm .npmrc

          # Create isolated npm environment with environment variables
          echo "üîß Setting up isolated npm environment..."

          # Set npm environment variables (safer than config commands)
          export NPM_CONFIG_AUDIT=false
          export NPM_CONFIG_FUND=false
          export NPM_CONFIG_WORKSPACES=false
          export NPM_CONFIG_WORKSPACE=""
          export npm_config_workspaces=false

          # Install dependencies with isolation flags
          echo "üì¶ Installing dependencies with isolation..."
          INSTALL_SUCCESS=false
          for attempt in 1 2 3; do
            echo "üì¶ Installation attempt $attempt/3..."

            # Use modern npm flags and isolation
            if npm install --ignore-workspace-root-check --no-workspaces --omit=optional --loglevel=error; then
              INSTALL_SUCCESS=true
              echo "‚úÖ npm install completed successfully on attempt $attempt"
              break
            else
              echo "‚ö†Ô∏è Attempt $attempt failed, cleaning up..."
              rm -rf node_modules package-lock.json
              sleep 5
            fi
          done

          if [ "$INSTALL_SUCCESS" = false ]; then
            echo "‚ùå All installation attempts failed"
            exit 1
          fi

          # Verify installation
          echo "üì¶ Installation verification:"
          if [ -d "node_modules" ]; then
            MODULE_COUNT=$(ls node_modules 2>/dev/null | wc -l || echo '0')
            echo "  - Modules installed: $MODULE_COUNT"

            # Check critical dependencies
            for module in express cors dotenv bcryptjs; do
              if [ -d "node_modules/$module" ]; then
                echo "  ‚úÖ $module: Found"
              else
                echo "  ‚ùå $module: Missing"
                exit 1
              fi
            done
          else
            echo "  ‚ùå node_modules directory not created"
            exit 1
          fi

      - name: Prepare deployment package
        run: |
          echo "üì¶ Creating deployment package..."

          # Create deployment directory
          mkdir -p deploy

          # Copy server files (explicitly include node_modules)
          cp -r server/* deploy/

          # Ensure node_modules is copied (critical for deployment)
          if [ -d "server/node_modules" ]; then
            echo "üì¶ Copying node_modules to deployment package..."
            cp -r server/node_modules deploy/
            echo "‚úÖ node_modules copied successfully"
          else
            echo "‚ùå server/node_modules not found - attempting emergency install in deploy directory"

            # Emergency npm install directly in deploy directory
            cd deploy
            echo "üö® Running emergency npm install in deploy directory..."
            npm install --production --no-optional --omit=dev
            cd ..

            if [ -d "deploy/node_modules" ]; then
              echo "‚úÖ Emergency npm install successful"
            else
              echo "‚ùå Emergency npm install failed - deployment will fail"
              exit 1
            fi
          fi

          # Copy additional resources
          cp -r shared deploy/shared 2>/dev/null || echo "No shared directory"
          cp -r knowledge-base deploy/knowledge-base 2>/dev/null || echo "No knowledge-base directory"

          # Create required directories
          mkdir -p deploy/app-logs/{exports,history}
          mkdir -p deploy/uploads

          # Clean up files that might cause EISDIR errors
          echo "üßπ Cleaning up potentially problematic files..."
          rm -f deploy/.env* deploy/tsconfig*.json
          rm -rf deploy/lib deploy/routes deploy/compat deploy/config
          rm -f deploy/*hot-reload* deploy/unified-*.js deploy/fallback-*.js
          rm -f deploy/*.ts deploy/*.md deploy/*.sql deploy/*.cjs deploy/*.mjs
          find deploy -name "*.ts" -delete 2>/dev/null || true
          find deploy -name "*.md" -delete 2>/dev/null || true
          find deploy -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true

          echo "üì¶ Keeping only essential files for minimal deployment..."

          # Ensure web.config exists for IIS/Azure App Service
          if [ ! -f deploy/web.config ]; then
            echo "‚ö†Ô∏è web.config missing, creating default..."
            cat > deploy/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="index.js" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="index.js"/>
                  </rule>
                </rules>
              </rewrite>
              <iisnode node_env="production" />
            </system.webServer>
          </configuration>
          EOF
          fi

          # Comprehensive deployment package verification
          echo "üîç Deployment package verification:"
          echo "  - Entry point: $(test -f deploy/index.js && echo 'OK' || echo 'MISSING')"
          echo "  - Package.json: $(test -f deploy/package.json && echo 'OK' || echo 'MISSING')"
          echo "  - Web.config: $(test -f deploy/web.config && echo 'OK' || echo 'MISSING')"
          echo "  - Node modules: $(test -d deploy/node_modules && echo 'OK' || echo 'MISSING')"
          echo "  - Express: $(test -f deploy/node_modules/express/package.json && echo 'OK' || echo 'MISSING')"

          # Detailed node_modules verification
          if [ -d deploy/node_modules ]; then
            echo "üì¶ Node modules details:"
            echo "  - Modules count: $(ls deploy/node_modules | wc -l)"
            echo "  - Express version: $(cat deploy/node_modules/express/package.json | grep '"version"' || echo 'Not found')"
            echo "  - Core modules present:"
            for module in express cors dotenv bcryptjs jsonwebtoken; do
              if [ -d "deploy/node_modules/$module" ]; then
                echo "    ‚úÖ $module"
              else
                echo "    ‚ùå $module (CRITICAL MISSING)"
              fi
            done
          else
            echo "‚ùå CRITICAL: node_modules directory missing completely"
            echo "üìã Deploy directory contents:"
            ls -la deploy/ || echo "Deploy directory not accessible"
            exit 1
          fi

          # Check file permissions and structure
          echo "üìÇ Deploy directory structure:"
          echo "  - Total files: $(find deploy -type f | wc -l)"
          echo "  - JavaScript files: $(find deploy -name '*.js' | wc -l)"
          echo "  - Index.js size: $(stat -c%s deploy/index.js 2>/dev/null || echo 'N/A') bytes"

          # Display package.json engines
          if [ -f deploy/package.json ]; then
            echo "  - Node version requirement: $(grep -A2 '"engines"' deploy/package.json || echo 'Not specified')"
          fi

      - name: Create deployment ZIP package
        run: |
          echo "üì¶ Creating deployment ZIP package..."
          cd deploy
          zip -r ../deploy.zip . -x "*.git*" -x "*.DS_Store" -x "*node_modules/.cache/*"
          cd ..
          echo "‚úÖ ZIP package created: deploy.zip"
          ls -lh deploy.zip

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: Emergency-Assistance
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy.zip
          clean: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FRONTEND_URL: "https://witty-river-012f39e00.1.azurestaticapps.net"
          NODE_ENV: "production"
          WEBSITE_NODE_DEFAULT_VERSION: "20-lts"
          SCM_DO_BUILD_DURING_DEPLOYMENT: "true"

      - name: Wait for app to be ready
        run: |
          APP_URL="https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net"

          echo "üöÄ Deployment completed"
          echo "‚è∞ Waiting 120 seconds for app startup..."
          sleep 120

          echo "üîç Starting health check..."

      - name: Health check
        run: |
          APP_URL="https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net"

          # First check /ping endpoint (lightweight)
          echo "üîç Checking /ping endpoint..."
          PING_SUCCESS=false
          
          for i in {1..5}; do
            echo "  Attempt $i/5 for /ping..."
            
            if curl -fsSL --retry 1 --retry-all-errors --max-time 10 "$APP_URL/ping" 2>/dev/null; then
              echo "  ‚úÖ SUCCESS - /ping is responding"
              PING_SUCCESS=true
              break
            else
              echo "  ‚ö†Ô∏è Attempt $i failed for /ping"
              if [ $i -lt 5 ]; then
                echo "  ‚è∞ Waiting 5 seconds before retry..."
                sleep 5
              fi
            fi
          done

          if [ "$PING_SUCCESS" = false ]; then
            echo "‚ùå /ping endpoint failed after 5 attempts"
            echo "üîç Trying /api/ping as fallback..."
            
            for i in {1..5}; do
              echo "  Attempt $i/5 for /api/ping..."
              
              if curl -fsSL --retry 1 --retry-all-errors --max-time 10 "$APP_URL/api/ping" 2>/dev/null; then
                echo "  ‚úÖ SUCCESS - /api/ping is responding"
                PING_SUCCESS=true
                break
              else
                echo "  ‚ö†Ô∏è Attempt $i failed for /api/ping"
                if [ $i -lt 5 ]; then
                  sleep 5
                fi
              fi
            done
          fi

          # Then check /health endpoint
          if [ "$PING_SUCCESS" = true ]; then
            echo "üîç Checking /health endpoint..."
            HEALTH_SUCCESS=false
            
            for i in {1..5}; do
              echo "  Attempt $i/5 for /health..."
              
              if curl -fsSL --retry 1 --retry-all-errors --max-time 10 "$APP_URL/health" 2>/dev/null; then
                echo "  ‚úÖ SUCCESS - /health is responding"
                HEALTH_SUCCESS=true
                break
              else
                echo "  ‚ö†Ô∏è Attempt $i failed for /health"
                if [ $i -lt 5 ]; then
                  sleep 5
                fi
              fi
            done

            if [ "$HEALTH_SUCCESS" = false ]; then
              echo "‚ö†Ô∏è /health failed, trying /api/health..."
              
              for i in {1..5}; do
                echo "  Attempt $i/5 for /api/health..."
                
                if curl -fsSL --retry 1 --retry-all-errors --max-time 10 "$APP_URL/api/health" 2>/dev/null; then
                  echo "  ‚úÖ SUCCESS - /api/health is responding"
                  HEALTH_SUCCESS=true
                  break
                else
                  echo "  ‚ö†Ô∏è Attempt $i failed for /api/health"
                  if [ $i -lt 5 ]; then
                    sleep 5
                  fi
                fi
              done
            fi
          fi

          if [ "$PING_SUCCESS" = true ] && [ "$HEALTH_SUCCESS" = true ]; then
            echo "‚úÖ Health check PASSED - Both ping and health endpoints are responding"

            # Additional verification with detailed health check
            echo "üîç Running detailed health verification..."
            if curl -f "$APP_URL/api/health" --max-time 30 --silent; then
              echo "‚úÖ Detailed health check also passed"
            else
              echo "‚ö†Ô∏è Detailed health check failed, but basic health is OK"
            fi

            exit 0
          else
            echo "‚ùå Health check failed - No endpoints responding after multiple attempts"
            echo "üìã Please check Azure App Service logs and deployment status"
            exit 1
          fi
