name: Deploy Server to Azure App Service (Oryx)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

concurrency:
  group: 'azure-appservice-deploy'
  cancel-in-progress: true

env:
  # æœ¬ç•ªã® App Service URLï¼ˆä¾‹: https://xxxx.azurewebsites.netï¼‰
  APP_URL: ${{ secrets.APP_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # å¿…é ˆSecretã®ç¢ºèªï¼ˆPublish Profileæ–¹å¼ï¼‰
      - name: Validate required secrets
        shell: bash
        run: |
          echo "ðŸ” Validating required secrets for Publish Profile deployment..."
          echo ""

          MISSING_SECRETS=()

          # Publish Profileæ–¹å¼ã«å¿…è¦ãªSecretã‚’ãƒã‚§ãƒƒã‚¯
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            MISSING_SECRETS+=("AZURE_WEBAPP_PUBLISH_PROFILE")
          fi

          if [ -z "${{ secrets.APP_URL }}" ]; then
            MISSING_SECRETS+=("APP_URL")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "ðŸ“‹ Quick Setup:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "ðŸ“ Required Secrets:"
            echo "   1. AZURE_WEBAPP_PUBLISH_PROFILE"
            echo "      - Azure Portal > App Service > Overview > Get publish profile"
            echo "      - Download .PublishSettings file and copy entire XML content"
            echo ""
            echo "   2. APP_URL"
            echo "      - Your App Service URL (e.g., https://your-app.azurewebsites.net)"
            echo ""
            exit 1
          fi

          echo "âœ… All required secrets are set"

      # Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆOryxãƒ“ãƒ«ãƒ‰ã¨åˆã‚ã›ã¦ä½¿ç”¨ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # package-lock.jsonåŒæœŸã®å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
          # cache: 'npm'

      # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ“ãƒ«ãƒ‰å‰ãƒã‚§ãƒƒã‚¯ï¼‰
      - name: Install dependencies
        shell: bash
        run: |
          echo "ðŸ”§ Clearing npm cache..."
          npm cache clean --force
          
          echo "ðŸ”§ Installing root dependencies..."
          npm install --no-audit --no-fund
          
          echo "ðŸ”§ Installing server dependencies..."
          cd server
          npm cache clean --force
          npm install --no-audit --no-fund      # åŸºæœ¬çš„ãªãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
      - name: Run build check
        shell: bash
        run: |
          echo "ðŸ” Checking server build..."
          cd server
          npm run build

          echo "âœ… Build check completed"

      # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
      - name: Pre-deploy validation
        shell: bash
        run: |
          echo "ðŸ“‹ Pre-deployment validation:"
          echo "   - Checking server/package.json..."
          test -f server/package.json || { echo "âŒ server/package.json not found"; exit 1; }

          echo "   - Checking server/azure-server.js..."
          test -f server/azure-server.js || { echo "âŒ server/azure-server.js not found"; exit 1; }

          echo "   - Checking server/web.config..."
          test -f server/web.config || { echo "âŒ server/web.config not found"; exit 1; }

          echo "âœ… All required files present"

      # Oryx Build ã‚’ç”¨ã„ãŸ App Service ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚µãƒ¼ãƒãƒ¼ã®ã¿ï¼‰
      - name: Deploy to Azure Web App (Oryx)
        uses: azure/webapps-deploy@v3
        with:
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./server
          # ðŸ”§ é‡è¦ï¼šä»¥ä¸‹ã®è¨­å®šã‚’Azure Portal > App Service > Configuration > Application settingsã§è¨­å®šã™ã‚‹:
          # - SCM_DO_BUILD_DURING_DEPLOYMENT=true (Oryxãƒ“ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–)
          # - WEBSITE_NODE_DEFAULT_VERSION=20-lts (Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³)
          # - NPM_CONFIG_PRODUCTION=false (devDependenciesã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)

      # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å¥å…¨æ€§ç¢ºèªï¼ˆæ®µéšŽçš„ãƒã‚§ãƒƒã‚¯ï¼‰
      - name: Wait for app to be ready (Health Check)
        env:
          APP_URL: ${{ env.APP_URL }}
          HEALTH_TOKEN: ${{ secrets.HEALTH_TOKEN }}
        shell: bash
        run: |
          set -eo pipefail
          if [ -z "${APP_URL}" ]; then
            echo "âŒ APP_URL is not set. Define it in GitHub Secrets (APP_URL)."
            exit 1
          fi

          echo "ðŸ“‹ Post-deployment health check for: ${APP_URL}"
          echo "â° Initial startup wait (180 seconds)..."
          sleep 180

          check_endpoint() {
            local url="$1"
            local timeout="${2:-10}"
            echo "ðŸ” Testing ${url} (timeout: ${timeout}s)"

            if [ -n "${HEALTH_TOKEN}" ]; then
              curl -fsSL --max-time "${timeout}" --retry 3 --retry-delay 10 \
                -H "x-health-token: ${HEALTH_TOKEN}" \
                "${url}" 2>/dev/null || return 1
            else
              curl -fsSL --max-time "${timeout}" --retry 3 --retry-delay 10 \
                "${url}" 2>/dev/null || return 1
            fi
          }

          # é †æ¬¡ãƒ†ã‚¹ãƒˆï¼ˆ1ã¤ã§ã‚‚æˆåŠŸã™ã‚Œã°OKï¼‰
          for endpoint in /live /ready /ping /api/ping /health /api/health; do
            if check_endpoint "${APP_URL}${endpoint}" 15; then
              echo "âœ… Health check PASSED: ${endpoint}"
              echo "ðŸš€ Deployment successful!"
              exit 0
            else
              echo "âš ï¸  ${endpoint} - Not available (continuing...)"
            fi
          done

          echo "âŒ All health check endpoints failed."
          echo "ðŸ“Š Manual verification required:"
          echo "   - Check Azure Portal > App Service > Log stream"
          echo "   - Verify environment variables are set correctly"
          echo "   - Check ${APP_URL} directly in browser"
          exit 1
