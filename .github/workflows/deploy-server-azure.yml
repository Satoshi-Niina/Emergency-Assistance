name: Deploy Server to Azure App Service (Oryx)

on:
  push:
    branches: ['main']
  workflow_dispatch: # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

permissions:
  contents: read

concurrency:
  group: 'azure-appservice-deploy'
  cancel-in-progress: true

env:
  # Êú¨Áï™„ÅÆ App Service URLÔºà‰æã: https://xxxx.azurewebsites.netÔºâ
  APP_URL: ${{ secrets.APP_URL }}
  # „Ç¨„Éº„Éâ„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ "false" „Å´„Åô„Çã
  ZIP_GUARD: 'true'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Azure„É≠„Ç∞„Ç§„É≥
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Zip/Artifact Á≥ª„ÅÆÊÆãÈ™∏„Åå„ÅÇ„Çå„Å∞ÊòéÁ§∫ÁöÑ„Å´Â§±Êïó„Åï„Åõ„ÇãÔºàÂé≥ÂØÜÂà§ÂÆö„Éª„Ç≥„É°„É≥„Éà„ÅØÁÑ°Ë¶ñÔºâ
      - name: Ensure no ZIP/artifact steps remain
        if: ${{ env.ZIP_GUARD != 'false' }}
        shell: bash
        run: |
          set -eo pipefail
          WF=".github/workflows/deploy-server-azure.yml"
          echo "üîé Checking residual zip/artifact usage in ${WF}"

          # „Ç≥„É°„É≥„ÉàË°å„ÇíÈô§Â§ñ„Åó„Å¶Ê§úÊüªÂØæË±°„ÇíÁîüÊàê
          awk '!/^[[:space:]]*#/' "${WF}" > /tmp/_wf.yml

          echo "üîé Searching for actions upload/download-artifact..."
          if grep -niE '^[[:space:]]*uses:[[:space:]]*actions/(upload-artifact|download-artifact)@' /tmp/_wf.yml; then
            echo "‚ùå Found actions/upload-artifact or actions/download-artifact. Remove them."; exit 1
          fi

          echo "üîé Searching for raw zip/unzip commands..."
          # zip/unzip „Ç≥„Éû„É≥„Éâ„ÅÆ„ÅøÊ§úÂá∫Ôºàgzip, gunzip Á≠â„Å´„ÅØ„Éû„ÉÉ„ÉÅ„Åó„Å™„ÅÑÔºâ
          if grep -niE '(^|[[:space:]])zip([[:space:]]|$|-)' /tmp/_wf.yml; then
            echo "‚ùå Found raw 'zip' command usage. Remove it."; exit 1
          fi
          if grep -niE '(^|[[:space:]])unzip([[:space:]]|$|-)' /tmp/_wf.yml; then
            echo "‚ùå Found raw 'unzip' command usage. Remove it."; exit 1
          fi

          echo "‚úÖ No residual ZIP/artifact steps found."

      # Oryx Build „ÇíÁî®„ÅÑ„Åü App Service „Éá„Éó„É≠„Ç§ÔºàZip Deploy „ÅØ‰ΩøÁî®„Åó„Å™„ÅÑÔºâ
      - name: Deploy to Azure Web App (Oryx)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME || 'emergency-assistance-bfckhjejb3fbf9du' }}
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
          package: .

      - name: Show Kudu deployment logs link
        shell: bash
        run: |
          echo "Kudu deployments:"
          echo "https://${{ secrets.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/deployments"

      # Ëµ∑ÂãïÂæÖ„Å° ‚Üí /live ‚Üí /ready ‚Üí /ping ‚Üí /api/ping ‚Üí /health ‚Üí /api/healthÔºàÊàêÂäü„Åó„Åü„ÇâÂç≥OKÔºâ
      - name: Wait for app to be ready (Health Check)
        env:
          APP_URL: ${{ env.APP_URL }}
          HEALTH_TOKEN: ${{ secrets.HEALTH_TOKEN }}
        shell: bash
        run: |
          set -eo pipefail
          if [ -z "${APP_URL}" ]; then
            echo "‚ùå APP_URL is not set. Define it in GitHub Secrets (APP_URL)."
            exit 1
          fi

          echo "‚è∞ Waiting 120 seconds for startup..."
          sleep 120

          check() {
            local url="$1"
            echo "üîç Checking ${url}"
            if [ -n "${HEALTH_TOKEN}" ]; then
              curl -fsSL --retry 5 --retry-all-errors --retry-delay 5 \
                -H "x-health-token: ${HEALTH_TOKEN}" \
                "${url}" > /dev/null
            else
              curl -fsSL --retry 5 --retry-all-errors --retry-delay 5 \
                "${url}" > /dev/null
            fi
          }

          for p in /live /ready /ping /api/ping /health /api/health; do
            if check "${APP_URL}${p}"; then
              echo "‚úÖ ${p} OK"
              exit 0
            fi
          done

          echo "‚ùå Health check failed for all endpoints."
          exit 1
