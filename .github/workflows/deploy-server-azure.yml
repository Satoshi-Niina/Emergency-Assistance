name: Deploy Server to Azure App Service (Simplified)

on:
  push:
    branches:
      - main
      - master
      - backup
    paths:
      - 'server/**'
      - 'shared/**'
      - 'knowledge-base/**'
      - '.github/workflows/deploy-server-azure.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Azure App Service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies (yarn fallback)
        working-directory: ./server
        run: |
          echo "üì¶ Installing server dependencies..."
          
          # Clean start
          rm -rf node_modules package-lock.json yarn.lock .npm .npmrc
          
          # Try yarn first (more stable in CI)
          if command -v yarn >/dev/null 2>&1; then
            echo "üîß Using yarn for stable installation..."
            yarn install --non-interactive --frozen-lockfile || yarn install --non-interactive
          else
            echo "üîß Installing yarn..."
            npm install -g yarn --no-audit --no-fund
            echo "üîß Using yarn for installation..."
            yarn install --non-interactive
          fi
          
          # Fallback to npm if yarn fails
          if [ ! -d "node_modules" ] || [ $(ls node_modules 2>/dev/null | wc -l) -lt 10 ]; then
            echo "‚ö†Ô∏è Yarn failed or insufficient modules, trying npm with specific approach..."
            rm -rf node_modules
            
            # Use npm with very basic approach
            NPM_CONFIG_AUDIT=false NPM_CONFIG_FUND=false npm install --no-optional --no-shrinkwrap
          fi
          
          # Verify installation
          echo "üì¶ Installation summary:"
          if [ -d "node_modules" ]; then
            MODULE_COUNT=$(ls node_modules 2>/dev/null | wc -l || echo '0')
            echo "  - Modules installed: $MODULE_COUNT"
            
            # Check critical dependencies
            for module in express cors dotenv bcryptjs; do
              if [ -d "node_modules/$module" ]; then
                echo "  ‚úÖ $module: Found"
              else
                echo "  ‚ùå $module: Missing"
              fi
            done
          else
            echo "  ‚ùå node_modules directory not created"
            exit 1
          fi

      - name: Prepare deployment package
        run: |
          echo "üì¶ Creating deployment package..."
          
          # Create deployment directory
          mkdir -p deploy
          
          # Copy server files
          cp -r server/* deploy/
          
          # Copy additional resources
          cp -r shared deploy/shared 2>/dev/null || echo "No shared directory"
          cp -r knowledge-base deploy/knowledge-base 2>/dev/null || echo "No knowledge-base directory"
          
          # Create required directories
          mkdir -p deploy/app-logs/{exports,history}
          mkdir -p deploy/uploads
          
          # Clean up
          rm -f deploy/.env* deploy/tsconfig*.json
          
          # Verify deployment package
          echo "üîç Deployment package verification:"
          echo "  - Entry point: $(test -f deploy/index.js && echo 'OK' || echo 'MISSING')"
          echo "  - Package.json: $(test -f deploy/package.json && echo 'OK' || echo 'MISSING')"
          echo "  - Node modules: $(test -d deploy/node_modules && echo 'OK' || echo 'MISSING')"
          echo "  - Express: $(test -f deploy/node_modules/express/package.json && echo 'OK' || echo 'MISSING')"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: Emergency-Assistance
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FRONTEND_URL: "https://witty-river-012f39e00.1.azurestaticapps.net"
          NODE_ENV: "production"
        
      - name: Health check
        run: |
          APP_URL="https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net"
          
          echo "üöÄ Deployment completed"
          echo "‚è∞ Starting health check in 30 seconds..."
          sleep 30
          
          # Health check with retries
          for i in {1..3}; do
            echo "üîç Health check attempt $i/3..."
            
            if curl -f "$APP_URL/api/health" --max-time 30 --silent; then
              echo "‚úÖ Health check PASSED - Server is responding"
              exit 0
            else
              echo "‚ö†Ô∏è Attempt $i failed"
              if [ $i -lt 3 ]; then
                sleep 60
              fi
            fi
          done
          
          echo "‚ùå Health check failed after 3 attempts"
          echo "üìã Please check Azure App Service logs"
          exit 1