name: Deploy Server to Azure App Service (Oryx)

on:
  push:
    branches: ['main']
  workflow_dispatch:

env:
  # „ÅÇ„Å™„Åü„ÅÆApp Service„ÅÆURL„Å´Âêà„Çè„Åõ„Å¶Â§âÊõ¥
  APP_URL: 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net'
  # ‰∏ÄÊôÇÁöÑ„Å´„Ç¨„Éº„Éâ„ÇíÁÑ°ÂäπÂåñ„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ 'false' „Å´„Åô„Çã
  ZIP_GUARD: 'true'

permissions:
  contents: read

concurrency:
  group: 'azure-appservice-deploy'
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Zip/ArtifactÁ≥ª„ÅÆÊÆãÈ™∏„Åå„ÅÇ„Çå„Å∞ÊòéÁ§∫ÁöÑ„Å´Â§±Êïó„Åï„Åõ„ÇãÔºà„Ç≥„É°„É≥„Éà„ÅØÈô§Â§ñÔºâ
      - name: Ensure no ZIP/artifact steps remain
        if: ${{ env.ZIP_GUARD != 'false' }}
        run: |
          awk '!/^[[:space:]]*#/' .github/workflows/deploy-server-azure.yml \
          | grep -RqiE '\b(uses:\s*actions/(upload-artifact|download-artifact)|[[:space:]]zip[[:space:]]|[[:space:]]unzip[[:space:]])' \
          && { echo "‚ùå Found residual ZIP/artifact steps. Remove them."; exit 1; } || echo "‚úÖ No ZIP/artifact steps found."

      # Oryx Build „ÇíÁî®„ÅÑ„Åü„Éá„Éó„É≠„Ç§ÔºàZip„ÅØ‰Ωø„Çè„Å™„ÅÑÔºâ
      - name: Deploy to Azure Web App (Oryx)
        uses: azure/webapps-deploy@v3
        with:
          # ‰æã: emergency-assistance „Å™„Å©„ÄÇApp ServiceÂêç„ÇíSecrets„Å´ÂÖ•„Çå„Å¶„Åä„Åè„ÅãÁõ¥Êõ∏„Åç„Åß„ÇÇÂèØ
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
          # ‚Üê „Åì„Åì„Åå„Éù„Ç§„É≥„Éà„ÄÇZIP„Åß„ÅØ„Å™„Åè„ÇΩ„Éº„Çπ‰∏ÄÂºè„Çí„Åù„ÅÆ„Åæ„ÅæÈÄÅ„Çã
          package: .

      - name: Show Kudu deployment logs link
        run: |
          echo "Kudu deployments: https://${{ secrets.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/deployments"

      # Ëµ∑ÂãïÂæÖ„Å° ‚Üí /live ‚Üí /ready ‚Üí /ping ‚Üí /api/ping ‚Üí /health ‚Üí /api/healthÔºàÊàêÂäü„Åó„Åü„ÇâÂç≥OKÔºâ
      - name: Wait for app to be ready (Health Check)
        env:
          APP_URL: ${{ env.APP_URL }}
          HEALTH_TOKEN: ${{ secrets.HEALTH_TOKEN }} # ‰ªªÊÑèË®≠ÂÆöÔºàApp Service „Å®‰∏ÄËá¥„Åï„Åõ„ÇãÔºâ
        run: |
          echo "‚è∞ Waiting 120 seconds for startup..."
          sleep 120
          check() {
            url="$1"
            echo "üîç Checking $url"
            if [ -n "${HEALTH_TOKEN}" ]; then
              curl -fsSL --retry 5 --retry-all-errors --retry-delay 5 \
                -H "x-health-token: ${HEALTH_TOKEN}" "$url" > /dev/null
            else
              curl -fsSL --retry 5 --retry-all-errors --retry-delay 5 "$url" > /dev/null
            fi
          }
          for p in /live /ready /ping /api/ping /health /api/health; do
            if check "${APP_URL}${p}"; then
              echo "‚úÖ $p OK"
              exit 0
            fi
          done
          echo "‚ùå Health check failed"
          exit 1
