name: Deploy Server (Docker Container)

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: 'server-docker-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  IMAGE_NAME: emergency-assistance
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Verify GitHub Repository Files
      run: |
        echo "剥 Verifying GitHub repository files before Docker build..."
        echo "搭 Commit SHA: ${{ github.sha }}"
        echo "搭 Branch: ${{ github.ref }}"
        echo ""

        # 驥崎ｦ√↑繝輔ぃ繧､繝ｫ縺ｮ蟄伜惠遒ｺ隱・        CRITICAL_FILES=(
          "server/azure-server.mjs"
          "server/lib/azure-storage.ts"
          "Dockerfile"
        )

        for file in "${CRITICAL_FILES[@]}"; do
          if [ -f "$file" ]; then
            FILE_SIZE=$(wc -c < "$file" 2>/dev/null || echo "0")
            LAST_MODIFIED=$(git log -1 --format="%ai" -- "$file" 2>/dev/null || echo "unknown")
            echo "笨・$file exists (size: $FILE_SIZE bytes, last modified: $LAST_MODIFIED)"
          else
            echo "笶・ERROR: $file not found in repository!"
            exit 1
          fi
        done

        # 繧ｵ繝ｼ繝舌・繝輔ぃ繧､繝ｫ縺ｮ蜀・ｮｹ遒ｺ隱・        echo ""
        echo "剥 Verifying server/azure-server.mjs content..."
        if grep -q "getBlobServiceClient" server/azure-server.mjs; then
          echo "笨・getBlobServiceClient function found"
        else
          echo "笶・ERROR: getBlobServiceClient function not found!"
          exit 1
        fi

        if grep -q "Testing BLOB connection" server/azure-server.mjs; then
          echo "笨・BLOB connection test found"
        else
          echo "笞・・WARNING: BLOB connection test not found"
        fi

        echo ""
        echo "笨・All critical files verified - Docker build will use these files"

    - name: Set Environment Variables
      id: configure-env
      run: |
        ENVIRONMENT="production"
        WEBAPP_NAME="${{ secrets.WEBAPP_NAME }}"
        RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
        APP_URL="${{ secrets.APP_URL }}"
        STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}"

        export ENVIRONMENT WEBAPP_NAME RESOURCE_GROUP APP_URL STATIC_WEB_APP_URL

        {
          echo "ENVIRONMENT=$ENVIRONMENT"
          echo "WEBAPP_NAME=$WEBAPP_NAME"
          echo "RESOURCE_GROUP=$RESOURCE_GROUP"
          echo "APP_URL=$APP_URL"
          echo "STATIC_WEB_APP_URL=$STATIC_WEB_APP_URL"
        } >> "$GITHUB_ENV"

        {
          echo "environment=$ENVIRONMENT"
          echo "webapp-name=$WEBAPP_NAME"
          echo "resource-group=$RESOURCE_GROUP"
          echo "app-url=$APP_URL"
          echo "static-web-app-url=$STATIC_WEB_APP_URL"
        } >> "$GITHUB_OUTPUT"

        echo "笨・Environment: $ENVIRONMENT"
        echo "迫 Backend: $APP_URL"
        echo "迫 Frontend: $STATIC_WEB_APP_URL"

    - name: Validate Required Secrets
      run: |
        echo "剥 Validating deployment secrets..."

        # Azure Container Registry
        if [ -z "${{ secrets.ACR_LOGIN_SERVER }}" ] || [ -z "${{ secrets.ACR_USERNAME }}" ] || [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
          echo "笶・Azure Container Registry secrets are missing"
          exit 1
        fi

        # Azure Resource Group
        if [ -z "$RESOURCE_GROUP" ]; then
          echo "笶・AZURE_RESOURCE_GROUP secret is missing"
          exit 1
        fi

        # Application secrets
        if [ -z "${{ secrets.DATABASE_URL }}" ]; then
          echo "笶・DATABASE_URL secret is missing"
          exit 1
        fi

        echo "笨・All required secrets validated"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Verify Docker Build Context
      run: |
        echo "剥 Verifying Docker build context..."
        echo "刀 Build context: . (repository root)"
        echo ""

        # Dockerfile縺悟ｭ伜惠縺吶ｋ縺狗｢ｺ隱・        if [ ! -f "Dockerfile" ]; then
          echo "笶・ERROR: Dockerfile not found!"
          exit 1
        fi

        # Dockerfile縺ｮ蜀・ｮｹ繧堤｢ｺ隱搾ｼ・OPY繧ｳ繝槭Φ繝峨′豁｣縺励＞縺具ｼ・        echo "搭 Dockerfile COPY commands:"
        grep -E "^COPY|^ADD" Dockerfile || echo "No COPY/ADD commands found"
        echo ""

        # 繧ｳ繝斐・縺輔ｌ繧九ヵ繧｡繧､繝ｫ縺悟ｭ伜惠縺吶ｋ縺狗｢ｺ隱・        echo "剥 Verifying files that will be copied into Docker image:"
        if [ -d "server" ]; then
          SERVER_FILES=$(find server -type f -name "*.mjs" -o -name "*.ts" | wc -l)
          echo "笨・server directory exists ($SERVER_FILES files)"
        else
          echo "笶・ERROR: server directory not found!"
          exit 1
        fi

        if [ -f "server/azure-server.mjs" ]; then
          FILE_SIZE=$(wc -c < server/azure-server.mjs)
          echo "笨・server/azure-server.mjs exists (size: $FILE_SIZE bytes)"
        else
          echo "笶・ERROR: server/azure-server.mjs not found!"
          exit 1
        fi

        echo ""
        echo "笨・Docker build context verified - all required files are present"

    - name: Build and Push Docker Image to ACR
      id: docker-build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        no-cache: true
        tags: |
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ steps.configure-env.outputs.environment }}-latest
        build-args: |
          NODE_ENV=${{ steps.configure-env.outputs.environment }}
          BUILDKIT_INLINE_CACHE=0
        cache-from: type=registry,ref=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=inline

    - name: Verify Docker Image Contents
      if: success()
      run: |
        echo "剥 Verifying Docker image contents..."
        IMAGE_TAG="${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "逃 Image: $IMAGE_TAG"
        echo ""

        # Docker繧､繝｡繝ｼ繧ｸ繧剃ｸ譎ら噪縺ｫ螳溯｡後＠縺ｦ繝輔ぃ繧､繝ｫ繧堤｢ｺ隱・        echo "剥 Checking files in Docker image..."
        docker run --rm --entrypoint sh "$IMAGE_TAG" -c "
          echo '=== Server files in image ==='
          ls -la /app/server/ | head -20
          echo ''
          echo '=== Checking critical server files ==='
          if [ -f /app/server/azure-server.mjs ]; then
            FILE_SIZE=\$(wc -c < /app/server/azure-server.mjs)
            echo '笨・azure-server.mjs found (size: '\$FILE_SIZE' bytes)'

            # 繝輔ぃ繧､繝ｫ縺ｮ蜀・ｮｹ繧堤｢ｺ隱・            if grep -q 'getBlobServiceClient' /app/server/azure-server.mjs; then
              echo '笨・getBlobServiceClient function found'
            else
              echo '笶・ERROR: getBlobServiceClient function not found!'
              exit 1
            fi

            if grep -q 'Testing BLOB connection' /app/server/azure-server.mjs; then
              echo '笨・BLOB connection test found'
            else
              echo '笞・・WARNING: BLOB connection test not found'
            fi
          else
            echo '笶・ERROR: azure-server.mjs not found in image!'
            exit 1
          fi

          if [ -f /app/server/lib/azure-storage.ts ]; then
            echo '笨・azure-storage.ts found'
          else
            echo '笞・・WARNING: azure-storage.ts not found (may be compiled)'
          fi

          echo ''
          echo '=== Client dist files ==='
          if [ -d /app/client/dist ]; then
            echo '笨・client/dist directory found'
            ls -la /app/client/dist/ | head -10
          else
            echo '笞・・WARNING: client/dist directory not found'
          fi
        " || {
          echo "笞・・Could not verify image contents directly (this is non-critical)"
          echo "庁 Image was built successfully, verification will happen at runtime"
        }

        echo ""
        echo "笨・Docker image verification completed"
        echo "搭 Image tag: $IMAGE_TAG"
        echo "搭 Commit SHA: ${{ github.sha }}"

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure App Service Environment Variables
      run: |
        echo "肌 Configuring App Service environment variables..."

        # DATABASE_URL縺ｮ讀懆ｨｼ・磯聞縺輔・縺ｿ縲∝・螳ｹ縺ｯ陦ｨ遉ｺ縺励↑縺・ｼ・        DB_URL="${{ secrets.DATABASE_URL }}"
        if [ -z "$DB_URL" ]; then
          echo "笶・ERROR: DATABASE_URL secret is empty!"
          exit 1
        fi
        DB_URL_LENGTH=${#DB_URL}
        echo "笨・DATABASE_URL length: $DB_URL_LENGTH characters"

        # Azure CLI縺ｮappsettings set繧ｳ繝槭Φ繝峨〒縺ｯ縲∝推險ｭ螳壹ｒ蛟句挨縺ｫ險ｭ螳壹☆繧区婿縺悟ｮ牙・
        echo "肌 Setting environment variables individually..."

        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            NODE_ENV=$ENVIRONMENT \
            PORT=8080 \
            PG_SSL=require \
            STORAGE_MODE=hybrid \
            LOCAL_EXPORT_DIR=/app/knowledge-base/exports \
            FAULT_HISTORY_IMAGES_DIR=/app/knowledge-base/images/chat-exports \
            DATABASE_BACKUP=false \
            WEBSITES_PORT=8080 \
            WEBSITES_CONTAINER_START_TIME_LIMIT=600 \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
          --output none

        # 讖溷ｯ・ュ蝣ｱ縺ｯ蛟句挨縺ｫ險ｭ螳夲ｼ亥ｼ慕畑隨ｦ縺ｧ蝗ｲ繧・・        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
          --output none

        # 繝輔Ο繝ｳ繝医お繝ｳ繝蔚RL險ｭ螳夲ｼ亥ｼ慕畑隨ｦ縺ｪ縺励〒險ｭ螳夲ｼ・        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            FRONTEND_URL=$STATIC_WEB_APP_URL \
            STATIC_WEB_APP_URL=$STATIC_WEB_APP_URL \
            CORS_ALLOW_ORIGINS=$STATIC_WEB_APP_URL,http://localhost:5173,http://localhost:8080 \
          --output none

        # 繧ｳ繝ｳ繝・リ蜷崎ｨｭ螳・        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
          --output none

        # AZURE_STORAGE_ACCOUNT_NAME縺瑚ｨｭ螳壹＆繧後※縺・ｋ蝣ｴ蜷医・霑ｽ蜉
        if [ -n "${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" ]; then
          az webapp config appsettings set \
            --resource-group "$RESOURCE_GROUP" \
            --name "$WEBAPP_NAME" \
            --settings \
              AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
            --output none
          echo "笨・AZURE_STORAGE_ACCOUNT_NAME set"
        else
          echo "笞・・AZURE_STORAGE_ACCOUNT_NAME not set (using connection string only)"
        fi

        # BLOB_PREFIX縺瑚ｨｭ螳壹＆繧後※縺・ｋ蝣ｴ蜷医・霑ｽ蜉
        if [ -n "${{ secrets.BLOB_PREFIX }}" ]; then
          az webapp config appsettings set \
            --resource-group "$RESOURCE_GROUP" \
            --name "$WEBAPP_NAME" \
            --settings \
              BLOB_PREFIX="${{ secrets.BLOB_PREFIX }}" \
            --output none
          echo "笨・BLOB_PREFIX set"
        fi

        echo "笨・Environment variables configured"

        # 險ｭ螳壹＆繧後◆迺ｰ蠅・､画焚繧堤｢ｺ隱搾ｼ域ｩ溷ｯ・ュ蝣ｱ縺ｯ繝槭せ繧ｯ・・        echo ""
        echo "剥 Verifying configured environment variables..."
        az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONNECTION_STRING' || name=='AZURE_STORAGE_ACCOUNT_NAME' || name=='AZURE_STORAGE_CONTAINER_NAME' || name=='BLOB_PREFIX'].{name:name, value:value}" \
          --output table || echo "笞・・Could not verify environment variables"

        # 迺ｰ蠅・､画焚縺ｮ蟄伜惠遒ｺ隱・        STORAGE_CONN_STR=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONNECTION_STRING'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -z "$STORAGE_CONN_STR" ]; then
          echo "笶・ERROR: AZURE_STORAGE_CONNECTION_STRING is not set in App Service!"
          exit 1
        else
          CONN_STR_LENGTH=${#STORAGE_CONN_STR}
          echo "笨・AZURE_STORAGE_CONNECTION_STRING is set (length: $CONN_STR_LENGTH)"
        fi

        STORAGE_ACCOUNT=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_ACCOUNT_NAME'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$STORAGE_ACCOUNT" ]; then
          echo "笨・AZURE_STORAGE_ACCOUNT_NAME is set: $STORAGE_ACCOUNT"
        else
          echo "笞・・AZURE_STORAGE_ACCOUNT_NAME is not set"
        fi

        STORAGE_CONTAINER=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONTAINER_NAME'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$STORAGE_CONTAINER" ]; then
          echo "笨・AZURE_STORAGE_CONTAINER_NAME is set: $STORAGE_CONTAINER"
        else
          echo "笞・・AZURE_STORAGE_CONTAINER_NAME is not set"
        fi

    - name: Deploy Docker Container to App Service
      run: |
        echo "正 Deploying Docker container to Azure App Service..."

        az webapp config container set \
          --name "$WEBAPP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --docker-custom-image-name ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --docker-registry-server-url https://${{ secrets.ACR_LOGIN_SERVER }} \
          --docker-registry-server-user ${{ secrets.ACR_USERNAME }} \
          --docker-registry-server-password ${{ secrets.ACR_PASSWORD }}

        echo "笨・Docker container configured"

        # Clear appCommandLine to use Dockerfile's CMD
        echo "肌 Clearing appCommandLine to use Dockerfile CMD..."
        az webapp config set \
          --name "$WEBAPP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --generic-configurations '{"appCommandLine":""}'

        echo "笨・appCommandLine cleared - Dockerfile CMD will be used"

    - name: Restart App Service
      run: |
        echo "売 Restarting App Service to pull new Docker image..."

        az webapp restart \
          --name "$WEBAPP_NAME" \
          --resource-group "$RESOURCE_GROUP"

        echo "笨・App Service restart initiated"

    - name: Wait for Container Startup
      run: |
        echo "竢ｳ Waiting for Docker container to start (60 seconds)..."
        sleep 60

    - name: Seed Database (Production Only)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "験 Seeding database with admin user..."

        # PostgreSQL 繧ｯ繝ｩ繧､繧｢繝ｳ繝医ｒ繧､繝ｳ繧ｹ繝医・繝ｫ
        sudo apt-get update -qq
        sudo apt-get install -y postgresql-client > /dev/null 2>&1

        # DATABASE_URL縺九ｉ謗･邯壽ュ蝣ｱ繧呈歓蜃ｺ縺励※螳溯｡・        echo "Executing seed script..."
        if psql "${{ secrets.DATABASE_URL }}" -f scripts/seed-admin-user.sql 2>&1 | grep -q "繧ｷ繝ｼ繝牙ｮ御ｺ・; then
          echo "笨・Database seeded successfully"
        else
          echo "笞・・ Seed script executed (check logs for details)"
        fi

    - name: Health Check
      continue-on-error: true
      run: |
        echo "唱 Verifying deployment health..."

        MAX_RETRIES=10
        RETRY_INTERVAL=10

        for attempt in $(seq 1 $MAX_RETRIES); do
          echo "剥 Health check attempt $attempt/$MAX_RETRIES..."

          # 繧ｷ繝ｳ繝励Ν縺ｪ /health 繧ｨ繝ｳ繝峨・繧､繝ｳ繝医ｒ繝√ぉ繝・け
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$APP_URL/health" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "笨・Health check passed (HTTP $HTTP_CODE)"

            # 隧ｳ邏ｰ縺ｪ繝倥Ν繧ｹ繝√ぉ繝・け繧ょｮ溯｡・            echo "投 Fetching detailed health info..."
            curl -s "$APP_URL/api/health/detailed" | head -n 20

            echo "脂 Deployment successful and server is responding"
            exit 0
          fi

          echo "竢ｳ Server not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
          [ $attempt -lt $MAX_RETRIES ] && sleep $RETRY_INTERVAL
        done

        echo "笞・・Health check timeout after $MAX_RETRIES attempts"
        echo "搭 Check logs: az webapp log tail --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP"
        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        echo "## 正 Docker Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${ENVIRONMENT} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Image | \`${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Web App | ${WEBAPP_NAME} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend URL | ${APP_URL} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend URL | ${STATIC_WEB_APP_URL} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "### 笨・Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Verification Commands:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Health check" >> $GITHUB_STEP_SUMMARY
          echo "curl ${APP_URL}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Detailed health" >> $GITHUB_STEP_SUMMARY
          echo "curl ${APP_URL}/api/health/detailed | jq" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# CORS test from frontend" >> $GITHUB_STEP_SUMMARY
          echo "curl -i -X OPTIONS ${APP_URL}/api/auth/login \\" >> $GITHUB_STEP_SUMMARY
          echo "  -H \"Origin: ${STATIC_WEB_APP_URL}\" \\" >> $GITHUB_STEP_SUMMARY
          echo '  -H "Access-Control-Request-Method: POST"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "az webapp log tail --name ${WEBAPP_NAME} --resource-group ${RESOURCE_GROUP}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### 笶・Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check workflow logs above" >> $GITHUB_STEP_SUMMARY
          echo "2. View container logs: \`az webapp log tail --name ${WEBAPP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check App Service status: \`az webapp show --name ${WEBAPP_NAME} --query state\`" >> $GITHUB_STEP_SUMMARY
        fi

# Trigger: 2025-11-25 10:15:49