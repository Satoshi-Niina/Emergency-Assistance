name: Deploy Server (Docker Container)

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: 'server-docker-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  IMAGE_NAME: emergency-assistance
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Verify GitHub Repository Files
      run: |
        echo "ğŸ” Verifying GitHub repository files before Docker build..."
        echo "ğŸ“‹ Commit SHA: ${{ github.sha }}"
        echo "ğŸ“‹ Branch: ${{ github.ref }}"
        echo ""

        # é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        CRITICAL_FILES=(
          "server/azure-server.mjs"
          "Dockerfile"
        )

        for file in "${CRITICAL_FILES[@]}"; do
          if [ -f "$file" ]; then
            FILE_SIZE=$(wc -c < "$file" 2>/dev/null || echo "0")
            LAST_MODIFIED=$(git log -1 --format="%ai" -- "$file" 2>/dev/null || echo "unknown")
            echo "âœ… $file exists (size: $FILE_SIZE bytes, last modified: $LAST_MODIFIED)"
          else
            echo "âŒ ERROR: $file not found in repository!"
            exit 1
          fi
        done

        # ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ç¢ºèª
        echo ""
        echo "ğŸ” Verifying server/azure-server.mjs content..."
        if grep -q "getBlobServiceClient" server/azure-server.mjs; then
          echo "âœ… getBlobServiceClient function found"
        else
          echo "âŒ ERROR: getBlobServiceClient function not found!"
          exit 1
        fi

        if grep -q "app.get('/api/knowledge'" server/azure-server.mjs; then
          echo "âœ… /api/knowledge route found"
        else
          echo "âŒ ERROR: /api/knowledge route not found!"
          exit 1
        fi

        if grep -q "Testing BLOB connection" server/azure-server.mjs; then
          echo "âœ… BLOB connection test found"
        else
          echo "âš ï¸ WARNING: BLOB connection test not found"
        fi

        echo ""
        echo "âœ… All critical files verified - Docker build will use these files"

    - name: Set Environment Variables
      id: configure-env
      run: |
        ENVIRONMENT="production"
        WEBAPP_NAME="${{ secrets.WEBAPP_NAME }}"
        RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
        APP_URL="${{ secrets.APP_URL }}"
        STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}"

        export ENVIRONMENT WEBAPP_NAME RESOURCE_GROUP APP_URL STATIC_WEB_APP_URL

        {
          echo "ENVIRONMENT=$ENVIRONMENT"
          echo "WEBAPP_NAME=$WEBAPP_NAME"
          echo "RESOURCE_GROUP=$RESOURCE_GROUP"
          echo "APP_URL=$APP_URL"
          echo "STATIC_WEB_APP_URL=$STATIC_WEB_APP_URL"
        } >> "$GITHUB_ENV"

        {
          echo "environment=$ENVIRONMENT"
          echo "webapp-name=$WEBAPP_NAME"
          echo "resource-group=$RESOURCE_GROUP"
          echo "app-url=$APP_URL"
          echo "static-web-app-url=$STATIC_WEB_APP_URL"
        } >> "$GITHUB_OUTPUT"

        echo "âœ… Environment: $ENVIRONMENT"
        echo "ğŸ”— Backend: $APP_URL"
        echo "ğŸ”— Frontend: $STATIC_WEB_APP_URL"

    - name: Validate Required Secrets
      run: |
        echo "ğŸ” Validating deployment secrets..."

        # Azure Resource Group
        if [ -z "$RESOURCE_GROUP" ]; then
          echo "âŒ AZURE_RESOURCE_GROUP secret is missing"
          exit 1
        fi

        # Application secrets
        if [ -z "${{ secrets.DATABASE_URL }}" ]; then
          echo "âŒ DATABASE_URL secret is missing"
          exit 1
        fi

        echo "âœ… All required secrets validated"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure App Service Environment Variables
      run: |
        echo "ğŸ”§ Configuring App Service environment variables..."

        # DATABASE_URLã®æ¤œè¨¼ï¼ˆé•·ã•ã®ã¿ã€å†…å®¹ã¯è¡¨ç¤ºã—ãªã„ï¼‰
        DB_URL="${{ secrets.DATABASE_URL }}"
        if [ -z "$DB_URL" ]; then
          echo "âŒ ERROR: DATABASE_URL secret is empty!"
          exit 1
        fi
        DB_URL_LENGTH=${#DB_URL}
        echo "âœ… DATABASE_URL length: $DB_URL_LENGTH characters"

        # Azure CLIã®appsettings setã‚³ãƒãƒ³ãƒ‰ã§ã¯ã€å„è¨­å®šã‚’å€‹åˆ¥ã«è¨­å®šã™ã‚‹æ–¹ãŒå®‰å…¨
        echo "ğŸ”§ Setting environment variables individually..."

        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            NODE_ENV=$ENVIRONMENT \
            PORT=8080 \
            PG_SSL=require \
            STORAGE_MODE=hybrid \
            KNOWLEDGE_BASE_PATH=/app/knowledge-base \
            LOCAL_EXPORT_DIR=/app/knowledge-base/exports \
            FAULT_HISTORY_IMAGES_DIR=/app/knowledge-base/images/chat-exports \
            DATABASE_BACKUP=false \
            WEBSITES_PORT=8080 \
            WEBSITES_CONTAINER_START_TIME_LIMIT=600 \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
          --output none

        # æ©Ÿå¯†æƒ…å ±ã¯å€‹åˆ¥ã«è¨­å®šï¼ˆå¼•ç”¨ç¬¦ã§å›²ã‚€ï¼‰
        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
            AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
            APPLICATIONINSIGHTS_CONNECTION_STRING="${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}" \
            ApplicationInsightsAgent_EXTENSION_VERSION="${{ secrets.ApplicationInsightsAgent_EXTENSION_VERSION }}" \
            XDT_MicrosoftApplicationInsights_Mode="${{ secrets.XDT_MicrosoftApplicationInsights_Mode }}" \
          --output none

        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰URLè¨­å®šï¼ˆå¼•ç”¨ç¬¦ãªã—ã§è¨­å®šï¼‰
        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            FRONTEND_URL=$STATIC_WEB_APP_URL \
            STATIC_WEB_APP_URL=$STATIC_WEB_APP_URL \
            CORS_ALLOW_ORIGINS=$STATIC_WEB_APP_URL,http://localhost:5173,http://localhost:8080 \
          --output none

        # Azure Container Registryèªè¨¼è¨­å®šï¼ˆDocker image pullç”¨ï¼‰
        echo "ğŸ” Configuring ACR authentication..."
        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            DOCKER_REGISTRY_SERVER_URL="https://${{ secrets.ACR_LOGIN_SERVER }}" \
            DOCKER_REGISTRY_SERVER_USERNAME="${{ secrets.ACR_USERNAME }}" \
            DOCKER_REGISTRY_SERVER_PASSWORD="${{ secrets.ACR_PASSWORD }}" \
          --output none
        echo "âœ… ACR authentication configured"

        # ã‚³ãƒ³ãƒ†ãƒŠåè¨­å®šï¼ˆä¸Šè¨˜ã®æ©Ÿå¯†æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¨­å®šæ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        echo "âœ… AZURE_STORAGE_CONTAINER_NAME already set in credentials section"

        # AZURE_STORAGE_ACCOUNT_NAMEï¼ˆä¸Šè¨˜ã®æ©Ÿå¯†æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¨­å®šæ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        echo "âœ… AZURE_STORAGE_ACCOUNT_NAME already set in credentials section"

        # BLOB_PREFIXãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¿½åŠ 
        if [ -n "${{ secrets.BLOB_PREFIX }}" ]; then
          az webapp config appsettings set \
            --resource-group "$RESOURCE_GROUP" \
            --name "$WEBAPP_NAME" \
            --settings \
              BLOB_PREFIX="${{ secrets.BLOB_PREFIX }}" \
            --output none
          echo "âœ… BLOB_PREFIX set"
        fi

        echo "âœ… Environment variables configured"

        # è¨­å®šã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªï¼ˆæ©Ÿå¯†æƒ…å ±ã¯ãƒã‚¹ã‚¯ï¼‰
        echo ""
        echo "ğŸ” Verifying configured environment variables..."
        az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONNECTION_STRING' || name=='AZURE_STORAGE_ACCOUNT_NAME' || name=='AZURE_STORAGE_CONTAINER_NAME' || name=='BLOB_PREFIX'].{name:name, value:value}" \
          --output table || echo "âš ï¸ Could not verify environment variables"

        # ç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ç¢ºèª
        STORAGE_CONN_STR=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONNECTION_STRING'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -z "$STORAGE_CONN_STR" ]; then
          echo "âŒ ERROR: AZURE_STORAGE_CONNECTION_STRING is not set in App Service!"
          exit 1
        else
          CONN_STR_LENGTH=${#STORAGE_CONN_STR}
          echo "âœ… AZURE_STORAGE_CONNECTION_STRING is set (length: $CONN_STR_LENGTH)"
        fi

        STORAGE_ACCOUNT=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_ACCOUNT_NAME'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$STORAGE_ACCOUNT" ]; then
          echo "âœ… AZURE_STORAGE_ACCOUNT_NAME is set: $STORAGE_ACCOUNT"
        else
          echo "âš ï¸ AZURE_STORAGE_ACCOUNT_NAME is not set"
        fi

        STORAGE_CONTAINER=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONTAINER_NAME'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$STORAGE_CONTAINER" ]; then
          echo "âœ… AZURE_STORAGE_CONTAINER_NAME is set: $STORAGE_CONTAINER"
        else
          echo "âš ï¸ AZURE_STORAGE_CONTAINER_NAME is not set"
        fi

    - name: Clean App Service Configuration
      run: |
        echo "ğŸ§¹ Cleaning App Service configuration for fresh deployment..."

        # é€²è¡Œä¸­ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒã‚§ãƒƒã‚¯
        echo "ğŸ” Checking for ongoing deployments..."
        ONGOING_DEPLOYMENT=$(az webapp deployment list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?provisioningState=='InProgress' || provisioningState=='Running'].id" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$ONGOING_DEPLOYMENT" ]; then
          echo "âš ï¸ WARNING: Ongoing deployment detected: $ONGOING_DEPLOYMENT"
          echo "â³ Waiting 30 seconds for deployment to complete..."
          sleep 30
        else
          echo "âœ… No ongoing deployments"
        fi

        # WEBSITE_RUN_FROM_PACKAGEè¨­å®šã®ç¢ºèªã¨å‰Šé™¤
        echo "ğŸ” Checking WEBSITE_RUN_FROM_PACKAGE setting..."
        CURRENT_SETTING=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$CURRENT_SETTING" ]; then
          echo "ğŸ”§ WEBSITE_RUN_FROM_PACKAGE found, removing..."
          az webapp config appsettings delete \
            --resource-group "$RESOURCE_GROUP" \
            --name "$WEBAPP_NAME" \
            --setting-names "WEBSITE_RUN_FROM_PACKAGE" \
            --output none

          # å‰Šé™¤ã‚’ç¢ºèª
          VERIFY_SETTING=$(az webapp config appsettings list \
            --resource-group "$RESOURCE_GROUP" \
            --name "$WEBAPP_NAME" \
            --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value" \
            --output tsv 2>/dev/null || echo "")

          if [ -z "$VERIFY_SETTING" ]; then
            echo "âœ… WEBSITE_RUN_FROM_PACKAGE successfully removed"
          else
            echo "âŒ ERROR: Failed to remove WEBSITE_RUN_FROM_PACKAGE"
            exit 1
          fi
        else
          echo "âœ… WEBSITE_RUN_FROM_PACKAGE not set (expected)"
        fi

        # App Service ã‚’åœæ­¢
        echo "ğŸ›‘ Stopping App Service..."
        az webapp stop \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME"

        # åœæ­¢å®Œäº†ã‚’å¾…ã¤
        echo "â³ Waiting for App Service to stop completely..."
        sleep 10

        # åœæ­¢ã‚’ç¢ºèª
        WEBAPP_STATE=$(az webapp show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "state" \
          --output tsv)

        echo "ğŸ“Š App Service State: $WEBAPP_STATE"

        # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå±¥æ­´ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
        echo "ğŸ§¹ Clearing deployment history..."
        az rest \
          --method delete \
          --uri "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Web/sites/$WEBAPP_NAME/deployments?api-version=2022-03-01" \
          2>/dev/null || echo "âš ï¸ Could not clear deployment history"

        # ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
        echo "ğŸ§¹ Clearing local cache..."
        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings WEBSITE_LOCAL_CACHE_OPTION=Never \
          --output none

        echo "âœ… Cache and deployment history cleared"

    - name: Verify Clean State Before Deployment
      run: |
        echo "ğŸ” Verifying App Service is ready for deployment..."

        # WEBSITE_RUN_FROM_PACKAGE ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        SETTING_CHECK=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$SETTING_CHECK" ]; then
          echo "âŒ ERROR: WEBSITE_RUN_FROM_PACKAGE still exists!"
          echo "âš ï¸ This should have been removed in the previous step"
          exit 1
        fi
        echo "âœ… WEBSITE_RUN_FROM_PACKAGE confirmed removed"

        # é€²è¡Œä¸­ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒãªã„ã“ã¨ã‚’ç¢ºèª
        ONGOING=$(az webapp deployment list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?provisioningState=='InProgress' || provisioningState=='Running'].id" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$ONGOING" ]; then
          echo "âŒ ERROR: Deployment still in progress: $ONGOING"
          echo "âš ï¸ Cannot proceed with new deployment"
          exit 1
        fi
        echo "âœ… No ongoing deployments"

        # App Service ã®çŠ¶æ…‹ã‚’ç¢ºèª
        STATE=$(az webapp show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "state" \
          --output tsv)

        echo "ğŸ“Š App Service State: $STATE"
        echo "âœ… App Service is ready for deployment"

    - name: Deploy Docker Container to App Service
      run: |
        echo "ğŸš€ Deploying server application to Azure App Service..."

        # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ
        echo "ğŸ“¦ Creating deployment package..."
        mkdir -p /tmp/deploy
        cd /tmp/deploy

        # server ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ãƒ«ãƒ¼ãƒˆã«ã‚³ãƒ”ãƒ¼ï¼ˆApp Service ãŒ server ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ï¼‰
        echo "ğŸ“‚ Preparing application files..."
        cp -r "$GITHUB_WORKSPACE/server/"* .

        # server/package*.json ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        if [ ! -f "package.json" ]; then
          echo "âŒ ERROR: package.json not found after copying server files!"
          ls -la
          exit 1
        fi

        # node_modulesã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã€ZIPã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ï¼‰
        if [ -d "node_modules" ]; then
          echo "ğŸ§¹ Removing existing node_modules..."
          rm -rf node_modules
        fi

        # .zipignoreã‚’ä½œæˆã—ã¦node_modulesã‚’é™¤å¤–
        cat > .zipignore << 'ZIPIGNORE'
        node_modules/
        .git/
        .github/
        *.log
        .DS_Store
        ZIPIGNORE

        echo "âœ… Application files prepared (without node_modules)"
        echo "ğŸ“‹ Files in deploy directory:"
        ls -la | head -20

        # web.config ã¯ server/web.config ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½œæˆã—ãªã„
        echo "âœ… Using existing web.config from server directory"

        # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        echo "ğŸ“ Generating version.txt..."
        echo "Commit: ${{ github.sha }}" > version.txt
        echo "Build Time: $(date -u)" >> version.txt
        echo "âœ… version.txt created"

        # ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆnode_modulesã‚’é™¤å¤–ï¼‰
        echo "ğŸ“¦ Creating ZIP archive (excluding node_modules)..."
        zip -r -q /tmp/deploy.zip . -x "node_modules/*" "node_modules/**/*" ".git/*" ".github/*" "*.log"
        DEPLOY_SIZE=$(du -h /tmp/deploy.zip | cut -f1)
        echo "âœ… ZIP created (${DEPLOY_SIZE})"

        # App Service ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆéåŒæœŸãƒ¢ãƒ¼ãƒ‰ + ã‚¯ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
        echo "ğŸš€ Uploading to App Service..."
        echo "â±ï¸ Large deployments may take several minutes..."

        # ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
        echo "ğŸ”§ Configuring deployment settings..."
        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            SCM_DO_BUILD_DURING_DEPLOYMENT=true \
            WEBSITE_NODE_DEFAULT_VERSION=20-lts \
            WEBSITE_RUN_FROM_PACKAGE=0 \
            WEBSITE_USE_ZIP=0 \
          --output none

        # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç¶™ç¶šã‚’è¨±å¯ï¼‰
        echo "ğŸš€ Deploying via Azure CLI..."
        
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ&ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
        (az webapp deployment source config-zip \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --src /tmp/deploy.zip 2>&1 | tee /tmp/deploy_log.txt) &
        
        DEPLOY_PID=$!
        echo "âœ… Deployment started (PID: $DEPLOY_PID)"
        
        # 2åˆ†é–“ã ã‘å¾…æ©Ÿ
        echo "â³ Waiting 2 minutes for initial deployment..."
        sleep 120
        
        # ãƒ—ãƒ­ã‚»ã‚¹ãŒã¾ã å®Ÿè¡Œä¸­ã‹ç¢ºèª
        if kill -0 $DEPLOY_PID 2>/dev/null; then
          echo "â³ Deployment still in progress, continuing in background..."
          echo "ğŸ“‹ Last log lines:"
          tail -10 /tmp/deploy_log.txt || true
        else
          wait $DEPLOY_PID
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Deployment completed successfully"
          else
            echo "âš ï¸ Deployment exited with code $EXIT_CODE"
            tail -20 /tmp/deploy_log.txt || true
          fi
        fi
        
        echo "ğŸ“ Check status at: https://${WEBAPP_NAME}.scm.japanwest-01.azurewebsites.net/api/deployments/latest"

        # çŸ­æ™‚é–“ã®å¾…æ©Ÿã®ã¿ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç¶™ç¶šï¼‰
        echo "â³ Waiting 30 seconds for deployment to start..."
        sleep 30
        
        echo "âœ… Deployment in progress"
        echo "ğŸ“‹ The deployment will continue in background on Azure"
        echo "ğŸ“‹ It may take 10-15 minutes to complete"
        echo "ğŸ“‹ Monitor at: https://${WEBAPP_NAME}.scm.japanwest-01.azurewebsites.net/api/deployments/latest"

    - name: Restart App Service
      run: |
        echo "â³ Waiting for deployment to settle (60 seconds)..."
        sleep 60
        
        echo "ğŸ”„ Restarting App Service..."
        az webapp restart \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME"

        echo "âœ… App Service restart initiated"
        echo "â³ Waiting for startup (60 seconds)..."
        sleep 60

    - name: Configure Node.js Runtime for App Service
      run: |
        echo "ğŸ”§ Configuring Node.js runtime..."

        # Docker ã‚³ãƒ³ãƒ†ãƒŠãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ è¨­å®šã¯ä¸è¦
        # ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯Dockerfileã§æŒ‡å®šæ¸ˆã¿
        echo "âœ… Using Docker container runtime (configured in Dockerfile)"

    - name: Check App Service Deployment Status
      run: |
        echo "ğŸ” Checking App Service deployment status..."

        # App Service ã®çŠ¶æ…‹ã‚’ç¢ºèª
        WEBAPP_STATE=$(az webapp show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "state" \
          --output tsv)

        echo "ğŸ”„ App Service State: $WEBAPP_STATE"

        # Dockerã‚³ãƒ³ãƒ†ãƒŠè¨­å®šã‚’ç¢ºèª
        echo "ğŸ³ Docker Container Configuration:"
        az webapp config container show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "{image: '[0].value', registryUrl: '[1].value'}" \
          --output json || echo "âš ï¸  Could not retrieve container configuration"

        # App ServiceãŒç¨¼åƒä¸­ã‹ç¢ºèª
        if [ "$WEBAPP_STATE" = "Running" ]; then
          echo "âœ… App Service is running"
        else
          echo "âš ï¸  App Service state: $WEBAPP_STATE"
        fi

    - name: View App Service Logs
      continue-on-error: true
      run: |
        echo "ğŸ“‹ Fetching App Service logs..."

        # ç°¡å˜ãªãƒ­ã‚°å–å¾—ã‚’è©¦ã¿ã‚‹
        az webapp log show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          || echo "âš ï¸ Could not fetch logs via az command"

        # ä»£æ›¿æ–¹æ³•: Kudu API ã‚’é€šã˜ãŸãƒ­ã‚°å–å¾—æƒ…å ±ã‚’è¡¨ç¤º
        echo ""
        echo "ğŸ“Œ To view detailed logs, visit Kudu console at:"
        echo "https://$WEBAPP_NAME-gwgscxcca5cahyb9.scm.japanwest-01.azurewebsites.net/api/logs/docker"

    - name: Wait for Container Startup
      run: |
        echo "â³ Waiting for application to start (60 seconds)..."
        sleep 60

    - name: Seed Database (Production Only)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸŒ± Seeding database with admin user..."

        # PostgreSQL ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        sudo apt-get update -qq
        sudo apt-get install -y postgresql-client > /dev/null 2>&1

        # DATABASE_URLã‹ã‚‰æ¥ç¶šæƒ…å ±ã‚’æŠ½å‡ºã—ã¦å®Ÿè¡Œ
        echo "Executing seed script..."
        if psql "${{ secrets.DATABASE_URL }}" -f scripts/seed-admin-user.sql 2>&1 | grep -q "ã‚·ãƒ¼ãƒ‰å®Œäº†"; then
          echo "âœ… Database seeded successfully"
        else
          echo "âš ï¸  Seed script executed (check logs for details)"
        fi

    - name: Health Check
      continue-on-error: true
      run: |
        echo "ğŸ¥ Verifying deployment health..."

        MAX_RETRIES=15
        RETRY_INTERVAL=15

        for attempt in $(seq 1 $MAX_RETRIES); do
          echo "ğŸ” Health check attempt $attempt/$MAX_RETRIES..."

          # ã‚·ãƒ³ãƒ—ãƒ«ãª /health ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¡¨ç¤ºï¼‰
          HTTP_CODE=$(curl -s -o /tmp/health_response.txt -w "%{http_code}" --max-time 15 "$APP_URL/health" 2>&1 | tail -n 1 || echo "000")
          
          # curlã®ã‚¨ãƒ©ãƒ¼ã‚‚ç¢ºèª
          if [ -f /tmp/health_response.txt ]; then
            RESPONSE_BODY=$(cat /tmp/health_response.txt)
            echo "ğŸ“‹ Response body: $RESPONSE_BODY"
          fi

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"

            # è©³ç´°ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚‚å®Ÿè¡Œ
            echo "ğŸ“Š Fetching detailed health info..."
            curl -s "$APP_URL/api/health/detailed" | head -n 20 || echo "âš ï¸ Detailed health check failed, but basic health check passed"

            echo "ğŸ‰ Deployment successful and server is responding"
            exit 0
          fi

          echo "â³ Server not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
          [ $attempt -lt $MAX_RETRIES ] && sleep $RETRY_INTERVAL
        done

        echo "âš ï¸ Health check timeout after $MAX_RETRIES attempts (total wait time: $((MAX_RETRIES * RETRY_INTERVAL))s)"
        echo "ğŸ“‹ This is a warning, not a failure. The deployment may still be successful."
        echo "ğŸ“‹ Check logs: az webapp log tail --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP"
        echo "ğŸ“‹ Or visit: $APP_URL/health"
        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        echo "## ğŸ³ Docker Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${ENVIRONMENT} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Image | \`${{ env.IMAGE_NAME }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Web App | ${WEBAPP_NAME} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend URL | ${APP_URL} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend URL | ${STATIC_WEB_APP_URL} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Verification Commands:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Health check" >> $GITHUB_STEP_SUMMARY
          echo "curl ${APP_URL}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Detailed health" >> $GITHUB_STEP_SUMMARY
          echo "curl ${APP_URL}/api/health/detailed | jq" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# CORS test from frontend" >> $GITHUB_STEP_SUMMARY
          echo "curl -i -X OPTIONS ${APP_URL}/api/auth/login \\" >> $GITHUB_STEP_SUMMARY
          echo "  -H \"Origin: ${STATIC_WEB_APP_URL}\" \\" >> $GITHUB_STEP_SUMMARY
          echo '  -H "Access-Control-Request-Method: POST"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "az webapp log tail --name ${WEBAPP_NAME} --resource-group ${RESOURCE_GROUP}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check workflow logs above" >> $GITHUB_STEP_SUMMARY
          echo "2. View container logs: \`az webapp log tail --name ${WEBAPP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check App Service status: \`az webapp show --name ${WEBAPP_NAME} --query state\`" >> $GITHUB_STEP_SUMMARY
        fi

# Trigger: 2025-11-25 10:19:22
