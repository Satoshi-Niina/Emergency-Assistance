name: Deploy Server (Azure App Service)

# æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰å¤ã„å®Ÿè¡Œã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: deploy-server-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    # pathsè¨­å®šã‚’å‰Šé™¤ - mainã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Server to Azure App Service
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1
          lfs: false

      - name: Verify package-lock.json exists
        run: |
          echo "ğŸ“‹ Checking for package-lock.json files..."
          ls -la package-lock.json || echo "âŒ Root package-lock.json not found"
          ls -la client/package-lock.json || echo "âŒ Client package-lock.json not found"
          ls -la server/package-lock.json || echo "âš ï¸ Server package-lock.json not found (expected)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install and build shared module (first)
        run: |
          echo "ğŸ“¦ Installing shared dependencies..."
          cd shared
          npm install --no-audit --no-fund
          echo "ğŸ”¨ Building shared module..."
          npm run build
          echo "âœ… Shared module built"

      - name: Install server dependencies
        run: |
          echo "ğŸ“¦ Installing server dependencies..."
          cd server
          
          # å¤ã„node_modulesã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ§¹ Cleaning old node_modules..."
          rm -rf node_modules
          
          # æœ¬ç•ªç”¨ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆpackage-lock.jsonãŒãªã„å ´åˆã¯npm installï¼‰
          if [ -f "package-lock.json" ]; then
            echo "Using npm ci with package-lock.json"
            npm ci --omit=dev --no-audit --no-fund
          else
            echo "âš ï¸ package-lock.json not found, using npm install"
            npm install --omit=dev --no-audit --no-fund
          fi
          
          echo "âœ… Server dependencies installed"
          echo "ğŸ“‹ Verifying .mjs files exist:"
          ls -lh *.mjs | head -5

      - name: Create web.config for Azure App Service
        run: |
          cat > server/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <security>
                <requestFiltering>
                  <hiddenSegments>
                    <remove segment="bin"/>
                  </hiddenSegments>
                </requestFiltering>
              </security>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          EOF
          echo "âœ… web.config created"
      
      - name: Create deployment package (all source files)
        timeout-minutes: 5
        run: |
          echo "ğŸ“¦ Creating fresh deployment package..."
          cd server
          
          # ä¸€æ„ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ
          TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-8)
          
          echo "Deployment Timestamp: $TIMESTAMP" > DEPLOY_INFO.txt
          echo "Git Commit: $COMMIT_SHORT" >> DEPLOY_INFO.txt
          echo "Workflow Run: ${{ github.run_number }}" >> DEPLOY_INFO.txt
          echo "Random ID: $RANDOM" >> DEPLOY_INFO.txt
          
          # å…¨ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’zipã«å«ã‚ã‚‹ï¼ˆnode_modulesé™¤å¤–ã€Azureå´ã§npm installï¼‰
          echo "Including all source files for fresh deployment..."
          zip -r ../server-deploy.zip \
            package.json \
            package-lock.json \
            azure-server.mjs \
            app.js \
            server.js \
            fallback-server.js \
            web.config \
            DEPLOY_INFO.txt \
            routes/ \
            middleware/ \
            services/ \
            utils/ \
            config/ \
            db/ \
            lib/ \
            types/ \
            -x "*.git*" "*.log" ".npm/*" "*.ts" "tsconfig.*" "*.test.*" "*.spec.*" "dist/*" "node_modules/*" "uploads/*"
          
          cd ..
          echo "âœ… Deployment zip created: server-deploy.zip"
          ls -lh server-deploy.zip
          
          # zipã®å†…å®¹ã‚’ç¢ºèª
          echo "ğŸ“‹ Package contents:"
          unzip -l server-deploy.zip
          
          # azure-server.mjsãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          echo "ğŸ” Verifying azure-server.mjs in package:"
          unzip -l server-deploy.zip | grep "azure-server.mjs" || echo "âŒ ERROR: azure-server.mjs not found in package!"

      - name: Stop Azure App Service (å¤ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Œå…¨åœæ­¢)
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "ğŸ›‘ App Serviceã‚’å®Œå…¨åœæ­¢..."
            az webapp stop \
              --name ${{ secrets.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
            
            echo "â³ åœæ­¢å®Œäº†ã‚’å¾…æ©Ÿï¼ˆ10ç§’ï¼‰..."
            sleep 10

      - name: Clear Azure App Service cache
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "ğŸ§¹ App Serviceã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢..."
            
            # KuduçµŒç”±ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªã‚¢
            PUBLISH_PROFILE=$(az webapp deployment list-publishing-profiles \
              --name ${{ secrets.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --xml | grep publishUrl | sed -n 's/.*<publishUrl>\(.*\)<\/publishUrl>.*/\1/p' | head -1)
            
            echo "Kuduã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${PUBLISH_PROFILE}"
            
            # node_modulesã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
            KUDU_URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net"
            echo "ğŸ—‘ï¸ KuduçµŒç”±ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢: ${KUDU_URL}"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          package: server-deploy.zip
          clean: true

      - name: Wait for deployment extraction
        run: |
          echo "â³ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹ã‚’å¾…æ©Ÿï¼ˆ40ç§’ï¼‰..."
          sleep 40

      - name: Start Azure App Service (æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã§èµ·å‹•)
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "â–¶ï¸ App Serviceã‚’èµ·å‹•..."
            az webapp start \
              --name ${{ secrets.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
            
            echo "â³ èµ·å‹•å®Œäº†ã‚’å¾…æ©Ÿï¼ˆ30ç§’ï¼‰..."
            sleep 30
            
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
            echo "âœ… App Serviceå†èµ·å‹•å®Œäº†"

      - name: Set environment variables on Azure App Service
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "âš™ï¸ Setting new app settings..."
            
            az webapp config appsettings set \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }} \
              --settings \
                NODE_ENV=production \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                PG_SSL="${{ secrets.PG_SSL }}" \
                SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
                STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}" \
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
                AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
                AZURE_STORAGE_CONTAINER_NAME=knowledge \
                BLOB_PREFIX=knowledge-base/ \
                STORAGE_MODE=azure \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                OPENAI_MAX_TOKENS=2000 \
                DEBUG_MODE=false \
                VERBOSE_LOGGING=false \
                SCM_DO_BUILD_DURING_DEPLOYMENT=true \
                WEBSITE_NODE_DEFAULT_VERSION=20-lts \
                WEBSITE_RUN_FROM_PACKAGE=0 \
                WEBSITE_LOCAL_CACHE_OPTION=Never \
                WEBSITE_DYNAMIC_CACHE=0 \
                WEBSITES_ENABLE_APP_SERVICE_STORAGE=true
            
            echo "âœ… App settings configured successfully"

      - name: Seed admin user to database
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "ğŸŒ± Seeding admin user to production database..."
            
            # PostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            apt-get update -qq && apt-get install -y postgresql-client > /dev/null 2>&1
            
            # SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
            psql "${{ secrets.DATABASE_URL }}" -c "
              INSERT INTO users (username, password, role, display_name, department, created_at, updated_at)
              VALUES (
                'niina',
                '\$2a\$10\$w9kGZVYX8yqK5YJ3p7H.4eN8Z9M0xQ1K2L3M4N5O6P7Q8R9S0T1U2V',
                'admin',
                'ç®¡ç†è€…',
                'æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨',
                NOW(),
                NOW()
              )
              ON CONFLICT (username) DO UPDATE SET
                password = EXCLUDED.password,
                updated_at = NOW();
            " || echo "âš ï¸ User seed may have failed, but continuing..."
            
            echo "âœ… Admin user seeded"

      - name: Restart App Service to load new package
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "ğŸ”„ Restarting App Service to ensure new package is loaded..."
            az webapp restart \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }}
            
            echo "âœ… App Service restarted"
            echo "â³ Waiting 30 seconds for app to fully start..."
            sleep 30

      - name: Verify deployment
        run: |
          echo "âœ… Deployment completed"
          echo "ğŸ” Checking application health..."
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          HEALTH_URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          echo "ğŸ¥ Checking health endpoint: $HEALTH_URL"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $RESPONSE)"
          else
            echo "âš ï¸ Health check returned HTTP $RESPONSE"
            echo "   This may be normal if the app is still starting up"
          fi

# Trigger: 2025-11-30 15:30 - Deploy with environment variable management
