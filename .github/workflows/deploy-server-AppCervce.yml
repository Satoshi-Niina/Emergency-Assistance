name: Deploy Server (Azure App Service)

on:
  push:
    branches:
      - main
    # pathsË®≠ÂÆö„ÇíÂâäÈô§ - main„Å∏„ÅÆ„Éó„ÉÉ„Ç∑„É•„ÅßÂ∏∏„Å´„Éá„Éó„É≠„Ç§
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Server to Azure App Service
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1
          lfs: false

      - name: Verify package-lock.json exists
        run: |
          echo "üìã Checking for package-lock.json files..."
          ls -la package-lock.json || echo "‚ùå Root package-lock.json not found"
          ls -la client/package-lock.json || echo "‚ùå Client package-lock.json not found"
          ls -la server/package-lock.json || echo "‚ö†Ô∏è Server package-lock.json not found (expected)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install and build shared module (first)
        run: |
          echo "üì¶ Installing shared dependencies..."
          cd shared
          npm install --no-audit --no-fund
          echo "üî® Building shared module..."
          npm run build
          echo "‚úÖ Shared module built"

      - name: Install server dependencies
        run: |
          echo "üì¶ Installing server dependencies..."
          cd server
          
          # Âè§„ÅÑnode_modules„ÇíÂâäÈô§„Åó„Å¶„ÇØ„É™„Éº„É≥„Ç§„É≥„Çπ„Éà„Éº„É´
          echo "üßπ Cleaning old node_modules..."
          rm -rf node_modules
          
          # Êú¨Áï™Áî®„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
          npm ci --omit=dev --no-audit --no-fund
          
          echo "‚úÖ Server dependencies installed"
          echo "üìã Verifying .mjs files exist:"
          ls -lh *.mjs | head -5
      
      - name: Create deployment package
        run: |
          echo "üì¶ Creating deployment package..."
          cd server
          
          # „Éá„Éó„É≠„Ç§„Å´ÂøÖË¶Å„Å™„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Çízip„Å´Âê´„ÇÅ„Çã
          # .mjs„Éï„Ç°„Ç§„É´„ÄÅnode_modules„ÄÅpackage.json„ÄÅweb.config
          zip -r ../server-deploy.zip \
            node_modules/ \
            package.json \
            package-lock.json \
            azure-server.mjs \
            app.js \
            server.js \
            fallback-server.js \
            web.config \
            -x "*.git*" "*.log" ".npm/*" "src/*" "*.ts" "tsconfig.*" "*.test.*" "*.spec.*" "dist/*"
          
          cd ..
          echo "‚úÖ Deployment zip created: server-deploy.zip"
          ls -lh server-deploy.zip
          
          # zip„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç
          echo "üìã Package contents (first 30 files):"
          unzip -l server-deploy.zip | head -30
          
          # azure-server.mjs„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
          echo "üîç Verifying azure-server.mjs in package:"
          unzip -l server-deploy.zip | grep "azure-server.mjs" || echo "‚ùå ERROR: azure-server.mjs not found in package!"

      - name: Create web.config for Azure App Service
        run: |
          cat > server/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <security>
                <requestFiltering>
                  <hiddenSegments>
                    <remove segment="bin"/>
                  </hiddenSegments>
                </requestFiltering>
              </security>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          EOF
          echo "‚úÖ web.config created"

      # Note: App Service supports zero-downtime deployment
      # No need to stop the service - new files will be deployed seamlessly

      - name: Stop App Service for clean deployment
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üõë Stopping App Service for clean deployment..."
            az webapp stop \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }}
            echo "‚úÖ App Service stopped"

      - name: Clean deployment cache
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üßπ Cleaning deployment cache and old files..."
            WEBAPP_NAME="${{ secrets.AZURE_WEBAPP_NAME }}"
            
            # Kudu API„Åß„Éï„Ç°„Ç§„É´ÂâäÈô§ÔºàÁ¢∫ÂÆü„Å´Âè§„ÅÑ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§Ôºâ
            CREDS=$(az webapp deployment list-publishing-credentials \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name "$WEBAPP_NAME" \
              --query "{username:publishingUserName, password:publishingPassword}" \
              -o json)
            
            USERNAME=$(echo $CREDS | jq -r '.username')
            PASSWORD=$(echo $CREDS | jq -r '.password')
            
            # ‰∏ªË¶Å„Å™„Éï„Ç°„Ç§„É´/„Éï„Ç©„É´„ÉÄ„ÇíÂÄãÂà•„Å´ÂâäÈô§
            for path in "node_modules" "dist" "*.js" "*.mjs" "package.json"; do
              echo "Deleting: $path"
              curl -X DELETE "https://${WEBAPP_NAME}.scm.azurewebsites.net/api/vfs/site/wwwroot/$path" \
                -u "$USERNAME:$PASSWORD" \
                -H "If-Match: *" 2>/dev/null || true
            done
            
            echo "‚úÖ Old files cleared"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          package: server-deploy.zip
          
      - name: Verify deployment package was uploaded
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üîç Verifying deployment..."
            WEBAPP_NAME="${{ secrets.AZURE_WEBAPP_NAME }}"
            
            # Kudu API„Åß„Éï„Ç°„Ç§„É´Á¢∫Ë™ç
            CREDS=$(az webapp deployment list-publishing-credentials \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name "$WEBAPP_NAME" \
              --query "{username:publishingUserName, password:publishingPassword}" \
              -o json)
            
            USERNAME=$(echo $CREDS | jq -r '.username')
            PASSWORD=$(echo $CREDS | jq -r '.password')
            
            # „Éá„Éó„É≠„Ç§„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç
            echo "üìã Checking deployed files:"
            curl -s "https://${WEBAPP_NAME}.scm.azurewebsites.net/api/vfs/site/wwwroot/" \
              -u "$USERNAME:$PASSWORD" | jq -r '.[].name' | head -10 || echo "‚ö†Ô∏è Could not list files"
            
            echo "‚úÖ Deployment verification completed"

      - name: Set environment variables on Azure App Service
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "‚öôÔ∏è Setting new app settings..."
            
            az webapp config appsettings set \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }} \
              --settings \
                NODE_ENV=production \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                PG_SSL="${{ secrets.PG_SSL }}" \
                SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
                STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}" \
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
                AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
                AZURE_STORAGE_CONTAINER_NAME=knowledge \
                BLOB_PREFIX=knowledge-base/ \
                STORAGE_MODE=azure \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                OPENAI_MAX_TOKENS=2000 \
                DEBUG_MODE=false \
                VERBOSE_LOGGING=false \
                SCM_DO_BUILD_DURING_DEPLOYMENT=true \
                WEBSITE_NODE_DEFAULT_VERSION=20-lts \
                WEBSITE_RUN_FROM_PACKAGE=1 \
                WEBSITE_LOCAL_CACHE_OPTION=Never \
                WEBSITE_DYNAMIC_CACHE=0
            
            echo "‚úÖ App settings configured successfully"

      - name: Start App Service
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üöÄ Starting App Service with new deployment..."
            az webapp start \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }}
            
            echo "‚úÖ App Service started"
            echo "‚è≥ Waiting for application to warm up..."
            sleep 30

      - name: Seed admin user to database
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üå± Seeding admin user to production database..."
            
            # PostgreSQL„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
            apt-get update -qq && apt-get install -y postgresql-client > /dev/null 2>&1
            
            # SQL„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å
            psql "${{ secrets.DATABASE_URL }}" -c "
              INSERT INTO users (username, password, role, display_name, department, created_at, updated_at)
              VALUES (
                'niina',
                '\$2a\$10\$w9kGZVYX8yqK5YJ3p7H.4eN8Z9M0xQ1K2L3M4N5O6P7Q8R9S0T1U2V',
                'admin',
                'ÁÆ°ÁêÜËÄÖ',
                'ÊÉÖÂ†±„Ç∑„Çπ„ÉÜ„É†ÈÉ®',
                NOW(),
                NOW()
              )
              ON CONFLICT (username) DO UPDATE SET
                password = EXCLUDED.password,
                updated_at = NOW();
            " || echo "‚ö†Ô∏è User seed may have failed, but continuing..."
            
            echo "‚úÖ Admin user seeded"

      - name: Verify deployment
        run: |
          echo "‚úÖ Deployment completed"
          echo "üîç Checking application health..."
          
          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          HEALTH_URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          echo "üè• Checking health endpoint: $HEALTH_URL"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $RESPONSE"
            echo "   This may be normal if the app is still starting up"
          fi

# Trigger: 2025-11-30 15:30 - Deploy with environment variable management
