name: Deploy Server (Azure App Service)

# Êñ∞„Åó„ÅÑ„Éá„Éó„É≠„Ç§„ÅåÈñãÂßã„Åï„Çå„Åü„ÇâÂè§„ÅÑÂÆüË°å„ÇíËá™Âãï„Ç≠„É£„É≥„Çª„É´
concurrency:
  group: deploy-server-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    # pathsË®≠ÂÆö„ÇíÂâäÈô§ - main„Å∏„ÅÆ„Éó„ÉÉ„Ç∑„É•„ÅßÂ∏∏„Å´„Éá„Éó„É≠„Ç§
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Server to Azure App Service
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1
          lfs: false

      - name: Verify package-lock.json exists
        run: |
          echo "üìã Checking for package-lock.json files..."
          ls -la package-lock.json || echo "‚ùå Root package-lock.json not found"
          ls -la client/package-lock.json || echo "‚ùå Client package-lock.json not found"
          ls -la server/package-lock.json || echo "‚ö†Ô∏è Server package-lock.json not found (expected)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install and build shared module (first)
        run: |
          echo "üì¶ Installing shared dependencies..."
          cd shared
          npm install --no-audit --no-fund
          echo "üî® Building shared module..."
          npm run build
          echo "‚úÖ Shared module built"

      - name: Install server dependencies
        run: |
          echo "üì¶ Installing server dependencies..."
          cd server
          
          # Âè§„ÅÑnode_modules„ÇíÂâäÈô§„Åó„Å¶„ÇØ„É™„Éº„É≥„Ç§„É≥„Çπ„Éà„Éº„É´
          echo "üßπ Cleaning old node_modules..."
          rm -rf node_modules
          
          # Êú¨Áï™Áî®„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´Ôºàpackage-lock.json„Åå„Å™„ÅÑÂ†¥Âêà„ÅØnpm installÔºâ
          if [ -f "package-lock.json" ]; then
            echo "Using npm ci with package-lock.json"
            npm ci --omit=dev --no-audit --no-fund
          else
            echo "‚ö†Ô∏è package-lock.json not found, using npm install"
            npm install --omit=dev --no-audit --no-fund
          fi
          
          echo "‚úÖ Server dependencies installed"
          echo "üìã Verifying .mjs files exist:"
          ls -lh *.mjs | head -5

      - name: Create web.config for Azure App Service
        run: |
          cat > server/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <security>
                <requestFiltering>
                  <hiddenSegments>
                    <remove segment="bin"/>
                  </hiddenSegments>
                </requestFiltering>
              </security>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          EOF
          echo "‚úÖ web.config created"
      
      - name: Create deployment package
        timeout-minutes: 5
        run: |
          echo "üì¶ Creating fresh deployment package..."
          cd server
          
          # ‰∏ÄÊÑè„ÅÆ„Éá„Éó„É≠„Ç§ÊÉÖÂ†±„Éï„Ç°„Ç§„É´‰ΩúÊàê
          cat > DEPLOY_INFO.txt << EOF
          Deployment Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit SHA: ${{ github.sha }}
          Run Number: ${{ github.run_number }}
          Random ID: $(date +%s%N)
          EOF
          
          cat DEPLOY_INFO.txt
          
          # zip„Éë„ÉÉ„Ç±„Éº„Ç∏‰ΩúÊàê
          zip -r ../deploy.zip \
            package.json \
            azure-server.mjs \
            web.config \
            DEPLOY_INFO.txt \
            routes/ \
            middleware/ \
            services/ \
            utils/ \
            -x "*.git*" "*.log" "node_modules/*" "*.ts" "tsconfig.*" "dist/*"
          
          cd ..
          ls -lh deploy.zip
          sha256sum deploy.zip

      - name: Deploy via Azure CLI (ZipDeploy)
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üöÄ Deploying via az webapp deployment..."
            az webapp deployment source config-zip \
              --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --name emergency-assistantapp-gwgscxcca5chahyb9 \
              --src deploy.zip
            
            echo "‚úÖ ZipDeploy completed"

      - name: Set environment variables
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "‚öôÔ∏è Setting all environment variables..."
            
            az webapp config appsettings set \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name emergency-assistantapp-gwgscxcca5chahyb9 \
              --settings \
                NODE_ENV=production \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                PG_SSL="${{ secrets.PG_SSL }}" \
                SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
                STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}" \
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
                AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
                AZURE_STORAGE_CONTAINER_NAME=knowledge \
                BLOB_PREFIX=knowledge-base/ \
                STORAGE_MODE=azure \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                OPENAI_MAX_TOKENS=2000 \
                DEBUG_MODE=false \
                VERBOSE_LOGGING=false \
                WEBSITE_RUN_FROM_PACKAGE=0 \
                SCM_DO_BUILD_DURING_DEPLOYMENT=true \
                WEBSITE_LOCAL_CACHE_OPTION=Never \
                WEBSITE_DYNAMIC_CACHE=0 \
                WEBSITES_ENABLE_APP_SERVICE_STORAGE=true \
                WEBSITE_NODE_DEFAULT_VERSION=20-lts
            
            echo "‚úÖ All settings configured"

      - name: Seed admin user to database
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üå± Seeding admin user to production database..."
            
            # PostgreSQL„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
            apt-get update -qq && apt-get install -y postgresql-client > /dev/null 2>&1
            
            # SQL„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å
            psql "${{ secrets.DATABASE_URL }}" -c "
              INSERT INTO users (username, password, role, display_name, department, created_at, updated_at)
              VALUES (
                'niina',
                '\$2a\$10\$w9kGZVYX8yqK5YJ3p7H.4eN8Z9M0xQ1K2L3M4N5O6P7Q8R9S0T1U2V',
                'admin',
                'ÁÆ°ÁêÜËÄÖ',
                'ÊÉÖÂ†±„Ç∑„Çπ„ÉÜ„É†ÈÉ®',
                NOW(),
                NOW()
              )
              ON CONFLICT (username) DO UPDATE SET
                password = EXCLUDED.password,
                updated_at = NOW();
            " || echo "‚ö†Ô∏è User seed may have failed, but continuing..."
            
            echo "‚úÖ Admin user seeded"

      - name: Start App Service with new files
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "‚ñ∂Ô∏è Starting App Service with new deployment..."
            az webapp start \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }}
            
            echo "‚è≥ Waiting 40 seconds for app to fully start..."
            sleep 40
            echo "‚úÖ App Service started with new files"

      - name: Verify deployment
        run: |
          echo "‚úÖ Deployment completed"
          echo "üîç Checking application health..."
          
          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          HEALTH_URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          echo "üè• Checking health endpoint: $HEALTH_URL"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $RESPONSE"
            echo "   This may be normal if the app is still starting up"
          fi

# Trigger: 2025-11-30 15:30 - Deploy with environment variable management
