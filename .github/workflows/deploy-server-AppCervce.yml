name: Deploy Server (Azure App Service)

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'shared/**'
      - '.github/workflows/deploy-server-AppCervce.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Server to Azure App Service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            shared/package-lock.json

      - name: Install dependencies (shared)
        run: |
          cd shared
          npm ci

      - name: Build shared module
        run: |
          cd shared
          npm run build

      - name: Install dependencies (server)
        run: |
          cd server
          npm ci

      - name: Build server
        run: |
          cd server
          npm run build
          echo "‚úÖ Server build completed"

      - name: Prepare deployment package
        run: |
          mkdir -p deployment-package
          
          # „Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº
          cp -r server/dist deployment-package/
          cp -r server/node_modules deployment-package/
          cp server/package.json deployment-package/
          
          # shared„É¢„Ç∏„É•„Éº„É´„Çí„Ç≥„Éî„Éº
          mkdir -p deployment-package/shared
          cp -r shared/dist deployment-package/shared/
          cp shared/package.json deployment-package/shared/
          
          # knowledge-base „Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÈÄ†„Çí‰ΩúÊàêÔºàÁ©∫„Åß„ÇÇOKÔºâ
          mkdir -p deployment-package/knowledge-base/exports
          mkdir -p deployment-package/knowledge-base/images/chat-exports
          mkdir -p deployment-package/knowledge-base/images/emergency-flows
          mkdir -p deployment-package/knowledge-base/troubleshooting
          
          echo "‚úÖ Deployment package prepared"

      - name: Create web.config for Azure App Service
        run: |
          cat > deployment-package/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="dist/azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^dist/azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="dist/azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <security>
                <requestFiltering>
                  <hiddenSegments>
                    <remove segment="bin"/>
                  </hiddenSegments>
                </requestFiltering>
              </security>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          EOF
          echo "‚úÖ web.config created"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deployment-package

      - name: Clear existing environment variables on Azure App Service
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "üßπ Clearing existing app settings..."
            
            # ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæóÔºàAzure„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö„ÇíÈô§„ÅèÔºâ
            CURRENT_SETTINGS=$(az webapp config appsettings list \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }} \
              --query "[?!starts_with(name, 'WEBSITE_') && !starts_with(name, 'SCM_') && !starts_with(name, 'APPLICATIONINSIGHTS_') && name != 'ApplicationInsightsAgent_EXTENSION_VERSION'].name" \
              -o tsv)
            
            # „Ç´„Çπ„Çø„É†Áí∞Â¢ÉÂ§âÊï∞„ÇíÂâäÈô§
            if [ -n "$CURRENT_SETTINGS" ]; then
              for setting in $CURRENT_SETTINGS; do
                echo "  Removing: $setting"
                az webapp config appsettings delete \
                  --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
                  --name ${{ secrets.AZURE_WEBAPP_NAME }} \
                  --setting-names "$setting"
              done
              echo "‚úÖ Existing app settings cleared"
            else
              echo "‚ÑπÔ∏è No custom app settings to clear"
            fi

      - name: Set environment variables on Azure App Service
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "‚öôÔ∏è Setting new app settings..."
            
            az webapp config appsettings set \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_WEBAPP_NAME }} \
              --settings \
                NODE_ENV=production \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                PG_SSL="${{ secrets.PG_SSL }}" \
                SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
                STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}" \
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
                AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
                AZURE_STORAGE_CONTAINER_NAME=knowledge \
                BLOB_PREFIX=knowledge-base/ \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                OPENAI_MAX_TOKENS=2000 \
                DEBUG_MODE=false \
                VERBOSE_LOGGING=false \
                SCM_DO_BUILD_DURING_DEPLOYMENT=false \
                WEBSITE_NODE_DEFAULT_VERSION=20-lts
            
            echo "‚úÖ App settings configured successfully"

      - name: Verify deployment
        run: |
          echo "‚úÖ Deployment completed"
          echo "üîç Waiting for app to start..."
          sleep 30
          
          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          HEALTH_URL="https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          echo "üè• Checking health endpoint: $HEALTH_URL"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $RESPONSE"
            echo "   This may be normal if the app is still starting up"
          fi

# Trigger: 2025-11-30 15:30 - Deploy with environment variable management
