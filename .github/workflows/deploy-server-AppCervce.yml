name: Deploy Server to Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'shared/**'
      - '.github/workflows/deploy-server-AppCervce.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÂÆåÂÖ®„Å™Â±•Ê≠¥„ÇíÂèñÂæó„Åó„Å¶„Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ

      - name: Generate deployment metadata
        id: metadata
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_TIME=$(git log -1 --format=%cI)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_time=$COMMIT_TIME" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "üìã Deployment Metadata:"
          echo "   Commit: $COMMIT_SHA"
          echo "   Time: $BUILD_TIME"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # npm cache„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶Â∏∏„Å´ÊúÄÊñ∞„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
          # cache: 'npm'

      - name: Security check - RSC & Next.js vulnerabilities
        run: |
          echo "üîç Running security vulnerability check..."
          node scripts/check-rsc-vulnerabilities.js
        continue-on-error: false

      - name: Install shared dependencies
        run: |
          cd shared
          npm ci --omit=dev --no-cache

      - name: Install server dependencies (production only)
        run: |
          cd server
          echo "üì¶ Installing production dependencies..."
          npm ci --omit=dev --no-cache
          
          echo "‚úÖ Dependencies installed:"
          ls -la node_modules | head -20
          
          echo ""
          echo "üìä node_modules size:"
          du -sh node_modules
          
      - name: Create deployment metadata file
        run: |
          cd server
          cat > deployment-info.json << EOF
          {
            "commit_sha": "${{ steps.metadata.outputs.commit_sha }}",
            "commit_time": "${{ steps.metadata.outputs.commit_time }}",
            "build_time": "${{ steps.metadata.outputs.build_time }}",
            "workflow_run": "${{ github.run_number }}",
            "deployed_by": "GitHub Actions"
          }
          EOF
          echo "üìã Created deployment-info.json:"
          cat deployment-info.json

      - name: Create web.config
        run: |
          cat > server/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          EOF
          
          echo "‚úÖ web.config created"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Stop App Service (force clean deployment)
        run: |
          echo "üõë Stopping app service for clean deployment..."
          az webapp stop --name emergency-assistantapp --resource-group rg-Emergencyassistant-app
          echo "‚úÖ App stopped"
          sleep 15

      - name: Delete ALL old files from wwwroot
        run: |
          echo "üóëÔ∏è  DELETING ALL OLD FILES FROM AZURE..."
          
          # Get deployment credentials
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --query "{username:publishingUserName, password:publishingPassword}" \
            -o json)
          
          USERNAME=$(echo $CREDS | jq -r .username)
          PASSWORD=$(echo $CREDS | jq -r .password)
          
          echo "::add-mask::$PASSWORD"
          
          # Delete wwwroot completely via Kudu VFS API
          echo "Deleting /site/wwwroot/..."
          curl -X DELETE \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/" \
            -u "$USERNAME:$PASSWORD" \
            -H "If-Match: *" \
            -w "\nHTTP_CODE:%{http_code}\n" || echo "Delete attempted"
          
          sleep 5
          
          # Verify deletion
          echo ""
          echo "Verifying wwwroot is empty..."
          RESULT=$(curl -s \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/" \
            -u "$USERNAME:$PASSWORD" || echo "[]")
          
          if [ "$RESULT" = "[]" ] || [ -z "$RESULT" ]; then
            echo "‚úÖ wwwroot successfully cleared"
          else
            echo "‚ö†Ô∏è  wwwroot may still contain files"
          fi

      - name: Verify critical files before packaging
        run: |
          cd server
          echo "üîç VERIFYING ALL CRITICAL FILES EXIST:"
          echo ""
          
          echo "1. Main application file:"
          ls -lh azure-server.mjs || (echo "‚ùå azure-server.mjs NOT FOUND" && exit 1)
          
          echo ""
          echo "2. Deployment metadata:"
          ls -lh deployment-info.json || (echo "‚ùå deployment-info.json NOT FOUND" && exit 1)
          cat deployment-info.json
          
          echo ""
          echo "3. Package.json:"
          ls -lh package.json || (echo "‚ùå package.json NOT FOUND" && exit 1)
          
          echo ""
          echo "4. node_modules (MUST EXIST):"
          if [ -d "node_modules" ]; then
            echo "‚úÖ node_modules exists"
            ls node_modules | head -20
            du -sh node_modules
          else
            echo "‚ùå node_modules NOT FOUND - DEPLOYMENT WILL FAIL"
            exit 1
          fi
          
          echo ""
          echo "5. src/api structure:"
          if [ -d "src/api" ]; then
            echo "‚úÖ src/api exists"
            find src/api -name "*.js" | head -20
          else
            echo "‚ùå src/api NOT FOUND"
            exit 1
          fi
          
          echo ""
          echo "6. web.config:"
          ls -lh web.config || (echo "‚ö†Ô∏è  web.config not found" && exit 1)
          
          echo ""
          echo "üìä Total files to deploy:"
          find . -type f | wc -l

      - name: Create deployment package (COMPLETE - with node_modules)
        run: |
          cd server
          echo "üì¶ Creating COMPLETE deployment ZIP..."
          echo "This ZIP will contain:"
          echo "  - All source files (*.js, *.mjs)"
          echo "  - ALL node_modules (production dependencies)"
          echo "  - src/api folder"
          echo "  - deployment-info.json"
          echo "  - package.json"
          echo "  - web.config"
          echo ""
          
          # ÂÆåÂÖ®„Å™„Éá„Éó„É≠„Ç§„É°„É≥„Éà„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰ΩúÊàêÔºànode_modulesÂê´„ÇÄÔºâ
          # Èô§Â§ñ„Åô„Çã„ÅÆ„ÅØÈñãÁô∫Èñ¢ÈÄ£„Éï„Ç°„Ç§„É´„ÅÆ„Åø
          zip -r ../deploy.zip . \
            -x '*.git*' \
            -x '*.log' \
            -x '*.ts' \
            -x 'tsconfig.*' \
            -x '.env*' \
            -x 'test/*' \
            -x 'tests/*' \
            -x '*.map'
          
          cd ..
          
          ZIP_SIZE=$(du -h deploy.zip | cut -f1)
          echo ""
          echo "‚úÖ Package created: $ZIP_SIZE"
          echo ""
          
          # ZIP„ÅÆÂÜÖÂÆπ„ÇíË©≥Á¥∞„Å´Ê§úË®º
          echo "üîç VERIFYING ZIP CONTENTS:"
          echo ""
          
          echo "1. Critical application files:"
          unzip -l deploy.zip | grep -E "azure-server\.mjs|deployment-info\.json|package\.json|web\.config"
          
          echo ""
          echo "2. node_modules (MUST BE PRESENT):"
          NODE_MODULES_COUNT=$(unzip -l deploy.zip | grep "node_modules/" | wc -l)
          if [ $NODE_MODULES_COUNT -gt 0 ]; then
            echo "‚úÖ node_modules IS INCLUDED ($NODE_MODULES_COUNT files)"
            unzip -l deploy.zip | grep "node_modules" | head -20
          else
            echo "‚ùå CRITICAL ERROR: node_modules NOT IN ZIP"
            exit 1
          fi
          
          echo ""
          echo "3. src/api files:"
          SRC_API_COUNT=$(unzip -l deploy.zip | grep "src/api" | wc -l)
          if [ $SRC_API_COUNT -gt 0 ]; then
            echo "‚úÖ src/api IS INCLUDED ($SRC_API_COUNT files)"
            unzip -l deploy.zip | grep "src/api" | head -15
          else
            echo "‚ùå CRITICAL ERROR: src/api NOT IN ZIP"
            exit 1
          fi
          
          echo ""
          echo "üìä Total files in ZIP:"
          unzip -l deploy.zip | tail -1

      - name: Deploy via Azure ZipDeploy API (COMPLETE PACKAGE)
        run: |
          echo "üöÄ DEPLOYING COMPLETE PACKAGE TO AZURE"
          echo "This deployment includes:"
          echo "  ‚úì azure-server.mjs"
          echo "  ‚úì src/api/*"
          echo "  ‚úì deployment-info.json"
          echo "  ‚úì package.json (for npm install)"
          echo "  ‚úì web.config"
          echo ""
          echo "Note: node_modules will be installed via Kudu after deployment"
          echo ""
          
          DEPLOY_START=$(date +%s)
          
          # Get deployment credentials
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --query "{username:publishingUserName, password:publishingPassword}" \
            -o json)
          
          USERNAME=$(echo $CREDS | jq -r .username)
          PASSWORD=$(echo $CREDS | jq -r .password)
          
          echo "::add-mask::$PASSWORD"
          
          # Deploy using ZipDeploy API
          echo "üì§ Uploading ZIP (this may take 1-2 minutes)..."
          HTTP_CODE=$(curl -X POST \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/zipdeploy" \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/zip" \
            --data-binary @deploy.zip \
            --max-time 600 \
            -w "%{http_code}" \
            -s \
            -o deploy_response.txt)
          
          DEPLOY_END=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START))
          
          echo ""
          echo "HTTP Status: $HTTP_CODE"
          echo "Duration: ${DEPLOY_DURATION}s"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "‚úÖ Deployment upload successful"
          else
            echo "‚ùå Deployment failed"
            echo "Response:"
            cat deploy_response.txt
            exit 1
          fi
          
          echo ""
          echo "üìÑ Deployment response:"
          cat deploy_response.txt || echo "(No response body)"
          echo ""
          echo "‚úÖ Package deployed successfully"

      - name: Verify deployment structure on Azure
        run: |
          echo "üîç Verifying deployment structure on Azure..."
          
          # Get deployment credentials
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --query "{username:publishingUserName, password:publishingPassword}" \
            -o json)
          
          USERNAME=$(echo $CREDS | jq -r .username)
          PASSWORD=$(echo $CREDS | jq -r .password)
          
          echo "::add-mask::$PASSWORD"
          
          # Check wwwroot structure
          echo "Checking wwwroot structure..."
          WWWROOT_FILES=$(curl -s \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/" \
            -u "$USERNAME:$PASSWORD" \
            -H "Accept: application/json")
          
          echo "Files in wwwroot:"
          echo "$WWWROOT_FILES" | jq -r '.[].name' || echo "$WWWROOT_FILES"
          
          # Check if azure-server.mjs exists (should be directly in wwwroot)
          if echo "$WWWROOT_FILES" | grep -q "azure-server.mjs"; then
            echo "‚úÖ azure-server.mjs found in wwwroot (correct structure)"
          else
            echo "‚ùå azure-server.mjs NOT in wwwroot - deployment structure is wrong!"
            exit 1
          fi
          
          # Check if package.json exists
          if echo "$WWWROOT_FILES" | grep -q "package.json"; then
            echo "‚úÖ package.json found in wwwroot"
          else
            echo "‚ùå package.json NOT in wwwroot"
            exit 1
          fi
          
          echo ""
          echo "üì¶ Now installing dependencies..."
          
          # Use Kudu's command API to install dependencies
          # Since we're in wwwroot directly (not wwwroot/server), just use current directory
          RESPONSE=$(curl -X POST \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/command" \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/json" \
            -d '{
              "command": "npm ci --production --no-optional --loglevel=verbose",
              "dir": "site/wwwroot"
            }' \
            --max-time 600 \
            -s)
          
          echo "npm install response:"
          echo "$RESPONSE" | jq . || echo "$RESPONSE"
          
          # Check for errors
          if echo "$RESPONSE" | grep -q "error"; then
            echo "‚ö†Ô∏è  npm install may have errors, but continuing..."
          fi
          
          # Check if node_modules exists
          echo ""
          echo "Verifying node_modules installation..."
          NODE_MODULES_CHECK=$(curl -s \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/node_modules/" \
            -u "$USERNAME:$PASSWORD" \
            -H "Accept: application/json")
          
          MODULE_COUNT=$(echo "$NODE_MODULES_CHECK" | jq '. | length' || echo "0")
          echo "node_modules contains $MODULE_COUNT packages"
          
          if [ "$MODULE_COUNT" -gt 10 ]; then
            echo "‚úÖ Dependencies installed successfully"
          else
            echo "‚ö†Ô∏è  Dependency installation may have failed"
          fi

      - name: Start App Service
        run: |
          echo "‚ñ∂Ô∏è Starting app service..."
          az webapp start --name emergency-assistantapp --resource-group rg-Emergencyassistant-app
          sleep 10
          echo "‚úÖ App started"

      - name: Verify deployment and check commit SHA
        run: |
          echo "‚è≥ Waiting 45 seconds for app to fully initialize..."
          sleep 45
          
          APP_URL="https://emergency-assistantapp.azurewebsites.net"
          EXPECTED_COMMIT="${{ steps.metadata.outputs.commit_sha }}"
          
          echo ""
          echo "üîç DEPLOYMENT VERIFICATION"
          echo "Expected commit: $EXPECTED_COMMIT"
          echo ""
          
          # Step 1: Check deployment-info.json
          echo "1. Checking deployment metadata..."
          DEPLOY_INFO=$(curl -s "$APP_URL/deployment-info.json" 2>/dev/null)
          
          if [ -n "$DEPLOY_INFO" ] && [ "$DEPLOY_INFO" != "<!DOCTYPE html>" ]; then
            echo "‚úÖ Deployment info accessible"
            echo "Raw response:"
            echo "$DEPLOY_INFO"
            echo ""
            
            # Try to parse with jq if valid JSON
            if echo "$DEPLOY_INFO" | jq . > /dev/null 2>&1; then
              echo "Parsed JSON:"
              echo "$DEPLOY_INFO" | jq .
              
              ACTUAL_COMMIT=$(echo "$DEPLOY_INFO" | jq -r '.commit // .commitSha // .commit_sha // "unknown"')
              
              if [ "$ACTUAL_COMMIT" = "$EXPECTED_COMMIT" ]; then
                echo "‚úÖ COMMIT SHA MATCHES - Correct version deployed"
              else
                echo "‚ö†Ô∏è  Commit SHA check:"
                echo "Expected: $EXPECTED_COMMIT"
                echo "Actual:   $ACTUAL_COMMIT"
              fi
            else
              echo "‚ö†Ô∏è  Response is not valid JSON (server may still be starting)"
            fi
          else
            echo "‚ö†Ô∏è  Could not fetch deployment-info.json (server may still be starting)"
          fi
          
          echo ""
          echo "2. Checking health endpoint..."
          SUCCESS=0
          for i in 1 2 3 4 5; do
            echo "Attempt $i/5..."
            
            HEALTH_RESPONSE=$(curl -s "$APP_URL/api/health/full" 2>/dev/null)
            
            if [ -n "$HEALTH_RESPONSE" ] && [ "$HEALTH_RESPONSE" != "<!DOCTYPE html>" ]; then
              echo "‚úÖ Server is responding"
              
              # Try to parse as JSON
              if echo "$HEALTH_RESPONSE" | jq . > /dev/null 2>&1; then
                echo "$HEALTH_RESPONSE" | jq .
              else
                echo "$HEALTH_RESPONSE"
              fi
              
              # Check version info
              VERSION_INFO=$(curl -s "$APP_URL/api/version" 2>/dev/null)
              if [ -n "$VERSION_INFO" ]; then
                echo ""
                echo "üìã Deployed version:"
                if echo "$VERSION_INFO" | jq . > /dev/null 2>&1; then
                  echo "$VERSION_INFO" | jq .
                else
                  echo "$VERSION_INFO"
                fi
              fi
              
              # Final deployment-info check
              DEPLOY_CHECK=$(curl -s "$APP_URL/deployment-info.json" 2>/dev/null)
              if [ -n "$DEPLOY_CHECK" ] && echo "$DEPLOY_CHECK" | jq . > /dev/null 2>&1; then
                DEPLOYED_COMMIT=$(echo "$DEPLOY_CHECK" | jq -r '.commit // .commitSha // .commit_sha // "unknown"')
                
                echo ""
                echo "üìã Final deployment info:"
                echo "$DEPLOY_CHECK" | jq .
                
                if [ "$DEPLOYED_COMMIT" = "$EXPECTED_COMMIT" ]; then
                  echo "‚úÖ DEPLOYMENT VERIFIED: Correct version deployed"
                  SUCCESS=1
                  break
                else
                  echo "‚ö†Ô∏è  Commit mismatch - Expected: $EXPECTED_COMMIT, Got: $DEPLOYED_COMMIT"
                fi
              fi
              
              # If health check passed, consider it success even if commit check failed
              SUCCESS=1
              break
            else
              echo "‚ö†Ô∏è  Server not responding yet"
            fi
            
            [ $i -lt 5 ] && sleep 20
          done
          
          if [ $SUCCESS -eq 1 ]; then
            echo ""
            echo "‚úÖ Deployment completed successfully"
            exit 0
          else
            echo ""
            echo "‚ùå Deployment verification failed - server not responding"
            echo "Please check application logs manually"
            exit 1
          fi
