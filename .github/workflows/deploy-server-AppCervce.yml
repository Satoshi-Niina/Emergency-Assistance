name: Deploy Server to Azure App Service

# æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰å¤ã„å®Ÿè¡Œã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: deploy-server-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-1
    name: Build and Deploy Server
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ“¦ Install shared module
        run: |
          echo "ğŸ“¦ Installing shared dependencies..."
          cd shared
          npm install --omit=dev --no-audit --no-fund
          echo "âš ï¸ Skipping shared build (tsc not required for server deploy)"
          echo "âœ… Shared dependencies installed"

      - name: ğŸ“¦ Install server dependencies
        run: |
          echo "ğŸ“¦ Installing server dependencies..."
          cd server
          
          # package-lock.jsonãŒã‚ã‚Œã°ciã€ãªã‘ã‚Œã°install
          if (Test-Path package-lock.json) {
            npm ci --omit=dev --no-audit --no-fund
          } else {
            npm install --omit=dev --no-audit --no-fund
          }
          
          echo "âœ… Dependencies installed"
          echo "ğŸ“Š Installed packages:"
          Get-ChildItem node_modules | Select-Object -First 20

      - name: ğŸ“ Create web.config
        run: |
          $content = @"
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <security>
                <requestFiltering>
                  <hiddenSegments>
                    <remove segment="bin"/>
                  </hiddenSegments>
                </requestFiltering>
              </security>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          "@
          Set-Content -Path server/web.config -Value $content -Encoding UTF8
          echo "âœ… web.config created"

      - name: ğŸ“ Create deployment info
        run: |
          cd server
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
          $content = "Deployment Timestamp: $timestamp`nCommit SHA: ${{ github.sha }}`nRun Number: ${{ github.run_number }}"
          Set-Content -Path DEPLOY_INFO.txt -Value $content
          
          echo "ğŸ“‹ Deployment Info:"
          Get-Content DEPLOY_INFO.txt

      - name: â¸ï¸ Stop App Service for clean deployment
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "â¸ï¸ Stopping App Service for clean deployment..."
            
            az webapp stop `
              --resource-group rg-Emergencyassistant-app `
              --name emergency-assistantapp
            
            echo "âœ… App Service stopped"
            echo "â³ Waiting 10 seconds..."
            Start-Sleep -Seconds 10

      - name: ğŸ—‘ï¸ Delete all files in wwwroot (Complete Clean)
        uses: azure/cli@v1
        continue-on-error: true
        with:
          inlineScript: |
            echo "ğŸ—‘ï¸ Deleting all files in wwwroot..."
            
            # wwwrootãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
            $folders = @("node_modules", "routes", "middleware", "services", "utils", "db", "config", "public")
            $files = @("azure-server.mjs", "package.json", "package-lock.json", "web.config", "DEPLOY_INFO.txt")
            
            # ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
            foreach ($folder in $folders) {
              echo "Deleting folder: $folder"
              az rest --method delete `
                --uri "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/${folder}/?recursive=true" `
                --resource "https://management.azure.com/" `
                || echo "Folder $folder not found or already deleted"
            }
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            foreach ($file in $files) {
              echo "Deleting file: $file"
              az rest --method delete `
                --uri "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/${file}" `
                --resource "https://management.azure.com/" `
                || echo "File $file not found or already deleted"
            }
            
            echo "âœ… All old files deleted - Ready for clean deployment"

      - name: ğŸ“¦ Create deployment package
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          cd server
          
          # zipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ (7zã‚’ä½¿ç”¨)
          # node_modulesã‚’å«ã‚ã‚‹
          # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
          7z a -tzip ../deploy.zip . `
            -xr!*.git* `
            -xr!*.log `
            -xr!*.ts `
            -xr!tsconfig.* `
            -xr!dist `
            -xr!src `
            -xr!.env* `
            -xr!test `
            -xr!tests
          
          cd ..
          echo "âœ… Package created:"
          Get-Item deploy.zip | Select-Object Name, Length
          echo "ğŸ“Š Package hash:"
          Get-FileHash deploy.zip -Algorithm SHA256

      - name: ğŸš€ Deploy to Azure App Service
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "ğŸš€ Deploying to Azure App Service..."
            
            # ZipDeployã‚’å®Ÿè¡Œ
            az webapp deployment source config-zip `
              --resource-group rg-Emergencyassistant-app `
              --name emergency-assistantapp `
              --src deploy.zip `
              --timeout 1800
            
            echo "âœ… ZipDeploy completed"

      - name: âš™ï¸ Configure environment variables
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "âš™ï¸ Setting environment variables..."
            
            az webapp config appsettings set `
              --resource-group rg-Emergencyassistant-app `
              --name emergency-assistantapp `
              --settings `
                NODE_ENV=production `
                DATABASE_URL="${{ secrets.DATABASE_URL }}" `
                PG_SSL="${{ secrets.PG_SSL }}" `
                SESSION_SECRET="${{ secrets.SESSION_SECRET }}" `
                JWT_SECRET="${{ secrets.JWT_SECRET }}" `
                FRONTEND_URL="${{ secrets.FRONTEND_URL }}" `
                STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}" `
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" `
                AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" `
                AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" `
                AZURE_STORAGE_CONTAINER_NAME=knowledge `
                BLOB_PREFIX=knowledge-base/ `
                STORAGE_MODE=azure `
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" `
                OPENAI_MAX_TOKENS=2000 `
                DEBUG_MODE=false `
                VERBOSE_LOGGING=false `
                WEBSITE_RUN_FROM_PACKAGE=0 `
                SCM_DO_BUILD_DURING_DEPLOYMENT=false `
                WEBSITE_LOCAL_CACHE_OPTION=Never `
                WEBSITE_DYNAMIC_CACHE=0 `
                WEBSITES_ENABLE_APP_SERVICE_STORAGE=true `
                WEBSITE_NODE_DEFAULT_VERSION=20-lts
            
            echo "âœ… Environment variables configured"

      - name: â–¶ï¸ Start App Service with new deployment
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "â–¶ï¸ Starting App Service with new deployment..."
            
            az webapp start `
              --resource-group rg-Emergencyassistant-app `
              --name emergency-assistantapp
            
            echo "â³ Waiting 45 seconds for app to fully start..."
            Start-Sleep -Seconds 45
            echo "âœ… App Service started successfully with clean deployment"

      - name: âœ… Verify deployment
        run: |
          echo "âœ… Deployment completed"
          echo "ğŸ” Verifying deployment..."
          
          $APP_URL = "https://emergency-assistantapp-gwgscxcca5chahyb9.japanwest-01.azurewebsites.net"
          
          # Health checkï¼ˆæœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
          for ($i=1; $i -le 3; $i++) {
            echo "Attempt $i/3: Checking /api/health..."
            
            try {
              $response = Invoke-WebRequest -Uri "$APP_URL/api/health" -Method Get -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                echo "âœ… Health check PASSED (HTTP 200)"
                
                # Version check
                echo ""
                echo "ğŸ“Š Checking deployment version..."
                try {
                  $v = Invoke-RestMethod -Uri "$APP_URL/api/version"
                  echo ($v | ConvertTo-Json -Depth 2)
                } catch {
                  echo "Version endpoint failed: $_"
                }
                
                break
              }
            } catch {
              echo "âš ï¸ Health check failed: $_"
            }
            
            if ($i -lt 3) {
              echo "Waiting 10 seconds before retry..."
              Start-Sleep -Seconds 10
            }
          }
          
          echo ""
          echo "ğŸ“Š Deployment Summary:"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Run: ${{ github.run_number }}"
          echo "  - URL: $APP_URL"
          echo ""
          echo "ğŸ‰ Deployment workflow completed!"
