name: Deploy Server (Docker Container)

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: 'server-docker-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  IMAGE_NAME: emergency-assistance
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Verify GitHub Repository Files
      run: |
        echo "üîç Verifying GitHub repository files before Docker build..."
        echo "üìã Commit SHA: ${{ github.sha }}"
        echo "üìã Branch: ${{ github.ref }}"
        echo ""

        # ÈáçË¶Å„Å™„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        CRITICAL_FILES=(
          "server/azure-server.mjs"
          "server/lib/azure-storage.ts"
          "Dockerfile"
        )

        for file in "${CRITICAL_FILES[@]}"; do
          if [ -f "$file" ]; then
            FILE_SIZE=$(wc -c < "$file" 2>/dev/null || echo "0")
            LAST_MODIFIED=$(git log -1 --format="%ai" -- "$file" 2>/dev/null || echo "unknown")
            echo "‚úÖ $file exists (size: $FILE_SIZE bytes, last modified: $LAST_MODIFIED)"
          else
            echo "‚ùå ERROR: $file not found in repository!"
            exit 1
          fi
        done

        # „Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπÁ¢∫Ë™ç
        echo ""
        echo "üîç Verifying server/azure-server.mjs content..."
        if grep -q "getBlobServiceClient" server/azure-server.mjs; then
          echo "‚úÖ getBlobServiceClient function found"
        else
          echo "‚ùå ERROR: getBlobServiceClient function not found!"
          exit 1
        fi

        if grep -q "Testing BLOB connection" server/azure-server.mjs; then
          echo "‚úÖ BLOB connection test found"
        else
          echo "‚ö†Ô∏è WARNING: BLOB connection test not found"
        fi

        echo ""
        echo "‚úÖ All critical files verified - Docker build will use these files"

    - name: Set Environment Variables
      id: configure-env
      run: |
        ENVIRONMENT="production"
        WEBAPP_NAME="${{ secrets.WEBAPP_NAME }}"
        RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
        APP_URL="${{ secrets.APP_URL }}"
        STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}"

        export ENVIRONMENT WEBAPP_NAME RESOURCE_GROUP APP_URL STATIC_WEB_APP_URL

        {
          echo "ENVIRONMENT=$ENVIRONMENT"
          echo "WEBAPP_NAME=$WEBAPP_NAME"
          echo "RESOURCE_GROUP=$RESOURCE_GROUP"
          echo "APP_URL=$APP_URL"
          echo "STATIC_WEB_APP_URL=$STATIC_WEB_APP_URL"
        } >> "$GITHUB_ENV"

        {
          echo "environment=$ENVIRONMENT"
          echo "webapp-name=$WEBAPP_NAME"
          echo "resource-group=$RESOURCE_GROUP"
          echo "app-url=$APP_URL"
          echo "static-web-app-url=$STATIC_WEB_APP_URL"
        } >> "$GITHUB_OUTPUT"

        echo "‚úÖ Environment: $ENVIRONMENT"
        echo "üîó Backend: $APP_URL"
        echo "üîó Frontend: $STATIC_WEB_APP_URL"

    - name: Validate Required Secrets
      run: |
        echo "üîç Validating deployment secrets..."

        # Azure Resource Group
        if [ -z "$RESOURCE_GROUP" ]; then
          echo "‚ùå AZURE_RESOURCE_GROUP secret is missing"
          exit 1
        fi

        # Application secrets
        if [ -z "${{ secrets.DATABASE_URL }}" ]; then
          echo "‚ùå DATABASE_URL secret is missing"
          exit 1
        fi

        echo "‚úÖ All required secrets validated"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure App Service Environment Variables
      run: |
        echo "üîß Configuring App Service environment variables..."

        # DATABASE_URL„ÅÆÊ§úË®ºÔºàÈï∑„Åï„ÅÆ„Åø„ÄÅÂÜÖÂÆπ„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºâ
        DB_URL="${{ secrets.DATABASE_URL }}"
        if [ -z "$DB_URL" ]; then
          echo "‚ùå ERROR: DATABASE_URL secret is empty!"
          exit 1
        fi
        DB_URL_LENGTH=${#DB_URL}
        echo "‚úÖ DATABASE_URL length: $DB_URL_LENGTH characters"

        # Azure CLI„ÅÆappsettings set„Ç≥„Éû„É≥„Éâ„Åß„ÅØ„ÄÅÂêÑË®≠ÂÆö„ÇíÂÄãÂà•„Å´Ë®≠ÂÆö„Åô„ÇãÊñπ„ÅåÂÆâÂÖ®
        echo "üîß Setting environment variables individually..."

        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            NODE_ENV=$ENVIRONMENT \
            PORT=8080 \
            PG_SSL=require \
            STORAGE_MODE=hybrid \
            KNOWLEDGE_BASE_PATH=/app/knowledge-base \
            LOCAL_EXPORT_DIR=/app/knowledge-base/exports \
            FAULT_HISTORY_IMAGES_DIR=/app/knowledge-base/images/chat-exports \
            DATABASE_BACKUP=false \
            WEBSITES_PORT=8080 \
            WEBSITES_CONTAINER_START_TIME_LIMIT=600 \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
          --output none

        # Ê©üÂØÜÊÉÖÂ†±„ÅØÂÄãÂà•„Å´Ë®≠ÂÆöÔºàÂºïÁî®Á¨¶„ÅßÂõ≤„ÇÄÔºâ
        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
            AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
            APPLICATIONINSIGHTS_CONNECTION_STRING="${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}" \
            ApplicationInsightsAgent_EXTENSION_VERSION="${{ secrets.ApplicationInsightsAgent_EXTENSION_VERSION }}" \
            XDT_MicrosoftApplicationInsights_Mode="${{ secrets.XDT_MicrosoftApplicationInsights_Mode }}" \
          --output none

        # „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâURLË®≠ÂÆöÔºàÂºïÁî®Á¨¶„Å™„Åó„ÅßË®≠ÂÆöÔºâ
        az webapp config appsettings set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --settings \
            FRONTEND_URL=$STATIC_WEB_APP_URL \
            STATIC_WEB_APP_URL=$STATIC_WEB_APP_URL \
            CORS_ALLOW_ORIGINS=$STATIC_WEB_APP_URL,http://localhost:5173,http://localhost:8080 \
          --output none

        # „Ç≥„É≥„ÉÜ„ÉäÂêçË®≠ÂÆöÔºà‰∏äË®ò„ÅÆÊ©üÂØÜÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„ÅßË®≠ÂÆöÊ∏à„Åø„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
        echo "‚úÖ AZURE_STORAGE_CONTAINER_NAME already set in credentials section"

        # AZURE_STORAGE_ACCOUNT_NAMEÔºà‰∏äË®ò„ÅÆÊ©üÂØÜÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„ÅßË®≠ÂÆöÊ∏à„Åø„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
        echo "‚úÖ AZURE_STORAGE_ACCOUNT_NAME already set in credentials section"

        # BLOB_PREFIX„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËøΩÂä†
        if [ -n "${{ secrets.BLOB_PREFIX }}" ]; then
          az webapp config appsettings set \
            --resource-group "$RESOURCE_GROUP" \
            --name "$WEBAPP_NAME" \
            --settings \
              BLOB_PREFIX="${{ secrets.BLOB_PREFIX }}" \
            --output none
          echo "‚úÖ BLOB_PREFIX set"
        fi

        echo "‚úÖ Environment variables configured"

        # Ë®≠ÂÆö„Åï„Çå„ÅüÁí∞Â¢ÉÂ§âÊï∞„ÇíÁ¢∫Ë™çÔºàÊ©üÂØÜÊÉÖÂ†±„ÅØ„Éû„Çπ„ÇØÔºâ
        echo ""
        echo "üîç Verifying configured environment variables..."
        az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONNECTION_STRING' || name=='AZURE_STORAGE_ACCOUNT_NAME' || name=='AZURE_STORAGE_CONTAINER_NAME' || name=='BLOB_PREFIX'].{name:name, value:value}" \
          --output table || echo "‚ö†Ô∏è Could not verify environment variables"

        # Áí∞Â¢ÉÂ§âÊï∞„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        STORAGE_CONN_STR=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONNECTION_STRING'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -z "$STORAGE_CONN_STR" ]; then
          echo "‚ùå ERROR: AZURE_STORAGE_CONNECTION_STRING is not set in App Service!"
          exit 1
        else
          CONN_STR_LENGTH=${#STORAGE_CONN_STR}
          echo "‚úÖ AZURE_STORAGE_CONNECTION_STRING is set (length: $CONN_STR_LENGTH)"
        fi

        STORAGE_ACCOUNT=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_ACCOUNT_NAME'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$STORAGE_ACCOUNT" ]; then
          echo "‚úÖ AZURE_STORAGE_ACCOUNT_NAME is set: $STORAGE_ACCOUNT"
        else
          echo "‚ö†Ô∏è AZURE_STORAGE_ACCOUNT_NAME is not set"
        fi

        STORAGE_CONTAINER=$(az webapp config appsettings list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[?name=='AZURE_STORAGE_CONTAINER_NAME'].value" \
          --output tsv 2>/dev/null || echo "")

        if [ -n "$STORAGE_CONTAINER" ]; then
          echo "‚úÖ AZURE_STORAGE_CONTAINER_NAME is set: $STORAGE_CONTAINER"
        else
          echo "‚ö†Ô∏è AZURE_STORAGE_CONTAINER_NAME is not set"
        fi

    - name: Deploy Docker Container to App Service
      run: |
        echo "üöÄ Deploying server application to Azure App Service..."

        # „Éá„Éó„É≠„Ç§„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆ‰ΩúÊàê
        echo "üì¶ Creating deployment package..."
        mkdir -p /tmp/deploy
        cd /tmp/deploy

        # server „Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂÜÖÂÆπ„Çí„É´„Éº„Éà„Å´„Ç≥„Éî„ÉºÔºàApp Service „Åå server „Éï„Ç©„É´„ÉÄ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„Çã„Åü„ÇÅÔºâ
        echo "üìÇ Preparing application files..."
        cp -r "$GITHUB_WORKSPACE/server/"* .
        
        # server/package*.json „ÅåÂ≠òÂú®„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
        if [ ! -f "package.json" ]; then
          echo "‚ùå ERROR: package.json not found after copying server files!"
          ls -la
          exit 1
        fi

        echo "‚úÖ Application files prepared"
        echo "üìã Files in deploy directory:"
        ls -la | head -20

        # web.config „Çí‰ΩúÊàê„Åó„Å¶Node.js„É©„É≥„Çø„Ç§„É†Ë®≠ÂÆö
        cat > web.config << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <configuration>
          <system.webServer>
            <webSocket enabled="false" />
            <handlers>
              <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode" />
            </handlers>
            <rewrite>
              <rules>
                <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                  <match url="^\/debug[\/]?" />
                  <action type="Rewrite" url="localhost:7071\/debug" />
                </rule>
                <rule name="StaticContent">
                  <action type="CustomResponse" statusCode="404" subStatusCode="1001" statusReason="Managed by iisnode" statusDescription="Managed by iisnode" />
                </rule>
                <rule name="DynamicContent">
                  <conditions>
                    <add input="{REQUEST_FILENAME}" matchType="File" negate="True" />
                  </conditions>
                  <action type="Rewrite" url="azure-server.mjs" />
                </rule>
              </rules>
            </rewrite>
            <security>
              <requestFiltering>
                <hiddenSegments>
                  <add segment="node_modules" />
                </hiddenSegments>
              </requestFiltering>
            </security>
            <httpErrors existingResponse="PassThrough" />
            <iisnode nodeProcessCommandLine="&quot;$PROGRAMFILES\nodejs\node.exe&quot;" debuggingEnabled="false" />
          </system.webServer>
        </configuration>
        EOF

        # ZIP „Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
        echo "üì¶ Creating ZIP archive..."
        zip -r -q /tmp/deploy.zip .
        DEPLOY_SIZE=$(du -h /tmp/deploy.zip | cut -f1)
        echo "‚úÖ ZIP created (${DEPLOY_SIZE})"

        # App Service „Å´„Éá„Éó„É≠„Ç§
        echo "üöÄ Uploading to App Service..."
        az webapp deployment source config-zip \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --src /tmp/deploy.zip

        echo "‚úÖ Application deployed to App Service"

    - name: Configure Node.js Runtime for App Service
      run: |
        echo "üîß Configuring Node.js runtime..."

        # Node.js „É©„É≥„Çø„Ç§„É†Ë®≠ÂÆö
        az webapp config set \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --linuxFxVersion "NODE|20-lts" \
          --startup-file "npm start"

        echo "‚úÖ Runtime configured"

        # „É©„É≥„Çø„Ç§„É†Ë®≠ÂÆö„ÅÆÁ¢∫Ë™ç
        az webapp config show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "{linuxFxVersion:linuxFxVersion, startupCommand:appCommandLine}" \
          --output table

    - name: Check App Service Deployment Status
      run: |
        echo "üîç Checking App Service deployment status..."

        # „Éá„Éó„É≠„Ç§Áä∂ÊÖã„ÇíÁ¢∫Ë™ç
        DEPLOYMENT_STATUS=$(az webapp deployment list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "[0].provisioningState" \
          --output tsv)

        echo "üìä Deployment Status: $DEPLOYMENT_STATUS"

        # App Service „ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
        WEBAPP_STATE=$(az webapp show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --query "state" \
          --output tsv)

        echo "üîÑ App Service State: $WEBAPP_STATE"

        # „É™„ÇΩ„Éº„Çπ„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        echo "üìÅ Checking if app files were deployed..."
        az webapp deployment slot list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          --output table || echo "‚ö†Ô∏è  Could not list deployment slots"

    - name: View App Service Logs
      continue-on-error: true
      run: |
        echo "üìã Fetching App Service logs..."

        # Á∞°Âçò„Å™„É≠„Ç∞ÂèñÂæó„ÇíË©¶„Åø„Çã
        az webapp log show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$WEBAPP_NAME" \
          || echo "‚ö†Ô∏è Could not fetch logs via az command"

        # ‰ª£ÊõøÊñπÊ≥ï: Kudu API „ÇíÈÄö„Åò„Åü„É≠„Ç∞ÂèñÂæóÊÉÖÂ†±„ÇíË°®Á§∫
        echo ""
        echo "üìå To view detailed logs, visit Kudu console at:"
        echo "https://$WEBAPP_NAME-gwgscxcca5cahyb9.scm.japanwest-01.azurewebsites.net/api/logs/docker"

    - name: Wait for Container Startup
      run: |
        echo "‚è≥ Waiting for application to start (60 seconds)..."
        sleep 60

    - name: Seed Database (Production Only)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "üå± Seeding database with admin user..."

        # PostgreSQL „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
        sudo apt-get update -qq
        sudo apt-get install -y postgresql-client > /dev/null 2>&1

        # DATABASE_URL„Åã„ÇâÊé•Á∂öÊÉÖÂ†±„ÇíÊäΩÂá∫„Åó„Å¶ÂÆüË°å
        echo "Executing seed script..."
        if psql "${{ secrets.DATABASE_URL }}" -f scripts/seed-admin-user.sql 2>&1 | grep -q "„Ç∑„Éº„ÉâÂÆå‰∫Ü"; then
          echo "‚úÖ Database seeded successfully"
        else
          echo "‚ö†Ô∏è  Seed script executed (check logs for details)"
        fi

    - name: Health Check
      continue-on-error: true
      run: |
        echo "üè• Verifying deployment health..."

        MAX_RETRIES=10
        RETRY_INTERVAL=10

        for attempt in $(seq 1 $MAX_RETRIES); do
          echo "üîç Health check attempt $attempt/$MAX_RETRIES..."

          # „Ç∑„É≥„Éó„É´„Å™ /health „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$APP_URL/health" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"

            # Ë©≥Á¥∞„Å™„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÂÆüË°å
            echo "üìä Fetching detailed health info..."
            curl -s "$APP_URL/api/health/detailed" | head -n 20

            echo "üéâ Deployment successful and server is responding"
            exit 0
          fi

          echo "‚è≥ Server not ready yet (HTTP $HTTP_CODE), retrying in ${RETRY_INTERVAL}s..."
          [ $attempt -lt $MAX_RETRIES ] && sleep $RETRY_INTERVAL
        done

        echo "‚ö†Ô∏è Health check timeout after $MAX_RETRIES attempts"
        echo "üìã Check logs: az webapp log tail --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP"
        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        echo "## üê≥ Docker Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${ENVIRONMENT} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Image | \`${{ env.IMAGE_NAME }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Web App | ${WEBAPP_NAME} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend URL | ${APP_URL} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend URL | ${STATIC_WEB_APP_URL} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Verification Commands:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Health check" >> $GITHUB_STEP_SUMMARY
          echo "curl ${APP_URL}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Detailed health" >> $GITHUB_STEP_SUMMARY
          echo "curl ${APP_URL}/api/health/detailed | jq" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# CORS test from frontend" >> $GITHUB_STEP_SUMMARY
          echo "curl -i -X OPTIONS ${APP_URL}/api/auth/login \\" >> $GITHUB_STEP_SUMMARY
          echo "  -H \"Origin: ${STATIC_WEB_APP_URL}\" \\" >> $GITHUB_STEP_SUMMARY
          echo '  -H "Access-Control-Request-Method: POST"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "az webapp log tail --name ${WEBAPP_NAME} --resource-group ${RESOURCE_GROUP}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check workflow logs above" >> $GITHUB_STEP_SUMMARY
          echo "2. View container logs: \`az webapp log tail --name ${WEBAPP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check App Service status: \`az webapp show --name ${WEBAPP_NAME} --query state\`" >> $GITHUB_STEP_SUMMARY
        fi

# Trigger: 2025-11-25 10:19:22
