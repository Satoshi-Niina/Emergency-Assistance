name: Deploy Server to Azure App Service

# æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰å¤ã„å®Ÿè¡Œã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: deploy-server-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Server
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ“¦ Install shared module
        run: |
          echo "ðŸ“¦ Installing shared dependencies..."
          cd shared
          npm install --omit=dev --no-audit --no-fund
          npm run build
          echo "âœ… Shared module built"

      - name: ðŸ“¦ Install server dependencies
        run: |
          echo "ðŸ“¦ Installing server dependencies..."
          cd server
          
          # package-lock.jsonãŒã‚ã‚Œã°ciã€ãªã‘ã‚Œã°install
          if [ -f "package-lock.json" ]; then
            npm ci --omit=dev --no-audit --no-fund
          else
            npm install --omit=dev --no-audit --no-fund
          fi
          
          echo "âœ… Dependencies installed"
          echo "ðŸ“Š Installed packages:"
          ls -la node_modules | head -20

      - name: ðŸ“ Create web.config
        run: |
          cat > server/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <security>
                <requestFiltering>
                  <hiddenSegments>
                    <remove segment="bin"/>
                  </hiddenSegments>
                </requestFiltering>
              </security>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          EOF
          echo "âœ… web.config created"

      - name: ðŸ“ Create deployment info
        run: |
          cd server
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > DEPLOY_INFO.txt << EOF
          Deployment Timestamp: $TIMESTAMP
          Commit SHA: ${{ github.sha }}
          Commit Short: ${GITHUB_SHA:0:8}
          Run Number: ${{ github.run_number }}
          Run ID: ${{ github.run_id }}
          Actor: ${{ github.actor }}
          Ref: ${{ github.ref }}
          EOF
          
          echo "ðŸ“‹ Deployment Info:"
          cat DEPLOY_INFO.txt

      - name: â¸ï¸ Stop App Service for clean deployment
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "â¸ï¸ Stopping App Service for clean deployment..."
            
            az webapp stop \
              --resource-group rg-Emergencyassistant-app \
              --name emergency-assistantapp
            
            echo "âœ… App Service stopped"
            echo "â³ Waiting 10 seconds..."
            sleep 10

      - name: ðŸ—‘ï¸ Delete all files in wwwroot (Complete Clean)
        uses: azure/cli@v1
        continue-on-error: true
        with:
          inlineScript: |
            echo "ðŸ—‘ï¸ Deleting all files in wwwroot..."
            
            # wwwrootãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
            # Kudu APIçµŒç”±ã§å‰Šé™¤ï¼ˆå†å¸°çš„ï¼‰
            FOLDERS=("node_modules" "routes" "middleware" "services" "utils" "db" "config" "public")
            FILES=("azure-server.mjs" "package.json" "package-lock.json" "web.config" "DEPLOY_INFO.txt")
            
            # ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
            for folder in "${FOLDERS[@]}"; do
              echo "Deleting folder: $folder"
              az rest --method delete \
                --uri "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/${folder}/?recursive=true" \
                --resource "https://management.azure.com/" \
                || echo "Folder $folder not found or already deleted"
            done
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            for file in "${FILES[@]}"; do
              echo "Deleting file: $file"
              az rest --method delete \
                --uri "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/${file}" \
                --resource "https://management.azure.com/" \
                || echo "File $file not found or already deleted"
            done
            
            echo "âœ… All old files deleted - Ready for clean deployment"

      - name: ðŸ“¦ Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          cd server
          
          # zipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆï¼ˆå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
          zip -r ../deploy.zip \
            package.json \
            package-lock.json \
            azure-server.mjs \
            web.config \
            DEPLOY_INFO.txt \
            node_modules/ \
            routes/ \
            middleware/ \
            services/ \
            utils/ \
            db/ \
            config/ \
            -x "*.ts" "*.map" "*tsconfig*" "*.git*" "*.log" "*test*" "*spec*"
          
          cd ..
          echo "âœ… Package created"
          ls -lh deploy.zip
          echo "ðŸ“Š Package hash:"
          sha256sum deploy.zip

      - name: ðŸš€ Deploy to Azure App Service
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "ðŸš€ Deploying to Azure App Service..."
            
            # ZipDeployã‚’å®Ÿè¡Œ
            az webapp deployment source config-zip \
              --resource-group rg-Emergencyassistant-app \
              --name emergency-assistantapp \
              --src deploy.zip \
              --timeout 1800
            
            echo "âœ… ZipDeploy completed"

      - name: âš™ï¸ Configure environment variables
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "âš™ï¸ Setting environment variables..."
            
            az webapp config appsettings set \
              --resource-group rg-Emergencyassistant-app \
              --name emergency-assistantapp \
              --settings \
                NODE_ENV=production \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                PG_SSL="${{ secrets.PG_SSL }}" \
                SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
                JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
                STATIC_WEB_APP_URL="${{ secrets.STATIC_WEB_APP_URL }}" \
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
                AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
                AZURE_STORAGE_CONTAINER_NAME=knowledge \
                BLOB_PREFIX=knowledge-base/ \
                STORAGE_MODE=azure \
                OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
                OPENAI_MAX_TOKENS=2000 \
                DEBUG_MODE=false \
                VERBOSE_LOGGING=false \
                WEBSITE_RUN_FROM_PACKAGE=0 \
                SCM_DO_BUILD_DURING_DEPLOYMENT=false \
                WEBSITE_LOCAL_CACHE_OPTION=Never \
                WEBSITE_DYNAMIC_CACHE=0 \
                WEBSITES_ENABLE_APP_SERVICE_STORAGE=true \
                WEBSITE_NODE_DEFAULT_VERSION=20-lts
            
            echo "âœ… Environment variables configured"

      - name: â–¶ï¸ Start App Service with new deployment
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "â–¶ï¸ Starting App Service with new deployment..."
            
            az webapp start \
              --resource-group rg-Emergencyassistant-app \
              --name emergency-assistantapp
            
            echo "â³ Waiting 45 seconds for app to fully start..."
            sleep 45
            echo "âœ… App Service started successfully with clean deployment"

      - name: âœ… Verify deployment
        run: |
          echo "âœ… Deployment completed"
          echo "ðŸ” Verifying deployment..."
          
          APP_URL="https://emergency-assistantapp-gwgscxcca5chahyb9.japanwest-01.azurewebsites.net"
          
          # Health checkï¼ˆæœ€å¤§3å›žãƒªãƒˆãƒ©ã‚¤ï¼‰
          for i in 1 2 3; do
            echo "Attempt $i/3: Checking /api/health..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/api/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check PASSED (HTTP 200)"
              
              # Version check
              echo ""
              echo "ðŸ“Š Checking deployment version..."
              curl -s "$APP_URL/api/version" | jq '.' || echo "Version endpoint failed"
              
              break
            else
              echo "âš ï¸ Health check returned HTTP $HTTP_CODE"
              
              if [ $i -lt 3 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          echo ""
          echo "ðŸ“Š Deployment Summary:"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Run: ${{ github.run_number }}"
          echo "  - URL: $APP_URL"
          echo ""
          echo "ðŸŽ‰ Deployment workflow completed!"

# Trigger: Simplified and reliable deployment workflow
