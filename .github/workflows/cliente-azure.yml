name: Deploy Client (Azure Static Web Apps)

on:
  push:
    branches: [main, develop]
    paths:
      - 'client/**'
      - '.github/workflows/cliente-azure.yml'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'client-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  deploy-client:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set Environment Variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            echo "BACKEND_URL=https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING || secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            echo "BACKEND_URL=https://emergency-assistance-staging.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://staging.witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          fi

          echo "âœ… Environment: $ENVIRONMENT"
          echo "ğŸ”— Backend: $BACKEND_URL"

      - name: Validate Secrets
        run: |
          if [ -z "$STATIC_WEB_APP_TOKEN" ]; then
            echo "âŒ ERROR: Azure Static Web Apps token not found"
            echo "Required secrets for $ENVIRONMENT:"
            if [ "$ENVIRONMENT" = "production" ]; then
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN"
            else
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING or AZURE_STATIC_WEB_APPS_API_TOKEN"
            fi
            exit 1
          fi
          echo "âœ… Secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Dependencies
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Installing client dependencies..."
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build Client
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '/api' }}
          VITE_BACKEND_SERVICE_URL: ${{ env.BACKEND_URL }}
          VITE_ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          echo "ğŸ”¨ Building client for $ENVIRONMENT environment..."
          echo "   Backend URL: $BACKEND_URL"

          npm run build

          # ãƒ“ãƒ«ãƒ‰çµæœæ¤œè¨¼
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          required_files=("index.html" "main.mjs" "style.css" "runtime-config.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "dist/$file" ]; then
              echo "âŒ ERROR: Required file missing after build: dist/$file"
              exit 1
            fi
          done

          file_count=$(find dist -type f | wc -l)
          echo "âœ… Client build completed successfully: $file_count files"

          echo "ğŸ“Š Build Statistics:"
          echo "   Files: $file_count"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "   Contents:"
          ls -la dist/

          if [ $file_count -gt 10 ]; then
            echo "âš ï¸ WARNING: File count ($file_count) higher than expected"
            echo "ğŸ”§ Consider rebuilding with latest vite.config.js"
          else
            echo "âœ… File count ($file_count) is optimal for Azure Static Web Apps"
          fi

      - name: Update Configuration Files
        run: |
          echo "ğŸ”§ Updating runtime configuration..."

          # client/dist/runtime-config.js ã®æ›´æ–°
          if [ -f "client/dist/runtime-config.js" ]; then
            echo "ğŸ”„ Updating runtime-config.js..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
            echo "âœ… Runtime config updated"
          else
            echo "âš ï¸ runtime-config.js not found, creating..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
          fi

      - name: Inject Backend URL
        working-directory: ./client
        run: |
          echo "ğŸ”§ Injecting backend URL into runtime configuration..."

          if [ -f "dist/index.html" ]; then
            # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ç½®æ›
            if grep -q "{{BACKEND_URL}}" dist/index.html; then
              sed -i "s|{{BACKEND_URL}}|$BACKEND_URL|g" dist/index.html
              echo "âœ… Backend URL injected: $BACKEND_URL"
            else
              echo "â„¹ï¸ No placeholder found for backend URL injection"
            fi
          else
            echo "âš ï¸ dist/index.html not found, skipping injection"
          fi

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: /client
          output_location: dist
          skip_app_build: true  # æ—¢ã«ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—

      - name: Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 20
        run: |
          echo "ğŸ¥ Running health check for $ENVIRONMENT environment..."

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–¢æ•°
          health_check() {
            local url="$1"
            echo "Checking: $url"

            response=$(curl -s -w "%{http_code}" "$url" -o /dev/null || echo "000")
            if [[ "$response" =~ ^[23] ]]; then
              echo "âœ… Health check passed ($response)"
              return 0
            else
              echo "âŒ Health check failed ($response)"
              return 1
            fi
          }

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          success=false
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            echo "ğŸ”„ Attempt $i/$MAX_RETRIES..."

            if health_check "$STATIC_WEB_APP_URL"; then
              success=true
              break
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "â³ Waiting $RETRY_INTERVAL seconds before retry..."
              sleep $RETRY_INTERVAL
            fi
          done

          if [ "$success" = false ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Integration Test with Backend
        if: env.ENVIRONMENT == 'production'
        run: |
          echo "ğŸ§ª Running integration tests with backend..."

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
          backend_health() {
            curl -s --max-time 10 "$BACKEND_URL/api/health" || return 1
          }

          if backend_health; then
            echo "âœ… Backend integration test passed"
          else
            echo "âš ï¸ Backend integration test failed - continuing deployment"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ CLIENT DEPLOYMENT SUMMARY"
          echo "============================="
          echo "ğŸ• Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Environment: $ENVIRONMENT"
          echo "ğŸ”— Static Web App: $STATIC_WEB_APP_URL"
          echo "ğŸ”— Backend API: $BACKEND_URL"
          echo "ğŸ¯ Status: ${{ job.status }}"
          echo ""
          echo "ğŸ“ Next Steps:"
          echo "1. Visit: $STATIC_WEB_APP_URL"
          echo "2. Test key features"
          echo "3. Monitor logs if issues occur"
