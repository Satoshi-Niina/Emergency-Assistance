name: Deploy Client (Azure Static Web Apps)

on:
  push:
    branches: [main, develop]
    paths:
      - 'client/**'
      - '.github/workflows/cliente-azure.yml'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'client-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  deploy-client:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set Environment Variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "BACKEND_URL=${{ secrets.VITE_BACKEND_SERVICE_URL || 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net' }}" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "BACKEND_URL=${{ secrets.VITE_BACKEND_SERVICE_URL_STAGING || 'https://emergency-assistance-staging.azurewebsites.net' }}" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://staging-emergency-assistance.azurestaticapps.net" >> $GITHUB_ENV
          fi

      - name: Validate Secrets
        run: |
          echo "ğŸ” Validating deployment secrets..."
          # ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆå€¤ã¯è¡¨ç¤ºã›ãšï¼‰
          echo "Environment: $(echo $ENVIRONMENT)"
          echo "Backend URL configured: $([ -n "$BACKEND_URL" ] && echo "Yes" || echo "No")"
          echo "Token configured: $([ -n "$STATIC_WEB_APP_TOKEN" ] && echo "Yes" || echo "No")"

          if [ -z "$STATIC_WEB_APP_TOKEN" ]; then
            echo "âŒ Azure Static Web Apps API token is missing"
            echo "ğŸ“‹ Required secret: AZURE_STATIC_WEB_APPS_API_TOKEN (for production) or AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING"
            exit 1
          fi
          echo "âœ… Secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Client Dependencies
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Installing client dependencies..."
          npm ci --prefer-offline --no-audit --no-fund --progress=false
          echo "âœ… Client dependencies installed"

      - name: Clean Previous Build
        working-directory: ./client
        run: |
          if [ -d "dist" ]; then
            rm -rf dist
            echo "ğŸ§¹ Cleaned previous build directory"
          else
            echo "â„¹ï¸ No previous build directory found"
          fi

      - name: Build Client Application
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || '/api' }}
        run: |
          echo "ğŸ”¨ Building client for $ENVIRONMENT environment..."
          echo "   Backend URL: $BACKEND_URL"
          echo "   Static Web App URL: $STATIC_WEB_APP_URL"
          
          # ç’°å¢ƒå¤‰æ•°ã‚’Viteã«æ¸¡ã™
          export VITE_BACKEND_SERVICE_URL="$BACKEND_URL"
          export VITE_STATIC_WEB_APP_URL="$STATIC_WEB_APP_URL"
          export VITE_ENVIRONMENT="$ENVIRONMENT"
          
          npm run build
          
          # ãƒ“ãƒ«ãƒ‰çµæœæ¤œè¨¼
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi
          
          echo "ğŸ“Š Build Statistics BEFORE optimization:"
          echo "   Files: $(find dist -type f | wc -l)"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          
          # Azure Static Web Apps ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ¶é™å¯¾ç­–
          echo "ğŸ”§ Optimizing for Azure Static Web Apps file limits..."
          
          # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          find dist -name "*.map" -delete 2>/dev/null || true
          find dist -name "*.txt" -delete 2>/dev/null || true
          find dist -name "README*" -delete 2>/dev/null || true
          find dist -name "LICENSE*" -delete 2>/dev/null || true
          
          # å°ã•ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ±åˆï¼ˆ1KBæœªæº€ï¼‰
          find dist -type f -size -1024c ! -name "index.html" ! -name "*.ico" -delete 2>/dev/null || true
          
          echo "ğŸ“Š Build Statistics AFTER optimization:"
          echo "   Files: $(find dist -type f | wc -l)"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "   File breakdown:"
          find dist -type f -exec basename {} \; | sort | uniq -c | sort -nr | head -10
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
          file_count=$(find dist -type f | wc -l)
          if [ $file_count -gt 10000 ]; then
            echo "âš ï¸ Warning: File count ($file_count) exceeds Azure Static Web Apps recommendation (10,000)"
            echo "ğŸ”§ Consider further optimization if deployment fails"
          else
            echo "âœ… File count ($file_count) is within limits"
          fi
          
          echo "âœ… Optimized client build completed successfully"

      - name: Update Configuration Files
        run: |
          cd client
          echo "âš™ï¸ Updating configuration files..."

          # Update staticwebapp.config.json with backend URL
          if [ -f "staticwebapp.config.json" ]; then
            sed -i "s|\${BACKEND_SERVICE_URL}|$BACKEND_URL|g" staticwebapp.config.json
            echo "âœ… Updated staticwebapp.config.json with backend URL: $BACKEND_URL"
          fi

          # Inject backend URL into index.html
          if [ -f "dist/index.html" ]; then
            sed -i "s|PLACEHOLDER_BACKEND_SERVICE_URL|$BACKEND_URL|g" dist/index.html

            # ç¢ºèªç”¨ï¼šå®Ÿéš›ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‹ç¢ºèª
            if grep -q "window.BACKEND_SERVICE_URL" dist/index.html; then
              echo "âœ… Backend URL injection completed"
            else
              echo "â„¹ï¸ No placeholder found for backend URL injection"
            fi
          else
            echo "âš ï¸ dist/index.html not found, skipping injection"
          fi

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ env.STATIC_WEB_APP_TOKEN || secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: /client
          output_location: dist
          skip_app_build: true  # æ—¢ã«ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—

      - name: Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 20
        run: |
          echo "ğŸ¥ Running health check for $ENVIRONMENT environment..."

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–¢æ•°
          health_check() {
            local url="$1"
            response=$(curl -s --max-time 15 -o /dev/null -w "%{http_code}" "$url")
            if [[ "$response" =~ ^2[0-9][0-9]$ ]]; then
              echo "âœ… $url - HTTP $response"
              return 0
            else
              echo "âš ï¸ $url - HTTP $response"
              return 1
            fi
          }

          # Static Web App ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          for attempt in $(seq 1 ${{ env.MAX_RETRIES }}); do
            echo "ğŸ” Attempt $attempt/${{ env.MAX_RETRIES }}..."

            if health_check "$STATIC_WEB_APP_URL"; then
              echo "ğŸŠ Client deployment health check passed!"
              break
            fi

            if [ $attempt -lt ${{ env.MAX_RETRIES }} ]; then
              echo "â° Waiting ${{ env.RETRY_INTERVAL }}s..."
              sleep ${{ env.RETRY_INTERVAL }}
            fi
          done

      - name: Integration Test with Backend
        if: env.ENVIRONMENT == 'production'
        run: |
          echo "ğŸ§ª Running integration tests with backend..."

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
          backend_health() {
            curl -s --max-time 10 "$BACKEND_URL/health" || return 1
          }

          if backend_health; then
            echo "âœ… Backend integration test passed"
          else
            echo "âš ï¸ Backend integration test failed - continuing deployment"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ CLIENT DEPLOYMENT SUMMARY"
          echo "============================="
          echo "ğŸ• Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Environment: $ENVIRONMENT"
          echo "ğŸ”— Static Web App: $STATIC_WEB_APP_URL"
          echo "ğŸ”— Backend API: $BACKEND_URL"
          echo "ğŸ¯ Status: ${{ job.status }}"
          echo ""

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… CLIENT DEPLOYMENT SUCCESSFUL!"
            echo "ğŸš€ Your client application is ready!"
          else
            echo "âŒ CLIENT DEPLOYMENT FAILED!"
            echo "ğŸ”§ Check logs for troubleshooting"
          fi
          echo "============================="
