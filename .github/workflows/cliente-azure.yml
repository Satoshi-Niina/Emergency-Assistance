name: Deploy Client (Azure Static Web Apps)

on:
  push:
    branches: [main, develop]
    paths:
      - 'client/**'
      - '.github/workflows/cliente-azure.yml'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'client-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  deploy-client:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set Environment Variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            echo "BACKEND_URL=https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            if [ -n "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}" ]; then
              echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}" >> $GITHUB_ENV
            else
              echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            fi
            echo "BACKEND_URL=https://emergency-assistance-staging.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://staging.witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          fi

          echo "‚úÖ Environment: $ENVIRONMENT"
          echo "üîó Backend: $BACKEND_URL"

      - name: Validate Secrets
        run: |
          if [ -z "$STATIC_WEB_APP_TOKEN" ]; then
            echo "‚ùå ERROR: Azure Static Web Apps token not found"
            echo "Required secrets for $ENVIRONMENT:"
            if [ "$ENVIRONMENT" = "production" ]; then
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN"
            else
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING or AZURE_STATIC_WEB_APPS_API_TOKEN"
            fi
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Dependencies
        working-directory: ./client
        run: |
          echo "üì¶ Installing client dependencies..."
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build Client
        working-directory: ./client
        env:
          NODE_ENV: production
          VITE_BACKEND_SERVICE_URL: ${{ env.BACKEND_URL }}
          VITE_ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          echo "üî® Building client for $ENVIRONMENT environment..."
          echo "   Backend URL: $BACKEND_URL"

          # Set VITE_API_BASE_URL with fallback
          if [ -n "${{ secrets.VITE_API_BASE_URL }}" ]; then
            export VITE_API_BASE_URL="${{ secrets.VITE_API_BASE_URL }}"
          else
            export VITE_API_BASE_URL="/api"
          fi
          echo "   API Base URL: $VITE_API_BASE_URL"

          npm run build

          # „Éì„É´„ÉâÁµêÊûúÊ§úË®º
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          required_files=("index.html" "main.mjs" "style.css" "runtime-config.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "dist/$file" ]; then
              echo "‚ùå ERROR: Required file missing after build: dist/$file"
              exit 1
            fi
          done

          file_count=$(find dist -type f | wc -l)
          echo "‚úÖ Client build completed successfully: $file_count files"

          echo "üìä Build Statistics:"
          echo "   Files: $file_count"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "   Contents:"
          ls -la dist/

          # Azure Static Web Apps file limit check and optimization
          if [ $file_count -gt 1000 ]; then
            echo "‚ùå ERROR: File count ($file_count) exceeds Azure Static Web Apps limit (1000 files)"
            echo "üîß Optimizing build output..."

            # Remove source maps if they exist
            find dist -name "*.map" -delete || true

            # Remove unnecessary files
            find dist -name "*.txt" -not -name "robots.txt" -delete || true
            find dist -name "*.md" -delete || true

            # Recount files
            file_count=$(find dist -type f | wc -l)
            echo "üì¶ Optimized file count: $file_count"

            if [ $file_count -gt 1000 ]; then
              echo "‚ùå Still too many files after optimization. Manual intervention required."
              exit 1
            fi
          elif [ $file_count -gt 100 ]; then
            echo "‚ö†Ô∏è WARNING: File count ($file_count) is high but acceptable"
            echo "üîß Consider further build optimization for better performance"
          else
            echo "‚úÖ File count ($file_count) is optimal for Azure Static Web Apps"
          fi

      - name: Update Configuration Files
        run: |
          echo "üîß Updating runtime configuration..."

          # client/dist/runtime-config.js „ÅÆÊõ¥Êñ∞
          if [ -f "client/dist/runtime-config.js" ]; then
            echo "üîÑ Updating runtime-config.js..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
            echo "‚úÖ Runtime config updated"
          else
            echo "‚ö†Ô∏è runtime-config.js not found, creating..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
          fi

      - name: Inject Backend URL
        working-directory: ./client
        run: |
          echo "üîß Injecting backend URL into runtime configuration..."

          if [ -f "dist/index.html" ]; then
            # „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁΩÆÊèõ
            if grep -q "{{BACKEND_URL}}" dist/index.html; then
              sed -i "s|{{BACKEND_URL}}|$BACKEND_URL|g" dist/index.html
              echo "‚úÖ Backend URL injected: $BACKEND_URL"
            else
              echo "‚ÑπÔ∏è No placeholder found for backend URL injection"
            fi
          else
            echo "‚ö†Ô∏è dist/index.html not found, skipping injection"
          fi

      - name: Prepare Optimized Deployment Package
        working-directory: ./client
        run: |
          echo "üì¶ Preparing optimized deployment package..."

          # Create a clean deployment directory
          mkdir -p ../deploy-client

          # Copy essential HTML and config files
          cp dist/index.html ../deploy-client/
          cp staticwebapp.config.json ../deploy-client/

          # Copy JavaScript files (main bundle and chunks)
          find dist -type f \( -name "*.js" -o -name "*.mjs" \) | while read file; do
            cp "$file" ../deploy-client/
          done

          # Copy CSS files
          find dist -type f -name "*.css" | while read file; do
            cp "$file" ../deploy-client/
          done

          # Copy essential assets (images, fonts, etc.)
          if [ -d "dist/assets" ]; then
            mkdir -p ../deploy-client/assets
            # Copy only essential asset files (exclude source maps and large files)
            find dist/assets -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" -o -name "*.gif" -o -name "*.webp" -o -name "*.woff" -o -name "*.woff2" -o -name "*.ttf" -o -name "*.eot" \) \
              -exec cp {} ../deploy-client/assets/ \;
          fi

          # Copy runtime config
          [ -f "dist/runtime-config.js" ] && cp dist/runtime-config.js ../deploy-client/ || true

          # Copy manifest and favicon if they exist
          [ -f "dist/favicon.ico" ] && cp dist/favicon.ico ../deploy-client/ || true
          [ -f "dist/manifest.json" ] && cp dist/manifest.json ../deploy-client/ || true
          [ -f "dist/robots.txt" ] && cp dist/robots.txt ../deploy-client/ || true

          # Remove source maps if they were copied
          find ../deploy-client -name "*.map" -delete

          # Remove any unnecessary files
          find ../deploy-client -type f \( -name "*.txt" -o -name "*.md" -o -name "*.log" \) ! -name "robots.txt" -delete

          echo "üìä Final optimized deployment package:"
          ls -la ../deploy-client/
          file_count=$(find ../deploy-client -type f | wc -l)
          size=$(du -sh ../deploy-client/ | cut -f1)
          echo "   Files: $file_count"
          echo "   Size: $size"

          if [ $file_count -gt 1000 ]; then
            echo "‚ö†Ô∏è WARNING: File count ($file_count) is high for Azure Static Web Apps"
          else
            echo "‚úÖ File count ($file_count) is optimal"
          fi

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: /deploy-client
          output_location: ''
          skip_app_build: true

      - name: Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 20
        run: |
          echo "üè• Running health check for $ENVIRONMENT environment..."

          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
          health_check() {
            local url="$1"
            echo "Checking: $url"

            response=$(curl -s -w "%{http_code}" "$url" -o /dev/null || echo "000")
            if [[ "$response" =~ ^[23] ]]; then
              echo "‚úÖ Health check passed ($response)"
              return 0
            else
              echo "‚ùå Health check failed ($response)"
              return 1
            fi
          }

          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
          success=false
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            echo "üîÑ Attempt $i/$MAX_RETRIES..."

            if health_check "$STATIC_WEB_APP_URL"; then
              success=true
              break
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "‚è≥ Waiting $RETRY_INTERVAL seconds before retry..."
              sleep $RETRY_INTERVAL
            fi
          done

          if [ "$success" = false ]; then
            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Integration Test with Backend
        if: github.ref == 'refs/heads/main'
        run: |
          echo "üß™ Running integration tests with backend..."

          # „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å®„ÅÆÊé•Á∂ö„ÉÜ„Çπ„Éà
          backend_health() {
            curl -s --max-time 10 "$BACKEND_URL/api/health" || return 1
          }

          if backend_health; then
            echo "‚úÖ Backend integration test passed"
          else
            echo "‚ö†Ô∏è Backend integration test failed - continuing deployment"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üìã CLIENT DEPLOYMENT SUMMARY"
          echo "============================="
          echo "üïê Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üåç Environment: $ENVIRONMENT"
          echo "üîó Static Web App: $STATIC_WEB_APP_URL"
          echo "üîó Backend API: $BACKEND_URL"
          echo "üéØ Status: ${{ job.status }}"
          echo ""
          echo "üìç Next Steps:"
          echo "1. Visit: $STATIC_WEB_APP_URL"
          echo "2. Test key features"
          echo "3. Monitor logs if issues occur"
