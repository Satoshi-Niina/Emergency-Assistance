# Azure App Service GitHub Actions Workflow
# 繝舌ャ繧ｯ繧ｨ繝ｳ繝会ｼ・ode.js繧｢繝励Μ・峨ｒ繝薙Ν繝峨＠縲、zure App Service 縺ｫ繝・・繝ｭ繧､
name: Deploy Backend to Azure App Service

on:
  push:
    branches:
      - buckup
      - deployment-fix
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Backend
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Prepare full backend deployment
        run: |
          # 繝・ヰ繝・げ諠・ｱ繧貞・蜉・
          echo "=== Current directory and files ==="
          pwd
          ls -la
          echo "=== Node and npm versions ==="
          node -v
          npm -v
          
          # Deploy package繝・ぅ繝ｬ繧ｯ繝医Μ繧剃ｽ懈・
          mkdir -p deploy-package
          
          # 蠢・ｦ√↑繝輔ぃ繧､繝ｫ繧堤｢ｺ隱阪＠縺ｦ縺九ｉ繧ｳ繝斐・
          echo "=== Checking required directories ==="
          test -d server && echo "笨・server directory exists" || echo "笶・server directory missing"
          test -d shared && echo "笨・shared directory exists" || echo "笶・shared directory missing"
          test -d knowledge-base && echo "笨・knowledge-base directory exists" || echo "笶・knowledge-base directory missing"
          test -d migrations && echo "笨・migrations directory exists" || echo "笶・migrations directory missing"
          test -f package.json && echo "笨・package.json exists" || echo "笶・package.json missing"
          
          # 繝輔ぃ繧､繝ｫ繧偵さ繝斐・
          cp -r server/ deploy-package/
          cp -r shared/ deploy-package/
          cp -r knowledge-base/ deploy-package/
          cp -r migrations/ deploy-package/
          
          # 險ｭ螳壹ヵ繧｡繧､繝ｫ繧偵さ繝斐・
          cp package.json deploy-package/
          cp tsconfig.json deploy-package/
          cp drizzle.config.ts deploy-package/
          
          # 繧ｵ繝ｼ繝舌・逕ｨ縺ｮpackage.json繧剃ｿｮ豁｣・域悽逡ｪ逕ｨ繧ｹ繧ｿ繝ｼ繝医せ繧ｯ繝ｪ繝励ヨ・・
          cd deploy-package/server
          echo "=== Updating server package.json for production ==="
          # start繧ｹ繧ｯ繝ｪ繝励ヨ繧呈悽逡ｪ逕ｨ縺ｫ螟画峩
          npm pkg set scripts.start="tsx index.ts"
          npm pkg set scripts.start:prod="NODE_ENV=production tsx index.ts"
          cat package.json | grep -A 5 -B 5 "start"
          cd ..
          
          # 迺ｰ蠅・ヵ繧｡繧､繝ｫ縺ｮ險ｭ螳夲ｼ域悽逡ｪ逕ｨ・・
          cat > .env << 'EOF'
          NODE_ENV=production
          PORT=3001
          LANG=ja_JP.UTF-8
          LC_ALL=ja_JP.UTF-8
          NODE_OPTIONS=--max-old-space-size=4096
          SESSION_SECRET=emergency-assistance-session-secret-production
          EOF
          
          # Deploy package縺ｮ蜀・ｮｹ繧堤｢ｺ隱・
          echo "=== Deploy package contents ==="
          ls -la
          
          # 蜷・ョ繧｣繝ｬ繧ｯ繝医Μ縺ｮ萓晏ｭ倬未菫ゅｒ蛟句挨縺ｫ繧､繝ｳ繧ｹ繝医・繝ｫ
          echo "=== Installing shared dependencies ==="
          cd shared && npm install && npm run build && cd ..
          
          echo "=== Installing server dependencies ==="
          cd server && npm install && npm run build && cd ..
          
          echo "=== Installing root dependencies ==="
          npm install --production
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'emergency-backend-webapp'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: 'deploy-package'
