name: Backend CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'shared/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/backend.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'shared/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/backend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  AZURE_WEBAPP_NAME: 'Emergencyassistance-sv'
  AZURE_WEBAPP_PACKAGE_PATH: 'server'
  NODE_ENV: 'production'
  AZURE_RESOURCE_GROUP: 'rg-Emergencyassistant-app'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Clean install dependencies
      run: |
        echo "Cleaning all node_modules and package-lock.json files..."
        rm -rf node_modules package-lock.json
        rm -rf server/node_modules server/package-lock.json
        rm -rf shared/node_modules shared/package-lock.json
        echo "Clearing npm cache..."
        npm cache clean --force
        echo "Installing root dependencies..."
        npm install
        echo "Installing server dependencies..."
        cd server && npm install
        echo "Installing shared dependencies..."
        cd ../shared && npm install
        echo "‚úÖ All dependencies installed successfully"
        
    - name: Build shared
      run: |
        npm run build:shared
        
    - name: Clean Azure Web App
      run: |
        echo "Cleaning existing Azure Web App files..."
        # Azure Web App deployment automatically replaces all files
        
    - name: Prepare deployment package (Oryx Build)
      run: |
        echo "Preparing deployment package for Azure App Service Linux (Oryx Build)..."
        
        # Copy shared build to server
        cp -r shared/dist server/
        
        # For Oryx build, we only need source files
        # Dependencies will be installed by Oryx during deployment
        cd server
        
        echo "Setting up environment variables..."
        echo "NODE_ENV=production" > .env
        echo "PORT=8080" >> .env
        echo "JWT_SECRET=emergency-assistance-jwt-secret-key-32chars-minimum" >> .env
        echo "SESSION_SECRET=emergency-assistance-session-secret-32chars-minimum" >> .env
        echo "FRONTEND_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> .env
        echo "WEBSITE_NODE_DEFAULT_VERSION=~20" >> .env
        echo "NODEJS_VERSION=20" >> .env
        echo "NODE_VERSION=20" >> .env
        
        echo "Verifying source files..."
        ls -la production-server.js || echo "‚ùå production-server.js not found"
        ls -la package.json || echo "‚ùå package.json not found"
        ls -la routes/ || echo "‚ùå Routes directory not found"
        
        echo "Final package structure:"
        ls -la
        cd ..
        
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Configure Azure App Service Node Version (SKIPPED - Already configured)
      run: |
        echo "Node version is already configured in Azure App Service settings"
        echo "Skipping configuration to avoid permission errors"
        
    - name: Deploy to Azure Web App
      run: |
        echo "Deploying to Azure Web App using Azure CLI..."
        cd server
        
        # Install dependencies
        echo "Installing dependencies..."
        npm install --production
        
        # Create deployment package with node_modules
        echo "Creating deployment package..."
        zip -r ../deployment.zip . -x "*.log" "*.tmp" "test/*" "*.test.js"
        
        # Deploy using new Azure CLI command
        echo "Deploying to Azure..."
        az webapp deploy \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --src-path ../deployment.zip \
          --type zip
        
        echo "‚úÖ Deployment completed"
        
    - name: Verify deployment
      if: failure()
      run: |
        echo "‚ùå Backend deployment failed. This might be due to:"
        echo "1. Invalid publish profile credentials"
        echo "2. Missing dependencies in node_modules"
        echo "3. Azure App Service Windows configuration issues"
        echo "4. web.config configuration problems"
        echo ""
        echo "To fix this:"
        echo "1. Download a new publish profile from Azure Portal"
        echo "2. Update the AZURE_WEBAPP_PUBLISH_PROFILE secret"
        echo "3. Check Azure App Service Windows settings:"
        echo "   - Platform: Linux"
        echo "   - Node.js version: 20.19.3 (or 20 LTS)"
        echo "   - Startup command: npm start"
        echo "   - Environment variables: NODE_ENV=production, PORT=8080"
        echo ""
        echo "Current app name: ${{ env.AZURE_WEBAPP_NAME }}"
        echo "Package path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}"
        
    - name: Health check after deployment
      if: success()
      run: |
        echo "Waiting for deployment to complete..."
        sleep 120
        
        echo "üîç Performing comprehensive health checks..."
        
        # 1. Basic connectivity test with retry
        echo "1. Testing basic connectivity with retry..."
        for i in {1..5}; do
          echo "Attempt $i/5..."
          if curl -f --max-time 60 --connect-timeout 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/ping; then
            echo "‚úÖ Basic connectivity successful on attempt $i"
            break
          else
            echo "‚ùå Attempt $i failed, waiting 30 seconds..."
            sleep 30
            if [ $i -eq 5 ]; then
              echo "‚ùå All connectivity attempts failed"
              echo "üîç Checking Azure App Service status..."
              curl -I --max-time 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net || echo "‚ùå App Service not responding"
              exit 1
            fi
          fi
        done
        
        # 2. Health endpoint test
        echo "2. Testing health endpoint..."
        HEALTH_RESPONSE=$(curl -s --max-time 60 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/api/health)
        if [ $? -eq 0 ]; then
          echo "‚úÖ Health endpoint successful"
          echo "Health response: $HEALTH_RESPONSE"
          # Check if Node version is 20.x
          NODE_VERSION=$(echo "$HEALTH_RESPONSE" | grep -o '"nodeVersion":"[^"]*"' | cut -d'"' -f4)
          if [[ "$NODE_VERSION" == v20* ]]; then
            echo "‚úÖ Node version is correct: $NODE_VERSION"
          else
            echo "‚ùå Node version is incorrect: $NODE_VERSION (expected v20.x)"
            exit 1
          fi
        else
          echo "‚ùå Health endpoint failed"
          echo "üîç Checking if app is starting up..."
          curl -I --max-time 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net || echo "‚ùå App Service not responding"
          exit 1
        fi
        
        # 3. API endpoints test
        echo "3. Testing API endpoints..."
        curl -f --max-time 60 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/api/auth/handshake || {
          echo "‚ùå API endpoints failed"
          echo "üîç Checking basic app response..."
          curl -I --max-time 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net || echo "‚ùå App Service not responding"
          exit 1
        }
        
        # 4. Detailed health check
        echo "4. Testing detailed health endpoint..."
        DETAILED_RESPONSE=$(curl -s --max-time 60 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/api/health/detailed)
        if [ $? -eq 0 ]; then
          echo "‚úÖ Detailed health check successful"
          echo "Detailed response: $DETAILED_RESPONSE"
        else
          echo "‚ö†Ô∏è Detailed health check failed, but basic health check passed"
        fi
        
        # 5. Environment variables check
        echo "5. Testing environment variables endpoint..."
        ENV_RESPONSE=$(curl -s --max-time 60 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/api/_diag/env)
        if [ $? -eq 0 ]; then
          echo "‚úÖ Environment variables check successful"
          echo "Environment response: $ENV_RESPONSE"
        else
          echo "‚ö†Ô∏è Environment variables check failed"
        fi
        
        echo "‚úÖ All health checks passed!"
        echo "üöÄ Application is ready for production use"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Backend deployment successful"
          echo "üöÄ Backend API is ready at: https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net"
        else
          echo "‚ùå Backend deployment failed"
          echo "üîç Check the logs above for detailed error information"
        fi