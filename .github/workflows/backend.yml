name: Backend CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  AZURE_WEBAPP_NAME: 'emergencyassistance-sv-fbanemhrbshuf9bd'
  AZURE_WEBAPP_PACKAGE_PATH: 'server'
  NODE_ENV: 'production'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Clean install dependencies
      run: |
        echo "Cleaning all node_modules and package-lock.json files..."
        rm -rf node_modules package-lock.json
        rm -rf server/node_modules server/package-lock.json
        rm -rf shared/node_modules shared/package-lock.json
        echo "Clearing npm cache..."
        npm cache clean --force
        echo "Installing root dependencies..."
        npm install
        echo "Installing server dependencies..."
        cd server && npm install
        echo "Installing shared dependencies..."
        cd ../shared && npm install
        
    - name: Build shared
      run: |
        npm run build:shared
        
    - name: Clean Azure Web App
      run: |
        echo "Cleaning existing Azure Web App files..."
        # Azure Web App deployment automatically replaces all files
        
    - name: Prepare deployment package
      run: |
        echo "Preparing deployment package for Azure App Service Windows..."
        
        # Copy shared build to server
        cp -r shared/dist server/
        
        # Clean and reinstall server dependencies
        cd server
        echo "Cleaning server node_modules..."
        rm -rf node_modules package-lock.json
        
        echo "Installing server dependencies..."
        npm install --omit=dev --no-optional
        
        echo "Setting up environment variables..."
        echo "NODE_ENV=production" > .env
        echo "PORT=8080" >> .env
        echo "JWT_SECRET=emergency-assistance-jwt-secret-key-32chars-minimum" >> .env
        echo "SESSION_SECRET=emergency-assistance-session-secret-32chars-minimum" >> .env
        echo "FRONTEND_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> .env
        
        echo "Verifying critical packages..."
        ls -la node_modules/express/ || echo "‚ùå Express not found"
        ls -la node_modules/cors/ || echo "‚ùå CORS not found"
        ls -la node_modules/pg/ || echo "‚ùå PG not found"
        
        echo "Checking package.json..."
        cat package.json | grep -A 5 -B 5 "start"
        
        echo "Verifying routes directory..."
        ls -la routes/ || echo "‚ùå Routes directory not found"
        ls -la routes/index.js || echo "‚ùå routes/index.js not found"
        
        echo "Final package structure:"
        ls -la
        cd ..
        
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
      continue-on-error: true
      
    - name: Verify deployment
      if: failure()
      run: |
        echo "‚ùå Deployment failed. This might be due to:"
        echo "1. Invalid publish profile credentials"
        echo "2. Missing dependencies in node_modules"
        echo "3. Azure App Service Windows configuration issues"
        echo "4. web.config configuration problems"
        echo ""
        echo "To fix this:"
        echo "1. Download a new publish profile from Azure Portal"
        echo "2. Update the AZURE_WEBAPP_PUBLISH_PROFILE secret"
        echo "3. Check Azure App Service Windows settings:"
        echo "   - Platform: Windows"
        echo "   - Node.js version: 20.19.3"
        echo "   - Startup command: npm start"
        echo "   - web.config: nodeProcessCommandLine='npm start'"
        echo ""
        echo "Current app name: ${{ env.AZURE_WEBAPP_NAME }}"
        echo "Package path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}"
        
    - name: Health check after deployment
      if: success()
      run: |
        echo "Waiting for deployment to complete..."
        sleep 120
        
        echo "üîç Performing comprehensive health checks..."
        
        # 1. Basic connectivity test with retry
        echo "1. Testing basic connectivity with retry..."
        for i in {1..5}; do
          echo "Attempt $i/5..."
          if curl -f --max-time 60 --connect-timeout 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/ping; then
            echo "‚úÖ Basic connectivity successful on attempt $i"
            break
          else
            echo "‚ùå Attempt $i failed, waiting 30 seconds..."
            sleep 30
            if [ $i -eq 5 ]; then
              echo "‚ùå All connectivity attempts failed"
              echo "üîç Checking Azure App Service status..."
              curl -I --max-time 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net || echo "‚ùå App Service not responding"
              exit 1
            fi
          fi
        done
        
        # 2. Health endpoint test
        echo "2. Testing health endpoint..."
        curl -f --max-time 60 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/api/health || {
          echo "‚ùå Health endpoint failed"
          echo "üîç Checking if app is starting up..."
          curl -I --max-time 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net || echo "‚ùå App Service not responding"
          exit 1
        }
        
        # 3. API endpoints test
        echo "3. Testing API endpoints..."
        curl -f --max-time 60 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net/api/auth/handshake || {
          echo "‚ùå API endpoints failed"
          echo "üîç Checking basic app response..."
          curl -I --max-time 30 https://${{ env.AZURE_WEBAPP_NAME }}.japanwest-01.azurewebsites.net || echo "‚ùå App Service not responding"
          exit 1
        }
        
        echo "‚úÖ All health checks passed!"
        echo "üöÄ Application is ready for production use"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Backend deployment successful"
        else
          echo "‚ùå Backend deployment failed"
        fi
