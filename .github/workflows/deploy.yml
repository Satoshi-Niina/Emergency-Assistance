name: Deploy to Azure

on:
  push:
    branches:
      - backup
    paths:
      - 'server/**'
      - 'client/**'
      - 'package.json'
      - 'server.js'
      - '.github/workflows/deploy.yml'
      - 'trigger.txt'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Application
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          echo "=== Installing dependencies ==="
          npm install
          cd server && npm install
          cd ../client && npm install

      - name: Build backend
        run: |
          echo "=== Building backend ==="
          cd server
          npm run build:v2
          echo "Build completed"

      - name: Build frontend
        run: |
          echo "=== Building frontend ==="
          cd client
          npm run build
          echo "Frontend build completed"

      - name: Prepare deployment packages
        run: |
          echo "=== Preparing deployment packages ==="
          
          # Backend package
          mkdir -p ./deploy-backend
          cp -r ./server/dist ./deploy-backend/
          cp ./server.js ./deploy-backend/
          
          # Create backend package.json
          cat > ./deploy-backend/package.json << 'EOF'
          {
            "name": "emergency-assistance-azure",
            "version": "1.0.0",
            "main": "server.js",
            "type": "commonjs",
            "scripts": {
              "start": "node server.js"
            },
            "dependencies": {
              "@azure/storage-blob": "^12.28.0",
              "bcrypt": "^6.0.0",
              "cors": "^2.8.5",
              "dotenv": "^16.6.1",
              "express": "^4.21.2",
              "express-session": "^1.18.0",
              "pg": "^8.16.3",
              "jsonwebtoken": "^9.0.2"
            },
            "engines": {
              "node": ">=20",
              "npm": ">=10"
            }
          }
          EOF
          
          # Install backend dependencies
          cd ./deploy-backend
          npm install --omit=dev --no-audit --prefer-offline
          cd ..
          
          # Frontend package
          mkdir -p ./deploy-frontend
          cp -r ./client/dist/* ./deploy-frontend/
          if [ -f ./client/staticwebapp.config.json ]; then
            cp ./client/staticwebapp.config.json ./deploy-frontend/
          fi
          
          echo "=== Deployment packages ready ==="
          echo "Backend package size:"
          du -sh ./deploy-backend
          echo "Frontend package size:"
          du -sh ./deploy-frontend

      - name: Deploy Backend to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: emergencyassistance-sv
          slot-name: Production 
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy-backend

      - name: Deploy Frontend to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "upload"
          app_location: "./deploy-frontend"
          skip_app_build: true

      - name: Health Check
        run: |
          echo "üîç Starting health check..."
          
          # Wait for deployment
          echo "‚è≥ Waiting for deployment to complete (60 seconds)..."
          sleep 60
          
          # Check backend
          backend_url="https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net"
          echo "Checking backend: ${backend_url}/health"
          
          for i in {1..3}; do
            backend_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${backend_url}/health")
            echo "Backend check $i: $backend_status"
            
            if [ "$backend_status" = "200" ]; then
              echo "‚úÖ Backend health check passed"
              break
            fi
            
            if [ $i -lt 3 ]; then
              echo "‚è≥ Retrying in 20 seconds..."
              sleep 20
            fi
          done
          
          # Check frontend
          frontend_url="https://witty-river-012f39e00.1.azurestaticapps.net"
          echo "Checking frontend: ${frontend_url}"
          frontend_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${frontend_url}")
          echo "Frontend status: $frontend_status"
          
          if [ "$backend_status" = "200" ]; then
            echo "‚úÖ Deployment successful!"
            echo "Backend: ${backend_url}"
            echo "Frontend: ${frontend_url}"
          else
            echo "‚ö†Ô∏è Backend health check failed, but deployment completed"
          fi
