name: deploy-server-production-optimized

on:
  push:
    branches: [main]
  workflow_dispatch:

# æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ç‰ˆ
concurrency:
  group: 'azure-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  APP_URL: 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net'
  AZURE_APP_NAME: 'Emergency-Assistance'
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 30åˆ†â†’45åˆ†ã«å»¶é•·

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "ğŸ” Validating required secrets..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "âŒ AZURE_WEBAPP_PUBLISH_PROFILE secret is missing"
            exit 1
          fi
          echo "âœ… Required secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      # ğŸš€ æœ€é©åŒ–1: ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ - ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åŒæ™‚å®Ÿè¡Œ
      - name: Install Server Dependencies (Parallel)
        working-directory: ./server
        run: |
          echo "ğŸ“¦ Installing server dependencies with optimizations..."
          # ä¸¦åˆ—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« + ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
          npm ci --prefer-offline --no-audit --no-fund --progress=false
          echo "âœ… Server dependencies installed"

      - name: Install Client Dependencies (Parallel)
        working-directory: ./client
        run: |
          echo "ğŸ—ï¸ Installing client dependencies with optimizations..."
          # ä¸¦åˆ—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« + ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
          npm ci --prefer-offline --no-audit --no-fund --progress=false
          echo "âœ… Client dependencies installed"

      - name: Build Client (Optimized)
        working-directory: ./client
        run: |
          echo "ğŸ”¨ Building client with production optimizations..."

          # Vite ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–
          NODE_ENV=production npm run build

          # ãƒ“ãƒ«ãƒ‰çµæœæ¤œè¨¼ï¼ˆé«˜é€Ÿï¼‰
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Client build failed"
            exit 1
          fi

          # çµ±è¨ˆæƒ…å ±ï¼ˆç°¡ç•¥ç‰ˆï¼‰
          echo "ğŸ“Š Build completed: $(find dist -type f | wc -l) files, $(du -sh dist/ | cut -f1)"
          echo "âœ… Client build successful"

      # ğŸš€ æœ€é©åŒ–2: äº‹å‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
      - name: Create Optimized Deployment Package
        shell: bash
        run: |
          echo "ğŸ“¦ Creating optimized deployment package..."

          # ã‚¯ãƒªãƒ¼ãƒ³ãªä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          rm -rf deploy-package
          mkdir -p deploy-package

          echo "ğŸ“ Copying server files..."
          # ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆnode_modulesé™¤å¤–ï¼‰
          rsync -av --exclude='node_modules' server/ deploy-package/

          echo "ğŸ“ Copying client build..."
          mkdir -p deploy-package/client/dist
          cp -r client/dist/* deploy-package/client/dist/

          # ğŸš€ æœ€é©åŒ–3: package.json ã®ä¾å­˜é–¢ä¿‚ã‚’æœ€å°åŒ–
          echo "âš¡ Optimizing package.json for production..."

          # æœ¬ç•ªç”¨ package.json ã‚’ç”Ÿæˆï¼ˆé–‹ç™ºä¾å­˜é–¢ä¿‚ã‚’é™¤å¤–ï¼‰
          cd deploy-package
          npm pkg delete devDependencies scripts.dev scripts.test
          npm pkg set scripts.start="node app.js"

          # æœ€å°é™ã®æ¤œè¨¼
          echo "ğŸ“‹ Package validation:"
          ls -la | head -5
          ls -la client/dist/ | head -5

          echo "âœ… Optimized package ready"

      # ğŸš€ æœ€é©åŒ–4: Azure ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šæœ€é©åŒ–
      - name: Deploy to Azure (Optimized)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package
          clean: true
          restart: true
        env:
          # Azure Oryx ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–
          SCM_DO_BUILD_DURING_DEPLOYMENT: 'true'
          ENABLE_ORYX_BUILD: 'true'
          # npm ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æœ€é©åŒ–
          NPM_CONFIG_PRODUCTION: 'false'  # devDependencies ã‚‚ä¸€æ™‚çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          NPM_CONFIG_CACHE: '.npm'
          NPM_CONFIG_PREFER_OFFLINE: 'true'

      # ğŸš€ æœ€é©åŒ–5: è»½é‡ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Quick Health Check
        env:
          MAX_RETRIES: 3  # 6å›â†’3å›ã«å‰Šæ¸›
          RETRY_INTERVAL: 30  # 20ç§’â†’30ç§’ã«èª¿æ•´
        run: |
          echo "ğŸ¥ Quick health check..."

          # è»½é‡ãƒã‚§ãƒƒã‚¯é–¢æ•°
          quick_check() {
            local url="$1"
            response=$(curl -s --max-time 15 -o /dev/null -w "%{http_code}" "$url")
            if [[ "$response" =~ ^2[0-9][0-9]$ ]]; then
              echo "âœ… $url - HTTP $response"
              return 0
            else
              echo "âš ï¸ $url - HTTP $response"
              return 1
            fi
          }

          # æœ€å°é™ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
          for attempt in $(seq 1 ${{ env.MAX_RETRIES }}); do
            echo "ğŸ” Attempt $attempt/${{ env.MAX_RETRIES }}..."

            if quick_check "${{ env.APP_URL }}/health" || quick_check "${{ env.APP_URL }}/"; then
              echo "ğŸŠ Health check passed!"
              break
            fi

            if [ $attempt -lt ${{ env.MAX_RETRIES }} ]; then
              echo "â° Waiting ${{ env.RETRY_INTERVAL }}s..."
              sleep ${{ env.RETRY_INTERVAL }}
            fi
          done

      - name: Deployment Summary
        if: always()
        run: |
          echo "ğŸ“‹ OPTIMIZED DEPLOYMENT SUMMARY"
          echo "=============================="
          echo "ğŸ• Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Application: ${{ env.APP_URL }}"
          echo "âš¡ Optimizations Applied:"
          echo "   âœ… Extended timeout (45min)"
          echo "   âœ… Parallel dependency installation"
          echo "   âœ… Production package optimization"
          echo "   âœ… Enhanced Azure build settings"
          echo "   âœ… Streamlined health checks"
          echo "ğŸ¯ Status: ${{ job.status }}"
          echo "=============================="
