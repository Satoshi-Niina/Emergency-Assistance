name: Deploy Client (Azure Static Web Apps)

on:
  push:
    branches: [main, develop]
    paths:
      - 'client/**'
      - '.github/workflows/deploy-cliente-azure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'client-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  deploy-client:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set Environment Variables
        run: |
          # ç’°å¢ƒåˆ¤å®š: ãƒ—ãƒƒã‚·ãƒ¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ãƒ–ãƒ©ãƒ³ãƒåã€workflow_dispatchã®å ´åˆã¯å…¥åŠ›å€¤ã‚’ä½¿ç”¨
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV_INPUT="${{ github.event.inputs.environment }}"
            if [[ "$ENV_INPUT" == "production" ]] || [[ -z "$ENV_INPUT" ]]; then
              ENV_TYPE="production"
            else
              ENV_TYPE="staging"
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV_TYPE="production"
          else
            ENV_TYPE="staging"
          fi

          if [[ "$ENV_TYPE" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            echo "BACKEND_URL=https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
            echo "âœ… Environment: production"
            echo "ğŸ”— Backend: https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net"
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            STAGING_TOKEN="${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}"
            if [ -n "$STAGING_TOKEN" ] && [ "$STAGING_TOKEN" != "" ]; then
              echo "STATIC_WEB_APP_TOKEN=$STAGING_TOKEN" >> $GITHUB_ENV
            else
              echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            fi
            echo "BACKEND_URL=https://emergency-assistance-staging.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://staging.witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
            echo "âœ… Environment: staging"
            echo "ğŸ”— Backend: https://emergency-assistance-staging.japanwest-01.azurewebsites.net"
          fi

      - name: Validate Secrets
        run: |
          if [ -z "$STATIC_WEB_APP_TOKEN" ]; then
            echo "âŒ ERROR: Azure Static Web Apps token not found"
            echo "Required secrets for $ENVIRONMENT:"
            if [ "$ENVIRONMENT" = "production" ]; then
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN"
            else
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING or AZURE_STATIC_WEB_APPS_API_TOKEN"
            fi
            exit 1
          fi
          echo "âœ… Secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Dependencies
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Installing client dependencies..."
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build Client
        working-directory: ./client
        run: |
          echo "ğŸ”¨ Building client for $ENVIRONMENT environment..."
          echo "   Backend URL: $BACKEND_URL"

          # Complete cache clear - ensure absolutely fresh build
          echo "ğŸ§¹ Clearing ALL build artifacts and caches..."
          rm -rf dist node_modules/.vite .vite .cache .parcel-cache .turbo .next .nuxt || true
          npm cache clean --force || true
          # Clear Vite cache specifically
          rm -rf node_modules/.cache || true
          # Clear any build artifacts
          find . -name "*.map" -delete || true
          find . -name ".DS_Store" -delete || true

          # Remove any existing dist to ensure clean build
          if [ -d "dist" ]; then
            echo "ğŸ—‘ï¸ Removing existing dist directory..."
            rm -rf dist
          fi

          # Verify source file has correct changes
          echo "ğŸ” Verifying source file changes..."
          echo "ğŸ“„ Checking source file: src/pages/settings.tsx"

          # Check file exists
          if [ ! -f "src/pages/settings.tsx" ]; then
            echo "âŒ ERROR: src/pages/settings.tsx not found!"
            ls -la src/pages/ || echo "src/pages directory not found"
            exit 1
          fi

          FILE_SIZE=$(wc -c < src/pages/settings.tsx 2>/dev/null || echo "0")
          echo "   File exists: yes"
          echo "   File size: $FILE_SIZE bytes"

          # Show file info
          if command -v stat >/dev/null 2>&1; then
            echo "   Last modified: $(stat -c %y src/pages/settings.tsx 2>/dev/null || stat -f %Sm src/pages/settings.tsx 2>/dev/null || echo 'unknown')"
          else
            echo "   Last modified: $(ls -la src/pages/settings.tsx | awk '{print $6, $7, $8}' 2>/dev/null || echo 'unknown')"
          fi

          # Check for old code
          if grep -q "hasSecurityAccess" src/pages/settings.tsx; then
            echo "âŒ ERROR: Source file still contains hasSecurityAccess!"
            echo "   Found at lines:"
            grep -n "hasSecurityAccess" src/pages/settings.tsx | head -3
            exit 1
          fi
          echo "   âœ… hasSecurityAccess not found (good)"

          # Count card occurrences
          SECURITY_COUNT=$(grep -c "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" src/pages/settings.tsx 2>/dev/null || echo "0")
          MAINTENANCE_COUNT=$(grep -c "ä¿å®ˆç®¡ç†" src/pages/settings.tsx 2>/dev/null || echo "0")

          echo "   Security card count: $SECURITY_COUNT"
          echo "   Maintenance card count: $MAINTENANCE_COUNT"

          # Verify cards exist
          if [ "$SECURITY_COUNT" -eq "0" ]; then
            echo "âŒ ERROR: Security card (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–) not found in source file!"
            echo "   Showing Card components in file:"
            grep -n "Card" src/pages/settings.tsx | head -15
            echo "   Showing lines around line 440-450:"
            sed -n '440,460p' src/pages/settings.tsx 2>/dev/null || echo "   Cannot read file"
            exit 1
          fi

          if [ "$MAINTENANCE_COUNT" -eq "0" ]; then
            echo "âŒ ERROR: Maintenance card (ä¿å®ˆç®¡ç†) not found in source file!"
            echo "   Showing Card components in file:"
            grep -n "Card" src/pages/settings.tsx | tail -15
            echo "   Showing lines around line 500-510:"
            sed -n '500,520p' src/pages/settings.tsx 2>/dev/null || echo "   Cannot read file"
            exit 1
          fi

          # Verify cards are NOT inside conditional rendering (check 20 lines before)
          SECURITY_LINE=$(grep -n "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" src/pages/settings.tsx | head -1 | cut -d: -f1)
          if [ -n "$SECURITY_LINE" ]; then
            START_LINE=$((SECURITY_LINE - 20))
            if [ "$START_LINE" -lt 1 ]; then START_LINE=1; fi
            if sed -n "${START_LINE},${SECURITY_LINE}p" src/pages/settings.tsx | grep -q "hasSecurityAccess\|user\?\.role.*admin\|role === 'admin'\|&&.*Card\|if.*Card"; then
              echo "âš ï¸ WARNING: Security card might be inside conditional rendering!"
              sed -n "${START_LINE},${SECURITY_LINE}p" src/pages/settings.tsx | grep -n "hasSecurityAccess\|user\?\.role\|role ===\|&&\|if"
            fi
          fi

          MAINTENANCE_LINE=$(grep -n "ä¿å®ˆç®¡ç†" src/pages/settings.tsx | head -1 | cut -d: -f1)
          if [ -n "$MAINTENANCE_LINE" ]; then
            START_LINE=$((MAINTENANCE_LINE - 20))
            if [ "$START_LINE" -lt 1 ]; then START_LINE=1; fi
            if sed -n "${START_LINE},${MAINTENANCE_LINE}p" src/pages/settings.tsx | grep -q "hasSecurityAccess\|user\?\.role.*admin\|role === 'admin'\|&&.*Card\|if.*Card"; then
              echo "âš ï¸ WARNING: Maintenance card might be inside conditional rendering!"
              sed -n "${START_LINE},${MAINTENANCE_LINE}p" src/pages/settings.tsx | grep -n "hasSecurityAccess\|user\?\.role\|role ===\|&&\|if"
            fi
          fi

          echo "âœ… Source file verification passed - cards are present and should be visible"

          # Set environment variables for Vite build
          export NODE_ENV=production
          export VITE_BACKEND_SERVICE_URL="$BACKEND_URL"
          export VITE_API_BASE_URL="$BACKEND_URL/api"
          export VITE_ENVIRONMENT="$ENVIRONMENT"
          # Force new build ID with timestamp to bypass ALL caches
          BUILD_TIMESTAMP=$(date +%s)
          export VITE_BUILD_ID="${BUILD_TIMESTAMP}-${{ github.sha }}"
          export VITE_BUILD_VERSION="${BUILD_TIMESTAMP}"

          echo "   API Base URL: $VITE_API_BASE_URL"
          echo "   Build ID: $VITE_BUILD_ID"
          echo "   Build Timestamp: $BUILD_TIMESTAMP"

          # Build with no cache
          echo "ğŸ”¨ Running build command..."
          npm run build 2>&1 | tee build.log || {
            echo "âŒ Build failed!"
            cat build.log
            exit 1
          }

          # Verify build output immediately after build
          echo "ğŸ” Immediate verification of build output..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ ERROR: dist/index.html not found immediately after build!"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          # Check if cards are in the built file
          MAIN_FILE=$(ls dist/main.*.mjs 2>/dev/null | head -1)
          if [ -z "$MAIN_FILE" ]; then
            echo "âŒ ERROR: main.*.mjs file not found!"
            ls -la dist/
            exit 1
          fi

          echo "ğŸ“„ Checking built file: $MAIN_FILE"
          echo "   File size: $(wc -c < "$MAIN_FILE" 2>/dev/null || echo 'unknown') bytes"

          # Check for security card in built file
          if grep -q "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" "$MAIN_FILE"; then
            SECURITY_MATCHES=$(grep -o "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" "$MAIN_FILE" | wc -l)
            echo "âœ… Security card found in $MAIN_FILE ($SECURITY_MATCHES occurrences)"
          else
            echo "âŒ ERROR: Security card NOT found in $MAIN_FILE!"
            echo "   File size: $(wc -c < "$MAIN_FILE" 2>/dev/null || echo 'unknown') bytes"
            echo "   Showing sample content from built file:"
            head -c 5000 "$MAIN_FILE" 2>/dev/null | tail -c 1000 || echo "   Cannot read file"
            echo "   Checking if file contains any Japanese text:"
            grep -o '[ã‚-ã‚“]' "$MAIN_FILE" | head -20 || echo "   No Japanese characters found"
            exit 1
          fi

          # Check for maintenance card in built file
          if grep -q "ä¿å®ˆç®¡ç†" "$MAIN_FILE"; then
            MAINTENANCE_MATCHES=$(grep -o "ä¿å®ˆç®¡ç†" "$MAIN_FILE" | wc -l)
            echo "âœ… Maintenance card found in $MAIN_FILE ($MAINTENANCE_MATCHES occurrences)"
          else
            echo "âŒ ERROR: Maintenance card NOT found in $MAIN_FILE!"
            echo "   File size: $(wc -c < "$MAIN_FILE" 2>/dev/null || echo 'unknown') bytes"
            echo "   Showing sample content from built file:"
            head -c 5000 "$MAIN_FILE" 2>/dev/null | tail -c 1000 || echo "   Cannot read file"
            exit 1
          fi

          # Verify old code is not in built file
          if grep -q "hasSecurityAccess" "$MAIN_FILE"; then
            echo "âŒ ERROR: hasSecurityAccess still found in $MAIN_FILE!"
            echo "   Found at:"
            grep -o "hasSecurityAccess[^\"']*" "$MAIN_FILE" | head -3
            exit 1
          else
            echo "âœ… hasSecurityAccess removed from $MAIN_FILE (good)"
          fi

          echo "âœ… Build verification passed - both cards are in the built file"

          if grep -q "hasSecurityAccess" "$MAIN_FILE"; then
            echo "âŒ ERROR: hasSecurityAccess still found in $MAIN_FILE!"
            grep -n "hasSecurityAccess" "$MAIN_FILE" | head -5
            exit 1
          else
            echo "âœ… hasSecurityAccess removed from $MAIN_FILE"
          fi

          # ãƒ“ãƒ«ãƒ‰çµæœæ¤œè¨¼
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          # ãƒãƒƒã‚·ãƒ¥ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œ
          required_files=("index.html" "runtime-config.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "dist/$file" ]; then
              echo "âŒ ERROR: Required file missing after build: dist/$file"
              exit 1
            fi
          done

          # ãƒãƒƒã‚·ãƒ¥ä»˜ããƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if ! ls dist/main.*.mjs 1> /dev/null 2>&1; then
            echo "âŒ ERROR: Required file missing after build: dist/main.*.mjs"
            ls -la dist/ | grep -E "\.(mjs|js)$" || echo "No .mjs or .js files found"
            exit 1
          fi

          if ! ls dist/style.*.css 1> /dev/null 2>&1; then
            echo "âŒ ERROR: Required file missing after build: dist/style.*.css"
            ls -la dist/ | grep -E "\.css$" || echo "No .css files found"
            exit 1
          fi

          file_count=$(find dist -type f | wc -l)
          echo "âœ… Client build completed successfully: $file_count files"

          echo "ğŸ“Š Build Statistics:"
          echo "   Files: $file_count"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "   Contents:"
          ls -la dist/

          # Azure Static Web Apps file limit check and optimization
          if [ $file_count -gt 1000 ]; then
            echo "âŒ ERROR: File count ($file_count) exceeds Azure Static Web Apps limit (1000 files)"
            echo "ğŸ”§ Optimizing build output..."

            # Remove source maps if they exist
            find dist -name "*.map" -delete || true

            # Remove unnecessary files
            find dist -name "*.txt" -not -name "robots.txt" -delete || true
            find dist -name "*.md" -delete || true

            # Recount files
            file_count=$(find dist -type f | wc -l)
            echo "ğŸ“¦ Optimized file count: $file_count"

            if [ $file_count -gt 1000 ]; then
              echo "âŒ Still too many files after optimization. Manual intervention required."
              exit 1
            fi
          elif [ $file_count -gt 100 ]; then
            echo "âš ï¸ WARNING: File count ($file_count) is high but acceptable"
            echo "ğŸ”§ Consider further build optimization for better performance"
          else
            echo "âœ… File count ($file_count) is optimal for Azure Static Web Apps"
          fi

      - name: Update Configuration Files
        run: |
          echo "ğŸ”§ Updating runtime configuration..."

          # client/dist/runtime-config.js ã®æ›´æ–°
          if [ -f "client/dist/runtime-config.js" ]; then
            echo "ğŸ”„ Updating runtime-config.js..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
            echo "âœ… Runtime config updated"
          else
            echo "âš ï¸ runtime-config.js not found, creating..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
          fi

          # index.htmlã«ãƒ“ãƒ«ãƒ‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ãƒ¡ã‚¿ã‚¿ã‚°ã‚’è¿½åŠ 
          if [ -f "client/dist/index.html" ]; then
            echo "ğŸ”„ Adding build version and cache-busting to index.html..."
            SHA_SHORT="${{ github.sha }}"
            BUILD_TIMESTAMP=$(date +%s)
            BUILD_VERSION="v${BUILD_TIMESTAMP}-${SHA_SHORT:0:7}"

            # HTMLã‚¿ã‚°ã«ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’è¿½åŠ 
            sed -i "s|<html lang=\"ja\">|<html lang=\"ja\" data-build=\"$BUILD_VERSION\" data-timestamp=\"$BUILD_TIMESTAMP\">|g" client/dist/index.html

            # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
            sed -i "s|<script type=\"module\"|<script type=\"module\" data-version=\"$BUILD_VERSION\" data-timestamp=\"$BUILD_TIMESTAMP\"|g" client/dist/index.html

            # metaã‚¿ã‚°ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ—¢ã«å­˜åœ¨ã—ãªã„å ´åˆã®ã¿è¿½åŠ ï¼‰
            if ! grep -q "Cache-Control" client/dist/index.html; then
              sed -i "s|<head>|<head>\n  <meta http-equiv=\"Cache-Control\" content=\"no-cache, no-store, must-revalidate\">\n  <meta http-equiv=\"Pragma\" content=\"no-cache\">\n  <meta http-equiv=\"Expires\" content=\"0\">|g" client/dist/index.html
            fi

            echo "âœ… Build version and cache-busting added: $BUILD_VERSION (timestamp: $BUILD_TIMESTAMP)"
          fi

      - name: Inject Backend URL
        working-directory: ./client
        run: |
          echo "ğŸ”§ Injecting backend URL into runtime configuration..."

          if [ -f "dist/index.html" ]; then
            # window.BACKEND_SERVICE_URLã‚’ç½®æ›
            if grep -q "window.BACKEND_SERVICE_URL" dist/index.html; then
              # æ—¢å­˜ã®window.BACKEND_SERVICE_URLã®å€¤ã‚’ç½®æ›
              sed -i "s|window.BACKEND_SERVICE_URL = '[^']*'|window.BACKEND_SERVICE_URL = '$BACKEND_URL'|g" dist/index.html
              echo "âœ… Backend URL injected: $BACKEND_URL"
            # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ç½®æ›
            elif grep -q "{{BACKEND_URL}}" dist/index.html; then
              sed -i "s|{{BACKEND_URL}}|$BACKEND_URL|g" dist/index.html
              echo "âœ… Backend URL injected via placeholder: $BACKEND_URL"
            else
              echo "â„¹ï¸ No window.BACKEND_SERVICE_URL or placeholder found for backend URL injection"
            fi
          else
            echo "âš ï¸ dist/index.html not found, skipping injection"
          fi

      - name: Verify Build Output
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Verifying build output..."

          # Copy staticwebapp.config.json to dist
          cp staticwebapp.config.json dist/

          echo "ğŸ“Š Final deployment package:"
          ls -lah dist/
          file_count=$(find dist -type f | wc -l)
          size=$(du -sh dist/ | cut -f1)
          echo "   Files: $file_count"
          echo "   Size: $size"

          # Remove source maps to reduce file count
          find dist -name "*.map" -delete || true

          file_count_after=$(find dist -type f | wc -l)
          echo "   Files after optimization: $file_count_after"

          if [ $file_count_after -gt 1000 ]; then
            echo "âš ï¸ WARNING: File count ($file_count_after) exceeds Azure Static Web Apps limit"
          else
            echo "âœ… File count ($file_count_after) is optimal"
          fi

      - name: Verify Build Output Before Deploy
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Verifying build output before deployment..."

          # distãƒ•ã‚©ãƒ«ãƒ€ã®å­˜åœ¨ç¢ºèª
          if [ ! -d "dist" ]; then
            echo "âŒ ERROR: dist directory not found!"
            exit 1
          fi

          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          required_files=("index.html" "main.*.mjs" "style.*.css")
          for pattern in "${required_files[@]}"; do
            if ! ls dist/$pattern 1> /dev/null 2>&1; then
              echo "âŒ ERROR: Required file not found: dist/$pattern"
              ls -la dist/ || echo "dist directory listing failed"
              exit 1
            fi
          done

          # settings.tsxã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«hasSecurityAccessãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ï¼‰
          echo "ğŸ” Checking if settings page changes are in build..."
          if find dist -name "*.mjs" -exec grep -l "hasSecurityAccess" {} \; 2>/dev/null | grep -q .; then
            echo "âŒ ERROR: hasSecurityAccess found in built files - old code is still present!"
            echo "This means the build is using cached or old code."
            echo "Files containing hasSecurityAccess:"
            find dist -name "*.mjs" -exec grep -l "hasSecurityAccess" {} \; 2>/dev/null
            exit 1
          else
            echo "âœ… hasSecurityAccess not found in built files - changes are included"
          fi

          # ã‚«ãƒ¼ãƒ‰ãŒç¢ºå®Ÿã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          echo "ğŸ” Verifying cards are in build..."
          if find dist -name "*.mjs" -exec grep -l "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" {} \; 2>/dev/null | grep -q .; then
            echo "âœ… Security card found in build"
          else
            echo "âŒ ERROR: Security card not found in build!"
            exit 1
          fi

          if find dist -name "*.mjs" -exec grep -l "ä¿å®ˆç®¡ç†" {} \; 2>/dev/null | grep -q .; then
            echo "âœ… Maintenance card found in build"
          else
            echo "âŒ ERROR: Maintenance card not found in build!"
            exit 1
          fi

          # æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          echo "ğŸ” Verifying permission checks are removed..."
          if find dist -name "*.mjs" -exec grep -l "hasSecurityAccess.*&&" {} \; 2>/dev/null | grep -q .; then
            echo "âŒ ERROR: Permission check (hasSecurityAccess &&) still found in build!"
            exit 1
          else
            echo "âœ… Permission checks removed from build"
          fi

          # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
          echo "ğŸ“Š Build output files:"
          ls -lah dist/ | head -20

          echo "âœ… Build output verification completed"

      - name: Clear All Caches Before Deploy
        run: |
          echo "ğŸ—‘ï¸ Clearing ALL caches before deployment..."
          # Clear Azure Static Web Apps CLI cache
          rm -rf ~/.azure-static-web-apps-cli || true
          # Clear npm cache
          npm cache clean --force || true
          # Clear any other potential caches
          rm -rf ~/.cache || true
          echo "âœ… All caches cleared"

      - name: Verify Files Before Deploy
        run: |
          echo "ğŸ“‹ Verifying files before deployment..."
          echo "Current directory: $(pwd)"
          echo "Working directory: ${{ github.workspace }}"

          # çµ¶å¯¾ãƒ‘ã‚¹ã§ç¢ºèª
          if [ ! -d "${{ github.workspace }}/client/dist" ]; then
            echo "âŒ ERROR: client/dist directory does not exist at ${{ github.workspace }}/client/dist"
            echo "Listing client directory:"
            ls -lah client/ || echo "client directory not found"
            exit 1
          fi

          echo "Checking client/dist directory:"
          ls -lah client/dist/ || echo "âŒ client/dist directory not found!"

          if [ ! -f "client/dist/index.html" ]; then
            echo "âŒ ERROR: client/dist/index.html not found!"
            echo "Files in client/dist:"
            ls -lah client/dist/ || echo "Cannot list files"
            exit 1
          fi

          echo "âœ… Required files verified"
          echo "File count in client/dist: $(find client/dist -type f | wc -l)"
          echo "Directory size: $(du -sh client/dist | cut -f1)"

      - name: Final Check Before Deploy
        run: |
          echo "ğŸ” Final check before deployment..."
          echo "Current directory: $(pwd)"
          echo "Checking if client/dist exists:"
          if [ -d "client/dist" ]; then
            echo "âœ… client/dist directory exists"
            echo "File count: $(find client/dist -type f | wc -l)"
            echo "Files in client/dist:"
            ls -lah client/dist/ | head -10
          else
            echo "âŒ ERROR: client/dist directory does not exist!"
            echo "Contents of client directory:"
            ls -lah client/ || echo "client directory not found"
            exit 1
          fi

      - name: Force Clean Deployment - Remove Old Files
        run: |
          echo "ğŸ—‘ï¸ Force cleaning deployment directory..."
          # Azure Static Web Appsã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
          # ã“ã‚Œã«ã‚ˆã‚Šå¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºå®Ÿã«å‰Šé™¤ã•ã‚Œã‚‹
          if [ -d "client/dist" ]; then
            echo "ğŸ“‹ Current files in dist before deployment:"
            find client/dist -type f -name "*.mjs" -o -name "*.js" -o -name "*.html" | head -20
            echo ""
            echo "ğŸ§¹ Ensuring clean state..."
            # æ—¢å­˜ã®ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
            OLD_MAIN_FILES=$(find client/dist -name "main.*.mjs" 2>/dev/null | wc -l)
            echo "   Old main.*.mjs files found: $OLD_MAIN_FILES"
            if [ "$OLD_MAIN_FILES" -gt 0 ]; then
              echo "   âš ï¸ Old build files detected - they will be replaced by new build"
            fi
          fi

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: client/dist
          output_location: ''
          skip_app_build: true
          skip_api_build: true
          production_branch: main
          deployment_environment: production
        continue-on-error: false
        env:
          DEBUG: '*'

      - name: Verify Deployed Files After Deployment
        run: |
          echo "ğŸ” Verifying deployed files after deployment..."
          echo "âš ï¸ Note: This verification checks local files, not Azure Static Web Apps"
          echo "   To verify actual deployment, check Azure Static Web Apps portal"
          echo ""
          
          if [ -d "client/dist" ]; then
            echo "ğŸ“‹ Files that were deployed:"
            MAIN_FILE=$(ls client/dist/main.*.mjs 2>/dev/null | head -1)
            if [ -n "$MAIN_FILE" ]; then
              echo "   Main file: $MAIN_FILE"
              echo "   File size: $(wc -c < "$MAIN_FILE" 2>/dev/null || echo 'unknown') bytes"
              echo ""
              echo "   Checking for cards in deployed file:"
              if grep -q "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" "$MAIN_FILE" 2>/dev/null; then
                SECURITY_COUNT=$(grep -o "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" "$MAIN_FILE" | wc -l)
                echo "   âœ… Security card found ($SECURITY_COUNT occurrences)"
              else
                echo "   âŒ Security card NOT found in deployed file!"
              fi
              
              if grep -q "ä¿å®ˆç®¡ç†" "$MAIN_FILE" 2>/dev/null; then
                MAINTENANCE_COUNT=$(grep -o "ä¿å®ˆç®¡ç†" "$MAIN_FILE" | wc -l)
                echo "   âœ… Maintenance card found ($MAINTENANCE_COUNT occurrences)"
              else
                echo "   âŒ Maintenance card NOT found in deployed file!"
              fi
              
              if grep -q "hasSecurityAccess" "$MAIN_FILE" 2>/dev/null; then
                echo "   âŒ ERROR: hasSecurityAccess found in deployed file (old code!)"
                exit 1
              else
                echo "   âœ… hasSecurityAccess removed (good)"
              fi
            else
              echo "   âŒ Main file not found!"
            fi
          else
            echo "   âŒ dist directory not found!"
          fi
          
          echo ""
          echo "ğŸ’¡ To verify actual deployment on Azure Static Web Apps:"
          echo "   1. Go to Azure Portal > Static Web Apps > Deployment History"
          echo "   2. Check the latest deployment"
          echo "   3. Verify the deployment contains the latest commit: ${{ github.sha }}"
          echo "   4. If old files are deployed, try purging CDN cache in Azure Portal"

      - name: Verify Deployment
        if: always()
        run: |
          DEPLOY_STATUS="${{ steps.deploy.outcome }}"
          CDN_CACHE_STATUS="${{ steps.cdn-cache.outcome }}"
          CDN_WAIT_STATUS="${{ steps.cdn-wait.outcome }}"

          echo "ğŸ“Š Deployment Status Summary:"
          echo "  Deploy step: $DEPLOY_STATUS"
          echo "  CDN cache step: $CDN_CACHE_STATUS"
          echo "  CDN wait step: $CDN_WAIT_STATUS"
          echo ""

          if [ "$DEPLOY_STATUS" == "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ”— Deployed to: $STATIC_WEB_APP_URL"
            echo "â° Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ”¢ Build ID: $VITE_BUILD_ID"
            echo ""
            echo "âš ï¸ Note: Azure Static Web Apps may take 2-3 minutes to propagate changes globally"
            echo "ğŸ’¡ If changes are not visible immediately, please:"
            echo "   1. Wait 2-3 minutes for CDN cache to clear"
            echo "   2. Hard refresh your browser (Ctrl+Shift+R or Cmd+Shift+R)"
            echo "   3. Clear browser cache if needed"
            echo ""
            echo "ğŸ” To verify cards are visible:"
            echo "   - Open: $STATIC_WEB_APP_URL/settings"
            echo "   - Check for 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–' and 'ä¿å®ˆç®¡ç†' cards"

            if [ "$CDN_CACHE_STATUS" != "success" ] || [ "$CDN_WAIT_STATUS" != "success" ]; then
              echo ""
              echo "âš ï¸ Warning: Some non-critical steps failed (CDN cache clearing)"
              echo "   This does not affect the deployment itself"
            fi
          else
            echo "âŒ Deployment step failed!"
            echo "   Check the 'Deploy to Azure Static Web Apps' step above for details"
            echo "   This is a critical failure - deployment did not complete"
          fi

      - name: Deployment Error Details
        if: failure() || steps.deploy.outcome == 'failure'
        run: |
          echo "âŒ Deployment failed or encountered errors!"
          echo "ğŸ“‹ Debug information:"
          echo "  Working directory: $(pwd)"
          echo "  Job status: ${{ job.status }}"
          echo "  Deploy step outcome: ${{ steps.deploy.outcome }}"
          echo "  Client dist exists: $([ -d 'client/dist' ] && echo 'yes' || echo 'no')"
          echo "  Index.html exists: $([ -f 'client/dist/index.html' ] && echo 'yes' || echo 'no')"
          echo "  Token set: $([ -n '${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}' ] && echo 'yes' || echo 'no')"
          echo ""
          echo "ğŸ“ Contents of client/dist:"
          ls -lah client/dist/ || echo "Directory not found"
          echo ""
          echo "ğŸ“„ Checking main build file:"
          MAIN_FILE=$(ls client/dist/main.*.mjs 2>/dev/null | head -1)
          if [ -n "$MAIN_FILE" ]; then
            echo "  Main file: $MAIN_FILE"
            echo "  File size: $(wc -c < "$MAIN_FILE" 2>/dev/null || echo 'unknown') bytes"
            if grep -q "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ç›£è¦–" "$MAIN_FILE" 2>/dev/null; then
              echo "  âœ… Security card found in build"
            else
              echo "  âŒ Security card NOT found in build"
            fi
            if grep -q "ä¿å®ˆç®¡ç†" "$MAIN_FILE" 2>/dev/null; then
              echo "  âœ… Maintenance card found in build"
            else
              echo "  âŒ Maintenance card NOT found in build"
            fi
          else
            echo "  âŒ Main build file not found!"
          fi
          echo ""
          echo "ğŸ” Check the step above for detailed error messages"
          echo "ğŸ’¡ If deploy step succeeded but job failed, check non-critical steps (CDN cache, etc.)"

      - name: Clear CDN Cache via Azure CLI
        id: cdn-cache
        continue-on-error: true
        run: |
          echo "ğŸ—‘ï¸ Attempting to clear Azure Static Web Apps CDN cache..."

          # Azure CLIã‚’ä½¿ã£ã¦CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹è©¦ã¿
          # æ³¨æ„: Azure Static Web Appsã®CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯è‡ªå‹•çš„ã«ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€
          # ç›´æ¥ã‚¯ãƒªã‚¢ã™ã‚‹APIã¯é™å®šçš„ã§ã™ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è‡ªå‹•çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã¯ãšã§ã™

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
          echo "ğŸ“‹ Deployment information:"
          echo "  Static Web App URL: $STATIC_WEB_APP_URL"
          echo "  Build ID: $VITE_BUILD_ID"
          echo "  Commit SHA: ${{ github.sha }}"

          # è¤‡æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
          TIMESTAMP=$(date +%s)
          RANDOM_ID=$(openssl rand -hex 8 2>/dev/null || echo "fallback-$TIMESTAMP")

          echo "ğŸ”„ Sending cache-busting requests..."

          # ä¸»è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          ENDPOINTS=("/" "/index.html" "/settings")
          ERROR_COUNT=0
          for endpoint in "${ENDPOINTS[@]}"; do
            if curl -X GET "$STATIC_WEB_APP_URL$endpoint?v=$TIMESTAMP&r=$RANDOM_ID&_t=$TIMESTAMP" \
              -H "Cache-Control: no-cache, no-store, must-revalidate, max-age=0" \
              -H "Pragma: no-cache" \
              -H "Expires: 0" \
              -H "X-Force-Refresh: true" \
              -H "X-Cache-Bust: $TIMESTAMP" \
              --max-time 10 \
              -s -o /dev/null -w "  $endpoint: %{http_code}\n" 2>&1; then
              echo "  âœ… $endpoint: Success"
            else
              echo "  âš ï¸ $endpoint: Failed (non-critical)"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âš ï¸ Some cache-busting requests failed (this is non-critical)"
          else
            echo "âœ… All cache-busting requests sent successfully"
          fi

          echo "ğŸ’¡ Note: Azure Static Web Apps CDN cache will be automatically invalidated on deployment"
          echo "ğŸ’¡ Users should hard refresh (Ctrl+Shift+R) or clear browser cache to see latest changes"
          echo ""
          echo "âš ï¸ IMPORTANT: If old files are still being served after deployment:"
          echo "   1. Check Azure Portal > Static Web Apps > Deployment History"
          echo "   2. Verify the latest deployment contains commit: ${{ github.sha }}"
          echo "   3. If old deployment is active, manually trigger a new deployment"
          echo "   4. Check if there are multiple deployment environments (production/staging)"
          echo "   5. Verify the correct API token is being used for the correct environment"

      - name: Wait for CDN Propagation
        id: cdn-wait
        continue-on-error: true
        run: |
          echo "â³ Waiting for CDN propagation (30 seconds)..."
          sleep 30
          echo "âœ… Wait completed"
          echo "ğŸ’¡ Deployment is complete. Changes should be visible within 2-3 minutes."

      - name: Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 20
        run: |
          echo "ğŸ¥ Running health check for $ENVIRONMENT environment..."

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–¢æ•°
          health_check() {
            local url="$1"
            echo "Checking: $url"

            response=$(curl -s -w "%{http_code}" "$url" -o /dev/null || echo "000")
            if [[ "$response" =~ ^[23] ]]; then
              echo "âœ… Health check passed ($response)"
              return 0
            else
              echo "âŒ Health check failed ($response)"
              return 1
            fi
          }

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          success=false
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            echo "ğŸ”„ Attempt $i/$MAX_RETRIES..."

            if health_check "$STATIC_WEB_APP_URL"; then
              success=true
              break
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "â³ Waiting $RETRY_INTERVAL seconds before retry..."
              sleep $RETRY_INTERVAL
            fi
          done

          if [ "$success" = false ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Integration Test with Backend
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ§ª Running integration tests with backend..."

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
          backend_health() {
            curl -s --max-time 10 "$BACKEND_URL/api/health" || return 1
          }

          if backend_health; then
            echo "âœ… Backend integration test passed"
          else
            echo "âš ï¸ Backend integration test failed - continuing deployment"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ CLIENT DEPLOYMENT SUMMARY"
          echo "============================="
          echo "ğŸ• Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Environment: $ENVIRONMENT"
          echo "ğŸ”— Static Web App: $STATIC_WEB_APP_URL"
          echo "ğŸ”— Backend API: $BACKEND_URL"
          echo "ğŸ¯ Status: ${{ job.status }}"
          echo ""
          echo "ğŸ“ Next Steps:"
          echo "1. Visit: $STATIC_WEB_APP_URL"
          echo "2. Test key features"
          echo "3. Monitor logs if issues occur"

