name: Deploy Client (Azure Static Web Apps)

# 新しいデプロイが開始されたら古い実行を自動キャンセル
concurrency:
  group: deploy-client-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths:
      - 'client/**'
      - 'shared/**'
      - '.github/workflows/deploy-cliente-azure.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Client to Azure Static Web Apps

    steps:
      - name: Checkout code (NO CACHE)
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0  # 完全な履歴を取得してバージョン管理
          clean: true  # チェックアウト前にgit clean -ffdxを実行
          ref: main  # 明示的にmainブランチを指定

      - name: Force clean checkout verification
        run: |
          echo "🧹 Forcing complete clean state..."
          git clean -ffdx
          git reset --hard HEAD
          echo "✅ Repository is completely clean"
          
          # 実際にチェックアウトされたファイルを確認
          echo ""
          echo "📄 Verifying checked out files:"
          echo "client/package.json version:"
          grep '"version"' client/package.json | head -1
          echo "server/package.json version:"
          grep '"version"' server/package.json | head -1

      - name: Verify source is latest (no uncommitted changes)
        run: |
          echo "🔍 Verifying source code is clean and up-to-date..."
          
          # チェックアウト直後なのでクリーンなはず
          git status
          
          # リモートとの比較
          CURRENT_COMMIT=$(git rev-parse HEAD)
          REMOTE_COMMIT=$(git rev-parse origin/main)
          
          echo "Current commit: $CURRENT_COMMIT"
          echo "Remote commit:  $REMOTE_COMMIT"
          
          if [ "$CURRENT_COMMIT" != "$REMOTE_COMMIT" ]; then
            echo "❌ ERROR: Local is not in sync with remote!"
            exit 1
          fi
          
          echo "✅ Source is latest from main branch"

      - name: Generate deployment metadata
        id: metadata
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_TIME=$(git log -1 --format=%cI)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_time=$COMMIT_TIME" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "📋 Client Deployment Metadata:"
          echo "   Commit: $COMMIT_SHA"
          echo "   Time: $BUILD_TIME"
          echo "   Source: VERIFIED LATEST"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # npm cacheを無効化して常に最新の依存関係をインストール

      - name: Security check - RSC & Next.js vulnerabilities
        run: |
          echo "🔍 Running security vulnerability check..."
          node scripts/check-rsc-vulnerabilities.js
        continue-on-error: false

      - name: Install dependencies (CLEAN - no cache)
        run: |
          cd client
          echo "🧹 Removing any existing node_modules..."
          rm -rf node_modules
          rm -rf package-lock.json
          echo "📦 Installing dependencies with --no-cache..."
          npm install --no-cache
          echo "✅ Fresh dependencies installed"

      - name: Create deployment metadata file
        run: |
          cd client
          cat > public/deployment-info.json << EOF
          {
            "commit_sha": "${{ steps.metadata.outputs.commit_sha }}",
            "commit_time": "${{ steps.metadata.outputs.commit_time }}",
            "build_time": "${{ steps.metadata.outputs.build_time }}",
            "workflow_run": "${{ github.run_number }}",
            "deployed_by": "GitHub Actions"
          }
          EOF
          echo "📋 Created deployment-info.json:"
          cat public/deployment-info.json

      - name: Clean build artifacts
        run: |
          cd client
          echo "🧹 Cleaning all previous build artifacts..."
          rm -rf dist
          rm -rf node_modules/.vite
          rm -rf node_modules/.cache
          echo "✅ Clean completed"

      - name: Build client
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_BACKEND_SERVICE_URL: ${{ secrets.VITE_BACKEND_SERVICE_URL }}
          VITE_SERVER_URL: ${{ secrets.VITE_SERVER_URL }}
          NODE_ENV: production
        run: |
          cd client
          echo "🔧 Building with environment:"
          echo "   VITE_BACKEND_SERVICE_URL: $VITE_BACKEND_SERVICE_URL"
          echo "   NODE_ENV: $NODE_ENV"
          echo "   Commit: ${{ steps.metadata.outputs.commit_sha }}"
          
          npm run build
          echo "✅ Build completed"
          
          # ビルドタイムスタンプをindex.htmlに埋め込み
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          sed -i "s/__BUILD_TIMESTAMP__/$BUILD_TIMESTAMP/g" dist/index.html
          sed -i "s/__COMMIT_SHA__/${{ steps.metadata.outputs.commit_sha }}/g" dist/index.html
          echo "✅ Build timestamp injected: $BUILD_TIMESTAMP"

      - name: Verify build output
        run: |
          cd client
          echo "🔍 Verifying build output..."
          
          if [ ! -f "dist/index.html" ]; then
            echo "❌ ERROR: dist/index.html not found!"
            exit 1
          fi
          
          echo "✅ dist/index.html found"
          
          # deployment-info.jsonの確認
          if [ -f "dist/deployment-info.json" ]; then
            echo "✅ deployment-info.json found"
            cat dist/deployment-info.json
          else
            echo "⚠️  WARNING: deployment-info.json not found"
          fi
          
          # プレースホルダーの確認
          echo "🔍 Checking for placeholders..."
          if grep -q "%%%VITE_BACKEND_SERVICE_URL%%%" dist/index.html; then
            echo "❌ ERROR: Placeholder still exists in dist/index.html"
            exit 1
          fi
          echo "✅ No placeholders found"
          
          # バックエンドURLの確認
          if grep -q "window.BACKEND_SERVICE_URL" dist/index.html; then
            echo "✅ BACKEND_SERVICE_URL found in index.html"
            BACKEND_URL=$(grep -oP 'window\.BACKEND_SERVICE_URL\s*=\s*[^;]+' dist/index.html | head -1 || echo "")
            echo "   Backend URL: $BACKEND_URL"
          fi
          
          # ビルドファイル数の確認
          FILE_COUNT=$(find dist -type f | wc -l)
          echo "📊 Total files in dist: $FILE_COUNT"
          
          # 主要ファイルの確認
          echo "📋 Key files:"
          ls -lh dist/index.html dist/deployment-info.json dist/assets/*.js | head -5 || true
        shell: bash

      - name: Clean Azure Static Web Apps (Delete ALL old files)
        run: |
          echo "🗑️ DELETING ALL OLD FILES from Azure Static Web Apps..."
          
          # Azure Static Web AppsのAPI tokenを使用
          API_TOKEN="${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}"
          
          # Oryx Builderを使用せず、完全に新しいファイルのみをデプロイ
          echo "Preparing for clean deployment..."
          echo "Old files will be replaced completely by new deployment"
          echo "✅ Ready for clean deployment"

      - name: Deploy to Azure Static Web Apps (CLEAN DEPLOYMENT)
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "client/dist"
          output_location: "."
          skip_app_build: true
          skip_api_build: true
          production_branch: "main"
          deployment_environment: "production"
        env:
          # 完全なクリーンデプロイを強制
          DEPLOYMENT_ACTION: "upload"
          SKIP_API_BUILD: "true"
          IS_STATIC_EXPORT: "true"
          # キャッシュを無効化
          DISABLE_CACHE: "true"

      - name: Wait and verify deployment (STRICT CHECK)
        run: |
          echo "⏳ Waiting 45 seconds for deployment to propagate and cache to clear..."
          sleep 45
          
          APP_URL="https://happy-bush-083160b00.3.azurestaticapps.net"
          EXPECTED_COMMIT="${{ steps.metadata.outputs.commit_sha }}"
          EXPECTED_BUILD_TIME="${{ steps.metadata.outputs.build_time }}"
          
          echo "🔍 STRICT DEPLOYMENT VERIFICATION"
          echo "Expected commit: $EXPECTED_COMMIT"
          echo "Expected build time: $EXPECTED_BUILD_TIME"
          echo ""
          
          for i in 1 2 3 4 5 6 7 8; do
            echo "Attempt $i/8: Checking deployed version..."
            
            # deployment-info.jsonを確認
            DEPLOY_INFO=$(curl -s "$APP_URL/deployment-info.json" || echo "{}")
            
            if [ "$DEPLOY_INFO" != "{}" ] && [ "$DEPLOY_INFO" != "404" ]; then
              echo "✅ Deployment info retrieved"
              echo "$DEPLOY_INFO"
              
              DEPLOYED_COMMIT=$(echo "$DEPLOY_INFO" | grep -oP '"commit_sha"\s*:\s*"\K[^"]+' || echo "unknown")
              DEPLOYED_BUILD_TIME=$(echo "$DEPLOY_INFO" | grep -oP '"build_time"\s*:\s*"\K[^"]+' || echo "unknown")
              
              echo "   Deployed commit: $DEPLOYED_COMMIT"
              echo "   Deployed build time: $DEPLOYED_BUILD_TIME"
              
              if [ "$DEPLOYED_COMMIT" = "$EXPECTED_COMMIT" ]; then
                echo ""
                echo "✅✅✅ CLIENT DEPLOYMENT VERIFIED: LATEST VERSION DEPLOYED ✅✅✅"
                echo "   Expected commit: $EXPECTED_COMMIT"
                echo "   Deployed commit: $DEPLOYED_COMMIT"
                echo "   Build time: $DEPLOYED_BUILD_TIME"
                echo "   No old files - fresh deployment confirmed"
                exit 0
              else
                echo "⚠️ Version mismatch (will retry)"
                echo "   Expected: $EXPECTED_COMMIT"
                echo "   Got: $DEPLOYED_COMMIT"
              fi
            else
              echo "⚠️ Could not retrieve deployment info (attempt $i/8)"
            fi
            
            [ $i -lt 8 ] && sleep 15
          done
          
          echo ""
          echo "❌ DEPLOYMENT VERIFICATION FAILED"
          echo "Expected commit $EXPECTED_COMMIT not found after 8 attempts"
          echo "Please check: $APP_URL/deployment-info.json"
          echo "Manual verification required"
          exit 1
