name: Deploy Client (Azure Static Web Apps)

on:
  push:
    branches: [main, develop]
    paths:
      - 'client/**'
      - '.github/workflows/deploy-cliente-azure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: 'client-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  deploy-client:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set Environment Variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            echo "BACKEND_URL=https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            if [ -n "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}" ]; then
              echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}" >> $GITHUB_ENV
            else
              echo "STATIC_WEB_APP_TOKEN=${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" >> $GITHUB_ENV
            fi
            echo "BACKEND_URL=https://emergency-assistance-staging.japanwest-01.azurewebsites.net" >> $GITHUB_ENV
            echo "STATIC_WEB_APP_URL=https://staging.witty-river-012f39e00.1.azurestaticapps.net" >> $GITHUB_ENV
          fi

          echo "âœ… Environment: $ENVIRONMENT"
          echo "ğŸ”— Backend: $BACKEND_URL"

      - name: Validate Secrets
        run: |
          if [ -z "$STATIC_WEB_APP_TOKEN" ]; then
            echo "âŒ ERROR: Azure Static Web Apps token not found"
            echo "Required secrets for $ENVIRONMENT:"
            if [ "$ENVIRONMENT" = "production" ]; then
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN"
            else
              echo "- AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING or AZURE_STATIC_WEB_APPS_API_TOKEN"
            fi
            exit 1
          fi
          echo "âœ… Secrets validated"

      - name: Setup Node.js with Enhanced Caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Dependencies
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Installing client dependencies..."
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build Client
        working-directory: ./client
        run: |
          echo "ğŸ”¨ Building client for $ENVIRONMENT environment..."
          echo "   Backend URL: $BACKEND_URL"

          # Clear build cache to ensure fresh build
          echo "ğŸ§¹ Clearing build cache..."
          rm -rf dist node_modules/.vite .vite || true

          # Set environment variables for Vite build
          export NODE_ENV=production
          export VITE_BACKEND_SERVICE_URL="$BACKEND_URL"
          export VITE_API_BASE_URL="$BACKEND_URL/api"
          export VITE_ENVIRONMENT="$ENVIRONMENT"
          # Force new build ID to bypass cache
          export VITE_BUILD_ID="$(date +%s)-${{ github.sha }}"

          echo "   API Base URL: $VITE_API_BASE_URL"
          echo "   Build ID: $VITE_BUILD_ID"

          # Build (npm run build already includes clean step via prebuild)
          npm run build

          # ãƒ“ãƒ«ãƒ‰çµæœæ¤œè¨¼
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Client build failed - index.html not found"
            ls -la dist/ || echo "dist directory not found"
            exit 1
          fi

          # ãƒãƒƒã‚·ãƒ¥ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œ
          required_files=("index.html" "runtime-config.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "dist/$file" ]; then
              echo "âŒ ERROR: Required file missing after build: dist/$file"
              exit 1
            fi
          done

          # ãƒãƒƒã‚·ãƒ¥ä»˜ããƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if ! ls dist/main.*.mjs 1> /dev/null 2>&1; then
            echo "âŒ ERROR: Required file missing after build: dist/main.*.mjs"
            ls -la dist/ | grep -E "\.(mjs|js)$" || echo "No .mjs or .js files found"
            exit 1
          fi

          if ! ls dist/style.*.css 1> /dev/null 2>&1; then
            echo "âŒ ERROR: Required file missing after build: dist/style.*.css"
            ls -la dist/ | grep -E "\.css$" || echo "No .css files found"
            exit 1
          fi

          file_count=$(find dist -type f | wc -l)
          echo "âœ… Client build completed successfully: $file_count files"

          echo "ğŸ“Š Build Statistics:"
          echo "   Files: $file_count"
          echo "   Size: $(du -sh dist/ | cut -f1)"
          echo "   Contents:"
          ls -la dist/

          # Azure Static Web Apps file limit check and optimization
          if [ $file_count -gt 1000 ]; then
            echo "âŒ ERROR: File count ($file_count) exceeds Azure Static Web Apps limit (1000 files)"
            echo "ğŸ”§ Optimizing build output..."

            # Remove source maps if they exist
            find dist -name "*.map" -delete || true

            # Remove unnecessary files
            find dist -name "*.txt" -not -name "robots.txt" -delete || true
            find dist -name "*.md" -delete || true

            # Recount files
            file_count=$(find dist -type f | wc -l)
            echo "ğŸ“¦ Optimized file count: $file_count"

            if [ $file_count -gt 1000 ]; then
              echo "âŒ Still too many files after optimization. Manual intervention required."
              exit 1
            fi
          elif [ $file_count -gt 100 ]; then
            echo "âš ï¸ WARNING: File count ($file_count) is high but acceptable"
            echo "ğŸ”§ Consider further build optimization for better performance"
          else
            echo "âœ… File count ($file_count) is optimal for Azure Static Web Apps"
          fi

      - name: Update Configuration Files
        run: |
          echo "ğŸ”§ Updating runtime configuration..."

          # client/dist/runtime-config.js ã®æ›´æ–°
          if [ -f "client/dist/runtime-config.js" ]; then
            echo "ğŸ”„ Updating runtime-config.js..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
            echo "âœ… Runtime config updated"
          else
            echo "âš ï¸ runtime-config.js not found, creating..."
            echo "window.runtimeConfig = { backendUrl: '$BACKEND_URL', environment: '$ENVIRONMENT' };" > client/dist/runtime-config.js
          fi

          # index.htmlã«ãƒ“ãƒ«ãƒ‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶çš„ã«ç„¡åŠ¹åŒ–
          if [ -f "client/dist/index.html" ]; then
            echo "ğŸ”„ Adding build version to index.html..."
            BUILD_VERSION="v$(date +%s)-${{ github.sha:0:7 }}"
            sed -i "s|<html lang=\"ja\">|<html lang=\"ja\" data-build=\"$BUILD_VERSION\">|g" client/dist/index.html
            # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã«ã‚‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ 
            sed -i "s|<script type=\"module\"|<script type=\"module\" data-version=\"$BUILD_VERSION\"|g" client/dist/index.html
            echo "âœ… Build version added: $BUILD_VERSION"
          fi

      - name: Inject Backend URL
        working-directory: ./client
        run: |
          echo "ğŸ”§ Injecting backend URL into runtime configuration..."

          if [ -f "dist/index.html" ]; then
            # window.BACKEND_SERVICE_URLã‚’ç½®æ›
            if grep -q "window.BACKEND_SERVICE_URL" dist/index.html; then
              # æ—¢å­˜ã®window.BACKEND_SERVICE_URLã®å€¤ã‚’ç½®æ›
              sed -i "s|window.BACKEND_SERVICE_URL = '[^']*'|window.BACKEND_SERVICE_URL = '$BACKEND_URL'|g" dist/index.html
              echo "âœ… Backend URL injected: $BACKEND_URL"
            # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ç½®æ›
            elif grep -q "{{BACKEND_URL}}" dist/index.html; then
              sed -i "s|{{BACKEND_URL}}|$BACKEND_URL|g" dist/index.html
              echo "âœ… Backend URL injected via placeholder: $BACKEND_URL"
            else
              echo "â„¹ï¸ No window.BACKEND_SERVICE_URL or placeholder found for backend URL injection"
            fi
          else
            echo "âš ï¸ dist/index.html not found, skipping injection"
          fi

      - name: Verify Build Output
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Verifying build output..."

          # Copy staticwebapp.config.json to dist
          cp staticwebapp.config.json dist/

          echo "ğŸ“Š Final deployment package:"
          ls -lah dist/
          file_count=$(find dist -type f | wc -l)
          size=$(du -sh dist/ | cut -f1)
          echo "   Files: $file_count"
          echo "   Size: $size"

          # Remove source maps to reduce file count
          find dist -name "*.map" -delete || true

          file_count_after=$(find dist -type f | wc -l)
          echo "   Files after optimization: $file_count_after"

          if [ $file_count_after -gt 1000 ]; then
            echo "âš ï¸ WARNING: File count ($file_count_after) exceeds Azure Static Web Apps limit"
          else
            echo "âœ… File count ($file_count_after) is optimal"
          fi

      - name: Verify Build Output Before Deploy
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Verifying build output before deployment..."

          # distãƒ•ã‚©ãƒ«ãƒ€ã®å­˜åœ¨ç¢ºèª
          if [ ! -d "dist" ]; then
            echo "âŒ ERROR: dist directory not found!"
            exit 1
          fi

          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          required_files=("index.html" "main.*.mjs" "style.*.css")
          for pattern in "${required_files[@]}"; do
            if ! ls dist/$pattern 1> /dev/null 2>&1; then
              echo "âŒ ERROR: Required file not found: dist/$pattern"
              ls -la dist/ || echo "dist directory listing failed"
              exit 1
            fi
          done

          # settings.tsxã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«hasSecurityAccessãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ï¼‰
          echo "ğŸ” Checking if settings page changes are in build..."
          if find dist -name "*.mjs" -exec grep -l "hasSecurityAccess" {} \; 2>/dev/null | grep -q .; then
            echo "âš ï¸ WARNING: hasSecurityAccess found in built files - old code may be cached"
          else
            echo "âœ… hasSecurityAccess not found in built files - changes are included"
          fi

          # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
          echo "ğŸ“Š Build output files:"
          ls -lah dist/ | head -20

          echo "âœ… Build output verification completed"

      - name: Clear Azure Static Web Apps Cache
        run: |
          echo "ğŸ—‘ï¸ Clearing deployment cache..."
          # Force fresh deployment by removing any cache markers
          rm -rf ~/.azure-static-web-apps-cli || true
          # Clear npm cache
          npm cache clean --force || true

      - name: Verify Files Before Deploy
        run: |
          echo "ğŸ“‹ Verifying files before deployment..."
          echo "Current directory: $(pwd)"
          echo "Working directory: ${{ github.workspace }}"

          # çµ¶å¯¾ãƒ‘ã‚¹ã§ç¢ºèª
          if [ ! -d "${{ github.workspace }}/client/dist" ]; then
            echo "âŒ ERROR: client/dist directory does not exist at ${{ github.workspace }}/client/dist"
            echo "Listing client directory:"
            ls -lah client/ || echo "client directory not found"
            exit 1
          fi

          echo "Checking client/dist directory:"
          ls -lah client/dist/ || echo "âŒ client/dist directory not found!"

          if [ ! -f "client/dist/index.html" ]; then
            echo "âŒ ERROR: client/dist/index.html not found!"
            echo "Files in client/dist:"
            ls -lah client/dist/ || echo "Cannot list files"
            exit 1
          fi

          echo "âœ… Required files verified"
          echo "File count in client/dist: $(find client/dist -type f | wc -l)"
          echo "Directory size: $(du -sh client/dist | cut -f1)"

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: client/dist
          output_location: ''
          skip_app_build: true
          skip_api_build: true
          production_branch: main
          deployment_environment: production
        continue-on-error: false
        env:
          DEBUG: '*'

      - name: Verify Deployment
        if: success()
        run: |
          echo "âœ… Deployment completed successfully"
          echo "ğŸ”— Deployed to: $STATIC_WEB_APP_URL"
          echo "â° Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”¢ Build ID: $VITE_BUILD_ID"
          echo ""
          echo "âš ï¸ Note: Azure Static Web Apps may take 2-3 minutes to propagate changes globally"
          echo "ğŸ’¡ If changes are not visible immediately, please:"
          echo "   1. Wait 2-3 minutes for CDN cache to clear"
          echo "   2. Hard refresh your browser (Ctrl+Shift+R or Cmd+Shift+R)"
          echo "   3. Clear browser cache if needed"

      - name: Deployment Error Details
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ“‹ Debug information:"
          echo "  Working directory: $(pwd)"
          echo "  Client dist exists: $([ -d 'client/dist' ] && echo 'yes' || echo 'no')"
          echo "  Index.html exists: $([ -f 'client/dist/index.html' ] && echo 'yes' || echo 'no')"
          echo "  Token set: $([ -n '${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}' ] && echo 'yes' || echo 'no')"
          echo ""
          echo "ğŸ“ Contents of client/dist:"
          ls -lah client/dist/ || echo "Directory not found"
          echo ""
          echo "ğŸ” Check the step above for detailed error messages"

      - name: Trigger CDN Cache Purge
        continue-on-error: true
        run: |
          echo "ğŸ—‘ï¸ Requesting CDN cache purge..."
          # Wait a bit for deployment to propagate
          sleep 10

          # Try to purge Azure CDN cache by making requests with cache-busting headers
          # Use timestamp query parameter to force cache miss
          TIMESTAMP=$(date +%s)

          curl -X GET "$STATIC_WEB_APP_URL/?v=$TIMESTAMP" \
            -H "Cache-Control: no-cache, no-store, must-revalidate" \
            -H "Pragma: no-cache" \
            -H "Expires: 0" \
            -s -o /dev/null -w "Status: %{http_code}\n" || true

          curl -X GET "$STATIC_WEB_APP_URL/index.html?v=$TIMESTAMP" \
            -H "Cache-Control: no-cache, no-store, must-revalidate" \
            -H "Pragma: no-cache" \
            -H "Expires: 0" \
            -s -o /dev/null -w "Status: %{http_code}\n" || true

          echo "âœ… Cache purge request sent with timestamp: $TIMESTAMP"

      - name: Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 20
        run: |
          echo "ğŸ¥ Running health check for $ENVIRONMENT environment..."

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–¢æ•°
          health_check() {
            local url="$1"
            echo "Checking: $url"

            response=$(curl -s -w "%{http_code}" "$url" -o /dev/null || echo "000")
            if [[ "$response" =~ ^[23] ]]; then
              echo "âœ… Health check passed ($response)"
              return 0
            else
              echo "âŒ Health check failed ($response)"
              return 1
            fi
          }

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          success=false
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            echo "ğŸ”„ Attempt $i/$MAX_RETRIES..."

            if health_check "$STATIC_WEB_APP_URL"; then
              success=true
              break
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "â³ Waiting $RETRY_INTERVAL seconds before retry..."
              sleep $RETRY_INTERVAL
            fi
          done

          if [ "$success" = false ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Integration Test with Backend
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ§ª Running integration tests with backend..."

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
          backend_health() {
            curl -s --max-time 10 "$BACKEND_URL/api/health" || return 1
          }

          if backend_health; then
            echo "âœ… Backend integration test passed"
          else
            echo "âš ï¸ Backend integration test failed - continuing deployment"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ CLIENT DEPLOYMENT SUMMARY"
          echo "============================="
          echo "ğŸ• Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ Environment: $ENVIRONMENT"
          echo "ğŸ”— Static Web App: $STATIC_WEB_APP_URL"
          echo "ğŸ”— Backend API: $BACKEND_URL"
          echo "ğŸ¯ Status: ${{ job.status }}"
          echo ""
          echo "ğŸ“ Next Steps:"
          echo "1. Visit: $STATIC_WEB_APP_URL"
          echo "2. Test key features"
          echo "3. Monitor logs if issues occur"
