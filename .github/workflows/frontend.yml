name: Build & Deploy Frontend

on:
  push:
    paths:
      - 'client/**'
      - '.github/workflows/frontend.yml'
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 1) Viteãƒ“ãƒ«ãƒ‰
      - run: npm ci
      - name: Create .env.production for Vite
        run: |
          cat > .env.production << 'EOF'
          VITE_API_BASE_URL=https://emergencyassistance-sv-fbanemhrbshuf9bd.japanwest-01.azurewebsites.net
          NODE_ENV=production
          EOF
          echo "=== Created .env.production ==="
          cat .env.production
      - run: npm run build

      # 2) SWA ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆâ˜… action: upload ãŒå¿…é ˆï¼‰
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: upload
          app_location: "client"   # package.json ãŒã‚ã‚‹å ´æ‰€
          output_location: "dist"  # ãƒ“ãƒ«ãƒ‰æˆæžœç‰©
          api_location: ""         # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯åˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ãªã‚‰ç©º
          skip_app_build: true     # ä¸Šã§æ—¢ã« build æ¸ˆã¿

      - name: Frontend Health Check
        run: |
          echo "ðŸ” Starting frontend health check..."
          # Wait for deployment
          echo "â³ Waiting for frontend deployment (30 seconds)..."
          sleep 30
          # Check frontend
          frontend_url="https://witty-river-012f39e00.1.azurestaticapps.net"
          echo "Checking frontend: ${frontend_url}"
          root_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${frontend_url}/")
          echo "/ (root) check: $root_status"
          if [ "$root_status" = "200" ]; then
            echo "âœ… Frontend root returned 200"
          else
            echo "âŒ Frontend health check failed!"
            exit 1
          fi

      - name: API Endpoint Test
        run: |
          echo "ðŸ” Testing API endpoints..."
          frontend_url="https://witty-river-012f39e00.1.azurestaticapps.net"
          
          # Test handshake
          echo "Testing /api/auth/handshake..."
          handshake_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${frontend_url}/api/auth/handshake")
          echo "Handshake status: $handshake_status"
          
          # Test me (should be 401)
          echo "Testing /api/auth/me (should be 401)..."
          me_status=$(curl -o /dev/null -s -w "%{http_code}" -L "${frontend_url}/api/auth/me")
          echo "Me status: $me_status"
          
          if [ "$handshake_status" = "200" ] && [ "$me_status" = "401" ]; then
            echo "âœ… API endpoints working correctly"
          else
            echo "âŒ API endpoint test failed!"
            exit 1
          fi
