name: Balanced Deploy to Azure App Service

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: 'azure-deploy-${{ github.ref }}'
  cancel-in-progress: true

env:
  APP_URL: 'https://emergency-assistance-bfckhjejb3fbf9du.japanwest-01.azurewebsites.net'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate Secrets
        run: |
          echo "üîç Validating required secrets..."
          if [ -z "${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}" ]; then
            echo "‚ùå AZURE_WEBAPP_PUBLISH_PROFILE secret is missing"
            echo "üìã Setup: GitHub > Settings > Secrets > Actions"
            exit 1
          fi
          echo "‚úÖ Required secrets validated"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            client/package-lock.json

      - name: Install Server Dependencies
        working-directory: ./server
        run: |
          echo "üì¶ Installing server dependencies..."
          npm ci --production=false
          echo "‚úÖ Server dependencies installed"

      - name: Build Client
        working-directory: ./client
        run: |
          echo "üèóÔ∏è Building client..."
          npm ci
          npm run build

          # Verify build output
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Client build failed - index.html not found"
            exit 1
          fi

          echo "üìä Client build stats:"
          du -sh dist/
          echo "‚úÖ Client built successfully"

      - name: Prepare Deployment Package
        shell: bash
        run: |
          echo "üì¶ Creating deployment package..."
          mkdir -p deploy-package

          # Copy server files with structure preservation
          echo "üìÅ Copying server files..."
          rsync -av --exclude='node_modules' --exclude='*.log' server/ deploy-package/

          # Copy client build
          echo "üìÅ Copying client build..."
          mkdir -p deploy-package/client/dist
          cp -r client/dist/* deploy-package/client/dist/

          # Install production dependencies
          echo "üì¶ Installing production dependencies..."
          cd deploy-package
          npm ci --production --silent
          cd ..

          # Validation
          echo "üîç Deployment package validation:"
          REQUIRED_FILES=(
            "deploy-package/package.json"
            "deploy-package/azure-server.js"
            "deploy-package/client/dist/index.html"
            "deploy-package/node_modules/express/package.json"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "  ‚úÖ ${file##*/}"
            else
              echo "  ‚ùå ${file##*/} - MISSING"
              exit 1
            fi
          done

          echo "üìä Package size: $(du -sh deploy-package/ | cut -f1)"
          echo "‚úÖ Deployment package ready"

      - name: Deploy to Azure
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'Emergency-Assistance'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy-package
          clean: true

      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting for deployment to stabilize..."
          sleep 45

      - name: Health Check
        env:
          MAX_RETRIES: 5
          RETRY_INTERVAL: 30
        run: |
          echo "üè• Starting health check..."

          health_check() {
            local url="$1"
            local description="$2"

            echo "üîç Testing: $description"

            if curl -f --max-time 10 --retry 2 --retry-delay 5 "$url" >/dev/null 2>&1; then
              echo "  ‚úÖ $description - OK"
              return 0
            else
              echo "  ‚ùå $description - FAILED"
              return 1
            fi
          }

          # Critical endpoints
          ENDPOINTS=(
            "${{ env.APP_URL }}/health|Health Endpoint"
            "${{ env.APP_URL }}/ping|Ping Endpoint"
            "${{ env.APP_URL }}/|Main Application"
          )

          failed_checks=0
          for endpoint_info in "${ENDPOINTS[@]}"; do
            IFS='|' read -r url description <<< "$endpoint_info"

            retry_count=0
            while [ $retry_count -lt ${{ env.MAX_RETRIES }} ]; do
              if health_check "$url" "$description"; then
                break
              fi

              retry_count=$((retry_count + 1))
              if [ $retry_count -lt ${{ env.MAX_RETRIES }} ]; then
                echo "  üîÑ Retry $retry_count/${{ env.MAX_RETRIES }} in ${{ env.RETRY_INTERVAL }}s..."
                sleep ${{ env.RETRY_INTERVAL }}
              fi
            done

            if [ $retry_count -eq ${{ env.MAX_RETRIES }} ]; then
              failed_checks=$((failed_checks + 1))
            fi
          done

          echo ""
          if [ $failed_checks -eq 0 ]; then
            echo "üéâ DEPLOYMENT SUCCESS!"
            echo "üåê Application URL: ${{ env.APP_URL }}"
            echo "üìä All health checks passed"
          else
            echo "‚ö†Ô∏è DEPLOYMENT COMPLETED WITH WARNINGS"
            echo "‚ùå $failed_checks health check(s) failed"
            echo "üîß Manual verification recommended: ${{ env.APP_URL }}"
            # Warning but don't fail the job - let manual verification decide
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "üìã DEPLOYMENT SUMMARY"
          echo "=================="
          echo "üïê Completed: $(date)"
          echo "üîó App URL: ${{ env.APP_URL }}"
          echo "üì¶ Package: Node.js 20 + Express + React"
          echo "üéØ Status: ${{ job.status }}"

          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Ready for testing!"
          else
            echo "‚ùå Check logs for issues"
            echo "üîß Troubleshooting: ${{ env.APP_URL }}.scm.azurewebsites.net"
          fi
