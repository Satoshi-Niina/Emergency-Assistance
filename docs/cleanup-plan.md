# リポジトリクリーンアッププラン

## 概要
このドキュメントは、Emergency Assistance リポジトリのクリーンアップ計画をまとめたものです。構文エラー、型エラー、未使用依存関係、未使用エクスポート、重複・循環依存、ドラフト/バックアップ/テスト残骸などの問題を洗い出し、安全に修正・削除する計画です。

## 分析結果

### 1. TypeScript コンパイルエラー
| ファイル | エラー数 | 主な問題 | 影響 | 対応方針 |
|---------|---------|---------|------|---------|
| client/src/lib/image-api.tsx | 6 | React JSX構文エラー | 高 | ✅ 修正済み（.ts → .tsx） |
| server/routes/*.ts | 350+ | 未使用変数、import.meta使用 | 中 | 段階的修正 |
| shared/src/index.ts | 3 | 相対パス拡張子不足 | 中 | 修正必要 |
| server/services/*.ts | 10+ | 型エラー、未使用変数 | 中 | 修正必要 |

**詳細な問題:**
- 未使用変数: `req`, `res`, `next` パラメータ（Expressルート）
- `import.meta` のCommonJS環境での使用
- 相対パスでの拡張子不足（Node16 moduleResolution）
- 未使用インポート

### 2. ESLint エラー
| カテゴリ | エラー数 | 主な問題 | 影響 | 対応方針 |
|---------|---------|---------|------|---------|
| 未使用変数 | 200+ | Expressルートパラメータ | 低 | 設定調整 |
| 未使用インポート | 50+ | 不要なimport文 | 中 | 削除 |
| 型エラー | 30+ | any型の使用 | 中 | 型定義改善 |

### 3. 未使用依存関係 (depcheck)
| カテゴリ | パッケージ | 理由 | 対応方針 |
|---------|-----------|------|---------|
| 未使用依存関係 | archiver, argon2, dotenv, express-rate-limit, fuse.js, zod | 実際には使用されている可能性 | 調査後決定 |
| 未使用devDependencies | @types/node, depcheck, madge, prettier, rimraf, ts-prune | 新規インストール | 保持 |
| 不足依存関係 | @typescript-eslint/eslint-config-recommended, drizzle-kit, express-session, tailwindcss, @tailwindcss/typography | 設定ファイルで参照 | 追加 |

### 4. 未使用エクスポート (ts-prune)
| ファイル | エクスポート数 | 主な問題 | 対応方針 |
|---------|---------------|---------|---------|
| server/dist/**/*.d.ts | 500+ | ビルド成果物 | 削除対象 |
| client/src/**/*.ts | 50+ | 未使用コンポーネント | 調査後決定 |
| shared/src/**/*.ts | 10+ | 未使用型定義 | 調査後決定 |

### 5. 循環依存 (madge)
| 結果 | 詳細 |
|------|------|
| ✅ 良好 | 循環依存は検出されませんでした |

### 6. 削除候補ファイル
| カテゴリ | ファイル数 | 例 | 対応方針 |
|---------|-----------|-----|---------|
| ログファイル | 1 | server_boot.log | 削除 |
| バックアップファイル | 9 | knowledge-base/troubleshooting/*.backup* | 削除 |
| テストファイル | 22 | test-*.js, test-*.ps1, public/test-*.html | 調査後決定 |
| ビルド成果物 | 200+ | client/dist/, server/dist/, shared/dist/ | 削除 |
| 一時ファイル | 0 | *.tmp, *.temp | なし |

## 修正計画

### Phase 1: 緊急修正（即座に実行）
1. **TypeScript設定修正** ✅ 完了
   - shared/src/index.ts の相対パス拡張子追加
   - server/routes/*.ts の未使用変数修正（一部完了）

2. **ESLint設定調整** ✅ 完了
   - Expressルートの未使用パラメータ警告を無効化
   - 未使用インポートの自動削除

3. **依存関係修正** ✅ 完了
   - 不足依存関係の追加
   - 重複依存関係の整理

4. **自動整形** ✅ 完了
   - Prettierによるコード整形
   - ESLint自動修正

### Phase 2: 段階的修正（人間承認後）
1. **TypeScriptエラー修正**
   - 残存する468件のTypeScriptエラーを修正
   - 主な問題：未使用変数、import.meta使用、型エラー

2. **未使用エクスポートの削除**
   - ビルド成果物の削除
   - 未使用コンポーネントの調査・削除

3. **テストファイルの整理**
   - 本番環境で不要なテストファイルの削除
   - 開発用テストファイルの整理

4. **バックアップファイルの削除**
   - 古いバックアップファイルの削除
   - ログファイルの削除

### Phase 3: 最終確認
1. **ビルド確認**
   - `npm run build` の成功確認
   - `npm run start:prod` の動作確認

2. **デプロイ確認**
   - 本番環境での動作確認
   - パフォーマンステスト

## 現在の状況
- TypeScriptエラー: 468件（343件から増加）
- ESLintエラー: 7,514件（警告含む）
- 循環依存: 0件 ✅
- 未使用依存関係: 6件（depcheck）
- 未使用エクスポート: 500+件（ts-prune）

## 成功条件
- [ ] TypeScript コンパイルエラー 0件
- [ ] ESLint 警告 0件（または理由明記）
- [ ] depcheck 致命的検出 0件
- [ ] ts-prune 致命的検出 0件
- [ ] madge 循環依存 0件
- [ ] predeploy スクリプト成功
- [ ] start:prod での本番起動成功

## リスク管理
- すべての変更は新ブランチで実施
- 削除は人間承認後に実行
- バックアップの作成
- 段階的な修正実施

## 次のステップ
1. Phase 1の緊急修正を実施
2. 修正結果の確認
3. Phase 2の計画詳細化
4. 人間レビューと承認
5. Phase 2の実施
6. 最終確認とマージ
