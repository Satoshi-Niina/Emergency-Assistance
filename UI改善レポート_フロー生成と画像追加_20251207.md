# フロー自動生成と画像追加機能の改善

## 実装日
2025年12月7日

## 概要
フロー自動生成機能では画像が含まれないため、ユーザーがフロー管理・編集画面で後から画像を追加できることを明確にするためのUI改善を実施しました。

## 変更内容

### 1. フロー生成画面の改善 (`emergency-flow-generator.tsx`)

#### 変更点:
- フロー生成時に画像が含まれないことを明示する説明を追加
- ユーザーが後から編集画面で画像を追加できることを案内

#### 修正箇所:
```tsx
<CardDescription>
  ドキュメントファイルまたはキーワードから、応急処置フローの草案を自動で生成します。
  <br />
  <span className='text-blue-600 font-semibold mt-2 inline-block'>
    ※ 画像は生成されません。フロー編集画面で後から追加できます。
  </span>
</CardDescription>
```

### 2. フロー編集画面の改善 (`emergency-flow-creator.tsx`)

#### 変更点1: 画像追加ボタンの視認性向上
- ボタンのスタイルを青色系に変更して目立たせる
- ツールチップで最大3枚まで追加できることを明示
- ボタンのラベルを「画像アップロード」から「画像を追加」に変更

```tsx
<Button
  variant='outline'
  size='sm'
  onClick={() =>
    document.getElementById(`image-upload-${slide.id}`)?.click()
  }
  className='text-base-2x h-12 px-4 bg-blue-50 hover:bg-blue-100 border-blue-300'
  title='このステップに画像を追加（最大3枚）'
>
  <Upload className='w-6 h-6 mr-2' />
  画像を追加
</Button>
```

#### 変更点2: 画像カウンター表示
- アップロード済み画像のラベルに枚数を表示（例: `アップロード済み画像 (2/3)`）
- 青色系のスタイルで視認性を向上

```tsx
<Label className='text-base-2x font-medium text-blue-700'>
  アップロード済み画像 ({step.images.length}/3)
</Label>
```

#### 変更点3: 画像未追加時のヘルプメッセージ
- 画像が追加されていない場合、ヒントメッセージを表示
- 最大3枚まで追加できることを案内

```tsx
<div className='mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg'>
  <p className='text-sm text-blue-700'>
    💡 ヒント: 「画像を追加」ボタンから、このステップに関連する画像を最大3枚まで追加できます。
  </p>
</div>
```

### 3. アップロード画面の改善 (`emergency-guide-uploader.tsx`)

#### 変更点:
- 「主な流れ」の説明に画像追加に関する注意事項を追加
- 編集画面で各ステップに個別に画像を追加できることを明示

```tsx
<li className='font-semibold text-blue-700 mt-2'>
  ※ 画像は自動生成されません。編集画面で各ステップに個別に追加してください。
</li>
```

## ユーザー体験の向上

### Before（改善前）:
- フロー生成時に画像が含まれないことが不明確
- 画像追加機能の存在に気づきにくい
- 画像の最大枚数が分かりにくい

### After（改善後）:
✅ フロー生成画面で画像が含まれないことを明示的に案内
✅ 画像追加ボタンが視覚的に目立つ
✅ 画像の枚数制限（最大3枚）を明確に表示
✅ 画像未追加時にヒントメッセージを表示
✅ 全体的な操作フローが理解しやすくなった

## 画像追加の操作フロー

1. **フロー生成**: キーワードまたはファイルからフローを自動生成
   - ⚠️ この時点では画像は含まれない

2. **フロー編集画面を開く**: 「編集・管理」タブから対象フローを選択

3. **画像を追加**: 各ステップの「画像を追加」ボタンをクリック
   - 最大3枚まで追加可能
   - 対応形式: JPEG, PNG, GIF, WebP

4. **保存**: 画像追加後、フローを保存

## 技術的な詳細

### 画像追加機能の仕様:
- **最大枚数**: 各ステップに3枚まで
- **ファイルサイズ制限**: 最大10MB
- **対応形式**: JPEG, PNG, GIF, WebP
- **保存先**: Azure Blob Storage (`knowledge-base/images/emergency-flows/`)
- **重複チェック**: 同名ファイルの上書き確認

### API エンドポイント:
- **画像アップロード**: `POST /api/emergency-flow/upload-image`
- **画像取得**: `GET /api/images/emergency-flows/{fileName}`
- **画像削除**: `DELETE /api/emergency-flow/image/{fileName}`

## 今後の改善案

1. **ドラッグ&ドロップ対応**: 画像追加時のUX向上
2. **画像プレビュー**: アップロード前のプレビュー機能
3. **一括アップロード**: 複数枚の画像を一度に追加
4. **画像編集機能**: トリミング、回転などの基本的な編集
5. **AIによる画像提案**: フロー内容に基づいた画像の自動提案（将来実装）

## 関連ファイル

### 修正したファイル:
- `client/src/components/emergency-guide/emergency-flow-generator.tsx`
- `client/src/components/emergency-guide/emergency-flow-creator.tsx`
- `client/src/components/emergency-guide/emergency-guide-uploader.tsx`

### 関連APIファイル:
- `server/src/api/emergency-flow/index.mjs` - 画像アップロード/削除API
- `server/src/api/images/index.mjs` - 画像取得API

## テスト方法

### 1. フロー生成のテスト:
```
1. 「アップロード」タブでキーワードを入力
2. 「フローを生成」ボタンをクリック
3. 生成完了後、「※ 画像は生成されません」のメッセージが表示されることを確認
```

### 2. 画像追加のテスト:
```
1. 「編集・管理」タブでフローを開く
2. 各ステップの「画像を追加」ボタンをクリック
3. 画像ファイルを選択
4. アップロード完了後、画像が表示されることを確認
5. 枚数カウンター（例: 1/3）が更新されることを確認
```

### 3. ヒントメッセージのテスト:
```
1. 画像が未追加のステップで編集画面を開く
2. 「💡 ヒント」メッセージが表示されることを確認
3. 画像を1枚追加後、ヒントメッセージが非表示になることを確認
```

## まとめ

この改善により、ユーザーは以下を明確に理解できるようになりました:

1. ✅ フロー自動生成では画像が含まれない
2. ✅ 画像は編集画面で後から追加できる
3. ✅ 各ステップに最大3枚まで追加可能
4. ✅ 画像追加ボタンの場所と操作方法

これらの改善により、ユーザーが混乱することなくスムーズに応急復旧フローを作成・編集できるようになりました。
