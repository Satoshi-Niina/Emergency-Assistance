import { Router } from 'express';
import bcrypt from 'bcrypt';
import { users } from '../db/schema';
import { db } from '../db';
import { eq } from 'drizzle-orm';
import { logInfo, logError } from '../lib/logger';

const router = Router();

// ãƒ­ã‚°ã‚¤ãƒ³
router.post('/login', async (req, res) => {
  try {
    console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡:', { 
      body: req.body, 
      hasSession: !!req.session,
      headers: req.headers['content-type'],
      origin: req.headers.origin,
      method: req.method,
      url: req.url,
      userAgent: req.headers['user-agent'],
      host: req.headers.host,
      referer: req.headers.referer
    });
    const { username, password } = req.body;
    
    logInfo(`ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: ${username}`);
    
    if (!username || !password) {
      return res.status(400).json({
        success: false,
        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™'
      });
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
    console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šçŠ¶æ³ã‚’ç¢ºèªä¸­...');
    try {
      // ç°¡å˜ãªæ¥ç¶šãƒ†ã‚¹ãƒˆ
      await db.select().from(users).limit(1);
      console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ­£å¸¸');
    } catch (dbError) {
      console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼:', dbError);
      throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“');
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
    console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ä¸­:', username);
    const user = await db.query.users.findFirst({
      where: eq(users.username, username)
    });
    console.log('ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢çµæœ:', user ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    if (!user) {
      logError(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${username}`);
      return res.status(401).json({
        success: false,
        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'
      });
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
    console.log('ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ä¸­...');
    const isValidPassword = await bcrypt.compare(password, user.password);
    console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼:', { 
      username,
      isValid: isValidPassword 
    });

    if (!isValidPassword) {
      logError(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ${username}`);
      return res.status(401).json({
        success: false,
        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'
      });
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
    if (req.session) {
      req.session.userId = user.id;
      req.session.userRole = user.role;
      console.log('ğŸ’¾ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜:', { 
        userId: user.id,
        userRole: user.role
      });
    }

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿
    const responseData = {
      success: true,
      user: {
        id: user.id,
        username: user.username,
        displayName: user.display_name,
        role: user.role,
        department: user.department
      }
    };

    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', responseData);
    res.status(200).json(responseData);
  } catch (error) {
    console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    logError(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error instanceof Error ? error.message : 'Unknown error'}`);
    res.status(500).json({
      success: false,
      message: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    });
  }
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
router.post('/register', async (req, res) => {
  try {
    console.log('ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡:', { 
      body: req.body,
      hasSession: !!req.session
    });
    
    const { username, password, displayName, role = 'employee' } = req.body;
    
    if (!username || !password || !displayName) {
      return res.status(400).json({
        success: false,
        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€è¡¨ç¤ºåãŒå¿…è¦ã§ã™'
      });
    }

    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèª
    const existingUser = await db.query.users.findFirst({
      where: eq(users.username, username)
    });

    if (existingUser) {
      return res.status(400).json({
        success: false,
        message: 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™'
      });
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–
    const hashedPassword = await bcrypt.hash(password, 10);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
    const newUser = await db.insert(users).values({
      username,
      password: hashedPassword,
      display_name: displayName,
      role,
      department: req.body.department || null
    }).returning();

    const user = newUser[0];

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
    if (req.session) {
      req.session.userId = user.id;
      req.session.userRole = user.role;
    }

    const responseData = {
      success: true,
      user: {
        id: user.id,
        username: user.username,
        displayName: user.display_name,
        role: user.role,
        department: user.department
      }
    };

    console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æˆåŠŸ:', responseData);
    res.status(201).json(responseData);
  } catch (error) {
    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
    logError(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error instanceof Error ? error.message : 'Unknown error'}`);
    res.status(500).json({
      success: false,
      message: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    });
  }
});

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
router.post('/logout', (req, res) => {
  console.log('ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡:', {
    hasSession: !!req.session,
    userId: req.session?.userId
  });
  
  if (req.session) {
    req.session.destroy((err) => {
      if (err) {
        console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
        return res.status(500).json({
          success: false,
          message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
        });
      }
      console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
      res.status(200).json({
        success: true,
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'
      });
    });
  } else {
    console.log('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
    res.status(200).json({
      success: true,
      message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'
    });
  }
});

// ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
router.get('/me', async (req, res) => {
  console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', {
    hasSession: !!req.session,
    userId: req.session?.userId
  });
  
  if (!req.session || !req.session.userId) {
    console.log('âŒ èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return res.status(401).json({
      success: false,
      message: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“'
    });
  }
  
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const user = await db.query.users.findFirst({
    where: eq(users.id, req.session.userId)
  });
  
  if (!user) {
    return res.status(401).json({
      success: false,
      message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
    });
  }
  
  const userData = {
    id: user.id,
    username: user.username,
    displayName: user.display_name,
    role: user.role,
    department: user.department
  };
  
  console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—æˆåŠŸ:', userData);
  res.status(200).json({
    success: true,
    user: userData
  });
});

export const authRouter = router;
