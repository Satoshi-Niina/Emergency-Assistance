#!/usr/bin/env node

// Main entry point for Azure App Service
// This file ensures that azure-server.js is started correctly
// ESModule compatible version with CORS fix

import { fileURLToPath } from 'url';
import { dirname } from 'path';

// ESM __filename and __dirname equivalent
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

console.log('ğŸš€ Starting Emergency Assistance Backend...');
console.log('ğŸ“ Working directory:', process.cwd());
console.log('ğŸ“„ Main file:', __filename);
console.log('â° Start time:', new Date().toISOString());
console.log('ğŸ” Environment variables:');
console.log('  - NODE_ENV:', process.env.NODE_ENV);
console.log('  - PORT:', process.env.PORT);
console.log('  - DATABASE_URL:', process.env.DATABASE_URL ? 'SET' : 'NOT SET');
console.log('  - JWT_SECRET:', process.env.JWT_SECRET ? 'SET' : 'NOT SET');

// ç’°å¢ƒå¤‰æ•°ã®ç¢ºèªã¨é©åˆ‡ãªã‚µãƒ¼ãƒãƒ¼é¸æŠ
const hasCriticalEnvVars = process.env.DATABASE_URL && process.env.JWT_SECRET && process.env.SESSION_SECRET;

console.log('ğŸ” Critical environment variables check:');
console.log('  - Has all critical vars:', hasCriticalEnvVars);

// File existence check before import
import fs from 'fs';
const azureServerPath = './azure-server.js';
const debugServerPath = './azure-server-debug.js';
const fallbackServerPath = './fallback-server.js';

console.log('ğŸ“ Checking file existence:');
console.log('  - azure-server.js:', fs.existsSync(azureServerPath) ? 'EXISTS' : 'MISSING');
console.log('  - azure-server-debug.js:', fs.existsSync(debugServerPath) ? 'EXISTS' : 'MISSING');
console.log('  - fallback-server.js:', fs.existsSync(fallbackServerPath) ? 'EXISTS' : 'MISSING');

if (hasCriticalEnvVars) {
  // æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡åŠ¹åŒ–ï¼‰
  console.log('ğŸ“¦ Loading azure-server.js (production server with all env vars)...');
  console.log('ğŸ”§ Production server FORCED - no fallback to debug server');
  console.log('ğŸ” Forcing production server to start, any errors will be fatal');

  if (!fs.existsSync(azureServerPath)) {
    console.error('âŒ FATAL: azure-server.js file not found at:', azureServerPath);
    process.exit(1);
  }

  try {
    await import('./azure-server.js');
    console.log('âœ… azure-server.js loaded successfully');
  } catch (error) {
    console.error('âŒ FATAL ERROR loading azure-server.js:', error);
    console.error('âŒ Error message:', error.message);
    console.error('âŒ Error name:', error.name);
    console.error('âŒ Error code:', error.code);
    console.error('âŒ Stack trace:', error.stack);

    // æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
    console.error('ï¿½ Production server failed to start. Exiting process...');
    process.exit(1);
  }
} else {
  // ç’°å¢ƒå¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ãƒ‡ãƒãƒƒã‚°ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨
  console.log('âš ï¸ Critical environment variables missing. Starting debug server...');
  console.log('ğŸ”§ Missing variables will be handled by debug server.');

  if (!fs.existsSync(debugServerPath)) {
    console.error('âŒ ERROR: azure-server-debug.js file not found at:', debugServerPath);
    console.log('ğŸ†˜ Falling back to minimal server...');
  } else {
    try {
      await import('./azure-server-debug.js');
      console.log('âœ… azure-server-debug.js loaded for missing env vars');
      console.error('âŒ Debug server failed to start:', debugError);
      console.error('âŒ Debug server stack trace:', debugError.stack);
    }
  }

  // æœ€å¾Œã®æ‰‹æ®µ: æœ€å°é™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼
  console.log('ğŸ†˜ Starting minimal fallback server as last resort...');

  if (!fs.existsSync(fallbackServerPath)) {
    console.error('âŒ FATAL: fallback-server.js file not found at:', fallbackServerPath);
    process.exit(1);
  }

  try {
    await import('./fallback-server.js');
    console.log('âœ… Fallback server started successfully');
  } catch (fallbackError) {
    console.error('âŒ Even fallback server failed:', fallbackError);
    process.exit(1);
  }
}
