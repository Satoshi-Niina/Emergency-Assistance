// ==============================================================================
// ä¿®æ­£ç‚¹ã‚µãƒãƒªãƒ¼ (azure-server.mjs ã®é‡è¦ãªå¤‰æ›´ç®‡æ‰€)
// ==============================================================================
//
// 1. CORSè¨­å®šã®ç°¡ç´ åŒ–
//    - ç’°å¢ƒå¤‰æ•°åã‚’ CORS_ALLOW_ORIGINS ã«çµ±ä¸€
//    - isOriginAllowed é–¢æ•°ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«
//
// 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã®ä¿®æ­£
//    - secure: true (HTTPSå¿…é ˆ)
//    - sameSite: 'none' (ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ç”¨)
//
// 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
//    - DBæ¥ç¶šå¤±æ•—æ™‚ã‚‚ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã•ã›ã‚‹ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯æˆåŠŸã™ã‚‹ï¼‰
//    - DBå¿…é ˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿503ã‚’è¿”ã™
//
// 4. PORTè¨­å®šã®æ˜ç¤ºåŒ–
//    - process.env.PORT || 8080 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ8080)
//
// 5. èµ·å‹•ãƒ­ã‚°ã®æ•´ç†
//    - é‡è¦ãªæƒ…å ±ã®ã¿å‡ºåŠ›
//
// ==============================================================================

// ========================================
// ğŸ”§ ä¿®æ­£ç®‡æ‰€ 1: CORSè¨­å®š (è¡Œ74-120)
// ========================================

// ç’°å¢ƒå¤‰æ•°åã‚’çµ±ä¸€: CORS_ALLOW_ORIGINS ã®ã¿
const corsAllowOriginsEnv = process.env.CORS_ALLOW_ORIGINS || '';

const allowedOrigins = [
  FRONTEND_URL,
  STATIC_WEB_APP_URL,
  'https://witty-river-012f39e00.1.azurestaticapps.net',
  'http://localhost:5173',
  'http://localhost:8080',
  'https://localhost:5173',
  ...corsAllowOriginsEnv.split(',').map(url => url.trim()).filter(Boolean)
].filter(Boolean);

console.log('âœ… CORS Allowed Origins:', allowedOrigins);

// ã‚·ãƒ³ãƒ—ãƒ«ãªã‚ªãƒªã‚¸ãƒ³åˆ¤å®š
const isOriginAllowed = (origin) => {
  if (!origin) return true; // Same-origin requests
  if (allowedOrigins.includes(origin)) return true;
  if (origin.includes('azurestaticapps.net')) return true;
  if (process.env.NODE_ENV !== 'production') {
    // Development: Allow localhost
    if (origin.includes('localhost') || origin.includes('127.0.0.1')) return true;
  }
  return false;
};

const corsOptions = {
  origin: (origin, callback) => {
    if (isOriginAllowed(origin)) {
      callback(null, true);
    } else {
      console.warn('âŒ CORS blocked origin:', origin);
      callback(new Error('Not allowed by CORS'), false);
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Accept', 'Origin'],
  exposedHeaders: ['Set-Cookie'],
  optionsSuccessStatus: 204
};

app.use(cors(corsOptions));
app.options('*', cors(corsOptions));


// ========================================
// ğŸ”§ ä¿®æ­£ç®‡æ‰€ 2: ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š (è¡Œ150-165)
// ========================================

app.use(
  session({
    secret: process.env.SESSION_SECRET || 'emergency-session-secret-change-in-production',
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: true,          // âœ… HTTPSå¿…é ˆ (Azure App Serviceã¯HTTPS)
      httpOnly: false,       // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
      sameSite: 'none',      // âœ… ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ç”¨ (secure: true ã¨ä½µç”¨)
      maxAge: 24 * 60 * 60 * 1000, // 24æ™‚é–“
      domain: process.env.COOKIE_DOMAIN || undefined // å¿…è¦ã«å¿œã˜ã¦è¨­å®š
    },
    proxy: true // trust proxyè¨­å®šæ¸ˆã¿
  })
);


// ========================================
// ğŸ”§ ä¿®æ­£ç®‡æ‰€ 3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š (è¡Œ240-310)
// ========================================

function initializeDatabase() {
  const useSQLite = process.env.USE_SQLITE === 'true' || process.env.NODE_ENV === 'development';

  if (useSQLite) {
    // SQLite initialization (å¤‰æ›´ãªã—)
    // ...
    return true;
  }

  // PostgreSQL initialization (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„)
  const databaseUrl = process.env.DATABASE_URL ||
    process.env.POSTGRES_URL ||
    process.env.AZURE_POSTGRESQL_CONNECTIONSTRING;

  if (!databaseUrl) {
    console.error('âŒ Database URL not configured');
    console.warn('âš ï¸  Server will start WITHOUT database connection');
    console.warn('âš ï¸  Health endpoints will return 200');
    console.warn('âš ï¸  Database-dependent endpoints will return 503');
    return false; // âœ… ã‚µãƒ¼ãƒãƒ¼ã¯èµ·å‹•ã™ã‚‹ï¼ˆfalseã§ã‚‚OKï¼‰
  }

  try {
    console.log('ğŸ”— Initializing PostgreSQL connection...');

    const sslConfig = process.env.PG_SSL === 'require'
      ? { rejectUnauthorized: false }
      : process.env.PG_SSL === 'disable'
        ? false
        : { rejectUnauthorized: false };

    dbPool = new Pool({
      connectionString: databaseUrl,
      ssl: sslConfig,
      max: 10,
      idleTimeoutMillis: 30000,
      connectionTimeoutMillis: 60000,
      query_timeout: 60000,
      statement_timeout: 60000
    });

    // æ¥ç¶šãƒ†ã‚¹ãƒˆã¯éåŒæœŸã§å®Ÿè¡Œï¼ˆèµ·å‹•ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
    dbPool.query('SELECT NOW()')
      .then(() => {
        console.log('âœ… Database connection successful');
      })
      .catch(error => {
        console.error('âŒ Database connection test failed:', error.message);
        console.warn('âš ï¸  Server will continue running WITHOUT database');
        dbPool = null; // ãƒ—ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
      });

    return true; // âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆã®çµæœã‚’å¾…ãŸãšã«èµ·å‹•ã‚’ç¶™ç¶š

  } catch (error) {
    console.error('âŒ Database initialization failed:', error.message);
    console.warn('âš ï¸  Server will start WITHOUT database connection');
    dbPool = null;
    return false;
  }
}


// ========================================
// ğŸ”§ ä¿®æ­£ç®‡æ‰€ 4: PORTè¨­å®š (è¡Œ60)
// ========================================

const PORT = process.env.PORT || 8080; // âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ8080


// ========================================
// ğŸ”§ ä¿®æ­£ç®‡æ‰€ 5: ã‚µãƒ¼ãƒãƒ¼èµ·å‹• (è¡Œ3050-3086)
// ========================================

const server = app.listen(PORT, '0.0.0.0', () => {
  console.log('\n' + '='.repeat(70));
  console.log('ğŸš€ Emergency Assistance Server Started');
  console.log('='.repeat(70));
  console.log(`ğŸ“ Environment: ${process.env.NODE_ENV || 'production'}`);
  console.log(`ğŸ”Œ Port: ${PORT}`);
  console.log(`ğŸŒ Host: 0.0.0.0 (listening on all interfaces)`);
  console.log(`ğŸ”— Frontend URL: ${FRONTEND_URL}`);
  console.log(`ğŸŒ Static Web App: ${STATIC_WEB_APP_URL}`);
  console.log(`ğŸ’¾ Database: ${dbPool ? 'âœ… Connected (PostgreSQL)' : sqliteDb ? 'âœ… Connected (SQLite)' : 'âŒ Not connected'}`);
  console.log(`ğŸ“¦ BLOB Storage: ${connectionString ? 'âœ… Configured' : 'âŒ Not configured'}`);
  console.log(`ğŸ¤– OpenAI: ${isOpenAIAvailable ? 'âœ… Available' : 'âŒ Not configured'}`);
  console.log('='.repeat(70));
  console.log(`\nâœ… Server is ready to accept connections`);
  console.log(`ğŸ” Health Check: http://localhost:${PORT}/health`);
  console.log(`ğŸ“Š Detailed Health: http://localhost:${PORT}/api/health/detailed\n`);
});

// Graceful shutdown
const shutdown = (signal) => {
  console.log(`\nâš ï¸  Received ${signal}, shutting down gracefully...`);
  server.close(() => {
    console.log('âœ… HTTP server closed');

    if (dbPool) {
      dbPool.end(() => {
        console.log('âœ… Database pool closed');
        process.exit(0);
      });
    } else if (sqliteDb) {
      sqliteDb.close();
      console.log('âœ… SQLite database closed');
      process.exit(0);
    } else {
      process.exit(0);
    }
  });

  // Force exit after 30 seconds
  setTimeout(() => {
    console.error('âŒ Forced shutdown after timeout');
    process.exit(1);
  }, 30000);
};

process.on('SIGTERM', () => shutdown('SIGTERM'));
process.on('SIGINT', () => shutdown('SIGINT'));

// Unhandled errors
process.on('unhandledRejection', (reason, promise) => {
  console.error('âŒ Unhandled Rejection at:', promise, 'reason:', reason);
  // âœ… ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚µãƒ¼ãƒãƒ¼ã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã•ã›ãªã„ï¼ˆãƒ­ã‚°ã®ã¿ï¼‰
});

process.on('uncaughtException', (error) => {
  console.error('âŒ Uncaught Exception:', error);
  // âœ… è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã¿ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³
  if (error.code === 'EADDRINUSE') {
    console.error(`âŒ Port ${PORT} is already in use`);
    process.exit(1);
  }
});


// ========================================
// ğŸ”§ ä¿®æ­£ç®‡æ‰€ 6: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¿…é ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (ä¾‹: ãƒ­ã‚°ã‚¤ãƒ³API)
// ========================================

app.post('/api/auth/login', async (req, res) => {
  // âœ… DBæœªæ¥ç¶šæ™‚ã¯503ã‚’è¿”ã™
  if (!dbPool && !sqliteDb) {
    return res.status(503).json({
      success: false,
      message: 'Database not available'
    });
  }

  // ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
  // ...
});


// ==============================================================================
// é©ç”¨æ–¹æ³•
// ==============================================================================
//
// 1. ã“ã®ä¿®æ­£ã‚’ azure-server.mjs ã«é©ç”¨
// 2. GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ç’°å¢ƒå¤‰æ•° CORS_ALLOW_ORIGINS ã‚’è¨­å®š
// 3. Dockerfile.RECOMMENDED ã‚’ä½¿ç”¨
// 4. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€health check ãŒ 200 ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
// 5. CORS ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
//
// ==============================================================================
