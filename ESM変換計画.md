# ESMå¤‰æ›ã¨è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç”»

## ç¾çŠ¶ï¼ˆ2025-12-05ï¼‰

### å®Œäº†ã—ãŸä½œæ¥­
- âœ… **è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…** - `azure-server.mjs`ã«`loadApiRoutes()`é–¢æ•°ã‚’è¿½åŠ 
- âœ… **BLOBãƒ‘ã‚¹çµ±ä¸€** - ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒ`knowledge-base/`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
- âœ… **å…±æœ‰é–¢æ•°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ** - `getBlobServiceClient`, `containerName`, `norm`, `dbQuery` ã‚’export
- âœ… **ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãƒ«ãƒ¼ãƒˆå¯¾å¿œ** - ç”»åƒã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨ã«`/api/images/*`ã‚’ã‚µãƒãƒ¼ãƒˆ
- âœ… ESMå¤‰æ›å®Œäº†:
  - âœ… `/api/users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
  - âœ… `/api/images` - ç”»åƒå–å¾—ï¼ˆchat-exports, emergency-flowså¯¾å¿œï¼‰

### è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
```javascript
// azure-server.mjs ã«å®Ÿè£…æ¸ˆã¿
async function loadApiRoutes(app) {
  // src/api/ é…ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’èµ°æŸ»
  // index.mjs ã¾ãŸã¯ index.js ã‚’å‹•çš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  // /api/{moduleName} ã«ãƒ«ãƒ¼ãƒˆã‚’è‡ªå‹•ç™»éŒ²
}
```

**å‹•ä½œ:**
1. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã« `loadApiRoutes()` ãŒå®Ÿè¡Œã•ã‚Œã‚‹
2. `src/api/` é…ä¸‹ã®å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¹ã‚­ãƒ£ãƒ³
3. `index.mjs` (å„ªå…ˆ) ã¾ãŸã¯ `index.js` ã‚’æ¤œç´¢
4. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ Express ãƒ«ãƒ¼ãƒˆã«ç™»éŒ²
5. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ãŒå„ªå…ˆã•ã‚Œã€è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯è¡çªã‚’å›é¿

### å•é¡Œã®è§£æ±º
1. âœ… **è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®Ÿè£…æ¸ˆã¿** - å¤‰æ›´ã®ãŸã³ã«`azure-server.mjs`ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒãªããªã£ãŸ
2. â³ **ESMå¤‰æ›** - æ®µéšçš„ã«`src/api/`é…ä¸‹ã‚’ESMå½¢å¼ã«å¤‰æ›ä¸­

---

## ä»Šå¾Œã®è¨ˆç”»

### Phase 1: ä¸€æ°—ã«ESMåŒ– ğŸš€ (é€²è¡Œä¸­)
**æ–¹é‡å¤‰æ›´ç†ç”±:** 
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ··åœ¨ã¯ä¿å®ˆãŒå›°é›£
- BLOBãƒ‘ã‚¹ä¸æ•´åˆãŒè¤‡æ•°ç®‡æ‰€ã«æ•£åœ¨
- æœ€çµ‚çš„ã«ESMåŒ–ã™ã‚‹ãªã‚‰ä»Šã‚„ã‚‹æ–¹ãŒåŠ¹ç‡çš„

**é€²æ—:**
- [x] å…±æœ‰é–¢æ•°ã®exportåŒ–
- [x] `/api/images` ESMåŒ–ï¼ˆå®Œäº†ï¼‰
- [x] `/api/users` ESMåŒ–ï¼ˆå®Œäº†ï¼‰
- [x] `/api/history` ESMåŒ–ï¼ˆå®Œäº†ï¼‰
- [x] `/api/troubleshooting` ESMåŒ–ï¼ˆå®Œäº†ï¼‰
- [x] `/api/emergency-flow` ESMåŒ–ï¼ˆå®Œäº†ï¼‰
- [x] `/api/settings` ESMåŒ–ï¼ˆå®Œäº†ï¼‰
- [x] `/api/machines` ESMåŒ–ï¼ˆå®Œäº†ï¼‰
- [x] ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ã®æ®µéšçš„å‰Šé™¤ï¼ˆå®Œäº†ï¼‰
- [x] **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Œäº†**: 16å€‹ã®ESMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
1. ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å„ªå…ˆçš„ã«ESMåŒ–
2. å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›å¾Œã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ
3. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ã‚’æ®µéšçš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
4. ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦æœ¬ç•ªç¢ºèª

---

### Phase 2: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã¨æ¤œè¨¼
**å‰æ:** ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ESMåŒ–å®Œäº†

å¯¾è±¡: ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**å¤‰æ›æ‰‹é †:**
```javascript
// Before (Azure Functionså½¢å¼ + CommonJS)
const { db } = require('../db/index.js');
module.exports = async function(context, req) {
  context.res = { ... };
}

// After (Expresså½¢å¼ + ESM)
import { dbQuery } from '../../../db/index.js';
export default async function handler(req, res) {
  res.json({ ... });
}
export const methods = ['get', 'post']; // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
```

**å„ªå…ˆé †ä½ï¼ˆä½ãƒªã‚¹ã‚¯ã‹ã‚‰é †ã«ï¼‰:**
1. âœ… `users/` - å®Œäº†ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
2. `settings/` - è¨­å®šç³»ï¼ˆå½±éŸ¿ç¯„å›²ãŒå°ã•ã„ï¼‰
3. `machines/` - ãƒã‚·ãƒ³ç®¡ç†
4. `documents/` - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†
5. `history/` - å±¥æ­´ç®¡ç†
6. `auth/` - èªè¨¼é–¢é€£ï¼ˆæœ€å¾Œï¼šé‡è¦åº¦ãŒé«˜ã„ãŸã‚æ…é‡ã«ï¼‰

**å¤‰æ›ã®é€²ã‚æ–¹:**
1. 1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãšã¤å¤‰æ›
2. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
3. ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦æœ¬ç•ªç¢ºèª
4. å•é¡Œãªã‘ã‚Œã°æ¬¡ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸
5. å•é¡ŒãŒã‚ã‚Œã°è©²å½“ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ`.mjs`ã‚’å‰Šé™¤ã™ã‚Œã°å…ƒã®`.js`ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

### Phase 3: å®Œå…¨ãªã‚³ãƒ¼ãƒ‰çµ±ä¸€ï¼ˆå°†æ¥çš„ãªç›®æ¨™ï¼‰
**ç›®çš„:** ã™ã¹ã¦ã®APIã‚³ãƒ¼ãƒ‰ã‚’ESM + Expresså½¢å¼ã«çµ±ä¸€

ç¾åœ¨ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ã‚’æ®µéšçš„ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–:
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ã¯æ®µéšçš„ã«å‰Šæ¸›
- æ–°è¦æ©Ÿèƒ½ã¯å¿…ãš`src/api/`ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦ä½œæˆ
- æœ€çµ‚çš„ã«ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ã‚¼ãƒ­ã‚’ç›®æŒ‡ã™

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ğŸ¯ ã‚³ãƒ¼ãƒ‰ä¸€è²«æ€§ã®å‘ä¸Š
- ğŸ”§ ä¿å®ˆæ€§ã®å‘ä¸Š
- ğŸš€ æ–°æ©Ÿèƒ½è¿½åŠ ãŒå®¹æ˜“
- ğŸ‘¥ ãƒãƒ¼ãƒ é–‹ç™ºãŒã‚¹ãƒ ãƒ¼ã‚º
- ğŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†åˆ©ç”¨ãŒå¯èƒ½

---

## ä½¿ã„æ–¹

### æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¿½åŠ æ–¹æ³•

1. **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ**
   ```
   server/src/api/my-feature/
   ```

2. **`index.mjs` ã‚’ä½œæˆ**
   ```javascript
   export default async function myFeatureHandler(req, res) {
     const method = req.method;
     
     if (method === 'GET') {
       // GETå‡¦ç†
       return res.json({ success: true, data: [] });
     }
     
     return res.status(405).json({ error: 'Method not allowed' });
   }
   
   export const methods = ['get', 'post'];
   ```

3. **ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•**
   - è‡ªå‹•çš„ã« `/api/my-feature` ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã‚‹
   - `azure-server.mjs` ã®ä¿®æ­£ã¯ä¸è¦ï¼

---

## ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1 ãƒ‡ãƒ—ãƒ­ã‚¤å‰
- [ ] ã™ã¹ã¦ã®BLOBãƒ‘ã‚¹ãŒ`knowledge-base/`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
- [ ] é‡è¤‡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒãªã„
- [ ] ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
  - `AZURE_STORAGE_CONNECTION_STRING`
  - `AZURE_STORAGE_CONTAINER_NAME=knowledge`
  - `DATABASE_URL`

### Phase 2 ç§»è¡Œæ™‚
- [ ] å¤‰æ›å‰ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- [ ] å¤‰æ›å¾Œã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Œäº†
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’ç¢ºèªï¼ˆ`.mjs`å‰Šé™¤ã§å…ƒã«æˆ»ã‚‹ï¼‰
- [ ] 1ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãšã¤æ®µéšçš„ã«å®Ÿæ–½

---

## ã‚³ãƒ¼ãƒ‰çµ±ä¸€ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### ã™ã¹ã¦ã®APIã‚³ãƒ¼ãƒ‰ã§çµ±ä¸€ã™ã¹ãé …ç›®

1. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å½¢å¼:** ESM (import/export)
2. **é–¢æ•°å½¢å¼:** Express ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å½¢å¼ `(req, res) => {}`
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:** try-catch + è©³ç´°ãªãƒ­ã‚°
4. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼:** 
   ```javascript
   {
     success: true/false,
     data: {},
     error: "",
     timestamp: ""
   }
   ```
5. **ãƒ­ã‚°å‡ºåŠ›:** `console.log('[api/endpoint-name] ...')`

### çµ±ä¸€ã—ãªã„ã‚‚ã®
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ç•°ãªã‚‹ã®ã¯å½“ç„¶ï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªï¼ˆå¿…è¦ã«å¿œã˜ã¦ç•°ãªã‚‹ï¼‰

---

## æ³¨æ„äº‹é …
- âœ… ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè£…ã¯è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹
- âœ… `.mjs` ãƒ•ã‚¡ã‚¤ãƒ«ãŒ `.js` ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹
- âœ… ESMå¤‰æ›ä¸­ã‚‚æœ¬ç•ªç’°å¢ƒã¯å‹•ä½œã—ç¶šã‘ã‚‹
- âœ… å¤‰æ›ã¯æ®µéšçš„ã«è¡Œã„ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
- âš ï¸ **é‡è¦:** Phase 1 ã®æ¤œè¨¼å®Œäº†å¾Œã«ã®ã¿ Phase 2 ã¸é€²ã‚€

---

## å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«
- ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒãƒ¼: `server/azure-server.mjs` (è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®Ÿè£…æ¸ˆã¿)
- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º: `server/unified-hot-reload-server.js`
- å¤‰æ›ã‚µãƒ³ãƒ—ãƒ«: `server/src/api/users/index.mjs`
- å¤‰æ›å¯¾è±¡: `server/src/api/**/*.js` (31ãƒ•ã‚¡ã‚¤ãƒ«)



azure-server.mjsnoã®åˆ†æ•£
Node.js (ESM) + Express ã‚µãƒ¼ãƒãƒ¼æ§‹æˆã®å†æ§‹ç¯‰ãŒå®Œäº†ã—
è‚¥å¤§åŒ–ã—ã¦ã„ãŸ azure-server.mjs ã‚’å½¹å‰²ã”ã¨ã«åˆ†å‰²ã—ã€ä¿å®ˆæ€§ã®é«˜ã„æ§‹é€ ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã—ãŸã€‚

server/
â”œâ”€â”€ azure-server.mjs       # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼ˆèµ·å‹•ãƒ»åˆæœŸåŒ–ã®ã¿ï¼‰
â”œâ”€â”€ package.json           # "type": "module", "start": "node azure-server.mjs"
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.mjs            # Expressã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ»ãƒ«ãƒ¼ãƒˆç™»éŒ²ï¼‰
â”‚   â”œâ”€â”€ api/               # è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆæ—¢å­˜ã®æ©Ÿèƒ½ç¶­æŒï¼‰
â”‚   â”‚   â”œâ”€â”€ ...            # (auth, history ã¯ routes ã«ç§»å‹•ã—ãŸãŸã‚å‰Šé™¤)
â”‚   â”œâ”€â”€ config/            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
â”‚   â”‚   â”œâ”€â”€ cors.mjs       # CORSè¨­å®š
â”‚   â”‚   â”œâ”€â”€ env.mjs        # ç’°å¢ƒå¤‰æ•°ãƒ»å®šæ•°
â”‚   â”‚   â”œâ”€â”€ security.mjs   # Helmetãƒ»CSPè¨­å®š
â”‚   â”‚   â””â”€â”€ session.mjs    # ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š
â”‚   â”œâ”€â”€ infra/             # ã‚¤ãƒ³ãƒ•ãƒ©å±¤
â”‚   â”‚   â”œâ”€â”€ blob.mjs       # Azure Blob Storage ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ db.mjs         # PostgreSQL (pg) æ¥ç¶šãƒ—ãƒ¼ãƒ«
â”‚   â”‚   â””â”€â”€ openai.mjs     # OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â””â”€â”€ routes/            # æ˜ç¤ºçš„ãªãƒ«ãƒ¼ãƒˆå®šç¾©ï¼ˆä¸»è¦æ©Ÿèƒ½ï¼‰
â”‚       â”œâ”€â”€ auth.mjs       # èªè¨¼ç³» (/api/auth/*)
â”‚       â”œâ”€â”€ diag.mjs       # è¨ºæ–­ãƒ»ç’°å¢ƒç¢ºèª (/api/_diag/*, /api/version)
â”‚       â”œâ”€â”€ health.mjs     # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ (/live, /ready, /api/health)
â”‚       â””â”€â”€ history.mjs    # å±¥æ­´ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (/api/history/*)