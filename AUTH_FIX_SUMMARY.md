# èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ä¿®æ­£ã‚µãƒžãƒªãƒ¼ï¼ˆæ›´æ–°ç‰ˆï¼‰

## ä¿®æ­£å†…å®¹

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆExpressï¼‰ä¿®æ­£

#### èªè¨¼APIã®æ”¹å–„
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `server/routes/auth.ts`
- **ä¿®æ­£å†…å®¹**:
  - ãƒ­ã‚°ã‚¤ãƒ³APIã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªžåŒ–
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‚’æ˜Žç¤ºçš„ã«å®Ÿè¡Œï¼ˆ`req.session.save()`ï¼‰
  - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®è©³ç´°åŒ–ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³IDã€ã‚¯ãƒƒã‚­ãƒ¼æƒ…å ±ï¼‰
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ï¼ˆ401ã€500ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªå‡¦ç†ï¼‰

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã®æ”¹å–„
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `server/app.ts`
- **ä¿®æ­£å†…å®¹**:
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã®`domain`è¨­å®šã‚’å‰Šé™¤ï¼ˆé–‹ç™ºç’°å¢ƒã§ã®å•é¡Œå›žé¿ï¼‰
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒãƒƒã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ç¶­æŒ

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReact/Viteï¼‰ä¿®æ­£

#### èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹å–„
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `client/src/context/auth-context.tsx`
- **ä¿®æ­£å†…å®¹**:
  - 401ã‚¨ãƒ©ãƒ¼ã®æ˜Žç¤ºçš„ãªå‡¦ç†
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°åŒ–ï¼ˆ401ã€500ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼‰
  - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®æ”¹å–„

#### ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®æ”¹å–„
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `client/src/pages/login.tsx`
- **ä¿®æ­£å†…å®¹**:
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªžåŒ–ã¨è©³ç´°åŒ–
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤º

### 3. ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ”¹å–„
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `test-auth.sh`
- **ä¿®æ­£å†…å®¹**:
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã®è©³ç´°è¡¨ç¤º
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ç¢ºèªå¼·åŒ–

## å‹•ä½œç¢ºèªæ–¹æ³•

### 1. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

#### ã‚µãƒ¼ãƒãƒ¼å´
```bash
cd server
cat > .env << EOF
NODE_ENV=development
PORT=3001
DATABASE_URL=postgresql://postgres:password@localhost:5432/emergency_assistance
SESSION_SECRET=your-super-secret-session-key-change-this-in-production
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
OPENAI_API_KEY=your_openai_api_key_here
VITE_API_BASE_URL=http://localhost:3001
EOF
```

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´
```bash
cd client
cat > .env.local << EOF
VITE_API_BASE_URL=http://localhost:3001
VITE_NODE_ENV=development
EOF
```

### 2. ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã¨ç¢ºèª

```bash
cd server
npm run dev
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°å‡ºåŠ›**:
```
ðŸ”§ é–‹ç™ºç’°å¢ƒèµ·å‹• - ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿é–‹å§‹
âœ… ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ: [ãƒ‘ã‚¹]
ðŸ”§ ç’°å¢ƒå¤‰æ•°ç¢ºèª: { DATABASE_URL: '[SET]', SESSION_SECRET: '[SET]', ... }
```

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®èµ·å‹•

```bash
cd client
npm run dev
```

### 4. èªè¨¼ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
chmod +x test-auth.sh
./test-auth.sh
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**:
```
ðŸ”§ Emergency Assistance System - èªè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹
================================================
1. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ç¢ºèª...
âœ… ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã™

2. ç’°å¢ƒå¤‰æ•°ç¢ºèª...
âœ… ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™

3. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª...
âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã§ãã¾ã—ãŸ

4. æœªèªè¨¼çŠ¶æ…‹ã§ã®èªè¨¼ç¢ºèª...
âœ… æœªèªè¨¼çŠ¶æ…‹ã§æ­£ã—ã401ãŒè¿”ã•ã‚Œã¾ã—ãŸ

5. ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰...
âœ… ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ­£ã—ã401ãŒè¿”ã•ã‚Œã¾ã—ãŸ

6. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®èªè¨¼çŠ¶æ…‹ç¢ºèª...
âš ï¸ ã‚¯ãƒƒã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
```

### 5. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèª

1. **ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®è¡¨ç¤ºç¢ºèª**
   - `http://localhost:5002` ã«ã‚¢ã‚¯ã‚»ã‚¹
   - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

2. **èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª**
   - ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ â†’ ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
   - æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é·ç§»

3. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒã®ç¢ºèª**
   - ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
   - ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒç¶­æŒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

## ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

### 1. ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‡ãƒãƒƒã‚°

```bash
# ç’°å¢ƒå¤‰æ•°ç¢ºèª
curl http://localhost:3001/api/auth/debug/env

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:3001/api/health

# èªè¨¼çŠ¶æ…‹ç¢ºèª
curl http://localhost:3001/api/auth/me

# ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'
```

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®ãƒ‡ãƒãƒƒã‚°

ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’ç¢ºèª:
```javascript
// ç’°å¢ƒå¤‰æ•°ç¢ºèª
console.log(import.meta.env.VITE_API_BASE_URL);

// èªè¨¼çŠ¶æ…‹ç¢ºèª
console.log('Auth context:', useAuth());

// ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§APIå‘¼ã³å‡ºã—ã‚’ç¢ºèª
```

### 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ç¢ºèª

```bash
# ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
curl -v http://localhost:3001/api/auth/debug/env

# ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin"}' \
  -c cookies.txt

curl -b cookies.txt http://localhost:3001/api/auth/me
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œãªã„
**è§£æ±ºæ–¹æ³•**:
1. ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
3. `VITE_API_BASE_URL`ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### å•é¡Œ2: ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¶­æŒã•ã‚Œãªã„
**è§£æ±ºæ–¹æ³•**:
1. ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã‚’ç¢ºèªï¼ˆ`secure: false`ï¼‰
2. ã‚¯ãƒƒã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
3. CORSè¨­å®šã‚’ç¢ºèª

### å•é¡Œ3: èªè¨¼APIãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
**è§£æ±ºæ–¹æ³•**:
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
2. ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§çŠ¶æ…‹ã‚’ç¢ºèª
3. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª

## ä¿®æ­£å¾Œã®æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

1. **ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚**: ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã€ãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã‚‹
2. **ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢**: æœªèªè¨¼æ™‚ã«æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
3. **èªè¨¼API**: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ401ã€500ï¼‰ã‚’è¿”ã™
4. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ãç¶­æŒã•ã‚Œã‚‹
5. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ—¥æœ¬èªžã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
2. ã‚µãƒ¼ãƒãƒ¼ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
3. ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
4. ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèª
5. å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ 