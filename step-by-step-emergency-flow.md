# 段階的応急処置フローシステム - 完成版

## 🎯 **実装内容**

要求された段階的で簡潔な応急処置フローを実装しました：

### ❌ **従来の問題**
```
AI: "エンジンの回転が上昇しない原因はいくつか考えられますね。以下に一般的な原因とその対策を挙げますので、確認してみてください。1. 燃料供給の問題: - 燃料フィルターが詰まっていると..."
```
**問題**: 長い回答をまとめて表示

### ✅ **新しいシステム**
```
ユーザー: "エンジン回転が上昇しない"
AI: "応急処置する時間がありますか？"

ユーザー: "約30分"
AI: "エンジンルームにあるアクセルワイヤーが外れていませんか？"

ユーザー: "つながっている"
AI: "アクセルレバーを指で押して動きますか？"

ユーザー: "動く"
AI: "アクセルレバーを押した時、エンジン回転が上昇しますか？"

ユーザー: "変わらない"
AI: "応急処置は困難です。アイドリング状態で退避してください。"
```

## 🔧 **技術的な実装**

### フロントエンド
- **ステップ管理**: `emergencyStep`で現在のステップを追跡
- **問題タイプ識別**: `problemType`で問題の種類を分類
- **段階的フロー**: 1ステップごとに簡潔な質問

### バックエンド
- **コンテキスト管理**: 現在のステップと問題タイプを考慮
- **会話履歴**: 直近の会話を参照
- **プロンプト最適化**: 段階的フローに特化した指示

## 📋 **対応する問題タイプ**

### 1. **エンジン回転上昇しない** (`engine_rpm`)
```
ステップ1: "応急処置する時間がありますか？"
ステップ2: "エンジンルームにあるアクセルワイヤーが外れていませんか？"
ステップ3: "アクセルレバーを指で押して動きますか？"
ステップ4: "アクセルレバーを押した時、エンジン回転が上昇しますか？"
```

### 2. **エンジン始動しない** (`engine_start`)
```
ステップ1: "応急処置する時間がありますか？"
ステップ2: "エアー圧はありますか？"
ステップ3: "バッテリー電圧は正常ですか？"
ステップ4: "スターターモーターは回りますか？"
```

### 3. **ブレーキ問題** (`brake`)
```
ステップ1: "応急処置する時間がありますか？"
ステップ2: "ブレーキペダルの踏み応えはありますか？"
ステップ3: "ブレーキフルードの量は正常ですか？"
ステップ4: "ブレーキパッドの摩耗はどうですか？"
```

## 🎨 **UI改善**

### ステップ表示
- 現在のステップ番号を表示
- 問題タイプの識別
- 時間管理機能

### 進捗管理
- ステップの自動進行
- 完了時の自動リセット
- 困難時の退避指示

## 📊 **期待される動作例**

### 正常な応急処置フロー
```
ユーザー: "エンジン回転が上昇しない"
AI: "応急処置する時間がありますか？"

ユーザー: "約30分"
AI: "エンジンルームにあるアクセルワイヤーが外れていませんか？"

ユーザー: "外れています"
AI: "アクセルワイヤーを接続してください。接続後、エンジン回転が上昇しますか？"

ユーザー: "上昇します"
AI: "応急処置完了です。"
```

### 応急処置困難な場合
```
ユーザー: "エンジン回転が上昇しない"
AI: "応急処置する時間がありますか？"

ユーザー: "5分しかない"
AI: "応急処置は困難です。アイドリング状態で退避してください。"
```

## 🔍 **テスト手順**

### 1. 基本フローテスト
1. AI支援を開始
2. "エンジン回転が上昇しない"と入力
3. 段階的な質問が表示されることを確認
4. 各ステップで適切な回答を入力

### 2. 問題タイプ別テスト
1. 異なる問題を報告
2. 問題タイプに応じた適切なフローが表示されることを確認

### 3. 完了・困難時のテスト
1. 応急処置完了時のメッセージを確認
2. 困難時の退避指示を確認

## ✅ **改善点**

- **簡潔性**: 1ステップ1確認
- **実用性**: 理論より応急処置を重視
- **段階性**: 問題を段階的に絞り込み
- **時間管理**: 20分制限の考慮
- **安全性**: 困難時の退避指示

このシステムにより、ユーザーは段階的で簡潔な応急処置フローを体験でき、長い説明文ではなく、ステップごとに簡潔な確認と指示を受けることができるようになりました。
