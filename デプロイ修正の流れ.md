# ãƒ‡ãƒ—ãƒ­ã‚¤ä¿®æ­£ã®æµã‚Œ

## ğŸ“‹ ä¿®æ­£ã®å…¨ä½“åƒ

### ğŸ”´ å…ƒã€…ã®å•é¡Œ

1. **CORSè¨­å®šä¸è¶³** â†’ Static Web Appsã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„
2. **ã‚µãƒ¼ãƒãƒ¼503ã‚¨ãƒ©ãƒ¼** â†’ node_modulesæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
3. **Azure ZipDeployã®ä»•æ§˜** â†’ node_modulesã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—
4. **GitHub Actionså¤±æ•—** â†’ scripts/ãŒ.gitignoreã§é™¤å¤–
5. **.gitignoreã®æ©Ÿèƒ½ä¸å…¨** â†’ 9,600ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‡ãƒ—ãƒ­ã‚¤

---

## âœ… å®Ÿæ–½ã—ãŸä¿®æ­£

### 1. CORSè¨­å®šå¼·åŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `server/azure-server.mjs`

```javascript
// allowedOriginsé…åˆ—ã« Static Web Apps URLè¿½åŠ 
const allowedOrigins = [
  'https://happy-bush-083160b00.3.azurestaticapps.net',
  // ... ãã®ä»–
];

// credentialså¯¾å¿œ
corsOptions: {
  origin: function (origin, callback) { ... },
  credentials: true,
  preflightContinue: false,
  optionsSuccessStatus: 204
}
```

### 2. Azure CLI CORSè¨­å®š

```bash
# è¨±å¯ã‚ªãƒªã‚¸ãƒ³è¿½åŠ 
az webapp cors add \
  --resource-group rg-emergency-assistance \
  --name emergency-assistantapp \
  --allowed-origins "https://happy-bush-083160b00.3.azurestaticapps.net"

# èªè¨¼æƒ…å ±ã‚µãƒãƒ¼ãƒˆæœ‰åŠ¹åŒ–
az webapp config set \
  --resource-group rg-emergency-assistance \
  --name emergency-assistantapp \
  --generic-configurations '{"cors":{"supportCredentials":true}}'
```

### 3. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ”¹å–„

**ãƒ•ã‚¡ã‚¤ãƒ«**: `.github/workflows/deploy-server-AppCervce.yml`

```yaml
â‘  å®Œå…¨å‰Šé™¤ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 
  - Kudu VFS APIçµŒç”±ã§wwwrootå…¨å‰Šé™¤
  - å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«æ®‹ç•™ã‚’å®Œå…¨é˜²æ­¢

â‘¡ ZipDeployã‚¹ãƒ†ãƒƒãƒ—
  - node_modulesé™¤å¤–ã§ZIPä½œæˆ
  - è»½é‡åŒ–(9,600ãƒ•ã‚¡ã‚¤ãƒ«å‰Šæ¸›)

â‘¢ Kudu Command APIè¿½åŠ 
  - POST /api/command
  - npm ci --productionå®Ÿè¡Œ
  - App Serviceç’°å¢ƒå¤‰æ•°ãŒè‡ªå‹•ãƒ­ãƒ¼ãƒ‰

â‘£ SHAæ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—
  - COMMIT_SHA.txtã§å³å¯†æ¤œè¨¼
  - GitHub SHA == App Service SHA
```

### 4. .gitignoreä¿®æ­£

**å‰Šé™¤ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«**:
- `server/node_modules/` (ç´„9,600ãƒ•ã‚¡ã‚¤ãƒ«)
- é–‹ç™ºå°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«23å€‹
  - `check-*.js`, `fix-*.js`, `create-*.js`
  - `trigger.js`, `startup-migration.js`
  - `fallback-server.js`, `unified-hot-reload-server.js`
  - `index.dev.js`, `azure-diagnosis.js`
  - `minimal-package.json`, `PATCHES_*.txt`

**ä¿æŒã—ãŸãƒ•ã‚¡ã‚¤ãƒ«**:
- âœ… `server/azure-server.mjs` (ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒãƒ¼)
- âœ… `server/package.json`, `server/package-lock.json`
- âœ… `server/web.config`
- âœ… `server/src/api/**` (å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)
- âœ… `server/routes.js`, `server/services/`, `server/lib/`
- âœ… `scripts/check-rsc-vulnerabilities.js` (CI/CDå¿…é ˆ)
- âœ… `client/scripts/replace-env.cjs` (ãƒ“ãƒ«ãƒ‰å¿…é ˆ)

---

## ğŸ”„ æœ€çµ‚çš„ãªæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

```
ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã€‘
  git add .
  git commit -m "ä¿®æ­£å†…å®¹"
  git push origin main
      â†“
      â†“
ã€GitHub Actionsè‡ªå‹•èµ·å‹•ã€‘
      â†“
  â‘  ã‚³ãƒŸãƒƒãƒˆSHAè¨˜éŒ²
     ${{ github.sha }} ã‚’å–å¾—
      â†“
  â‘¡ ZIPãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
     âœ… server/azure-server.mjs
     âœ… server/package.json
     âœ… server/package-lock.json
     âœ… server/web.config
     âœ… server/src/api/**
     âœ… COMMIT_SHA.txt
     âŒ node_modules/ (é™¤å¤–)
     âŒ é–‹ç™ºãƒ•ã‚¡ã‚¤ãƒ« (é™¤å¤–)
      â†“
  â‘¢ Azure App Service
     - Kudu VFS API: wwwrootå®Œå…¨å‰Šé™¤
     - ZipDeploy: æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«å±•é–‹
      â†“
  â‘£ Kudu Command APIå®Ÿè¡Œ
     POST /api/command
     {
       "command": "npm ci --production",
       "dir": "site/wwwroot/server"
     }
     
     å®Ÿè¡Œå†…å®¹:
     â†’ App Serviceç’°å¢ƒå¤‰æ•°ãŒè‡ªå‹•ãƒ­ãƒ¼ãƒ‰
     â†’ package.jsonã‹ã‚‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
     â†’ node_modules/ç”Ÿæˆ(æœ¬ç•ªç’°å¢ƒã§)
     â†’ package-lock.jsonã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®š
      â†“
  â‘¤ ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼
     Kudu VFS API: COMMIT_SHA.txtèª­ã¿å–ã‚Š
     
     GitHub SHA == App Service SHA?
     âœ… ä¸€è‡´ â†’ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ
     âŒ ä¸ä¸€è‡´ â†’ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—(ã‚¨ãƒ©ãƒ¼çµ‚äº†)
      â†“
  â‘¥ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
     node server/azure-server.mjs
     
     è¨­å®š:
     - ãƒãƒ¼ãƒˆ: 8080
     - ç’°å¢ƒå¤‰æ•°: App Serviceã‹ã‚‰è‡ªå‹•æ³¨å…¥
     - CORS: è¨­å®šæ¸ˆã¿
     - node_modules: æ–°è¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
```

---

## ğŸ¯ é”æˆã•ã‚ŒãŸä¿è¨¼

| è¦ä»¶ | å®Ÿè£…æ–¹æ³• | çŠ¶æ…‹ |
|-----|---------|------|
| ãƒ­ãƒ¼ã‚«ãƒ«=æœ¬ç•ª | package.jsonä¾å­˜ç®¡ç† | âœ… å®Œäº† |
| ç’°å¢ƒå¤‰æ•°ã§åˆ‡ã‚Šæ›¿ãˆ | App Serviceè¨­å®š | âœ… å®Œäº† |
| ãƒ“ãƒ«ãƒ‰/ZIP/ãƒ‡ãƒ—ãƒ­ã‚¤å®Œå…¨è‡ªå‹• | GitHub Actions | âœ… å®Œäº† |
| å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å®Œå…¨å‰Šé™¤ | wwwrootå‰Šé™¤â†’ZipDeploy | âœ… å®Œäº† |
| çµ¶å¯¾ã«æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ« | SHAæ¤œè¨¼ | âœ… å®Œäº† |
| node_modulesè‡ªå‹•ç”Ÿæˆ | Kudu API npm ci | âœ… å®Œäº† |
| ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«é™¤å¤– | .gitignoreä¿®æ­£ | âœ… å®Œäº† |
| CORSè¨­å®š | ã‚³ãƒ¼ãƒ‰+Azure CLI | âœ… å®Œäº† |

---

## ğŸ“Œ ä»Šå¾Œã®é‹ç”¨æ–¹æ³•

### é€šå¸¸ã®é–‹ç™ºãƒ•ãƒ­ãƒ¼

```powershell
# 1. ã‚³ãƒ¼ãƒ‰ä¿®æ­£

# 2. ã‚³ãƒŸãƒƒãƒˆ&ãƒ—ãƒƒã‚·ãƒ¥
git add .
git commit -m "ä¿®æ­£å†…å®¹"
git push origin main

# â†’ ä»¥é™ã¯å…¨è‡ªå‹•
```

### è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨

1. âœ… GitHub ActionsãŒèµ·å‹•
2. âœ… ZIPãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ(è»½é‡åŒ–æ¸ˆã¿)
3. âœ… Azure App Serviceã¸ãƒ‡ãƒ—ãƒ­ã‚¤
4. âœ… å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å®Œå…¨å‰Šé™¤
5. âœ… npm ci --productionå®Ÿè¡Œ
6. âœ… SHAæ¤œè¨¼ã§æœ€æ–°æ€§ç¢ºèª
7. âœ… ã‚µãƒ¼ãƒãƒ¼è‡ªå‹•èµ·å‹•

### æ–°è¦ç’°å¢ƒã§ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```powershell
# ãƒªãƒã‚¸ãƒˆãƒªã‚’clone
git clone https://github.com/Satoshi-Niina/Emergency-Assistance.git
cd Emergency-Assistance

# ã‚µãƒ¼ãƒãƒ¼å´ã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cd server
npm install

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cd ../client
npm install

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

**é‡è¦**: `node_modules/`ã¯Gitç®¡ç†å¤–ãªã®ã§ã€`npm install`ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

---

## ğŸ”§ æŠ€è¡“çš„ãªè©³ç´°

### Azure ZipDeployã®ä»•æ§˜

- `node_modules/`ãƒ•ã‚©ãƒ«ãƒ€ã¯**è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—**ã•ã‚Œã‚‹
- ã“ã‚Œã¯Azureã®ä»•æ§˜(å¤‰æ›´ä¸å¯)
- å¯¾ç­–: Kudu APIã§`npm ci`ã‚’å®Ÿè¡Œ

### Kudu APIæ´»ç”¨

```yaml
# npm installã®å®Ÿè¡Œ
- name: Run npm ci via Kudu
  run: |
    $body = @{
      command = "npm ci --production"
      dir = "site/wwwroot/server"
    } | ConvertTo-Json
    
    Invoke-RestMethod -Method POST `
      -Uri "https://emergency-assistantapp.scm.azurewebsites.net/api/command" `
      -Body $body `
      -Headers @{ Authorization = "Basic $base64AuthInfo" }
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- App Serviceç’°å¢ƒå¤‰æ•°ãŒè‡ªå‹•ãƒ­ãƒ¼ãƒ‰
- `package-lock.json`ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®š
- `--production`ã§é–‹ç™ºä¾å­˜é™¤å¤–

### SHAæ¤œè¨¼ã®é‡è¦æ€§

```yaml
# ãƒ‡ãƒ—ãƒ­ã‚¤å‰: GitHubã®ã‚³ãƒŸãƒƒãƒˆSHA
$expectedSha = "${{ github.sha }}"

# ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ: App Serviceã®COMMIT_SHA.txt
$deployedSha = (Invoke-RestMethod -Uri "...COMMIT_SHA.txt").Trim()

# å³å¯†æ¯”è¼ƒ
if ($deployedSha -ne $expectedSha) {
  Write-Error "ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—: SHAä¸ä¸€è‡´"
  exit 1
}
```

**ä¿è¨¼å†…å®¹**:
- ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ€æ–°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- ä¸ä¸€è‡´ãªã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã¨ã—ã¦æ‰±ã†
- ã€Œ**çµ¶å¯¾ã«æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«**ã€è¦ä»¶ã‚’å®Ÿç¾

---

## ğŸ“ ä¿®æ­£å±¥æ­´

### ã‚³ãƒŸãƒƒãƒˆ: 3674fe03
**æ—¥æ™‚**: 2025å¹´12æœˆ4æ—¥  
**å†…å®¹**: node_modulesã¨é–‹ç™ºå°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã€.gitignoreã‚’æ•´ç†

**å¤‰æ›´å†…å®¹**:
- server/node_modules/å…¨ä½“ã‚’è¿½è·¡ã‹ã‚‰å‰Šé™¤(ç´„9,619ãƒ•ã‚¡ã‚¤ãƒ«)
- é–‹ç™ºå°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«23å€‹ã‚’é™¤å¤–
- .gitignoreã‚’æ•´ç†(é‡è¤‡ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤ã€ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ )
- CI/CDå¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒ

### ã‚³ãƒŸãƒƒãƒˆ: 1b636f05
**å†…å®¹**: check-rsc-vulnerabilities.jsã‚’Gitã«è¿½åŠ 

### ã‚³ãƒŸãƒƒãƒˆ: 387dbd03
**å†…å®¹**: Kudu APIçµŒç”±ã§npm installã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 

### ã‚³ãƒŸãƒƒãƒˆ: 36f4d9ac
**å†…å®¹**: CORSè¨­å®šå¼·åŒ–(azure-server.mjs)

---

## âœ… å®Œäº†äº‹é …ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] CORSè¨­å®š(ã‚³ãƒ¼ãƒ‰å´)
- [x] CORSè¨­å®š(Azure CLIå´)
- [x] ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Œå…¨å‰Šé™¤ã‚¹ãƒ†ãƒƒãƒ—
- [x] Kudu APIçµŒç”±ã®npm ciã‚¹ãƒ†ãƒƒãƒ—
- [x] SHAæ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—
- [x] .gitignoreã®ä¿®æ­£
- [x] node_modules/ã®é™¤å¤–
- [x] é–‹ç™ºå°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã®é™¤å¤–
- [x] CI/CDå¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿æŒ
- [x] æœ¬ç•ªå¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿æŒ

---

## ğŸ‰ çµæœ

**ã‚ãªãŸãŒã‚„ã‚‹ã“ã¨**: `git push`ã®ã¿  
**è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨**: ãƒ“ãƒ«ãƒ‰ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã€npm installã€æ¤œè¨¼ã€èµ·å‹•

ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ€æ–°ã§ã€æ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã¾ã™ã€‚
