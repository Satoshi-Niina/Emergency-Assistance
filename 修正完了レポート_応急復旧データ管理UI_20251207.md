# デプロイ後の応急復旧データ管理UIの修正内容

## 問題の概要

デプロイ後、応急復旧データ管理UIで以下の2つの問題が発生していました:

1. **JSONデータが保存されない**: GPTを活用してキーワードから応急復旧処置を生成した際、生成は成功と表示されるが、BLOBの`knowledge-base\troubleshooting`に生成されたjsonデータが保存されない
2. **画像が表示されない**: jsonの中でリンクした画像（`knowledge-base\images\emergency-flows`）が表示されない

## 原因分析

### 1. BLOB保存の問題

- **原因**: BLOB保存処理自体は実装されていたが、以下の問題がありました:
  - コンテナの存在確認と作成処理が不足していた
  - 詳細なログ出力が不足しており、保存処理の成否が不明確だった
  - エラーハンドリングが不十分で、保存失敗時の詳細情報が取得できなかった

### 2. 画像表示の問題

- **原因分析結果**: 
  - 画像アップロードAPI (`/api/emergency-flow/upload-image`) は正しく実装されており、画像はBLOBに保存されている
  - 画像URLは正しく生成されている (`/api/images/emergency-flows/${fileName}`)
  - 画像取得API (`/api/images/emergency-flows/*`) も正しく実装されている
  - **結論**: 画像表示の問題は、BLOB保存が失敗していることに起因する可能性が高い

## 修正内容

### 修正1: `/api/emergency-flow/generate` エンドポイントの改善

**ファイル**: `server/src/api/emergency-flow/index.mjs`

#### 変更点:

1. **コンテナ存在確認と作成処理を追加**:
   ```javascript
   // コンテナが存在するか確認し、なければ作成
   const containerExists = await containerClient.exists();
   if (!containerExists) {
     console.log('[api/emergency-flow/generate] Creating container:', containerName);
     await containerClient.create();
   }
   ```

2. **詳細なログ出力を追加**:
   ```javascript
   console.log('[api/emergency-flow/generate] ✅ Saving generated flow to BLOB');
   console.log('[api/emergency-flow/generate]   Container:', containerName);
   console.log('[api/emergency-flow/generate]   BLOB path:', blobName);
   console.log('[api/emergency-flow/generate]   File name:', fileName);
   ```

3. **エラーハンドリングを強化**:
   ```javascript
   } catch (blobError) {
     console.error('[api/emergency-flow/generate] ❌ BLOB save failed:', blobError);
     console.error('[api/emergency-flow/generate] Error details:', blobError.stack);
     return res.json({
       success: true,
       data: flowTemplate,
       saved: false,
       warning: 'フローを生成しましたが、保存に失敗しました',
       error: blobError.message,
       errorStack: blobError.stack
     });
   }
   ```

4. **レスポンスメッセージに詳細情報を追加**:
   ```javascript
   return res.json({
     success: true,
     data: flowTemplate,
     saved: true,
     blobName: blobName,
     fileName: fileName,
     message: `フローを生成してBLOBに保存しました (${blobName})`
   });
   ```

### 修正2: `/api/emergency-flow/save` エンドポイントの改善

**ファイル**: `server/src/api/emergency-flow/index.mjs`

#### 変更点:

1. **コンテナ存在確認と作成処理を追加**:
   ```javascript
   // コンテナが存在するか確認
   const containerExists = await containerClient.exists();
   if (!containerExists) {
     console.log('[api/emergency-flow/save] Creating container:', containerName);
     await containerClient.create();
   }
   ```

2. **詳細なログ出力を追加**:
   ```javascript
   console.log('[api/emergency-flow/save] ✅ Saving flow data to BLOB');
   console.log('[api/emergency-flow/save]   Container:', containerName);
   console.log('[api/emergency-flow/save]   BLOB path:', blobNamePrimary);
   console.log('[api/emergency-flow/save]   Flow ID:', flowId);
   ```

3. **エラーログを改善**:
   ```javascript
   const blobServiceClient = getBlobServiceClient();
   if (!blobServiceClient) {
     console.error('[api/emergency-flow/save] ❌ BLOB service client not available');
     return res.status(503).json({ 
       success: false, 
       error: 'BLOB storage not available' 
     });
   }
   ```

## 期待される効果

### 1. BLOB保存の信頼性向上

- コンテナの自動作成により、初回保存時のエラーを防止
- 詳細なログ出力により、保存処理の進行状況を追跡可能
- エラー時の詳細情報により、問題の迅速な特定と解決が可能

### 2. デバッグとトラブルシューティングの容易化

- 各処理ステップでのログ出力により、問題箇所の特定が容易
- エラー時のスタックトレース出力により、根本原因の特定が可能
- レスポンスに詳細情報を含めることで、クライアント側でも状態確認が可能

### 3. 画像表示の問題解決

- BLOB保存が成功することで、保存されたJSONファイルに含まれる画像URLが正しく機能
- 画像APIは既に正しく実装されているため、BLOB保存の成功により画像表示も正常化

## 検証方法

### 1. フロー生成のテスト

1. 応急復旧データ管理UIにアクセス
2. キーワードを入力してGPTによるフロー生成を実行
3. ブラウザの開発者ツール（F12）でコンソールを開き、以下のログを確認:
   - `[api/emergency-flow/generate] ✅ Saving generated flow to BLOB`
   - `[api/emergency-flow/generate] ✅ Flow saved successfully to BLOB:`
4. Azure Portalでストレージアカウントを開き、以下を確認:
   - コンテナが存在すること
   - `knowledge-base/troubleshooting/` 配下にJSONファイルが保存されていること

### 2. 画像表示のテスト

1. フロー編集画面で画像をアップロード
2. フローを保存
3. フロー一覧からフローを再度開き、画像が正しく表示されることを確認
4. Azure Portalで `knowledge-base/images/emergency-flows/` 配下に画像ファイルが保存されていることを確認

### 3. エラーハンドリングのテスト

1. Azure Storage接続文字列を一時的に無効化
2. フロー生成を実行
3. 以下を確認:
   - エラーメッセージが適切に表示されること
   - コンソールにエラーログが出力されること
   - クライアント側でエラー情報が取得できること

## 今後の改善提案

1. **リトライ機能の追加**: BLOB保存失敗時に自動的にリトライする機能
2. **保存状態の可視化**: UI上でBLOB保存状態（保存中、保存済み、失敗）を表示
3. **バッチ保存機能**: 複数のフローを一括で保存する機能
4. **画像最適化**: アップロード時の画像圧縮・リサイズ機能

## 関連ファイル

- `server/src/api/emergency-flow/index.mjs` - 応急復旧フローAPI
- `server/src/api/images/index.mjs` - 画像取得API
- `server/src/infra/blob.mjs` - BLOB接続管理
- `client/src/components/emergency-guide/emergency-flow-creator.tsx` - フロー作成UI
- `client/src/components/emergency-guide/emergency-flow-generator.tsx` - フロー生成UI

## 修正日時

2025年12月7日
